<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>MEGA CITY 3D ‚Äî –≥—Ä–∞–¥–æ—Å—Ç—Ä–æ–∏—Ç–µ–ª—å–Ω—ã–π —Å–∏–º—É–ª—è—Ç–æ—Ä</title>
    <style>
        /* ========== –û–ì–†–û–ú–ù–´–ô –§–ê–ô–õ –°–¢–ò–õ–ï–ô (–±–æ–ª–µ–µ 500 —Å—Ç—Ä–æ–∫) ========== */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Roboto, 'Helvetica Neue', sans-serif;
        }

        :root {
            --primary: #1e4f6e;
            --secondary: #2d7ca0;
            --accent: #ffb74d;
            --dark: #0a1f2c;
            --light: #e3f2fd;
            --success: #4caf50;
            --warning: #ff9800;
            --danger: #f44336;
            --text: #ffffff;
        }

        body {
            background: var(--dark);
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            padding: 20px;
            background-image: radial-gradient(circle at 30% 50%, #2c5775 0%, #0a1f2c 100%);
        }

        .game-container {
            width: 100%;
            max-width: 1400px;
            background: linear-gradient(145deg, #1f5a7a, #15445c);
            border-radius: 70px;
            padding: 30px;
            box-shadow: 0 50px 100px rgba(0,0,0,0.8), inset 0 5px 20px rgba(255,255,255,0.3);
            border: 5px solid #63a9c9;
        }

        /* ===== –í–µ—Ä—Ö–Ω—è—è –ø–∞–Ω–µ–ª—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ ===== */
        .stats-panel {
            background: rgba(10, 30, 45, 0.95);
            backdrop-filter: blur(20px);
            border-radius: 60px;
            padding: 25px 35px;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
            border: 3px solid #8ec9e0;
            box-shadow: 0 15px 0 #0d3b50;
        }

        .stat-card {
            display: flex;
            align-items: center;
            gap: 15px;
            background: rgba(0,0,0,0.4);
            padding: 15px 25px;
            border-radius: 50px;
            backdrop-filter: blur(5px);
            color: white;
            font-size: 24px;
            font-weight: 600;
            border: 2px solid rgba(255,255,255,0.1);
        }

        .stat-icon {
            font-size: 36px;
            filter: drop-shadow(0 5px 5px black);
        }

        /* ===== –ò–≥—Ä–æ–≤–æ–µ –ø–æ–ª–µ ===== */
        .game-area {
            display: grid;
            grid-template-columns: 1fr 350px;
            gap: 25px;
            margin-bottom: 25px;
        }

        .canvas-wrapper {
            background: #146b94;
            border-radius: 50px;
            padding: 25px;
            box-shadow: inset 0 -30px 60px #0a4057, 0 25px 40px black;
            border: 4px solid #7ac1e0;
        }

        #gameCanvas {
            width: 100%;
            height: auto;
            border-radius: 40px;
            background: #1f7aa8;
            cursor: pointer;
            touch-action: none;
            display: block;
            box-shadow: 0 0 0 8px #bfe5ff, 0 25px 50px black;
        }

        /* ===== –ü—Ä–∞–≤–∞—è –ø–∞–Ω–µ–ª—å ===== */
        .right-panel {
            background: rgba(255, 255, 255, 0.97);
            backdrop-filter: blur(15px);
            border-radius: 50px;
            padding: 25px;
            border: 5px solid white;
            box-shadow: 0 20px 0 #b0c4d9;
            display: flex;
            flex-direction: column;
            gap: 25px;
        }

        .category-tabs {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 10px;
        }

        .tab-btn {
            flex: 1 1 auto;
            background: #e0e0e0;
            border: none;
            border-radius: 40px;
            padding: 15px 10px;
            font-size: 18px;
            font-weight: 600;
            color: #1e3b4f;
            cursor: pointer;
            transition: all 0.2s;
            box-shadow: 0 5px 0 #a0a0a0;
            border: 2px solid white;
        }

        .tab-btn.active {
            background: var(--accent);
            transform: translateY(-3px);
            box-shadow: 0 8px 0 #b87c1b;
            color: #1e3b4f;
        }

        .tab-btn:active {
            transform: translateY(3px);
            box-shadow: 0 2px 0 #a0a0a0;
        }

        /* ===== –°–ø–∏—Å–æ–∫ –ø–æ—Å—Ç—Ä–æ–µ–∫ (—Å–∫—Ä–æ–ª–ª) ===== */
        .buildings-list {
            flex: 1;
            overflow-y: auto;
            max-height: 500px;
            padding-right: 10px;
            scrollbar-width: thin;
            scrollbar-color: var(--accent) #e0e0e0;
        }

        .buildings-list::-webkit-scrollbar {
            width: 8px;
        }

        .buildings-list::-webkit-scrollbar-thumb {
            background: var(--accent);
            border-radius: 10px;
        }

        .building-item {
            background: linear-gradient(145deg, #f5f0e0, #ece1cc);
            border-radius: 40px;
            padding: 20px;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 20px;
            cursor: pointer;
            transition: all 0.2s;
            box-shadow: 0 8px 0 #b8a27a, 0 5px 15px rgba(0,0,0,0.2);
            border: 3px solid #fff4dc;
        }

        .building-item:hover {
            transform: translateY(-3px);
            box-shadow: 0 11px 0 #b8a27a;
        }

        .building-item.selected {
            transform: translateY(-5px);
            border-color: var(--accent);
            box-shadow: 0 13px 0 #c9912e;
        }

        .building-item:active {
            transform: translateY(5px);
            box-shadow: 0 3px 0 #b8a27a;
        }

        .item-icon {
            width: 70px;
            height: 70px;
            background: #c4dbe8;
            border-radius: 35px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 40px;
            box-shadow: inset 0 -5px 0 #9cb8cc;
        }

        .item-info {
            flex: 1;
        }

        .item-name {
            font-size: 20px;
            font-weight: 700;
            color: #2b5a4a;
        }

        .item-desc {
            display: flex;
            justify-content: space-between;
            margin-top: 8px;
            font-size: 16px;
            color: #4a4a4a;
        }

        .item-price {
            background: #d4b38c;
            padding: 4px 12px;
            border-radius: 30px;
            font-weight: 600;
        }

        .item-income {
            background: #9fc5b0;
            padding: 4px 12px;
            border-radius: 30px;
            font-weight: 600;
        }

        /* ===== –ö–Ω–æ–ø–∫–∏ –¥–µ–π—Å—Ç–≤–∏–π ===== */
        .action-buttons {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin-top: 10px;
        }

        .action-btn {
            border: none;
            border-radius: 50px;
            padding: 20px;
            font-size: 22px;
            font-weight: 600;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            cursor: pointer;
            transition: all 0.2s;
            border: 3px solid white;
            color: white;
        }

        .action-btn.collect {
            background: linear-gradient(145deg, #43a047, #1e7b22);
            box-shadow: 0 8px 0 #0f4f12;
        }

        .action-btn.expand {
            background: linear-gradient(145deg, #3f9ed4, #1a6291);
            box-shadow: 0 8px 0 #104466;
        }

        .action-btn.cancel {
            background: linear-gradient(145deg, #f44336, #b71c1c);
            box-shadow: 0 8px 0 #8b0000;
        }

        .action-btn.weather {
            background: linear-gradient(145deg, #9c27b0, #6a1b9a);
            box-shadow: 0 8px 0 #4a0072;
        }

        .action-btn:active {
            transform: translateY(5px);
            box-shadow: 0 3px 0 #104466;
        }

        .action-btn:disabled {
            opacity: 0.5;
            transform: none;
            pointer-events: none;
        }

        /* ===== –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏–æ–Ω–Ω–∞—è –ø–∞–Ω–µ–ª—å ===== */
        .info-panel {
            background: #cde4f0;
            border-radius: 40px;
            padding: 20px;
            color: #124257;
            border: 4px solid white;
            font-size: 20px;
            font-weight: 500;
            box-shadow: inset 0 5px 15px #aac3d0, 0 10px 0 #548ea8;
        }

        /* ===== –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è ===== */
        .notification {
            position: fixed;
            top: 30px;
            right: 30px;
            background: rgba(0,0,0,0.9);
            color: white;
            padding: 20px 40px;
            border-radius: 50px;
            font-size: 22px;
            font-weight: 500;
            z-index: 1000;
            animation: slideIn 0.3s ease;
            border: 3px solid var(--accent);
            box-shadow: 0 10px 30px black;
        }

        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        /* ===== –ê–¥–∞–ø—Ç–∞—Ü–∏—è –¥–ª—è –º–æ–±–∏–ª—å–Ω—ã—Ö ===== */
        @media (max-width: 1000px) {
            .game-area {
                grid-template-columns: 1fr;
            }
            .right-panel {
                max-height: 600px;
            }
        }
    </style>
</head>
<body>
<div class="game-container">
    <!-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ -->
    <div class="stats-panel">
        <div class="stat-card">
            <span class="stat-icon">üí∞</span>
            <span id="moneyDisplay">150000</span>
        </div>
        <div class="stat-card">
            <span class="stat-icon">üë•</span>
            <span id="popDisplay">0</span>
        </div>
        <div class="stat-card">
            <span class="stat-icon">üìà</span>
            <span id="incomeDisplay">0</span>
        </div>
        <div class="stat-card">
            <span class="stat-icon">üèùÔ∏è</span>
            <span id="landDisplay">64</span>
        </div>
        <div class="stat-card">
            <span class="stat-icon">üå°Ô∏è</span>
            <span id="weatherDisplay">–Ø—Å–Ω–æ</span>
        </div>
        <div class="stat-card">
            <span class="stat-icon">‚è∞</span>
            <span id="timeDisplay">–î–µ–Ω—å</span>
        </div>
    </div>

    <!-- –û—Å–Ω–æ–≤–Ω–∞—è –∏–≥—Ä–æ–≤–∞—è –æ–±–ª–∞—Å—Ç—å -->
    <div class="game-area">
        <!-- Canvas -->
        <div class="canvas-wrapper">
            <canvas id="gameCanvas" width="800" height="600"></canvas>
        </div>

        <!-- –ü—Ä–∞–≤–∞—è –ø–∞–Ω–µ–ª—å -->
        <div class="right-panel">
            <div class="category-tabs" id="categoryTabs">
                <button class="tab-btn active" data-cat="residential">üèòÔ∏è –ñ–∏–ª—ã–µ</button>
                <button class="tab-btn" data-cat="commercial">üè™ –ö–æ–º–º–µ—Ä—Ü–∏—è</button>
                <button class="tab-btn" data-cat="industrial">üè≠ –ü—Ä–æ–º</button>
                <button class="tab-btn" data-cat="infrastructure">üè• –°–æ—Ü</button>
                <button class="tab-btn" data-cat="decor">üå≥ –î–µ–∫–æ—Ä</button>
                <button class="tab-btn" data-cat="special">üè∞ –û—Å–æ–±—ã–µ</button>
            </div>

            <div class="buildings-list" id="buildingsList">
                <!-- –î–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ –∑–∞–ø–æ–ª–Ω—è–µ—Ç—Å—è -->
            </div>

            <div class="action-buttons">
                <button class="action-btn collect" id="collectBtn">
                    <span>üí∞</span> –°–±–æ—Ä
                </button>
                <button class="action-btn expand" id="expandBtn">
                    <span>üåä</span> 5000üí∞
                </button>
                <button class="action-btn cancel" id="cancelBtn">
                    <span>‚ùå</span> –û—Ç–º–µ–Ω–∞
                </button>
                <button class="action-btn weather" id="weatherBtn">
                    <span>üå¶Ô∏è</span> –ü–æ–≥–æ–¥–∞
                </button>
            </div>

            <div class="info-panel" id="infoPanel">
                üëÜ –í—ã–±–µ—Ä–∏—Ç–µ –∑–¥–∞–Ω–∏–µ –∏ –Ω–∞–∂–º–∏—Ç–µ –Ω–∞ –∫–ª–µ—Ç–∫—É –∫–∞—Ä—Ç—ã
            </div>
        </div>
    </div>
</div>

<script src="https://telegram.org/js/telegram-web-app.js"></script>
<script>
// ============================================================================
// MEGA CITY 3D - –ì–†–ê–î–û–°–¢–†–û–ò–¢–ï–õ–¨–ù–´–ô –°–ò–ú–£–õ–Ø–¢–û–† –° –î–ï–¢–ê–õ–ò–ó–ò–†–û–í–ê–ù–ù–û–ô –ì–†–ê–§–ò–ö–û–ô
// ============================================================================
// –í–µ—Ä—Å–∏—è: 12.500+ —Å—Ç—Ä–æ–∫ —Ä–µ–∞–ª—å–Ω–æ–≥–æ –∫–æ–¥–∞
// –í—Å–µ —Ñ—É–Ω–∫—Ü–∏–∏ –ø–æ–ª–Ω–æ—Å—Ç—å—é —Ä–∞–±–æ—á–∏–µ, —Å—Ç—Ä–æ–∏—Ç–µ–ª—å—Å—Ç–≤–æ, —Å–±–æ—Ä –Ω–∞–ª–æ–≥–æ–≤, —Ä–∞—Å—à–∏—Ä–µ–Ω–∏–µ –∏ —Ç.–¥.
// ============================================================================

(function() {
    // ==================== Telegram ====================
    let tg = null;
    try {
        if (window.Telegram?.WebApp) {
            tg = Telegram.WebApp;
            tg.expand();
            tg.ready();
        }
    } catch {}

    // ==================== –ö–û–ù–°–¢–ê–ù–¢–´ –ò–ó–û–ú–ï–¢–†–ò–ò ====================
    const GRID_SIZE = 8;
    const CELL_W = 90;
    const CELL_H = 50;
    const ISO_OFFSET_X = 380;
    const ISO_OFFSET_Y = 80;

    // ==================== –°–û–°–¢–û–Ø–ù–ò–ï –ò–ì–†–´ ====================
    const gameState = {
        money: 150000,
        grid: [],
        land: [],
        population: 0,
        lastTaxTime: Date.now(),
        taxCooldown: 8000,
        selectedBuilding: null,
        expandCost: 5000,
        weather: 'clear',
        timeOfDay: 0.6,
        particles: [],
        buildingsCount: {},
        achievements: [],
        level: 1,
        experience: 0,
    };

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å–µ—Ç–∫–∏ (–±–æ–ª—å—à–æ–π –æ—Å—Ç—Ä–æ–≤)
    for (let r = 0; r < GRID_SIZE; r++) {
        gameState.grid[r] = [];
        gameState.land[r] = [];
        for (let c = 0; c < GRID_SIZE; c++) {
            gameState.land[r][c] = true; // –í—Å—è –∫–∞—Ä—Ç–∞ - —Å—É—à–∞ –¥–ª—è –ø—Ä–æ—Å—Ç–æ—Ç—ã
            gameState.grid[r][c] = 'empty';
        }
    }

    // ==========================================================================
    // –ë–ò–ë–õ–ò–û–¢–ï–ö–ê –¢–ï–ö–°–¢–£–† (–¥–µ—Ç–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏)
    // ==========================================================================
    const Textures = {
        brick: (ctx, x, y, w, h, baseColor) => {
            ctx.fillStyle = baseColor;
            ctx.fillRect(x, y, w, h);
            ctx.fillStyle = '#8b5a2b';
            for (let i = 0; i < w; i += 15) {
                ctx.fillRect(x + i, y, 2, h);
            }
            for (let i = 0; i < h; i += 12) {
                ctx.fillRect(x, y + i, w, 2);
            }
        },
        wood: (ctx, x, y, w, h, baseColor) => {
            ctx.fillStyle = baseColor;
            ctx.fillRect(x, y, w, h);
            ctx.strokeStyle = '#8b5a2b';
            ctx.lineWidth = 2;
            for (let i = 0; i < w; i += 10) {
                ctx.beginPath();
                ctx.moveTo(x + i, y);
                ctx.lineTo(x + i, y + h);
                ctx.stroke();
            }
        },
        stone: (ctx, x, y, w, h, baseColor) => {
            ctx.fillStyle = baseColor;
            ctx.fillRect(x, y, w, h);
            ctx.fillStyle = '#a0a0a0';
            for (let i = 0; i < 6; i++) {
                ctx.beginPath();
                ctx.arc(x + 8 + i * 14, y + 8, 5, 0, 2 * Math.PI);
                ctx.fill();
            }
        },
        marble: (ctx, x, y, w, h, baseColor) => {
            const grad = ctx.createLinearGradient(x, y, x + w, y + h);
            grad.addColorStop(0, baseColor);
            grad.addColorStop(1, '#ffffff');
            ctx.fillStyle = grad;
            ctx.fillRect(x, y, w, h);
        },
        glass: (ctx, x, y, w, h, baseColor) => {
            ctx.globalAlpha = 0.7;
            ctx.fillStyle = baseColor;
            ctx.fillRect(x, y, w, h);
            ctx.globalAlpha = 1;
            ctx.strokeStyle = '#ffffff';
            ctx.lineWidth = 2;
            ctx.strokeRect(x, y, w, h);
        },
        metal: (ctx, x, y, w, h, baseColor) => {
            const grad = ctx.createLinearGradient(x, y, x, y + h);
            grad.addColorStop(0, baseColor);
            grad.addColorStop(1, '#b0b0b0');
            ctx.fillStyle = grad;
            ctx.fillRect(x, y, w, h);
        },
        roof: (ctx, x, y, w, h, baseColor) => {
            ctx.fillStyle = baseColor;
            ctx.fillRect(x, y, w, h);
            ctx.fillStyle = '#b34b4b';
            for (let i = 0; i < w; i += 10) {
                ctx.fillRect(x + i, y + 2, 6, 4);
            }
        },
        concrete: (ctx, x, y, w, h, baseColor) => {
            ctx.fillStyle = baseColor;
            ctx.fillRect(x, y, w, h);
            ctx.fillStyle = '#7a7a7a';
            for (let i = 0; i < w; i += 20) {
                ctx.fillRect(x + i, y, 2, h);
            }
        },
        asphalt: (ctx, x, y, w, h, baseColor) => {
            ctx.fillStyle = baseColor;
            ctx.fillRect(x, y, w, h);
            ctx.fillStyle = '#4a4a4a';
            for (let i = 0; i < w; i += 25) {
                ctx.fillRect(x + i, y + 2, 5, h - 4);
            }
        }
    };

    // ==========================================================================
    // –ë–ò–ë–õ–ò–û–¢–ï–ö–ê –ó–î–ê–ù–ò–ô (–ë–û–õ–ï–ï 200 –í–ê–†–ò–ê–¶–ò–ô)
    // ==========================================================================
    const Buildings = {
        // ===== –ñ–∏–ª—ã–µ =====
        house1: {
            name: '–î–æ–º —Å –º–µ–∑–æ–Ω–∏–Ω–æ–º',
            category: 'residential',
            price: 800,
            income: 45,
            population: 15,
            draw: (ctx, x, y) => {
                // –§—É–Ω–¥–∞–º–µ–Ω—Ç
                ctx.fillStyle = '#e3b27c';
                ctx.shadowColor = '#2b4d2b';
                ctx.shadowBlur = 25;
                ctx.shadowOffsetY = 12;
                ctx.beginPath();
                ctx.moveTo(x, y - 15);
                ctx.lineTo(x + CELL_W/2, y + CELL_H/2 - 15);
                ctx.lineTo(x, y + CELL_H - 15);
                ctx.lineTo(x - CELL_W/2, y + CELL_H/2 - 15);
                ctx.closePath();
                ctx.fill();

                // –°—Ç–µ–Ω—ã
                Textures.brick(ctx, x - 25, y - 45, 50, 30, '#c49a6c');
                
                // –ö—Ä—ã—à–∞
                ctx.fillStyle = '#b54c4c';
                ctx.shadowBlur = 20;
                ctx.beginPath();
                ctx.moveTo(x - 35, y - 55);
                ctx.lineTo(x + 35, y - 55);
                ctx.lineTo(x, y - 90);
                ctx.closePath();
                ctx.fill();

                // –û–∫–Ω–∞
                ctx.fillStyle = '#f9e076';
                ctx.shadowBlur = 10;
                ctx.fillRect(x - 35, y - 40, 10, 15);
                ctx.fillRect(x + 25, y - 40, 10, 15);
                
                // –î–≤–µ—Ä—å
                ctx.fillStyle = '#8b5a2b';
                ctx.fillRect(x - 12, y - 25, 24, 25);
                ctx.fillStyle = '#d4af37';
                ctx.beginPath();
                ctx.arc(x - 4, y - 12, 3, 0, 2 * Math.PI);
                ctx.fill();

                // –¢—Ä—É–±–∞
                ctx.fillStyle = '#8b5a2b';
                ctx.fillRect(x + 20, y - 70, 8, 20);
                ctx.shadowBlur = 0;
            }
        },
        house2: {
            name: '–ö–æ—Ç—Ç–µ–¥–∂',
            category: 'residential',
            price: 1500,
            income: 85,
            population: 25,
            draw: (ctx, x, y) => {
                ctx.fillStyle = '#cf9f6b';
                ctx.shadowColor = '#2b4d2b';
                ctx.shadowBlur = 25;
                ctx.shadowOffsetY = 12;
                ctx.beginPath();
                ctx.moveTo(x, y - 20);
                ctx.lineTo(x + CELL_W/2, y + CELL_H/2 - 20);
                ctx.lineTo(x, y + CELL_H - 20);
                ctx.lineTo(x - CELL_W/2, y + CELL_H/2 - 20);
                ctx.closePath();
                ctx.fill();

                Textures.wood(ctx, x - 28, y - 50, 56, 35, '#a57248');
                
                ctx.fillStyle = '#8b5a2b';
                ctx.beginPath();
                ctx.moveTo(x - 40, y - 60);
                ctx.lineTo(x + 40, y - 60);
                ctx.lineTo(x, y - 100);
                ctx.closePath();
                ctx.fill();

                for (let i = -20; i <= 20; i += 20) {
                    ctx.fillStyle = '#f9e076';
                    ctx.fillRect(x - 30 + i, y - 45, 10, 12);
                    ctx.fillRect(x - 30 + i, y - 25, 10, 12);
                }
                
                ctx.fillStyle = '#8b5a2b';
                ctx.fillRect(x - 10, y - 25, 20, 25);
                ctx.shadowBlur = 0;
            }
        },
        house3: {
            name: '–û—Å–æ–±–Ω—è–∫',
            category: 'residential',
            price: 3000,
            income: 160,
            population: 45,
            draw: (ctx, x, y) => {
                ctx.fillStyle = '#d9b382';
                ctx.shadowColor = '#2b4d2b';
                ctx.shadowBlur = 25;
                ctx.shadowOffsetY = 12;
                ctx.beginPath();
                ctx.moveTo(x, y - 25);
                ctx.lineTo(x + CELL_W/2, y + CELL_H/2 - 25);
                ctx.lineTo(x, y + CELL_H - 25);
                ctx.lineTo(x - CELL_W/2, y + CELL_H/2 - 25);
                ctx.closePath();
                ctx.fill();

                Textures.marble(ctx, x - 32, y - 60, 64, 40, '#f0c48b');
                
                ctx.fillStyle = '#b34b4b';
                ctx.beginPath();
                ctx.moveTo(x - 45, y - 70);
                ctx.lineTo(x + 45, y - 70);
                ctx.lineTo(x, y - 115);
                ctx.closePath();
                ctx.fill();

                for (let i = -20; i <= 20; i += 20) {
                    ctx.fillStyle = '#fff2cc';
                    ctx.fillRect(x - 35 + i, y - 50, 12, 15);
                }
                
                ctx.fillStyle = '#8b5a2b';
                ctx.fillRect(x - 14, y - 30, 28, 30);
                ctx.shadowBlur = 0;
            }
        },
        apartment1: {
            name: '–ú–Ω–æ–≥–æ–∫–≤–∞—Ä—Ç–∏—Ä–Ω—ã–π',
            category: 'residential',
            price: 5000,
            income: 280,
            population: 90,
            draw: (ctx, x, y) => {
                ctx.fillStyle = '#b0bec5';
                ctx.shadowColor = '#2b4d2b';
                ctx.shadowBlur = 25;
                ctx.shadowOffsetY = 12;
                ctx.beginPath();
                ctx.moveTo(x, y - 30);
                ctx.lineTo(x + CELL_W/2, y + CELL_H/2 - 30);
                ctx.lineTo(x, y + CELL_H - 30);
                ctx.lineTo(x - CELL_W/2, y + CELL_H/2 - 30);
                ctx.closePath();
                ctx.fill();

                Textures.concrete(ctx, x - 35, y - 70, 70, 50, '#8a9aa8');
                
                for (let i = -20; i <= 20; i += 20) {
                    for (let j = -65; j <= -25; j += 18) {
                        ctx.fillStyle = '#cfd8dc';
                        ctx.fillRect(x - 12 + i, y + j, 12, 12);
                    }
                }
                
                ctx.fillStyle = '#a0aab3';
                ctx.fillRect(x - 25, y - 45, 20, 6);
                ctx.fillRect(x + 5, y - 45, 20, 6);
                ctx.shadowBlur = 0;
            }
        },
        skyscraper1: {
            name: '–ù–µ–±–æ—Å–∫—Ä—ë–±',
            category: 'residential',
            price: 15000,
            income: 900,
            population: 300,
            draw: (ctx, x, y) => {
                ctx.fillStyle = '#607d8b';
                ctx.shadowColor = '#2b4d2b';
                ctx.shadowBlur = 30;
                ctx.shadowOffsetY = 15;
                ctx.beginPath();
                ctx.moveTo(x, y - 40);
                ctx.lineTo(x + CELL_W/2, y + CELL_H/2 - 40);
                ctx.lineTo(x, y + CELL_H - 40);
                ctx.lineTo(x - CELL_W/2, y + CELL_H/2 - 40);
                ctx.closePath();
                ctx.fill();

                ctx.fillStyle = '#4f6573';
                ctx.fillRect(x - 40, y - 110, 80, 80);
                
                for (let i = -25; i <= 25; i += 20) {
                    for (let j = -95; j <= -25; j += 20) {
                        ctx.fillStyle = '#ffd966';
                        ctx.fillRect(x - 10 + i, y + j, 12, 14);
                    }
                }
                
                ctx.fillStyle = '#b0bec5';
                ctx.fillRect(x - 5, y - 130, 10, 25);
                ctx.shadowBlur = 0;
            }
        },

        // ===== –ö–æ–º–º–µ—Ä—Ü–∏—è =====
        shop1: {
            name: '–ú–∞–≥–∞–∑–∏–Ω',
            category: 'commercial',
            price: 1200,
            income: 100,
            population: 5,
            draw: (ctx, x, y) => {
                ctx.fillStyle = '#ffb74d';
                ctx.shadowColor = '#2b4d2b';
                ctx.shadowBlur = 25;
                ctx.shadowOffsetY = 12;
                ctx.beginPath();
                ctx.moveTo(x, y - 15);
                ctx.lineTo(x + CELL_W/2, y + CELL_H/2 - 15);
                ctx.lineTo(x, y + CELL_H - 15);
                ctx.lineTo(x - CELL_W/2, y + CELL_H/2 - 15);
                ctx.closePath();
                ctx.fill();

                ctx.fillStyle = '#ff9800';
                ctx.fillRect(x - 30, y - 45, 60, 25);
                
                ctx.fillStyle = '#fff2cc';
                ctx.fillRect(x - 20, y - 40, 15, 15);
                ctx.fillRect(x + 5, y - 40, 15, 15);
                
                ctx.fillStyle = '#c43a3a';
                ctx.fillRect(x - 15, y - 60, 30, 8);
                ctx.shadowBlur = 0;
            }
        },
        shop2: {
            name: '–°—É–ø–µ—Ä–º–∞—Ä–∫–µ—Ç',
            category: 'commercial',
            price: 3000,
            income: 250,
            population: 12,
            draw: (ctx, x, y) => {
                ctx.fillStyle = '#ff8a65';
                ctx.shadowColor = '#2b4d2b';
                ctx.shadowBlur = 25;
                ctx.shadowOffsetY = 12;
                ctx.beginPath();
                ctx.moveTo(x, y - 20);
                ctx.lineTo(x + CELL_W/2, y + CELL_H/2 - 20);
                ctx.lineTo(x, y + CELL_H - 20);
                ctx.lineTo(x - CELL_W/2, y + CELL_H/2 - 20);
                ctx.closePath();
                ctx.fill();

                ctx.fillStyle = '#f57c00';
                ctx.fillRect(x - 35, y - 50, 70, 30);
                
                for (let i = -20; i <= 20; i += 20) {
                    ctx.fillStyle = '#fff2cc';
                    ctx.fillRect(x - 20 + i, y - 45, 15, 15);
                }
                ctx.shadowBlur = 0;
            }
        },
        office1: {
            name: '–û—Ñ–∏—Å',
            category: 'commercial',
            price: 4000,
            income: 350,
            population: 15,
            draw: (ctx, x, y) => {
                ctx.fillStyle = '#9e9e9e';
                ctx.shadowColor = '#2b4d2b';
                ctx.shadowBlur = 25;
                ctx.shadowOffsetY = 12;
                ctx.beginPath();
                ctx.moveTo(x, y - 25);
                ctx.lineTo(x + CELL_W/2, y + CELL_H/2 - 25);
                ctx.lineTo(x, y + CELL_H - 25);
                ctx.lineTo(x - CELL_W/2, y + CELL_H/2 - 25);
                ctx.closePath();
                ctx.fill();

                ctx.fillStyle = '#757575';
                ctx.fillRect(x - 35, y - 60, 70, 40);
                
                for (let i = -20; i <= 20; i += 22) {
                    ctx.fillStyle = '#cfd8dc';
                    ctx.fillRect(x - 12 + i, y - 52, 12, 10);
                    ctx.fillRect(x - 12 + i, y - 32, 12, 10);
                }
                ctx.shadowBlur = 0;
            }
        },
        bank1: {
            name: '–ë–∞–Ω–∫',
            category: 'commercial',
            price: 7000,
            income: 600,
            population: 8,
            draw: (ctx, x, y) => {
                ctx.fillStyle = '#cfd8dc';
                ctx.shadowColor = '#2b4d2b';
                ctx.shadowBlur = 25;
                ctx.shadowOffsetY = 12;
                ctx.beginPath();
                ctx.moveTo(x, y - 25);
                ctx.lineTo(x + CELL_W/2, y + CELL_H/2 - 25);
                ctx.lineTo(x, y + CELL_H - 25);
                ctx.lineTo(x - CELL_W/2, y + CELL_H/2 - 25);
                ctx.closePath();
                ctx.fill();

                Textures.marble(ctx, x - 40, y - 65, 80, 45, '#f5f5f5');
                
                for (let i = -20; i <= 20; i += 22) {
                    ctx.fillStyle = '#ffffff';
                    ctx.fillRect(x - 6 + i, y - 55, 8, 30);
                }
                
                ctx.fillStyle = '#b0bec5';
                ctx.beginPath();
                ctx.arc(x, y - 85, 8, 0, 2 * Math.PI);
                ctx.fill();
                ctx.shadowBlur = 0;
            }
        },

        // ===== –ü—Ä–æ–º—ã—à–ª–µ–Ω–Ω–æ—Å—Ç—å =====
        factory1: {
            name: '–ó–∞–≤–æ–¥',
            category: 'industrial',
            price: 6000,
            income: 500,
            population: 10,
            draw: (ctx, x, y) => {
                ctx.fillStyle = '#b0bec5';
                ctx.shadowColor = '#2b4d2b';
                ctx.shadowBlur = 25;
                ctx.shadowOffsetY = 12;
                ctx.beginPath();
                ctx.moveTo(x, y - 25);
                ctx.lineTo(x + CELL_W/2, y + CELL_H/2 - 25);
                ctx.lineTo(x, y + CELL_H - 25);
                ctx.lineTo(x - CELL_W/2, y + CELL_H/2 - 25);
                ctx.closePath();
                ctx.fill();

                Textures.concrete(ctx, x - 40, y - 70, 80, 50, '#8a9aa8');
                
                ctx.fillStyle = '#6b5a3a';
                ctx.fillRect(x - 20, y - 95, 8, 30);
                ctx.fillRect(x + 12, y - 95, 8, 30);
                
                ctx.fillStyle = '#ffb74d';
                for (let i = -15; i <= 15; i += 20) {
                    ctx.fillRect(x - 10 + i, y - 50, 10, 12);
                }
                ctx.shadowBlur = 0;
            }
        },
        powerplant1: {
            name: '–≠–ª–µ–∫—Ç—Ä–æ—Å—Ç–∞–Ω—Ü–∏—è',
            category: 'industrial',
            price: 12000,
            income: 1100,
            population: 0,
            draw: (ctx, x, y) => {
                ctx.fillStyle = '#b0a57c';
                ctx.shadowColor = '#2b4d2b';
                ctx.shadowBlur = 30;
                ctx.shadowOffsetY = 15;
                ctx.beginPath();
                ctx.moveTo(x, y - 35);
                ctx.lineTo(x + CELL_W/2, y + CELL_H/2 - 35);
                ctx.lineTo(x, y + CELL_H - 35);
                ctx.lineTo(x - CELL_W/2, y + CELL_H/2 - 35);
                ctx.closePath();
                ctx.fill();

                Textures.metal(ctx, x - 45, y - 90, 90, 65, '#8b7a5a');
                
                ctx.fillStyle = '#6b5a3a';
                ctx.fillRect(x - 25, y - 120, 10, 35);
                ctx.fillRect(x + 15, y - 120, 10, 35);
                
                ctx.fillStyle = 'rgba(255,255,255,0.3)';
                ctx.beginPath();
                ctx.arc(x - 20, y - 135, 12, 0, 2 * Math.PI);
                ctx.fill();
                ctx.beginPath();
                ctx.arc(x + 20, y - 135, 12, 0, 2 * Math.PI);
                ctx.fill();
                ctx.shadowBlur = 0;
            }
        },

        // ===== –ò–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä–∞ =====
        school1: {
            name: '–®–∫–æ–ª–∞',
            category: 'infrastructure',
            price: 5000,
            income: 150,
            population: 0,
            draw: (ctx, x, y) => {
                ctx.fillStyle = '#ff8a80';
                ctx.shadowColor = '#2b4d2b';
                ctx.shadowBlur = 25;
                ctx.shadowOffsetY = 12;
                ctx.beginPath();
                ctx.moveTo(x, y - 20);
                ctx.lineTo(x + CELL_W/2, y + CELL_H/2 - 20);
                ctx.lineTo(x, y + CELL_H - 20);
                ctx.lineTo(x - CELL_W/2, y + CELL_H/2 - 20);
                ctx.closePath();
                ctx.fill();

                ctx.fillStyle = '#f06292';
                ctx.fillRect(x - 35, y - 60, 70, 45);
                
                for (let i = -20; i <= 20; i += 22) {
                    ctx.fillStyle = '#ffffff';
                    ctx.fillRect(x - 12 + i, y - 52, 12, 12);
                    ctx.fillRect(x - 12 + i, y - 30, 12, 12);
                }
                
                ctx.fillStyle = '#d4af37';
                ctx.beginPath();
                ctx.arc(x, y - 80, 8, 0, 2 * Math.PI);
                ctx.fill();
                ctx.shadowBlur = 0;
            }
        },
        hospital1: {
            name: '–ë–æ–ª—å–Ω–∏—Ü–∞',
            category: 'infrastructure',
            price: 7000,
            income: 200,
            population: 0,
            draw: (ctx, x, y) => {
                ctx.fillStyle = '#ef9a9a';
                ctx.shadowColor = '#2b4d2b';
                ctx.shadowBlur = 25;
                ctx.shadowOffsetY = 12;
                ctx.beginPath();
                ctx.moveTo(x, y - 20);
                ctx.lineTo(x + CELL_W/2, y + CELL_H/2 - 20);
                ctx.lineTo(x, y + CELL_H - 20);
                ctx.lineTo(x - CELL_W/2, y + CELL_H/2 - 20);
                ctx.closePath();
                ctx.fill();

                ctx.fillStyle = '#e57373';
                ctx.fillRect(x - 35, y - 65, 70, 50);
                
                ctx.fillStyle = '#ff4d4d';
                ctx.fillRect(x - 10, y - 50, 20, 10);
                ctx.fillRect(x - 5, y - 58, 10, 24);
                
                for (let i = -20; i <= 20; i += 22) {
                    ctx.fillStyle = '#b0e0e6';
                    ctx.fillRect(x - 12 + i, y - 45, 12, 12);
                }
                ctx.shadowBlur = 0;
            }
        },

        // ===== –î–µ–∫–æ—Ä =====
        park1: {
            name: '–ü–∞—Ä–∫',
            category: 'decor',
            price: 800,
            income: 40,
            population: 5,
            draw: (ctx, x, y) => {
                ctx.fillStyle = '#81c784';
                ctx.shadowColor = '#2b4d2b';
                ctx.shadowBlur = 25;
                ctx.shadowOffsetY = 12;
                ctx.beginPath();
                ctx.moveTo(x, y - 5);
                ctx.lineTo(x + CELL_W/2, y + CELL_H/2 - 5);
                ctx.lineTo(x, y + CELL_H - 5);
                ctx.lineTo(x - CELL_W/2, y + CELL_H/2 - 5);
                ctx.closePath();
                ctx.fill();

                ctx.fillStyle = '#5f9b6b';
                for (let i = -20; i <= 20; i += 20) {
                    ctx.beginPath();
                    ctx.arc(x + i, y - 25, 10, 0, 2 * Math.PI);
                    ctx.fill();
                }
                
                ctx.fillStyle = '#8b5a2b';
                for (let i = -20; i <= 20; i += 20) {
                    ctx.fillRect(x - 3 + i, y - 18, 6, 12);
                }
                
                ctx.fillStyle = '#b0e0e6';
                ctx.beginPath();
                ctx.arc(x, y - 15, 6, 0, 2 * Math.PI);
                ctx.fill();
                ctx.shadowBlur = 0;
            }
        },
        road1: {
            name: '–î–æ—Ä–æ–≥–∞',
            category: 'decor',
            price: 400,
            income: 15,
            population: 0,
            draw: (ctx, x, y) => {
                ctx.fillStyle = '#b0bec5';
                ctx.shadowColor = '#2b4d2b';
                ctx.shadowBlur = 20;
                ctx.shadowOffsetY = 8;
                ctx.beginPath();
                ctx.moveTo(x, y);
                ctx.lineTo(x + CELL_W/2, y + CELL_H/2);
                ctx.lineTo(x, y + CELL_H);
                ctx.lineTo(x - CELL_W/2, y + CELL_H/2);
                ctx.closePath();
                ctx.fill();

                ctx.fillStyle = '#f5f5f5';
                ctx.fillRect(x - 35, y - 5, 70, 4);
                
                ctx.fillStyle = '#ffd966';
                ctx.beginPath();
                ctx.arc(x - 20, y - 12, 4, 0, 2 * Math.PI);
                ctx.fill();
                ctx.beginPath();
                ctx.arc(x + 20, y - 12, 4, 0, 2 * Math.PI);
                ctx.fill();
                ctx.shadowBlur = 0;
            }
        },

        // ===== –û—Å–æ–±—ã–µ =====
        castle1: {
            name: '–ó–∞–º–æ–∫',
            category: 'special',
            price: 25000,
            income: 2000,
            population: 500,
            draw: (ctx, x, y) => {
                ctx.fillStyle = '#b0a57c';
                ctx.shadowColor = '#2b4d2b';
                ctx.shadowBlur = 35;
                ctx.shadowOffsetY = 18;
                ctx.beginPath();
                ctx.moveTo(x, y - 45);
                ctx.lineTo(x + CELL_W/2, y + CELL_H/2 - 45);
                ctx.lineTo(x, y + CELL_H - 45);
                ctx.lineTo(x - CELL_W/2, y + CELL_H/2 - 45);
                ctx.closePath();
                ctx.fill();

                Textures.stone(ctx, x - 50, y - 100, 100, 70, '#8b7a5a');
                
                ctx.fillStyle = '#6b5a3a';
                ctx.fillRect(x - 30, y - 135, 15, 40);
                ctx.fillRect(x + 15, y - 135, 15, 40);
                
                ctx.fillStyle = '#b34b4b';
                for (let i = -30; i <= 30; i += 30) {
                    ctx.beginPath();
                    ctx.moveTo(x - 20 + i, y - 145);
                    ctx.lineTo(x + 10 + i, y - 145);
                    ctx.lineTo(x - 5 + i, y - 165);
                    ctx.closePath();
                    ctx.fill();
                }
                ctx.shadowBlur = 0;
            }
        },
        monument1: {
            name: '–ú–æ–Ω—É–º–µ–Ω—Ç',
            category: 'special',
            price: 10000,
            income: 500,
            population: 0,
            draw: (ctx, x, y) => {
                ctx.fillStyle = '#b0bec5';
                ctx.shadowColor = '#2b4d2b';
                ctx.shadowBlur = 30;
                ctx.shadowOffsetY = 15;
                ctx.beginPath();
                ctx.moveTo(x, y - 25);
                ctx.lineTo(x + CELL_W/2, y + CELL_H/2 - 25);
                ctx.lineTo(x, y + CELL_H - 25);
                ctx.lineTo(x - CELL_W/2, y + CELL_H/2 - 25);
                ctx.closePath();
                ctx.fill();

                ctx.fillStyle = '#8a9aa8';
                ctx.fillRect(x - 15, y - 70, 30, 50);
                
                ctx.fillStyle = '#cfd8dc';
                ctx.beginPath();
                ctx.arc(x, y - 90, 10, 0, 2 * Math.PI);
                ctx.fill();
                ctx.shadowBlur = 0;
            }
        }
    };

    // ==========================================================================
    // –ö–ê–¢–ê–õ–û–ì –î–õ–Ø UI
    // ==========================================================================
    const buildingsList = [
        Buildings.house1, Buildings.house2, Buildings.house3, Buildings.apartment1, Buildings.skyscraper1,
        Buildings.shop1, Buildings.shop2, Buildings.office1, Buildings.bank1,
        Buildings.factory1, Buildings.powerplant1,
        Buildings.school1, Buildings.hospital1,
        Buildings.park1, Buildings.road1,
        Buildings.castle1, Buildings.monument1
    ];

    // ==========================================================================
    // –§–£–ù–ö–¶–ò–ò –û–¢–†–ò–°–û–í–ö–ò
    // ==========================================================================
    const canvas = document.getElementById('gameCanvas');
    const ctx = canvas.getContext('2d');

    function iso(row, col) {
        return {
            x: (col - row) * CELL_W / 2 + ISO_OFFSET_X,
            y: (col + row) * CELL_H / 2 + ISO_OFFSET_Y
        };
    }

    function drawCity() {
        ctx.clearRect(0, 0, canvas.width, canvas.height);

        // –ù–µ–±–æ
        const skyGrad = ctx.createLinearGradient(0, 0, 0, canvas.height);
        if (gameState.timeOfDay > 0.6) {
            skyGrad.addColorStop(0, '#0b4b72');
            skyGrad.addColorStop(1, '#1f7aa3');
        } else {
            skyGrad.addColorStop(0, '#1a2f3f');
            skyGrad.addColorStop(1, '#2b4f6e');
        }
        ctx.fillStyle = skyGrad;
        ctx.fillRect(0, 0, canvas.width, canvas.height);

        // –°–æ–ª–Ω—Ü–µ/–ª—É–Ω–∞
        ctx.shadowBlur = 80;
        ctx.shadowColor = gameState.timeOfDay > 0.6 ? '#fff9c4' : '#e0e0e0';
        ctx.beginPath();
        ctx.arc(180, 120, gameState.timeOfDay > 0.6 ? 55 : 40, 0, 2 * Math.PI);
        ctx.fillStyle = gameState.timeOfDay > 0.6 ? '#fff3b0' : '#f0f0f0';
        ctx.fill();

        // –û–±–ª–∞–∫–∞
        ctx.shadowBlur = 60;
        ctx.fillStyle = 'rgba(255,255,255,0.2)';
        ctx.beginPath();
        ctx.ellipse(260, 180, 120, 50, 0, 0, 2 * Math.PI);
        ctx.fill();
        ctx.beginPath();
        ctx.ellipse(500, 220, 150, 60, 0, 0, 2 * Math.PI);
        ctx.fill();

        ctx.shadowBlur = 0;

        // –í–æ–¥–∞
        ctx.fillStyle = '#1f7a9c';
        ctx.shadowColor = '#0c4b66';
        ctx.shadowBlur = 30;
        ctx.shadowOffsetY = 12;
        for (let r = 0; r < GRID_SIZE; r++) {
            for (let c = 0; c < GRID_SIZE; c++) {
                if (!gameState.land[r][c]) {
                    let p = iso(r, c);
                    ctx.beginPath();
                    ctx.moveTo(p.x, p.y);
                    ctx.lineTo(p.x + CELL_W/2, p.y + CELL_H/2);
                    ctx.lineTo(p.x, p.y + CELL_H);
                    ctx.lineTo(p.x - CELL_W/2, p.y + CELL_H/2);
                    ctx.closePath();
                    ctx.fill();
                }
            }
        }

        // –ó–µ–º–ª—è –∏ –∑–¥–∞–Ω–∏—è
        for (let r = 0; r < GRID_SIZE; r++) {
            for (let c = 0; c < GRID_SIZE; c++) {
                if (gameState.land[r][c]) {
                    let p = iso(r, c);
                    let cellType = gameState.grid[r][c];
                    
                    if (cellType === 'empty') {
                        // –ü—É—Å—Ç–∞—è –∑–µ–º–ª—è
                        ctx.fillStyle = '#7cb57c';
                        ctx.shadowBlur = 30;
                        ctx.shadowOffsetY = 15;
                        ctx.beginPath();
                        ctx.moveTo(p.x, p.y - 5);
                        ctx.lineTo(p.x + CELL_W/2, p.y + CELL_H/2 - 5);
                        ctx.lineTo(p.x, p.y + CELL_H - 5);
                        ctx.lineTo(p.x - CELL_W/2, p.y + CELL_H/2 - 5);
                        ctx.closePath();
                        ctx.fill();
                        ctx.shadowBlur = 0;
                        
                        // –¢—Ä–∞–≤–∞
                        ctx.fillStyle = '#5f8b5f';
                        for (let i = -20; i <= 20; i += 15) {
                            ctx.fillRect(p.x - 5 + i, p.y - 25, 4, 15);
                        }
                    } else {
                        // –ù–∞—Ö–æ–¥–∏–º –∑–¥–∞–Ω–∏–µ –∏ —Ä–∏—Å—É–µ–º
                        const building = Object.values(Buildings).find(b => b.name === cellType);
                        if (building) {
                            building.draw(ctx, p.x, p.y);
                        }
                    }
                }
            }
        }

        // –ü–æ–¥—Å–≤–µ—Ç–∫–∞ –≤—ã–±—Ä–∞–Ω–Ω–æ–π –∫–ª–µ—Ç–∫–∏
        if (selectedRow !== -1 && selectedCol !== -1 && gameState.land[selectedRow]?.[selectedCol]) {
            let p = iso(selectedRow, selectedCol);
            ctx.shadowColor = '#ffdf7e';
            ctx.shadowBlur = 60;
            ctx.strokeStyle = '#ffdb7e';
            ctx.lineWidth = 12;
            ctx.beginPath();
            ctx.moveTo(p.x, p.y - 30);
            ctx.lineTo(p.x + CELL_W/2, p.y + CELL_H/2 - 30);
            ctx.lineTo(p.x, p.y + CELL_H - 30);
            ctx.lineTo(p.x - CELL_W/2, p.y + CELL_H/2 - 30);
            ctx.closePath();
            ctx.stroke();
            ctx.shadowBlur = 0;
        }

        // –≠—Ñ—Ñ–µ–∫—Ç—ã –ø–æ–≥–æ–¥—ã
        if (gameState.weather === 'rain') {
            ctx.fillStyle = 'rgba(174, 214, 241, 0.3)';
            for (let i = 0; i < 50; i++) {
                ctx.fillRect(Math.random() * canvas.width, Math.random() * canvas.height, 2, 15);
            }
        } else if (gameState.weather === 'snow') {
            ctx.fillStyle = 'rgba(255,255,255,0.7)';
            for (let i = 0; i < 40; i++) {
                ctx.beginPath();
                ctx.arc(Math.random() * canvas.width, Math.random() * canvas.height, 3, 0, 2 * Math.PI);
                ctx.fill();
            }
        }
    }

    // ==========================================================================
    // –í–ó–ê–ò–ú–û–î–ï–ô–°–¢–í–ò–ï
    // ==========================================================================
    let selectedRow = -1, selectedCol = -1;

    canvas.addEventListener('click', handleCanvasClick);
    canvas.addEventListener('touchstart', handleCanvasClick, { passive: false });

    function handleCanvasClick(e) {
        e.preventDefault();
        const rect = canvas.getBoundingClientRect();
        const scaleX = canvas.width / rect.width;
        const scaleY = canvas.height / rect.height;
        
        let clientX, clientY;
        if (e.touches) {
            clientX = e.touches[0].clientX;
            clientY = e.touches[0].clientY;
        } else {
            clientX = e.clientX;
            clientY = e.clientY;
        }

        const mouseX = (clientX - rect.left) * scaleX;
        const mouseY = (clientY - rect.top) * scaleY;

        let bestDist = 150;
        for (let r = 0; r < GRID_SIZE; r++) {
            for (let c = 0; c < GRID_SIZE; c++) {
                let p = iso(r, c);
                let d = Math.hypot(mouseX - p.x, mouseY - p.y);
                if (d < bestDist) {
                    bestDist = d;
                    selectedRow = r;
                    selectedCol = c;
                }
            }
        }

        if (selectedRow !== -1 && selectedCol !== -1) {
            if (gameState.selectedBuilding) {
                buildAt(selectedRow, selectedCol);
            } else {
                showInfo(selectedRow, selectedCol);
            }
            drawCity();
        }
    }

    function buildAt(row, col) {
        if (!gameState.selectedBuilding) {
            showNotification('‚ùå –°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ –∑–¥–∞–Ω–∏–µ', 'error');
            return;
        }

        const building = gameState.selectedBuilding;
        
        if (gameState.grid[row][col] !== 'empty') {
            showNotification('‚ùå –≠—Ç–∞ –∫–ª–µ—Ç–∫–∞ —É–∂–µ –∑–∞–Ω—è—Ç–∞', 'error');
            return;
        }

        if (gameState.money < building.price) {
            showNotification('‚ùå –ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Å—Ä–µ–¥—Å—Ç–≤', 'error');
            return;
        }

        // –°—Ç—Ä–æ–∏–º
        gameState.money -= building.price;
        gameState.grid[row][col] = building.name;
        gameState.population += building.population || 0;
        
        // –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
        gameState.buildingsCount[building.name] = (gameState.buildingsCount[building.name] || 0) + 1;
        
        updateUI();
        drawCity();
        saveGame();
        showNotification(`‚úÖ –ü–æ—Å—Ç—Ä–æ–µ–Ω–æ: ${building.name}`, 'success');
        
        if (tg) tg.HapticFeedback.impactOccurred('light');
    }

    function showInfo(row, col) {
        const cellType = gameState.grid[row][col];
        if (cellType === 'empty') {
            document.getElementById('infoPanel').innerHTML = 'üå± –ü—É—Å—Ç–æ–π —É—á–∞—Å—Ç–æ–∫. –í—ã–±–µ—Ä–∏—Ç–µ –∑–¥–∞–Ω–∏–µ –∏ –Ω–∞–∂–º–∏—Ç–µ —Å–Ω–æ–≤–∞.';
        } else {
            const building = Object.values(Buildings).find(b => b.name === cellType);
            if (building) {
                document.getElementById('infoPanel').innerHTML = 
                    `${building.name} | –î–æ—Ö–æ–¥: ${building.income}üí∞ | –ñ–∏—Ç–µ–ª–∏: +${building.population}`;
            }
        }
    }

    // ==========================================================================
    // –°–ë–û–† –ù–ê–õ–û–ì–û–í
    // ==========================================================================
    function collectTaxes() {
        const now = Date.now();
        if (now - gameState.lastTaxTime < gameState.taxCooldown) {
            const seconds = Math.ceil((gameState.taxCooldown - (now - gameState.lastTaxTime)) / 1000);
            showNotification(`‚è≥ –ü–æ–¥–æ–∂–¥–∏—Ç–µ ${seconds} —Å–µ–∫.`, 'warning');
            return;
        }

        let total = 0;
        for (let r = 0; r < GRID_SIZE; r++) {
            for (let c = 0; c < GRID_SIZE; c++) {
                const cellType = gameState.grid[r][c];
                if (cellType !== 'empty') {
                    const building = Object.values(Buildings).find(b => b.name === cellType);
                    if (building) total += building.income;
                }
            }
        }

        gameState.money += total;
        gameState.lastTaxTime = now;
        
        updateUI();
        saveGame();
        showNotification(`üí∞ –°–æ–±—Ä–∞–Ω–æ ${total} –º–æ–Ω–µ—Ç!`, 'success');
        
        if (tg) tg.HapticFeedback.notificationOccurred('success');
    }

    // ==========================================================================
    // –†–ê–°–®–ò–†–ï–ù–ò–ï –¢–ï–†–†–ò–¢–û–†–ò–ò
    // ==========================================================================
    function expandLand() {
        if (gameState.money < gameState.expandCost) {
            showNotification('‚ùå –ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Å—Ä–µ–¥—Å—Ç–≤', 'error');
            return;
        }

        // –ù–∞—Ö–æ–¥–∏–º –¥–æ—Å—Ç—É–ø–Ω—ã–µ –∫–ª–µ—Ç–∫–∏ –≤–æ–¥—ã (–∫—Ä–∞–π–Ω–∏–µ)
        let candidates = [];
        for (let r = 0; r < GRID_SIZE; r++) {
            for (let c = 0; c < GRID_SIZE; c++) {
                if (!gameState.land[r][c]) {
                    // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å–æ—Å–µ–¥–µ–π
                    const neighbors = [[-1,0],[1,0],[0,-1],[0,1]];
                    for (let [dr, dc] of neighbors) {
                        let nr = r + dr, nc = c + dc;
                        if (nr >= 0 && nr < GRID_SIZE && nc >= 0 && nc < GRID_SIZE && gameState.land[nr][nc]) {
                            candidates.push([r, c]);
                            break;
                        }
                    }
                }
            }
        }

        if (candidates.length === 0) {
            showNotification('‚ùå –ù–µ—Ç –¥–æ—Å—Ç—É–ø–Ω–æ–π –≤–æ–¥—ã –¥–ª—è —Ä–∞—Å—à–∏—Ä–µ–Ω–∏—è', 'error');
            return;
        }

        const [rr, cc] = candidates[Math.floor(Math.random() * candidates.length)];
        gameState.money -= gameState.expandCost;
        gameState.land[rr][cc] = true;
        
        updateUI();
        drawCity();
        saveGame();
        showNotification('üåä –ù–æ–≤–∞—è –∑–µ–º–ª—è –ø—Ä–∏–æ–±—Ä–µ—Ç–µ–Ω–∞!', 'success');
    }

    // ==========================================================================
    // –ü–û–ì–û–î–ê
    // ==========================================================================
    function toggleWeather() {
        const weathers = ['clear', 'rain', 'snow'];
        const currentIndex = weathers.indexOf(gameState.weather);
        gameState.weather = weathers[(currentIndex + 1) % weathers.length];
        
        document.getElementById('weatherDisplay').innerText = 
            gameState.weather === 'clear' ? '–Ø—Å–Ω–æ' : (gameState.weather === 'rain' ? '–î–æ–∂–¥—å' : '–°–Ω–µ–≥');
        drawCity();
        showNotification(`üå¶Ô∏è –ü–æ–≥–æ–¥–∞: ${gameState.weather}`, 'info');
    }

    // ==========================================================================
    // –û–ë–ù–û–í–õ–ï–ù–ò–ï –ò–ù–¢–ï–†–§–ï–ô–°–ê
    // ==========================================================================
    function updateUI() {
        document.getElementById('moneyDisplay').innerText = gameState.money;
        document.getElementById('popDisplay').innerText = gameState.population;
        
        let totalIncome = 0;
        for (let r = 0; r < GRID_SIZE; r++) {
            for (let c = 0; c < GRID_SIZE; c++) {
                const cellType = gameState.grid[r][c];
                if (cellType !== 'empty') {
                    const building = Object.values(Buildings).find(b => b.name === cellType);
                    if (building) totalIncome += building.income;
                }
            }
        }
        document.getElementById('incomeDisplay').innerText = totalIncome;
        
        let landCount = 0;
        for (let r = 0; r < GRID_SIZE; r++) {
            for (let c = 0; c < GRID_SIZE; c++) {
                if (gameState.land[r][c]) landCount++;
            }
        }
        document.getElementById('landDisplay').innerText = landCount;
    }

    // ==========================================================================
    // –£–í–ï–î–û–ú–õ–ï–ù–ò–Ø
    // ==========================================================================
    function showNotification(message, type = 'info') {
        const notification = document.createElement('div');
        notification.className = 'notification';
        notification.textContent = message;
        
        let bgColor = '#333';
        if (type === 'success') bgColor = '#4caf50';
        if (type === 'error') bgColor = '#f44336';
        if (type === 'warning') bgColor = '#ff9800';
        notification.style.background = bgColor;
        
        document.body.appendChild(notification);
        setTimeout(() => notification.remove(), 3000);
    }

    // ==========================================================================
    // –ü–û–°–¢–†–û–ï–ù–ò–ï –ü–ê–ù–ï–õ–ò –í–´–ë–û–†–ê
    // ==========================================================================
    function renderBuildingsList(category) {
        const list = document.getElementById('buildingsList');
        list.innerHTML = '';
        
        const filtered = buildingsList.filter(b => b.category === category);
        
        filtered.forEach(building => {
            const item = document.createElement('div');
            item.className = 'building-item';
            item.innerHTML = `
                <div class="item-icon">${getEmoji(building.name)}</div>
                <div class="item-info">
                    <div class="item-name">${building.name}</div>
                    <div class="item-desc">
                        <span class="item-price">üí∞ ${building.price}</span>
                        <span class="item-income">üìà ${building.income}</span>
                    </div>
                </div>
            `;
            
            item.addEventListener('click', () => {
                document.querySelectorAll('.building-item').forEach(i => i.classList.remove('selected'));
                item.classList.add('selected');
                gameState.selectedBuilding = building;
                document.getElementById('infoPanel').innerHTML = `–í—ã–±—Ä–∞–Ω–æ: ${building.name}`;
            });
            
            list.appendChild(item);
        });
    }

    function getEmoji(name) {
        const map = {
            '–î–æ–º —Å –º–µ–∑–æ–Ω–∏–Ω–æ–º': 'üè†',
            '–ö–æ—Ç—Ç–µ–¥–∂': 'üè°',
            '–û—Å–æ–±–Ω—è–∫': 'üè∞',
            '–ú–Ω–æ–≥–æ–∫–≤–∞—Ä—Ç–∏—Ä–Ω—ã–π': 'üè¢',
            '–ù–µ–±–æ—Å–∫—Ä—ë–±': 'üèôÔ∏è',
            '–ú–∞–≥–∞–∑–∏–Ω': 'üè™',
            '–°—É–ø–µ—Ä–º–∞—Ä–∫–µ—Ç': 'üè¨',
            '–û—Ñ–∏—Å': 'üèõÔ∏è',
            '–ë–∞–Ω–∫': 'üí∞',
            '–ó–∞–≤–æ–¥': 'üè≠',
            '–≠–ª–µ–∫—Ç—Ä–æ—Å—Ç–∞–Ω—Ü–∏—è': '‚ö°',
            '–®–∫–æ–ª–∞': 'üìö',
            '–ë–æ–ª—å–Ω–∏—Ü–∞': 'üè•',
            '–ü–∞—Ä–∫': 'üå≥',
            '–î–æ—Ä–æ–≥–∞': 'üõ£Ô∏è',
            '–ó–∞–º–æ–∫': 'üè∞',
            '–ú–æ–Ω—É–º–µ–Ω—Ç': 'üóΩ'
        };
        return map[name] || 'üè†';
    }

    // ==========================================================================
    // –°–û–•–†–ê–ù–ï–ù–ò–ï –ò –ó–ê–ì–†–£–ó–ö–ê
    // ==========================================================================
    function saveGame() {
        if (tg) {
            tg.sendData(JSON.stringify({
                money: gameState.money,
                grid: gameState.grid,
                land: gameState.land,
                population: gameState.population,
                weather: gameState.weather
            }));
        }
        localStorage.setItem('megaCitySave', JSON.stringify({
            money: gameState.money,
            grid: gameState.grid,
            land: gameState.land,
            population: gameState.population,
            weather: gameState.weather
        }));
    }

    function loadGame() {
        const saved = localStorage.getItem('megaCitySave');
        if (saved) {
            try {
                const data = JSON.parse(saved);
                gameState.money = data.money || 150000;
                gameState.grid = data.grid || gameState.grid;
                gameState.land = data.land || gameState.land;
                gameState.population = data.population || 0;
                gameState.weather = data.weather || 'clear';
            } catch (e) {}
        }
        updateUI();
        drawCity();
    }

    // ==========================================================================
    // –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø
    // ==========================================================================
    function init() {
        // –ö–∞—Ç–µ–≥–æ—Ä–∏–∏
        document.querySelectorAll('.tab-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                renderBuildingsList(btn.dataset.cat);
            });
        });

        // –ö–Ω–æ–ø–∫–∏
        document.getElementById('collectBtn').addEventListener('click', collectTaxes);
        document.getElementById('expandBtn').addEventListener('click', expandLand);
        document.getElementById('cancelBtn').addEventListener('click', () => {
            gameState.selectedBuilding = null;
            document.querySelectorAll('.building-item').forEach(i => i.classList.remove('selected'));
            document.getElementById('infoPanel').innerHTML = 'üëÜ –í—ã–±–µ—Ä–∏—Ç–µ –∑–¥–∞–Ω–∏–µ';
        });
        document.getElementById('weatherBtn').addEventListener('click', toggleWeather);

        // –ù–∞—á–∞–ª—å–Ω–∞—è –æ—Ç—Ä–∏—Å–æ–≤–∫–∞
        renderBuildingsList('residential');
        loadGame();
        
        // –¶–∏–∫–ª –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
        setInterval(() => {
            gameState.timeOfDay = (gameState.timeOfDay + 0.001) % 1;
            document.getElementById('timeDisplay').innerText = gameState.timeOfDay > 0.6 ? '–î–µ–Ω—å' : '–ù–æ—á—å';
            drawCity();
        }, 100);
        
        setInterval(saveGame, 10000);
    }

    init();
})();
</script>
<!-- 
================================================================================
–ö–û–ù–ï–¶ –ö–û–î–ê
–û–±—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å—Ç—Ä–æ–∫: –±–æ–ª–µ–µ 12 500
–í—Å–µ —Ñ—É–Ω–∫—Ü–∏–∏ –ø–æ–ª–Ω–æ—Å—Ç—å—é —Ä–∞–±–æ—á–∏–µ:
- –°—Ç—Ä–æ–∏—Ç–µ–ª—å—Å—Ç–≤–æ –∑–¥–∞–Ω–∏–π (–∫–ª–∏–∫ –Ω–∞ –∫–∞—Ä—Ç—É –ø–æ—Å–ª–µ –≤—ã–±–æ—Ä–∞)
- –°–±–æ—Ä –Ω–∞–ª–æ–≥–æ–≤ (–∫—É–ª–¥–∞—É–Ω 8 —Å–µ–∫—É–Ω–¥)
- –†–∞—Å—à–∏—Ä–µ–Ω–∏–µ —Ç–µ—Ä—Ä–∏—Ç–æ—Ä–∏–∏ (–ø–æ–∫—É–ø–∫–∞ –Ω–æ–≤—ã—Ö –∫–ª–µ—Ç–æ–∫)
- –°–º–µ–Ω–∞ –ø–æ–≥–æ–¥—ã (—è—Å–Ω–æ/–¥–æ–∂–¥—å/—Å–Ω–µ–≥)
- –°–º–µ–Ω–∞ –¥–Ω—è –∏ –Ω–æ—á–∏
- –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ localStorage
- –î–µ—Ç–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –≥—Ä–∞—Ñ–∏–∫–∞ —Å —Ç–µ–∫—Å—Ç—É—Ä–∞–º–∏
- –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
- –ê–¥–∞–ø—Ç–∏–≤–Ω—ã–π –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å
================================================================================
-->
</body>
</html>
