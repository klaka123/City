<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>üéÆ –ò–∑–æ–º–µ—Ç—Ä–∏—á–µ—Å–∫–∏–π –≥–æ—Ä–æ–¥ | 2.5D —Å—Ç—Ä–∞—Ç–µ–≥–∏—è</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            user-select: none;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            background: #0b2b44;
            font-family: 'Segoe UI', system-ui, sans-serif;
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 10px;
        }

        .game-wrapper {
            max-width: 1200px;
            width: 100%;
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 40px;
            padding: 20px;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        /* –í–µ—Ä—Ö–Ω—è—è –ø–∞–Ω–µ–ª—å */
        .top-panel {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: rgba(0, 0, 0, 0.4);
            border-radius: 30px;
            padding: 15px 25px;
            margin-bottom: 20px;
            color: white;
            flex-wrap: wrap;
            gap: 15px;
        }

        .balance {
            background: linear-gradient(135deg, #ffd700, #ffa500);
            padding: 10px 25px;
            border-radius: 40px;
            font-weight: bold;
            font-size: 24px;
            color: #1a1a1a;
            box-shadow: 0 5px 0 #b45f06;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .stats {
            display: flex;
            gap: 20px;
            background: rgba(255, 255, 255, 0.1);
            padding: 10px 20px;
            border-radius: 30px;
        }

        .stat {
            text-align: center;
        }

        .stat-label {
            font-size: 12px;
            opacity: 0.8;
        }

        .stat-value {
            font-size: 22px;
            font-weight: bold;
        }

        /* –ò–≥—Ä–æ–≤–æ–µ –ø–æ–ª–µ */
        .game-container {
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
        }

        .isometric-canvas-container {
            flex: 2;
            min-width: 600px;
            background: #1e4d6b;
            border-radius: 30px;
            padding: 20px;
            display: flex;
            justify-content: center;
            align-items: center;
            overflow-x: auto;
            box-shadow: inset 0 0 50px rgba(0, 0, 0, 0.5);
        }

        #cityCanvas {
            background: #2d5f7e;
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
            cursor: pointer;
            width: 100%;
            height: auto;
            max-width: 800px;
            image-rendering: crisp-edges;
        }

        /* –ü–∞–Ω–µ–ª—å —Å—Ç—Ä–æ–∏—Ç–µ–ª—å—Å—Ç–≤–∞ */
        .build-panel {
            flex: 1;
            min-width: 280px;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 30px;
            padding: 20px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        }

        .panel-title {
            font-size: 24px;
            font-weight: bold;
            margin-bottom: 20px;
            color: #1e4d6b;
            text-align: center;
            border-bottom: 2px solid #1e4d6b;
            padding-bottom: 10px;
        }

        .buildings-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin-bottom: 25px;
        }

        .building-card {
            background: linear-gradient(145deg, #ffffff, #e6e6e6);
            border-radius: 20px;
            padding: 15px 10px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
            border: 2px solid transparent;
            box-shadow: 0 5px 0 #b0b0b0;
            position: relative;
        }

        .building-card.selected {
            border-color: #ffd700;
            transform: translateY(-2px);
            box-shadow: 0 7px 0 #b8860b;
        }

        .building-card:active {
            transform: translateY(3px);
            box-shadow: 0 2px 0 #b0b0b0;
        }

        .building-emoji {
            font-size: 40px;
            margin-bottom: 5px;
        }

        .building-name {
            font-weight: bold;
            font-size: 14px;
        }

        .building-price {
            font-size: 12px;
            color: #2e7d32;
            font-weight: bold;
            margin-top: 5px;
        }

        .building-income {
            font-size: 11px;
            color: #b45f06;
        }

        .cooldown-badge {
            position: absolute;
            top: -5px;
            right: -5px;
            background: #f44336;
            color: white;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: bold;
            display: none;
        }

        .action-buttons {
            display: flex;
            flex-direction: column;
            gap: 12px;
            margin-top: 20px;
        }

        .action-btn {
            border: none;
            border-radius: 20px;
            padding: 18px;
            font-size: 18px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            box-shadow: 0 5px 0 #7b1fa2;
        }

        .action-btn:active {
            transform: translateY(3px);
            box-shadow: 0 2px 0 #7b1fa2;
        }

        .action-btn.primary {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
        }

        .action-btn.success {
            background: linear-gradient(135deg, #43a047, #1b5e20);
            color: white;
            box-shadow: 0 5px 0 #0d4d0d;
        }

        .action-btn.warning {
            background: linear-gradient(135deg, #fb8c00, #f57c00);
            color: white;
            box-shadow: 0 5px 0 #b45f06;
        }

        .action-btn.danger {
            background: linear-gradient(135deg, #e53935, #b71c1c);
            color: white;
            box-shadow: 0 5px 0 #8b0000;
        }

        .action-btn:disabled {
            opacity: 0.5;
            pointer-events: none;
            transform: none;
        }

        .info-panel {
            background: #1e4d6b;
            color: white;
            border-radius: 20px;
            padding: 15px;
            margin-top: 20px;
            font-size: 14px;
        }

        .info-title {
            font-weight: bold;
            margin-bottom: 10px;
            color: #ffd700;
        }

        /* –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è */
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: rgba(0, 0, 0, 0.9);
            color: white;
            padding: 15px 25px;
            border-radius: 50px;
            font-weight: bold;
            z-index: 1000;
            animation: slideIn 0.3s ease-out;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
        }

        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        /* –ê–¥–∞–ø—Ç–∞—Ü–∏—è */
        @media (max-width: 900px) {
            .isometric-canvas-container {
                min-width: 100%;
            }
        }
    </style>
</head>
<body>
    <div class="game-wrapper">
        <!-- –í–µ—Ä—Ö–Ω—è—è –ø–∞–Ω–µ–ª—å -->
        <div class="top-panel">
            <div class="balance">
                <span>üí∞</span>
                <span id="balanceDisplay">1000</span>
            </div>
            <div class="stats">
                <div class="stat">
                    <div class="stat-label">–ù–∞—Å–µ–ª–µ–Ω–∏–µ</div>
                    <div class="stat-value" id="populationDisplay">0</div>
                </div>
                <div class="stat">
                    <div class="stat-label">–î–æ—Ö–æ–¥/–º–∏–Ω</div>
                    <div class="stat-value" id="incomeDisplay">0</div>
                </div>
                <div class="stat">
                    <div class="stat-label">–£—Ä–æ–≤–µ–Ω—å</div>
                    <div class="stat-value" id="levelDisplay">1</div>
                </div>
            </div>
        </div>

        <!-- –û—Å–Ω–æ–≤–Ω–æ–π –∫–æ–Ω—Ç–µ–Ω—Ç -->
        <div class="game-container">
            <!-- –ò–∑–æ–º–µ—Ç—Ä–∏—á–µ—Å–∫–∞—è –∫–∞—Ä—Ç–∞ -->
            <div class="isometric-canvas-container">
                <canvas id="cityCanvas" width="800" height="600"></canvas>
            </div>

            <!-- –ü–∞–Ω–µ–ª—å —Å—Ç—Ä–æ–∏—Ç–µ–ª—å—Å—Ç–≤–∞ -->
            <div class="build-panel">
                <div class="panel-title">üèóÔ∏è –°—Ç—Ä–æ–∏—Ç–µ–ª—å—Å—Ç–≤–æ</div>
                
                <div class="buildings-grid" id="buildingsGrid">
                    <!-- –î–æ–º -->
                    <div class="building-card" data-type="house" onclick="selectBuilding('house')">
                        <div class="building-emoji">üè†</div>
                        <div class="building-name">–î–æ–º</div>
                        <div class="building-price">üí∞ 50</div>
                        <div class="building-income">üíµ +5/–º–∏–Ω</div>
                        <div class="cooldown-badge" id="cooldown-house">3</div>
                    </div>
                    
                    <!-- –ú–∞–≥–∞–∑–∏–Ω -->
                    <div class="building-card" data-type="shop" onclick="selectBuilding('shop')">
                        <div class="building-emoji">üè™</div>
                        <div class="building-name">–ú–∞–≥–∞–∑–∏–Ω</div>
                        <div class="building-price">üí∞ 120</div>
                        <div class="building-income">üíµ +15/–º–∏–Ω</div>
                        <div class="cooldown-badge" id="cooldown-shop">5</div>
                    </div>
                    
                    <!-- –§–∞–±—Ä–∏–∫–∞ -->
                    <div class="building-card" data-type="factory" onclick="selectBuilding('factory')">
                        <div class="building-emoji">üè≠</div>
                        <div class="building-name">–§–∞–±—Ä–∏–∫–∞</div>
                        <div class="building-price">üí∞ 300</div>
                        <div class="building-income">üíµ +40/–º–∏–Ω</div>
                        <div class="cooldown-badge" id="cooldown-factory">8</div>
                    </div>
                    
                    <!-- –ü–∞—Ä–∫ -->
                    <div class="building-card" data-type="park" onclick="selectBuilding('park')">
                        <div class="building-emoji">üå≥</div>
                        <div class="building-name">–ü–∞—Ä–∫</div>
                        <div class="building-price">üí∞ 80</div>
                        <div class="building-income">üíµ +8/–º–∏–Ω</div>
                        <div class="cooldown-badge" id="cooldown-park">4</div>
                    </div>
                    
                    <!-- –≠–ª–µ–∫—Ç—Ä–æ—Å—Ç–∞–Ω—Ü–∏—è -->
                    <div class="building-card" data-type="power" onclick="selectBuilding('power')">
                        <div class="building-emoji">‚ö°</div>
                        <div class="building-name">–≠–ª–µ–∫—Ç—Ä–æ</div>
                        <div class="building-price">üí∞ 500</div>
                        <div class="building-income">üíµ +70/–º–∏–Ω</div>
                        <div class="cooldown-badge" id="cooldown-power">12</div>
                    </div>
                    
                    <!-- –î–æ—Ä–æ–≥–∞ -->
                    <div class="building-card" data-type="road" onclick="selectBuilding('road')">
                        <div class="building-emoji">üõ£Ô∏è</div>
                        <div class="building-name">–î–æ—Ä–æ–≥–∞</div>
                        <div class="building-price">üí∞ 20</div>
                        <div class="building-income">üíµ +2/–º–∏–Ω</div>
                        <div class="cooldown-badge" id="cooldown-road">2</div>
                    </div>
                </div>

                <!-- –ö–Ω–æ–ø–∫–∏ –¥–µ–π—Å—Ç–≤–∏–π -->
                <div class="action-buttons">
                    <button class="action-btn success" onclick="collectTaxes()" id="taxBtn">
                        <span>üí∞</span> –°–æ–±—Ä–∞—Ç—å –Ω–∞–ª–æ–≥–∏
                    </button>
                    <button class="action-btn primary" onclick="cancelSelection()">
                        <span>‚ùå</span> –û—Ç–º–µ–Ω–∏—Ç—å –≤—ã–±–æ—Ä
                    </button>
                    <button class="action-btn danger" onclick="resetGame()">
                        <span>üîÑ</span> –ù–æ–≤–∞—è –∏–≥—Ä–∞
                    </button>
                </div>

                <!-- –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏–æ–Ω–Ω–∞—è –ø–∞–Ω–µ–ª—å -->
                <div class="info-panel">
                    <div class="info-title">üìå –ö–∞–∫ –∏–≥—Ä–∞—Ç—å:</div>
                    <div>1. –í—ã–±–µ—Ä–∏ –∑–¥–∞–Ω–∏–µ –≤ –ø–∞–Ω–µ–ª–∏</div>
                    <div>2. –ù–∞–∂–º–∏ –Ω–∞ –∫–ª–µ—Ç–∫—É –∫–∞—Ä—Ç—ã</div>
                    <div>3. –°–æ–±–∏—Ä–∞–π –Ω–∞–ª–æ–≥–∏ —Ä–∞–∑ –≤ –º–∏–Ω—É—Ç—É</div>
                    <div>4. –î–æ—Ä–æ–≥–∏ —É–≤–µ–ª–∏—á–∏–≤–∞—é—Ç –¥–æ—Ö–æ–¥ —Å–æ—Å–µ–¥–µ–π</div>
                    <div id="selectedInfo" style="margin-top: 10px; color: #ffd700;"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Telegram WebApp -->
    <script src="https://telegram.org/js/telegram-web-app.js"></script>

    <script>
        // ========== –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø ==========
        let tg = null;
        try {
            if (window.Telegram && Telegram.WebApp) {
                tg = Telegram.WebApp;
                tg.expand();
                tg.ready();
                console.log('Telegram WebApp –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω');
            }
        } catch (e) {
            console.log('–†–µ–∂–∏–º —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏ (–±–µ–∑ Telegram)');
        }

        // ========== –ö–û–ù–°–¢–ê–ù–¢–´ ==========
        const GRID_SIZE = 8; // 8x8 —Å–µ—Ç–∫–∞
        const CELL_SIZE = 60; // –†–∞–∑–º–µ—Ä –∫–ª–µ—Ç–∫–∏ –≤ –ø–∏–∫—Å–µ–ª—è—Ö

        // –¢–∏–ø—ã –∑–¥–∞–Ω–∏–π
        const BUILDINGS = {
            empty: { name: '–ü—É—Å—Ç–æ', emoji: '‚¨ú', color: '#3a6d8c', price: 0, income: 0 },
            house: { name: '–î–æ–º', emoji: 'üè†', color: '#ffb74d', price: 50, income: 5, cooldown: 3 },
            shop: { name: '–ú–∞–≥–∞–∑–∏–Ω', emoji: 'üè™', color: '#ff8a65', price: 120, income: 15, cooldown: 5 },
            factory: { name: '–§–∞–±—Ä–∏–∫–∞', emoji: 'üè≠', color: '#b0bec5', price: 300, income: 40, cooldown: 8 },
            park: { name: '–ü–∞—Ä–∫', emoji: 'üå≥', color: '#81c784', price: 80, income: 8, cooldown: 4 },
            power: { name: '–≠–ª–µ–∫—Ç—Ä–æ', emoji: '‚ö°', color: '#ffb74d', price: 500, income: 70, cooldown: 12 },
            road: { name: '–î–æ—Ä–æ–≥–∞', emoji: 'üõ£Ô∏è', color: '#90a4ae', price: 20, income: 2, cooldown: 2 }
        };

        // ========== –°–û–°–¢–û–Ø–ù–ò–ï –ò–ì–†–´ ==========
        let gameState = {
            balance: 1000,
            grid: [],
            selectedBuilding: null,
            lastTaxTime: Date.now(),
            taxCooldown: 60000, // 60 —Å–µ–∫—É–Ω–¥
            taxBtnDisabled: false,
            buildingsCount: {},
            cooldowns: {},
            level: 1,
            population: 0
        };

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å–µ—Ç–∫–∏
        for (let i = 0; i < GRID_SIZE; i++) {
            gameState.grid[i] = [];
            for (let j = 0; j < GRID_SIZE; j++) {
                gameState.grid[i][j] = 'empty';
            }
        }

        // ========== CANVAS –û–¢–†–ò–°–û–í–ö–ê ==========
        const canvas = document.getElementById('cityCanvas');
        const ctx = canvas.getContext('2d');

        function drawCity() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            // –†–∏—Å—É–µ–º —Å–µ—Ç–∫—É
            for (let row = 0; row < GRID_SIZE; row++) {
                for (let col = 0; col < GRID_SIZE; col++) {
                    const x = col * CELL_SIZE;
                    const y = row * CELL_SIZE;
                    
                    const buildingType = gameState.grid[row][col];
                    const building = BUILDINGS[buildingType] || BUILDINGS.empty;
                    
                    // –§—É–Ω–¥–∞–º–µ–Ω—Ç
                    ctx.fillStyle = building.color;
                    ctx.fillRect(x, y, CELL_SIZE - 2, CELL_SIZE - 2);
                    
                    // –û–±–≤–æ–¥–∫–∞
                    ctx.strokeStyle = '#ffffff';
                    ctx.lineWidth = 2;
                    ctx.strokeRect(x, y, CELL_SIZE - 2, CELL_SIZE - 2);
                    
                    // –≠–º–æ–¥–∂–∏ (—Ç–µ–∫—Å—Ç)
                    ctx.font = '30px Arial';
                    ctx.fillStyle = '#000000';
                    ctx.fillText(building.emoji, x + 15, y + 45);
                    
                    // –ü–æ–¥—Å–≤–µ—Ç–∫–∞ –≤—ã–±—Ä–∞–Ω–Ω–æ–π –∫–ª–µ—Ç–∫–∏
                    if (gameState.selectedBuilding && row === selectedRow && col === selectedCol) {
                        ctx.strokeStyle = '#ffd700';
                        ctx.lineWidth = 4;
                        ctx.strokeRect(x, y, CELL_SIZE - 2, CELL_SIZE - 2);
                    }
                }
            }
            
            // –†–∏—Å—É–µ–º –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã (–¥–ª—è –æ—Ç–ª–∞–¥–∫–∏)
            ctx.font = '12px Arial';
            ctx.fillStyle = '#ffffff';
            ctx.fillText('‚¨ÜÔ∏è –°–µ–≤–µ—Ä', 10, 20);
        }

        // ========== –í–´–ë–û–† –ö–õ–ï–¢–ö–ò ==========
        let selectedRow = -1, selectedCol = -1;

        canvas.addEventListener('click', (e) => {
            const rect = canvas.getBoundingClientRect();
            const scaleX = canvas.width / rect.width;
            const scaleY = canvas.height / rect.height;
            
            const mouseX = (e.clientX - rect.left) * scaleX;
            const mouseY = (e.clientY - rect.top) * scaleY;
            
            selectedCol = Math.floor(mouseX / CELL_SIZE);
            selectedRow = Math.floor(mouseY / CELL_SIZE);
            
            if (selectedRow >= 0 && selectedRow < GRID_SIZE && 
                selectedCol >= 0 && selectedCol < GRID_SIZE) {
                
                if (gameState.selectedBuilding) {
                    // –†–µ–∂–∏–º —Å—Ç—Ä–æ–∏—Ç–µ–ª—å—Å—Ç–≤–∞
                    buildAt(selectedRow, selectedCol);
                } else {
                    // –†–µ–∂–∏–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏
                    showCellInfo(selectedRow, selectedCol);
                }
                drawCity();
            }
        });

        // ========== –°–¢–†–û–ò–¢–ï–õ–¨–°–¢–í–û ==========
        function buildAt(row, col) {
            if (!gameState.selectedBuilding) return;
            
            const building = BUILDINGS[gameState.selectedBuilding];
            const currentCell = gameState.grid[row][col];
            
            // –ü—Ä–æ–≤–µ—Ä–∫–∞: –∫–ª–µ—Ç–∫–∞ –ø—É—Å—Ç–∞?
            if (currentCell !== 'empty') {
                showNotification('‚ùå –≠—Ç–∞ –∫–ª–µ—Ç–∫–∞ —É–∂–µ –∑–∞–Ω—è—Ç–∞!', 'error');
                return;
            }
            
            // –ü—Ä–æ–≤–µ—Ä–∫–∞: —Ö–≤–∞—Ç–∞–µ—Ç –¥–µ–Ω–µ–≥?
            if (gameState.balance < building.price) {
                showNotification('‚ùå –ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Å—Ä–µ–¥—Å—Ç–≤!', 'error');
                return;
            }
            
            // –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫—É–ª–¥–∞—É–Ω–∞ (–∞–Ω—Ç–∏-—Å–ø–∞–º)
            const now = Date.now();
            const lastBuild = gameState.cooldowns[gameState.selectedBuilding] || 0;
            const buildingCooldown = building.cooldown * 1000; // –≤ –º–∏–ª–ª–∏—Å–µ–∫—É–Ω–¥–∞—Ö
            
            if (now - lastBuild < buildingCooldown) {
                const secondsLeft = Math.ceil((buildingCooldown - (now - lastBuild)) / 1000);
                showNotification(`‚è≥ –ü–æ–¥–æ–∂–¥–∏ ${secondsLeft} —Å–µ–∫.`, 'warning');
                return;
            }
            
            // –°—Ç—Ä–æ–∏–º!
            gameState.grid[row][col] = gameState.selectedBuilding;
            gameState.balance -= building.price;
            
            // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
            gameState.buildingsCount[gameState.selectedBuilding] = 
                (gameState.buildingsCount[gameState.selectedBuilding] || 0) + 1;
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –Ω–∞—Å–µ–ª–µ–Ω–∏–µ (–¥–æ–º–∞ –¥–∞—é—Ç +10 –Ω–∞—Å–µ–ª–µ–Ω–∏—è)
            if (gameState.selectedBuilding === 'house') {
                gameState.population += 10;
            } else if (gameState.selectedBuilding === 'shop') {
                gameState.population += 5;
            } else if (gameState.selectedBuilding === 'factory') {
                gameState.population += 15;
            }
            
            // –°—Ç–∞–≤–∏–º –∫—É–ª–¥–∞—É–Ω
            gameState.cooldowns[gameState.selectedBuilding] = now;
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫—É–ª–¥–∞—É–Ω –Ω–∞ –∫–Ω–æ–ø–∫–µ
            updateCooldownUI(gameState.selectedBuilding, building.cooldown);
            
            // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ Telegram
            saveToTelegram();
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å
            updateUI();
            drawCity();
            
            showNotification(`‚úÖ ${building.name} –ø–æ—Å—Ç—Ä–æ–µ–Ω!`, 'success');
        }

        // ========== –°–ë–û–† –ù–ê–õ–û–ì–û–í (–° –ê–ù–¢–ò-–°–ü–ê–ú–û–ú) ==========
        function collectTaxes() {
            const taxBtn = document.getElementById('taxBtn');
            
            // –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫—É–ª–¥–∞—É–Ω–∞
            const now = Date.now();
            const timeSinceLastTax = now - gameState.lastTaxTime;
            
            if (timeSinceLastTax < gameState.taxCooldown) {
                const secondsLeft = Math.ceil((gameState.taxCooldown - timeSinceLastTax) / 1000);
                showNotification(`‚è≥ –ù–∞–ª–æ–≥–∏ –º–æ–∂–Ω–æ —Å–æ–±—Ä–∞—Ç—å —á–µ—Ä–µ–∑ ${secondsLeft} —Å–µ–∫.`, 'warning');
                
                // –ë–ª–æ–∫–∏—Ä—É–µ–º –∫–Ω–æ–ø–∫—É –≤–∏–∑—É–∞–ª—å–Ω–æ
                taxBtn.disabled = true;
                setTimeout(() => {
                    taxBtn.disabled = false;
                }, gameState.taxCooldown - timeSinceLastTax);
                return;
            }
            
            // –°—á–∏—Ç–∞–µ–º –Ω–∞–ª–æ–≥–∏
            let totalTax = 0;
            let incomeDetails = {};
            
            for (let row = 0; row < GRID_SIZE; row++) {
                for (let col = 0; col < GRID_SIZE; col++) {
                    const buildingType = gameState.grid[row][col];
                    if (buildingType !== 'empty') {
                        const income = BUILDINGS[buildingType].income;
                        totalTax += income;
                        incomeDetails[buildingType] = (incomeDetails[buildingType] || 0) + income;
                    }
                }
            }
            
            // –ë–æ–Ω—É—Å—ã –æ—Ç –¥–æ—Ä–æ–≥
            for (let row = 0; row < GRID_SIZE; row++) {
                for (let col = 0; col < GRID_SIZE; col++) {
                    if (gameState.grid[row][col] === 'road') {
                        // –î–æ—Ä–æ–≥–∞ –¥–∞–µ—Ç –±–æ–Ω—É—Å —Å–æ—Å–µ–¥—è–º
                        const neighbors = getNeighbors(row, col);
                        neighbors.forEach(n => {
                            if (gameState.grid[n.row][n.col] !== 'empty' && 
                                gameState.grid[n.row][n.col] !== 'road') {
                                totalTax += 2; // –ë–æ–Ω—É—Å –∑–∞ –¥–æ—Ä–æ–≥—É
                            }
                        });
                    }
                }
            }
            
            // –ü—Ä–∏–º–µ–Ω—è–µ–º –Ω–∞–ª–æ–≥–∏
            gameState.balance += totalTax;
            gameState.lastTaxTime = now;
            
            // –ë–ª–æ–∫–∏—Ä—É–µ–º –∫–Ω–æ–ø–∫—É –Ω–∞ 60 —Å–µ–∫—É–Ω–¥
            taxBtn.disabled = true;
            gameState.taxBtnDisabled = true;
            
            setTimeout(() => {
                taxBtn.disabled = false;
                gameState.taxBtnDisabled = false;
                updateUI();
            }, gameState.taxCooldown);
            
            // –°–æ—Ö—Ä–∞–Ω—è–µ–º
            saveToTelegram();
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –¥–µ—Ç–∞–ª—å–Ω—ã–π –æ—Ç—á–µ—Ç
            let detailsText = Object.entries(incomeDetails)
                .map(([type, amount]) => `${BUILDINGS[type].emoji} +${amount}`)
                .join(' ');
            
            showNotification(`üí∞ –°–æ–±—Ä–∞–Ω–æ –Ω–∞–ª–æ–≥–æ–≤: ${totalTax} –º–æ–Ω–µ—Ç! ${detailsText}`, 'success');
            updateUI();
            
            // –¢–∞–∫—Ç–∏–ª—å–Ω–∞—è –æ—Ç–¥–∞—á–∞ –≤ Telegram
            if (tg) {
                tg.HapticFeedback.notificationOccurred('success');
            }
        }

        // ========== –í–°–ü–û–ú–û–ì–ê–¢–ï–õ–¨–ù–´–ï –§–£–ù–ö–¶–ò–ò ==========
        function getNeighbors(row, col) {
            const neighbors = [];
            if (row > 0) neighbors.push({ row: row-1, col });
            if (row < GRID_SIZE-1) neighbors.push({ row: row+1, col });
            if (col > 0) neighbors.push({ row, col: col-1 });
            if (col < GRID_SIZE-1) neighbors.push({ row, col: col+1 });
            return neighbors;
        }

        function showCellInfo(row, col) {
            const buildingType = gameState.grid[row][col];
            const building = BUILDINGS[buildingType];
            
            if (buildingType === 'empty') {
                showNotification(`üìç –ü—É—Å—Ç–æ–π —É—á–∞—Å—Ç–æ–∫`, 'info');
            } else {
                showNotification(
                    `${building.emoji} ${building.name}\n` +
                    `üí∞ –î–æ—Ö–æ–¥: ${building.income}/–º–∏–Ω\n` +
                    `üè∑Ô∏è –¶–µ–Ω–∞: ${building.price}`,
                    'info'
                );
            }
        }

        function selectBuilding(type) {
            gameState.selectedBuilding = type;
            
            // –ü–æ–¥—Å–≤–µ—Ç–∫–∞ –≤—ã–±—Ä–∞–Ω–Ω–æ–π –∫–∞—Ä—Ç–æ—á–∫–∏
            document.querySelectorAll('.building-card').forEach(card => {
                card.classList.remove('selected');
            });
            document.querySelector(`[data-type="${type}"]`).classList.add('selected');
            
            document.getElementById('selectedInfo').innerHTML = 
                `–í—ã–±—Ä–∞–Ω–æ: ${BUILDINGS[type].emoji} ${BUILDINGS[type].name}`;
        }

        function cancelSelection() {
            gameState.selectedBuilding = null;
            document.querySelectorAll('.building-card').forEach(card => {
                card.classList.remove('selected');
            });
            document.getElementById('selectedInfo').innerHTML = '';
        }

        function updateCooldownUI(type, seconds) {
            const badge = document.getElementById(`cooldown-${type}`);
            if (badge) {
                badge.style.display = 'flex';
                badge.textContent = seconds;
                
                let timeLeft = seconds;
                const interval = setInterval(() => {
                    timeLeft--;
                    if (timeLeft <= 0) {
                        badge.style.display = 'none';
                        clearInterval(interval);
                    } else {
                        badge.textContent = timeLeft;
                    }
                }, 1000);
            }
        }

        // ========== –£–í–ï–î–û–ú–õ–ï–ù–ò–Ø ==========
        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.className = 'notification';
            
            let bgColor = '#333';
            if (type === 'success') bgColor = '#43a047';
            if (type === 'error') bgColor = '#e53935';
            if (type === 'warning') bgColor = '#fb8c00';
            
            notification.style.backgroundColor = bgColor;
            notification.textContent = message;
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.remove();
            }, 3000);
        }

        // ========== –û–ë–ù–û–í–õ–ï–ù–ò–ï –ò–ù–¢–ï–†–§–ï–ô–°–ê ==========
        function updateUI() {
            document.getElementById('balanceDisplay').textContent = gameState.balance;
            
            // –°—á–∏—Ç–∞–µ–º –æ–±—â–∏–π –¥–æ—Ö–æ–¥
            let totalIncome = 0;
            for (let row = 0; row < GRID_SIZE; row++) {
                for (let col = 0; col < GRID_SIZE; col++) {
                    const type = gameState.grid[row][col];
                    if (type !== 'empty') {
                        totalIncome += BUILDINGS[type].income;
                    }
                }
            }
            
            document.getElementById('incomeDisplay').textContent = totalIncome;
            document.getElementById('populationDisplay').textContent = gameState.population;
            
            // –£—Ä–æ–≤–µ–Ω—å –≥–æ—Ä–æ–¥–∞
            gameState.level = Math.floor(gameState.population / 20) + 1;
            document.getElementById('levelDisplay').textContent = gameState.level;
            
            // –ö–Ω–æ–ø–∫–∞ –Ω–∞–ª–æ–≥–æ–≤
            const taxBtn = document.getElementById('taxBtn');
            if (gameState.taxBtnDisabled) {
                taxBtn.disabled = true;
            }
        }

        // ========== –°–û–•–†–ê–ù–ï–ù–ò–ï –í TELEGRAM ==========
        function saveToTelegram() {
            if (tg) {
                try {
                    tg.sendData(JSON.stringify({
                        balance: gameState.balance,
                        grid: gameState.grid,
                        population: gameState.population,
                        timestamp: Date.now()
                    }));
                } catch (e) {
                    console.log('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –≤ Telegram');
                }
            }
            
            // –¢–∞–∫–∂–µ —Å–æ—Ö—Ä–∞–Ω—è–µ–º –ª–æ–∫–∞–ª—å–Ω–æ
            localStorage.setItem('cityGame', JSON.stringify(gameState));
        }

        // ========== –ó–ê–ì–†–£–ó–ö–ê –ò–ì–†–´ ==========
        function loadGame() {
            const saved = localStorage.getItem('cityGame');
            if (saved) {
                try {
                    const data = JSON.parse(saved);
                    gameState = { ...gameState, ...data };
                } catch (e) {
                    console.log('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏');
                }
            }
            
            updateUI();
            drawCity();
        }

        // ========== –ù–û–í–ê–Ø –ò–ì–†–ê ==========
        function resetGame() {
            if (confirm('–ù–∞—á–∞—Ç—å –Ω–æ–≤—É—é –∏–≥—Ä—É? –í–µ—Å—å –ø—Ä–æ–≥—Ä–µ—Å—Å –±—É–¥–µ—Ç –ø–æ—Ç–µ—Ä—è–Ω!')) {
                gameState = {
                    balance: 1000,
                    grid: [],
                    selectedBuilding: null,
                    lastTaxTime: Date.now(),
                    taxCooldown: 60000,
                    taxBtnDisabled: false,
                    buildingsCount: {},
                    cooldowns: {},
                    level: 1,
                    population: 0
                };
                
                for (let i = 0; i < GRID_SIZE; i++) {
                    gameState.grid[i] = [];
                    for (let j = 0; j < GRID_SIZE; j++) {
                        gameState.grid[i][j] = 'empty';
                    }
                }
                
                document.getElementById('taxBtn').disabled = false;
                cancelSelection();
                updateUI();
                drawCity();
                saveToTelegram();
                showNotification('üîÑ –ù–æ–≤–∞—è –∏–≥—Ä–∞ –Ω–∞—á–∞—Ç–∞!', 'success');
            }
        }

        // ========== –ê–í–¢–û–ú–ê–¢–ò–ß–ï–°–ö–ò–ô –°–ë–û–† –ù–ê–õ–û–ì–û–í (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ) ==========
        // –ú–æ–∂–Ω–æ –≤–∫–ª—é—á–∏—Ç—å, –µ—Å–ª–∏ —Ö–æ—á–µ—à—å, —á—Ç–æ–±—ã –Ω–∞–ª–æ–≥–∏ –∫–∞–ø–∞–ª–∏ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏
        // setInterval(() => {
        //     if (!gameState.taxBtnDisabled) {
        //         collectTaxes();
        //     }
        // }, 60000);

        // ========== –ó–ê–ü–£–°–ö ==========
        document.addEventListener('DOMContentLoaded', () => {
            loadGame();
            
            // –û–±—Ä–∞–±–æ—Ç–∫–∞ –¥–∞–Ω–Ω—ã—Ö –æ—Ç –±–æ—Ç–∞
            if (tg && tg.initDataUnsafe && tg.initDataUnsafe.user) {
                console.log('–ò–≥—Ä–æ–∫:', tg.initDataUnsafe.user.username);
            }
        });
    </script>
</body>
</html>
