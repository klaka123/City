<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>MEGA CITY 5120 - –î–ï–¢–ê–õ–¨–ù–´–ï 3D –ú–û–î–ï–õ–ò</title>
<style>
*{
    margin:0;
    padding:0;
    box-sizing:border-box;
    font-family:Segoe UI, Roboto, sans-serif;
    user-select:none;
}
body{
    background:#081823;
    overflow:hidden;
}
.game{
    width:100vw;
    height:100vh;
    position:relative;
}
canvas{
    width:100%;
    height:100%;
    display:block;
    touch-action:none;
    cursor:grab;
}
canvas:active{cursor:grabbing}

.ui{
    position:fixed;
    bottom:15px;
    left:50%;
    transform:translateX(-50%);
    display:flex;
    gap:15px;
    background:rgba(15,35,50,.95);
    padding:12px 25px;
    border-radius:40px;
    color:#fff;
    font-size:18px;
    z-index:10;
}
.ui div{
    background:rgba(0,0,0,.3);
    padding:6px 14px;
    border-radius:30px;
}

.menu-left{
    position:fixed;
    top:50%;
    left:15px;
    transform:translateY(-50%);
    width:320px;
    height:80vh;
    background:rgba(10,28,40,.95);
    border-radius:25px;
    padding:15px;
    display:flex;
    flex-direction:column;
    gap:10px;
    z-index:10;
}
.menu-left h2{
    color:#fff;
    text-align:center;
}
.categories{
    display:flex;
    flex-wrap:wrap;
    gap:5px;
}
.categories button{
    flex:1;
    padding:6px;
    border-radius:20px;
    border:none;
    cursor:pointer;
}
.list{
    flex:1;
    overflow:auto;
}
.item{
    background:rgba(255,255,255,.08);
    margin-bottom:6px;
    padding:8px;
    border-radius:18px;
    color:#fff;
    cursor:pointer;
}
.item.selected{
    outline:2px solid #ffb84d;
}

.menu-right{
    position:fixed;
    top:50%;
    right:15px;
    transform:translateY(-50%);
    background:rgba(10,28,40,.95);
    border-radius:25px;
    padding:15px;
    display:flex;
    flex-direction:column;
    gap:10px;
    z-index:10;
}
.menu-right button{
    padding:12px;
    font-size:16px;
    border-radius:25px;
    border:none;
    cursor:pointer;
}

.info{
    position:fixed;
    top:15px;
    left:50%;
    transform:translateX(-50%);
    background:rgba(10,28,40,.95);
    padding:12px 25px;
    border-radius:30px;
    color:#fff;
    z-index:10;
}
</style>
</head>

<body>
<div class="game">
<canvas id="c"></canvas>

<div class="info" id="info">–í—ã–±–µ—Ä–∏—Ç–µ –∑–¥–∞–Ω–∏–µ</div>

<div class="ui">
    <div>üí∞ <span id="money">50,000,000</span></div>
    <div>üë• <span id="pop">0</span></div>
    <div>üìà <span id="inc">0</span></div>
    <div>üèóÔ∏è <span id="cnt">0/3600</span></div>
</div>

<div class="menu-left">
<h2>üèóÔ∏è 3D –ó–î–ê–ù–ò–Ø</h2>
<div class="categories" id="cats"></div>
<div class="list" id="list"></div>
</div>

<div class="menu-right">
<button onclick="collect()">üí∞ –°–ë–û–†</button>
<button onclick="weather()">üå¶Ô∏è –ü–û–ì–û–î–ê</button>
<button onclick="timeDay()">‚è∞ –í–†–ï–ú–Ø</button>
<button onclick="cancel()">‚ùå –û–¢–ú–ï–ù–ê</button>
<button onclick="resetGame()">üîÑ –ù–û–í–´–ô –ì–û–†–û–î</button>
</div>
</div>

<script>
const tg = window.Telegram?.WebApp;
tg?.expand(); tg?.ready();

const GRID=60, CELL=70;
const canvas=document.getElementById('c');
const ctx=canvas.getContext('2d');

let cam={x:0,y:0,z:1};
let drag=false, lx=0, ly=0;
let selRow=-1, selCol=-1;

let game={
money:50000000,
pop:0,
cnt:0,
weather:0,
time:0.6,
grid:[]
};

for(let r=0;r<GRID;r++){
game.grid[r]=[];
for(let c=0;c<GRID;c++)game.grid[r][c]=null;
}

// ==================== –î–ï–¢–ê–õ–¨–ù–´–ï 3D –ú–û–î–ï–õ–ò –ó–î–ê–ù–ò–ô ====================
const buildingStyles = [
    // –ñ–∏–ª—ã–µ –¥–æ–º–∞
    { 
        type: 'house1', 
        name: 'üè† –£—é—Ç–Ω—ã–π –¥–æ–º–∏–∫',
        baseColor: '#e3b27c', 
        roofColor: '#b54c4c', 
        doorColor: '#8b5a2b', 
        windowColor: '#f9e076',
        height: 50,
        hasChimney: true,
        hasShutters: true,
        hasFlowers: true,
        windows: 2
    },
    { 
        type: 'house2', 
        name: 'üè° –ö–æ—Ç—Ç–µ–¥–∂',
        baseColor: '#cf9f6b', 
        roofColor: '#8b5a2b', 
        doorColor: '#a57248', 
        windowColor: '#f9e076',
        height: 65,
        hasChimney: true,
        hasShutters: true,
        hasBalcony: true,
        windows: 3
    },
    { 
        type: 'house3', 
        name: 'üèòÔ∏è –û—Å–æ–±–Ω—è–∫',
        baseColor: '#d9b382', 
        roofColor: '#b34b4b', 
        doorColor: '#8b5a2b', 
        windowColor: '#fff2cc',
        height: 80,
        hasChimney: true,
        hasColumns: true,
        hasGarage: true,
        windows: 4
    },
    { 
        type: 'house4', 
        name: 'üè∞ –ó–∞–º–æ–∫',
        baseColor: '#b0a57c', 
        roofColor: '#6b5a3a', 
        doorColor: '#5a3e24', 
        windowColor: '#ffe68f',
        height: 100,
        hasTower: true,
        hasFlag: true,
        windows: 5
    },

    // –ú–Ω–æ–≥–æ–∫–≤–∞—Ä—Ç–∏—Ä–Ω—ã–µ
    { 
        type: 'apt1', 
        name: 'üè¢ –ú–Ω–æ–≥–æ—ç—Ç–∞–∂–∫–∞',
        baseColor: '#b0bec5', 
        accentColor: '#8a9aa8', 
        windowColor: '#cfd8dc',
        height: 120,
        floors: 5,
        hasBalconies: true,
        windows: 4
    },
    { 
        type: 'apt2', 
        name: 'üè¨ –ñ–∏–ª–æ–π –∫–æ–º–ø–ª–µ–∫—Å',
        baseColor: '#9e9e9e', 
        accentColor: '#757575', 
        windowColor: '#cfd8dc',
        height: 140,
        floors: 7,
        hasBalconies: true,
        windows: 5
    },

    // –ú–∞–≥–∞–∑–∏–Ω—ã
    { 
        type: 'shop1', 
        name: 'üè™ –ú–∞–≥–∞–∑–∏–Ω',
        baseColor: '#ffb74d', 
        roofColor: '#ff9800', 
        doorColor: '#8b5a2b',
        windowColor: '#fff2cc',
        height: 45,
        hasSign: true,
        hasAwning: true,
        windows: 2
    },
    { 
        type: 'shop2', 
        name: 'üè¨ –°—É–ø–µ—Ä–º–∞—Ä–∫–µ—Ç',
        baseColor: '#ff8a65', 
        roofColor: '#f57c00', 
        doorColor: '#8b5a2b',
        windowColor: '#fff2cc',
        height: 55,
        hasSign: true,
        hasAwning: false,
        windows: 3
    },
    { 
        type: 'shop3', 
        name: 'üõçÔ∏è –¢–æ—Ä–≥–æ–≤—ã–π —Ü–µ–Ω—Ç—Ä',
        baseColor: '#7986cb', 
        roofColor: '#3f51b5', 
        doorColor: '#303f9f',
        windowColor: '#fff2cc',
        height: 90,
        floors: 3,
        windows: 6
    },

    // –û—Ñ–∏—Å—ã
    { 
        type: 'office1', 
        name: 'üè¢ –û—Ñ–∏—Å',
        baseColor: '#9e9e9e', 
        accentColor: '#757575', 
        windowColor: '#cfd8dc',
        height: 85,
        floors: 4,
        hasLogo: true,
        windows: 4
    },
    { 
        type: 'office2', 
        name: 'üèõÔ∏è –ë–∏–∑–Ω–µ—Å-—Ü–µ–Ω—Ç—Ä',
        baseColor: '#607d8b', 
        accentColor: '#455a64', 
        windowColor: '#b0bec5',
        height: 110,
        floors: 6,
        hasLogo: true,
        windows: 5
    },

    // –†–µ—Å—Ç–æ—Ä–∞–Ω—ã –∏ –∫–∞—Ñ–µ
    { 
        type: 'cafe1', 
        name: '‚òï –ö–∞—Ñ–µ',
        baseColor: '#ffcc80', 
        roofColor: '#ffb74d', 
        doorColor: '#8b5a2b',
        windowColor: '#fff2cc',
        height: 40,
        hasTerrace: true,
        hasSign: true,
        windows: 2
    },
    { 
        type: 'restaurant1', 
        name: 'üçΩÔ∏è –†–µ—Å—Ç–æ—Ä–∞–Ω',
        baseColor: '#ef9a9a', 
        roofColor: '#e57373', 
        doorColor: '#c62828',
        windowColor: '#fff2cc',
        height: 50,
        hasTerrace: true,
        hasSign: true,
        windows: 3
    },

    // –ü—Ä–æ–º—ã—à–ª–µ–Ω–Ω–æ—Å—Ç—å
    { 
        type: 'factory1', 
        name: 'üè≠ –ó–∞–≤–æ–¥',
        baseColor: '#b0bec5', 
        accentColor: '#8a9aa8', 
        doorColor: '#5d4037',
        height: 70,
        chimney: true,
        smoke: true,
        windows: 3
    },
    { 
        type: 'factory2', 
        name: '‚ö° –≠–ª–µ–∫—Ç—Ä–æ—Å—Ç–∞–Ω—Ü–∏—è',
        baseColor: '#b0a57c', 
        accentColor: '#8b7a5a', 
        doorColor: '#5a3e24',
        height: 100,
        chimneys: 2,
        smoke: true,
        windows: 2
    },
    { 
        type: 'factory3', 
        name: 'üì¶ –°–∫–ª–∞–¥',
        baseColor: '#8d6e63', 
        accentColor: '#6d4c41', 
        doorColor: '#4e342e',
        height: 55,
        doors: 2,
        windows: 1
    },

    // –°–æ—Ü–∏–∞–ª—å–Ω—ã–µ
    { 
        type: 'hospital1', 
        name: 'üè• –ë–æ–ª—å–Ω–∏—Ü–∞',
        baseColor: '#ef9a9a', 
        accentColor: '#e57373', 
        doorColor: '#c62828',
        height: 75,
        hasCross: true,
        windows: 4
    },
    { 
        type: 'school1', 
        name: 'üìö –®–∫–æ–ª–∞',
        baseColor: '#ff8a80', 
        accentColor: '#f06292', 
        doorColor: '#ad1457',
        height: 65,
        hasBell: true,
        windows: 5
    },
    { 
        type: 'university1', 
        name: 'üéì –£–Ω–∏–≤–µ—Ä—Å–∏—Ç–µ—Ç',
        baseColor: '#c5e1a5', 
        accentColor: '#9ccc65', 
        doorColor: '#33691e',
        height: 90,
        hasColumns: true,
        windows: 6
    },

    // –ö—É–ª—å—Ç—É—Ä–∞
    { 
        type: 'church1', 
        name: '‚õ™ –¶–µ—Ä–∫–æ–≤—å',
        baseColor: '#f5f5f5', 
        roofColor: '#b71c1c', 
        doorColor: '#8b5a2b',
        height: 120,
        hasSpire: true,
        hasCross: true,
        windows: 4
    },
    { 
        type: 'theater1', 
        name: 'üé≠ –¢–µ–∞—Ç—Ä',
        baseColor: '#ffe082', 
        accentColor: '#ffd54f', 
        doorColor: '#ff8f00',
        height: 80,
        hasColumns: true,
        hasStatue: true,
        windows: 4
    },
    { 
        type: 'museum1', 
        name: 'üèõÔ∏è –ú—É–∑–µ–π',
        baseColor: '#cfd8dc', 
        accentColor: '#b0bec5', 
        doorColor: '#37474f',
        height: 70,
        hasColumns: true,
        windows: 5
    },

    // –°–ø–æ—Ä—Ç
    { 
        type: 'stadium1', 
        name: 'üèüÔ∏è –°—Ç–∞–¥–∏–æ–Ω',
        baseColor: '#81c784', 
        accentColor: '#4caf50', 
        doorColor: '#1b5e20',
        height: 60,
        hasField: true,
        seats: true,
        windows: 8
    },
    { 
        type: 'pool1', 
        name: 'üèä –ë–∞—Å—Å–µ–π–Ω',
        baseColor: '#4fc3f7', 
        accentColor: '#039be5', 
        doorColor: '#01579b',
        height: 30,
        hasWater: true,
        windows: 3
    },

    // –¢—Ä–∞–Ω—Å–ø–æ—Ä—Ç
    { 
        type: 'station1', 
        name: 'üöâ –í–æ–∫–∑–∞–ª',
        baseColor: '#b0bec5', 
        accentColor: '#8a9aa8', 
        doorColor: '#37474f',
        height: 60,
        hasClock: true,
        windows: 5
    },
    { 
        type: 'airport1', 
        name: '‚úàÔ∏è –ê—ç—Ä–æ–ø–æ—Ä—Ç',
        baseColor: '#cfd8dc', 
        accentColor: '#b0bec5', 
        doorColor: '#263238',
        height: 50,
        hasTower: true,
        windows: 8
    },

    // –ü–∞—Ä–∫–∏
    { 
        type: 'park1', 
        name: 'üå≥ –ü–∞—Ä–∫',
        baseColor: '#81c784', 
        treeColor: '#2e7d32',
        height: 20,
        trees: 4,
        hasFountain: true,
        hasBench: true
    },
    { 
        type: 'park2', 
        name: 'üå≤ –õ–µ—Å–æ–ø–∞—Ä–∫',
        baseColor: '#66bb6a', 
        treeColor: '#1b5e20',
        height: 25,
        trees: 6,
        hasFountain: false,
        hasBench: true
    },

    // –î–æ—Ä–æ–≥–∏
    { 
        type: 'road1', 
        name: 'üõ£Ô∏è –î–æ—Ä–æ–≥–∞',
        baseColor: '#b0bec5', 
        lineColor: '#f5f5f5',
        height: 5,
        hasMarkup: true,
        hasLights: true
    }
];

// ==================== –§–£–ù–ö–¶–ò–ò –î–õ–Ø –†–ò–°–û–í–ê–ù–ò–Ø 3D ====================
function drawBase(x, y, color, heightOffset = 0) {
    ctx.fillStyle = color;
    ctx.shadowColor = '#2b4d2b';
    ctx.shadowBlur = 20 * cam.z;
    ctx.shadowOffsetY = 5 * cam.z;
    ctx.beginPath();
    ctx.moveTo(x, y - 5 * cam.z - heightOffset);
    ctx.lineTo(x + CELL/2 * cam.z, y + CELL/4 * cam.z - 5 * cam.z - heightOffset);
    ctx.lineTo(x, y + CELL/2 * cam.z - 5 * cam.z - heightOffset);
    ctx.lineTo(x - CELL/2 * cam.z, y + CELL/4 * cam.z - 5 * cam.z - heightOffset);
    ctx.closePath();
    ctx.fill();
}

function drawHouse(x, y, style) {
    const h = style.height * cam.z;
    const w = CELL * 0.7 * cam.z;
    
    // –¢–µ–Ω—å
    ctx.shadowColor = '#2b4d2b';
    ctx.shadowBlur = 25 * cam.z;
    ctx.shadowOffsetY = 10 * cam.z;
    
    // –§—É–Ω–¥–∞–º–µ–Ω—Ç
    drawBase(x, y, style.baseColor);
    
    // –°—Ç–µ–Ω—ã (–ø—Ä—è–º–æ—É–≥–æ–ª—å–Ω–∏–∫)
    ctx.fillStyle = style.baseColor;
    ctx.fillRect(x - w/2, y - h, w, h);
    
    // –î–µ—Ç–∞–ª–∏ —Å—Ç–µ–Ω (—Ç–µ–∫—Å—Ç—É—Ä–∞)
    ctx.fillStyle = '#8b5a2b';
    ctx.globalAlpha = 0.3;
    for (let i = 0; i < 3; i++) {
        ctx.fillRect(x - w/2 + 5 * cam.z, y - h + i * 20 * cam.z, w - 10 * cam.z, 2 * cam.z);
    }
    ctx.globalAlpha = 1;
    
    // –ö—Ä—ã—à–∞
    ctx.fillStyle = style.roofColor;
    ctx.beginPath();
    ctx.moveTo(x - w/2 - 10 * cam.z, y - h);
    ctx.lineTo(x + w/2 + 10 * cam.z, y - h);
    ctx.lineTo(x, y - h - 30 * cam.z);
    ctx.closePath();
    ctx.fill();
    
    // –¢—Ä—É–±–∞
    if (style.hasChimney) {
        ctx.fillStyle = '#8b5a2b';
        ctx.fillRect(x + w/4, y - h - 15 * cam.z, 10 * cam.z, 25 * cam.z);
    }
    
    // –û–∫–Ω–∞
    ctx.fillStyle = style.windowColor;
    ctx.shadowColor = '#ffd700';
    ctx.shadowBlur = 10 * cam.z;
    
    if (style.windows === 2) {
        ctx.fillRect(x - w/3, y - h/2, 12 * cam.z, 16 * cam.z);
        ctx.fillRect(x + w/6, y - h/2, 12 * cam.z, 16 * cam.z);
    } else if (style.windows === 3) {
        ctx.fillRect(x - w/2.5, y - h/2, 12 * cam.z, 16 * cam.z);
        ctx.fillRect(x - w/12, y - h/2, 12 * cam.z, 16 * cam.z);
        ctx.fillRect(x + w/4, y - h/2, 12 * cam.z, 16 * cam.z);
    } else if (style.windows === 4) {
        ctx.fillRect(x - w/2.5, y - h/1.5, 12 * cam.z, 16 * cam.z);
        ctx.fillRect(x - w/12, y - h/1.5, 12 * cam.z, 16 * cam.z);
        ctx.fillRect(x - w/2.5, y - h/3, 12 * cam.z, 16 * cam.z);
        ctx.fillRect(x - w/12, y - h/3, 12 * cam.z, 16 * cam.z);
    }
    
    // –î–≤–µ—Ä—å
    ctx.fillStyle = style.doorColor || '#8b5a2b';
    ctx.shadowBlur = 0;
    ctx.fillRect(x - 8 * cam.z, y - h/3, 16 * cam.z, 25 * cam.z);
    
    // –ë–∞–ª–∫–æ–Ω
    if (style.hasBalcony) {
        ctx.fillStyle = '#a57248';
        ctx.fillRect(x - w/3, y - h + 20 * cam.z, w/1.5, 6 * cam.z);
    }
    
    ctx.shadowBlur = 0;
}

function drawOffice(x, y, style) {
    const h = style.height * cam.z;
    const w = CELL * 0.7 * cam.z;
    
    drawBase(x, y, style.baseColor);
    
    ctx.fillStyle = style.accentColor;
    ctx.fillRect(x - w/2, y - h, w, h);
    
    // –û–∫–Ω–∞
    ctx.fillStyle = '#cfd8dc';
    for (let f = 0; f < style.floors; f++) {
        for (let i = 0; i < style.windows; i++) {
            ctx.fillRect(
                x - w/2 + 15 * cam.z + i * 15 * cam.z,
                y - h + 15 * cam.z + f * 20 * cam.z,
                10 * cam.z,
                12 * cam.z
            );
        }
    }
    
    // –õ–æ–≥–æ—Ç–∏–ø
    if (style.hasLogo) {
        ctx.fillStyle = '#ffb74d';
        ctx.beginPath();
        ctx.arc(x, y - h - 5 * cam.z, 8 * cam.z, 0, Math.PI*2);
        ctx.fill();
    }
}

function drawFactory(x, y, style) {
    const h = style.height * cam.z;
    const w = CELL * 0.8 * cam.z;
    
    drawBase(x, y, style.baseColor);
    
    ctx.fillStyle = style.accentColor;
    ctx.fillRect(x - w/2, y - h, w, h);
    
    // –¢—Ä—É–±—ã
    if (style.chimney) {
        ctx.fillStyle = '#6b5a3a';
        ctx.fillRect(x - w/4, y - h - 20 * cam.z, 8 * cam.z, 25 * cam.z);
        if (style.smoke) {
            ctx.fillStyle = '#ffffff60';
            ctx.beginPath();
            ctx.arc(x - w/4 + 4 * cam.z, y - h - 35 * cam.z, 10 * cam.z, 0, Math.PI*2);
            ctx.fill();
        }
    }
    
    // –û–∫–Ω–∞
    ctx.fillStyle = '#ffb74d';
    for (let i = 0; i < style.windows; i++) {
        ctx.fillRect(x - w/2 + 20 * cam.z + i * 20 * cam.z, y - h/2, 10 * cam.z, 12 * cam.z);
    }
}

function drawPark(x, y, style) {
    drawBase(x, y, style.baseColor);
    
    // –î–µ—Ä–µ–≤—å—è
    for (let i = 0; i < style.trees; i++) {
        const tx = x - 30 * cam.z + i * 20 * cam.z;
        const ty = y - 30 * cam.z;
        
        // –°—Ç–≤–æ–ª
        ctx.fillStyle = '#8b5a2b';
        ctx.fillRect(tx - 3 * cam.z, ty, 6 * cam.z, 20 * cam.z);
        
        // –ö—Ä–æ–Ω–∞
        ctx.fillStyle = style.treeColor;
        ctx.beginPath();
        ctx.arc(tx, ty - 5 * cam.z, 10 * cam.z, 0, Math.PI*2);
        ctx.fill();
    }
    
    // –§–æ–Ω—Ç–∞–Ω
    if (style.hasFountain) {
        ctx.fillStyle = '#b0e0e6';
        ctx.beginPath();
        ctx.arc(x, y - 25 * cam.z, 12 * cam.z, 0, Math.PI*2);
        ctx.fill();
    }
}

function drawRoad(x, y, style) {
    drawBase(x, y, style.baseColor, 2 * cam.z);
    
    // –†–∞–∑–º–µ—Ç–∫–∞
    ctx.fillStyle = style.lineColor;
    ctx.fillRect(x - 30 * cam.z, y - 10 * cam.z, 60 * cam.z, 4 * cam.z);
    ctx.fillRect(x - 10 * cam.z, y - 25 * cam.z, 4 * cam.z, 20 * cam.z);
    
    // –§–æ–Ω–∞—Ä–∏
    if (style.hasLights) {
        ctx.fillStyle = '#8a9aa8';
        ctx.fillRect(x - 25 * cam.z, y - 40 * cam.z, 4 * cam.z, 20 * cam.z);
        ctx.fillRect(x + 21 * cam.z, y - 40 * cam.z, 4 * cam.z, 20 * cam.z);
        
        ctx.fillStyle = '#ffd966';
        ctx.beginPath();
        ctx.arc(x - 23 * cam.z, y - 45 * cam.z, 4 * cam.z, 0, Math.PI*2);
        ctx.fill();
        ctx.beginPath();
        ctx.arc(x + 23 * cam.z, y - 45 * cam.z, 4 * cam.z, 0, Math.PI*2);
        ctx.fill();
    }
}

// ==================== –ö–ê–¢–ê–õ–û–ì –ó–î–ê–ù–ò–ô ====================
const buildings = {};
let buildingId = 0;

buildingStyles.forEach((style, index) => {
    for (let i = 0; i < 320; i++) {
        const price = 1000 + (index * 800) + (i * 40);
        const income = Math.floor(price * 0.08) + 5;
        const population = style.type.includes('house') ? 3 + Math.floor(i/10) : 
                          style.type.includes('apt') ? 10 + Math.floor(i/5) : 1;
        
        buildings['b'+buildingId] = {
            id: 'b'+buildingId,
            name: style.name + ' ' + (i+1),
            price: price,
            income: income,
            population: population,
            style: style,
            category: Math.floor(index / 4)
        };
        buildingId++;
    }
});

console.log('–°–æ–∑–¥–∞–Ω–æ –∑–¥–∞–Ω–∏–π:', buildingId);

// ==================== –§–£–ù–ö–¶–ò–ò –ö–ê–ú–ï–†–´ ====================
function resize(){
    canvas.width = window.innerWidth;
    canvas.height = window.innerHeight;
    draw();
}
window.addEventListener('resize', resize);
resize();

function iso(r,c){
    return {
        x: (c - r) * CELL/2 * cam.z + cam.x + canvas.width/2,
        y: (c + r) * CELL/4 * cam.z + cam.y + canvas.height/3
    };
}

function draw(){
    ctx.clearRect(0,0,canvas.width,canvas.height);
    
    // –ù–µ–±–æ
    ctx.fillStyle = '#0b4b72';
    ctx.fillRect(0,0,canvas.width,canvas.height);
    
    // –†–∏—Å—É–µ–º –≤—Å–µ –∫–ª–µ—Ç–∫–∏
    for(let r=0; r<GRID; r++){
        for(let c=0; c<GRID; c++){
            const p = iso(r,c);
            
            // –ó–µ–º–ª—è
            ctx.fillStyle = '#7cb57c';
            ctx.shadowColor = '#2b4d2b';
            ctx.shadowBlur = 15 * cam.z;
            ctx.shadowOffsetY = 5 * cam.z;
            
            ctx.beginPath();
            ctx.moveTo(p.x, p.y);
            ctx.lineTo(p.x + CELL/2*cam.z, p.y + CELL/4*cam.z);
            ctx.lineTo(p.x, p.y + CELL/2*cam.z);
            ctx.lineTo(p.x - CELL/2*cam.z, p.y + CELL/4*cam.z);
            ctx.closePath();
            ctx.fill();
            
            // –ó–¥–∞–Ω–∏–µ
            const id = game.grid[r][c];
            if(id){
                const b = buildings[id];
                if(b){
                    ctx.shadowBlur = 20 * cam.z;
                    
                    // –í—ã–±–æ—Ä —Ñ—É–Ω–∫—Ü–∏–∏ –æ—Ç—Ä–∏—Å–æ–≤–∫–∏ –ø–æ —Ç–∏–ø—É
                    if(b.style.type.includes('house') || b.style.type.includes('cottage') || b.style.type.includes('mansion')) {
                        drawHouse(p.x, p.y, b.style);
                    } else if(b.style.type.includes('office') || b.style.type.includes('apt')) {
                        drawOffice(p.x, p.y, b.style);
                    } else if(b.style.type.includes('factory')) {
                        drawFactory(p.x, p.y, b.style);
                    } else if(b.style.type.includes('park')) {
                        drawPark(p.x, p.y, b.style);
                    } else if(b.style.type.includes('road')) {
                        drawRoad(p.x, p.y, b.style);
                    } else {
                        drawHouse(p.x, p.y, b.style);
                    }
                }
            }
        }
    }
    
    // –ü–æ–¥—Å–≤–µ—Ç–∫–∞ –≤—ã–±—Ä–∞–Ω–Ω–æ–π –∫–ª–µ—Ç–∫–∏
    if(selRow != -1 && selCol != -1){
        const p = iso(selRow, selCol);
        ctx.shadowColor = '#ffd700';
        ctx.shadowBlur = 30 * cam.z;
        ctx.strokeStyle = '#ffd700';
        ctx.lineWidth = 5 * cam.z;
        ctx.beginPath();
        ctx.moveTo(p.x, p.y - 10*cam.z);
        ctx.lineTo(p.x + CELL/2*cam.z, p.y + CELL/4*cam.z - 10*cam.z);
        ctx.lineTo(p.x, p.y + CELL/2*cam.z - 10*cam.z);
        ctx.lineTo(p.x - CELL/2*cam.z, p.y + CELL/4*cam.z - 10*cam.z);
        ctx.closePath();
        ctx.stroke();
    }
    
    ctx.shadowBlur = 0;
}

// ==================== –£–ü–†–ê–í–õ–ï–ù–ò–ï ====================
canvas.onmousedown = e => { drag = true; lx = e.clientX; ly = e.clientY; };
canvas.onmouseup = _ => drag = false;
canvas.onmousemove = e => {
    if(!drag) return;
    cam.x += e.clientX - lx;
    cam.y += e.clientY - ly;
    lx = e.clientX; ly = e.clientY;
    draw();
};
canvas.onwheel = e => {
    cam.z = Math.min(3, Math.max(.4, cam.z + (e.deltaY < 0 ? .1 : -.1)));
    draw();
};

canvas.onclick = e => {
    const rect = canvas.getBoundingClientRect();
    let mx = e.clientX - rect.left, my = e.clientY - rect.top;
    let best = null, br = -1, bc = -1;
    
    for(let r=0; r<GRID; r++){
        for(let c=0; c<GRID; c++){
            const p = iso(r,c);
            const d = Math.hypot(mx - p.x, my - p.y);
            if(d < 40 && (!best || d < best)){ best = d; br = r; bc = c; }
        }
    }
    
    if(br != -1){
        selRow = br; selCol = bc;
        if(selected) build(br,bc);
    }
    draw();
};

let selected = null;

function build(r,c){
    const b = buildings[selected];
    if(!b) return;
    if(game.money < b.price || game.grid[r][c]) return;
    
    game.money -= b.price;
    game.grid[r][c] = b.id;
    game.pop += b.population;
    game.cnt++;
    update();
    draw();
    info.innerText = '‚úÖ –ü–æ—Å—Ç—Ä–æ–µ–Ω–æ: ' + b.name;
}

function collect(){
    let t = 0;
    for(let r=0; r<GRID; r++) for(let c=0; c<GRID; c++){
        const id = game.grid[r][c];
        if(id && buildings[id]) t += buildings[id].income;
    }
    game.money += t;
    update();
    info.innerText = 'üí∞ –°–æ–±—Ä–∞–Ω–æ: ' + t.toLocaleString();
}

function weather(){ game.weather = (game.weather + 1) % 3; draw(); }
function timeDay(){ game.time = (game.time + .3) % 1; draw(); }
function cancel(){ selected = null; info.innerText = '–í—ã–±–æ—Ä —Å–±—Ä–æ—à–µ–Ω'; }
function resetGame(){ location.reload(); }

function update(){
    money.innerText = game.money.toLocaleString();
    pop.innerText = game.pop.toLocaleString();
    cnt.innerText = game.cnt + '/3600';
    let inc = 0;
    for(let r=0; r<GRID; r++) for(let c=0; c<GRID; c++){
        const id = game.grid[r][c];
        if(id && buildings[id]) inc += buildings[id].income;
    }
    incSpan.innerText = inc.toLocaleString();
}

// ==================== –ò–ù–¢–ï–†–§–ï–ô–° ====================
const catsDiv = document.getElementById('cats');
const list = document.getElementById('list');
const info = document.getElementById('info');
const money = document.getElementById('money');
const pop = document.getElementById('pop');
const incSpan = document.getElementById('inc');
const cnt = document.getElementById('cnt');

// –ö–Ω–æ–ø–∫–∏ –∫–∞—Ç–µ–≥–æ—Ä–∏–π
for(let i = 0; i < 8; i++){
    const btn = document.createElement('button');
    btn.textContent = 'üèóÔ∏è –ö–∞—Ç ' + (i+1);
    btn.onclick = () => {
        list.innerHTML = '';
        Object.values(buildings).filter(b => b.category === i).slice(0,200).forEach(b => {
            const d = document.createElement('div');
            d.className = 'item';
            d.innerText = b.name + ' üí∞' + b.price;
            d.onclick = () => {
                document.querySelectorAll('.item').forEach(i => i.classList.remove('selected'));
                d.classList.add('selected');
                selected = b.id;
                info.innerText = '–í—ã–±—Ä–∞–Ω–æ: ' + b.name;
            };
            list.appendChild(d);
        });
    };
    catsDiv.appendChild(btn);
}

// –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –≤—Å–µ –∑–¥–∞–Ω–∏—è –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
Object.values(buildings).slice(0,200).forEach(b => {
    const d = document.createElement('div');
    d.className = 'item';
    d.innerText = b.name + ' üí∞' + b.price;
    d.onclick = () => {
        document.querySelectorAll('.item').forEach(i => i.classList.remove('selected'));
        d.classList.add('selected');
        selected = b.id;
        info.innerText = '–í—ã–±—Ä–∞–Ω–æ: ' + b.name;
    };
    list.appendChild(d);
});

draw();
update();
</script>
</body>
</html>
