<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>MEGA CITY 5120 - 3D PREMIUM</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', 'Roboto', sans-serif;
            user-select: none;
        }

        body {
            background: linear-gradient(135deg, #0a1928 0%, #1a2f3f 100%);
            overflow: hidden;
        }

        .game {
            width: 100vw;
            height: 100vh;
            position: relative;
        }

        canvas {
            width: 100%;
            height: 100%;
            display: block;
            touch-action: none;
            filter: drop-shadow(0 0 20px rgba(0,0,0,0.5));
        }

        .ui {
            position: fixed;
            bottom: 30px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 20px;
            background: rgba(10, 20, 30, 0.9);
            backdrop-filter: blur(20px);
            padding: 20px 40px;
            border-radius: 70px;
            color: #fff;
            font-size: 22px;
            z-index: 30;
            border: 1px solid rgba(255, 215, 0, 0.5);
            box-shadow: 0 25px 50px rgba(0, 0, 0, 0.8);
        }

        .ui div {
            background: rgba(0, 0, 0, 0.4);
            padding: 12px 28px;
            border-radius: 50px;
            display: flex;
            align-items: center;
            gap: 12px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            transition: all 0.3s ease;
        }

        .ui div:hover {
            background: rgba(255, 215, 0, 0.2);
            transform: translateY(-3px);
            border-color: #ffd700;
        }

        .menu-left {
            position: fixed;
            top: 50%;
            left: 30px;
            transform: translateY(-50%);
            width: 420px;
            height: 85vh;
            background: rgba(10, 20, 30, 0.95);
            backdrop-filter: blur(20px);
            border-radius: 50px;
            padding: 30px;
            display: flex;
            flex-direction: column;
            gap: 20px;
            z-index: 20;
            border: 1px solid rgba(255, 215, 0, 0.4);
            box-shadow: 0 30px 70px rgba(0, 0, 0, 0.9);
            animation: slideInLeft 0.6s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }

        @keyframes slideInLeft {
            from { opacity: 0; transform: translateY(-50%) translateX(-100px); }
            to { opacity: 1; transform: translateY(-50%) translateX(0); }
        }

        .menu-left h2 {
            color: #ffd700;
            text-align: center;
            font-size: 32px;
            text-shadow: 0 0 30px rgba(255, 215, 0, 0.6);
            letter-spacing: 4px;
            margin-bottom: 10px;
        }

        .categories {
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
            justify-content: center;
        }

        .categories button {
            flex: 1;
            min-width: 100px;
            padding: 15px;
            border-radius: 40px;
            border: none;
            cursor: pointer;
            background: linear-gradient(135deg, rgba(255,255,255,0.1) 0%, rgba(255,255,255,0.05) 100%);
            color: #fff;
            font-weight: bold;
            font-size: 18px;
            transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            border: 1px solid rgba(255, 215, 0, 0.3);
            backdrop-filter: blur(10px);
        }

        .categories button:hover {
            background: linear-gradient(135deg, rgba(255,215,0,0.3) 0%, rgba(255,215,0,0.2) 100%);
            border-color: #ffd700;
            transform: scale(1.08);
            box-shadow: 0 10px 30px rgba(255, 215, 0, 0.4);
        }

        .list {
            flex: 1;
            overflow-y: auto;
            padding-right: 15px;
        }

        .list::-webkit-scrollbar {
            width: 10px;
        }

        .list::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
        }

        .list::-webkit-scrollbar-thumb {
            background: linear-gradient(135deg, #ffd700, #ffaa00);
            border-radius: 10px;
            border: 2px solid rgba(0,0,0,0.3);
        }

        .item {
            background: rgba(255, 255, 255, 0.08);
            margin-bottom: 15px;
            padding: 18px;
            border-radius: 35px;
            color: #fff;
            cursor: pointer;
            transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            border: 2px solid transparent;
            display: flex;
            align-items: center;
            gap: 18px;
            backdrop-filter: blur(10px);
        }

        .item:hover {
            background: rgba(255, 215, 0, 0.2);
            transform: translateX(10px) scale(1.02);
            border-color: rgba(255, 215, 0, 0.6);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.4);
        }

        .item.selected {
            border-color: #ffd700;
            background: rgba(255, 215, 0, 0.25);
            box-shadow: 0 0 40px rgba(255, 215, 0, 0.5);
            transform: scale(1.03);
        }

        .menu-right {
            position: fixed;
            top: 50%;
            right: 30px;
            transform: translateY(-50%);
            background: rgba(10, 20, 30, 0.95);
            backdrop-filter: blur(20px);
            border-radius: 50px;
            padding: 30px;
            display: flex;
            flex-direction: column;
            gap: 18px;
            z-index: 20;
            border: 1px solid rgba(255, 215, 0, 0.4);
            animation: slideInRight 0.6s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }

        @keyframes slideInRight {
            from { opacity: 0; transform: translateY(-50%) translateX(100px); }
            to { opacity: 1; transform: translateY(-50%) translateX(0); }
        }

        .menu-right button {
            padding: 18px 32px;
            font-size: 20px;
            border-radius: 50px;
            border: none;
            cursor: pointer;
            background: linear-gradient(135deg, rgba(255,255,255,0.1) 0%, rgba(255,255,255,0.05) 100%);
            color: #fff;
            font-weight: bold;
            transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            border: 1px solid rgba(255, 215, 0, 0.3);
            min-width: 200px;
            backdrop-filter: blur(10px);
        }

        .menu-right button:hover {
            background: linear-gradient(135deg, rgba(255,215,0,0.3) 0%, rgba(255,215,0,0.2) 100%);
            border-color: #ffd700;
            transform: scale(1.08) translateY(-3px);
            box-shadow: 0 15px 40px rgba(255, 215, 0, 0.4);
        }

        .info {
            position: fixed;
            top: 30px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(10, 20, 30, 0.95);
            backdrop-filter: blur(20px);
            padding: 20px 60px;
            border-radius: 70px;
            color: #ffd700;
            font-size: 22px;
            font-weight: bold;
            z-index: 30;
            border: 1px solid rgba(255, 215, 0, 0.5);
            box-shadow: 0 15px 50px rgba(0, 0, 0, 0.8);
            letter-spacing: 2px;
            animation: fadeInDown 0.6s ease;
        }

        @keyframes fadeInDown {
            from { opacity: 0; transform: translateX(-50%) translateY(-30px); }
            to { opacity: 1; transform: translateX(-50%) translateY(0); }
        }

        .time-indicator {
            position: fixed;
            top: 30px;
            right: 30px;
            background: rgba(10, 20, 30, 0.95);
            backdrop-filter: blur(20px);
            padding: 15px 30px;
            border-radius: 50px;
            color: #fff;
            z-index: 30;
            border: 1px solid rgba(255, 215, 0, 0.5);
            font-size: 20px;
            animation: fadeInRight 0.6s ease;
        }

        @keyframes fadeInRight {
            from { opacity: 0; transform: translateX(30px); }
            to { opacity: 1; transform: translateX(0); }
        }

        .building-preview {
            width: 60px;
            height: 60px;
            background: rgba(0,0,0,0.3);
            border-radius: 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 35px;
        }
    </style>
</head>
<body>
<div class="game">
    <canvas id="c"></canvas>
    
    <div class="info" id="info">üèóÔ∏è MEGA CITY 5120 - 3D PREMIUM</div>
    <div class="time-indicator" id="timeIndicator">‚òÄÔ∏è –ü–û–õ–î–ï–ù–¨</div>
    
    <div class="ui">
        <div><span style="color:#ffd700">üí∞</span> <span id="money">50 000 000</span></div>
        <div><span style="color:#4CAF50">üë•</span> <span id="pop">0</span></div>
        <div><span style="color:#FF9800">‚ö°</span> <span id="inc">0</span></div>
        <div><span style="color:#2196F3">üèóÔ∏è</span> <span id="cnt">0/1600</span></div>
    </div>
    
    <div class="menu-left">
        <h2>üèóÔ∏è 3D –ö–ê–¢–ê–õ–û–ì</h2>
        <div class="categories" id="cats"></div>
        <div class="list" id="list"></div>
    </div>
    
    <div class="menu-right">
        <button onclick="collect()"><span style="color:#ffd700">üí∞</span> –°–ë–û–† –î–û–•–û–î–ê</button>
        <button onclick="weather()"><span style="color:#87CEEB">üå¶Ô∏è</span> –ü–û–ì–û–î–ê</button>
        <button onclick="timeDay()"><span style="color:#ffd700">‚è∞</span> –í–†–ï–ú–Ø</button>
        <button onclick="cancel()"><span style="color:#ff6b6b">‚ùå</span> –û–¢–ú–ï–ù–ê</button>
        <button onclick="resetGame()"><span style="color:#4CAF50">üîÑ</span> –ù–û–í–´–ô –ì–û–†–û–î</button>
    </div>
</div>

<script>
const tg = window.Telegram?.WebApp;
tg?.expand();
tg?.ready();

const GRID = 40;
const CELL = 100;
const canvas = document.getElementById('c');
const ctx = canvas.getContext('2d');

// –ü–ª–∞–≤–Ω–∞—è –∫–∞–º–µ—Ä–∞ —Å —Ñ–∏–∑–∏–∫–æ–π –ø—Ä–µ–º–∏—É–º-–∫–ª–∞—Å—Å–∞
class Camera {
    constructor() {
        this.x = 0;
        this.y = 0;
        this.z = 1;
        this.targetX = 0;
        this.targetY = 0;
        this.targetZ = 1;
        this.velocityX = 0;
        this.velocityY = 0;
        this.damping = 0.92;
        this.elasticity = 0.1;
        this.minZoom = 0.7;
        this.maxZoom = 2.2;
    }
    
    update() {
        // –°—É–ø–µ—Ä –ø–ª–∞–≤–Ω–æ–µ –¥–≤–∏–∂–µ–Ω–∏–µ —Å —Ñ–∏–∑–∏–∫–æ–π
        this.velocityX += (this.targetX - this.x) * this.elasticity;
        this.velocityY += (this.targetY - this.y) * this.elasticity;
        
        this.velocityX *= this.damping;
        this.velocityY *= this.damping;
        
        this.x += this.velocityX;
        this.y += this.velocityY;
        
        // –ü–ª–∞–≤–Ω—ã–π –∑—É–º
        const zoomDiff = this.targetZ - this.z;
        this.z += zoomDiff * 0.1;
    }
    
    move(dx, dy) {
        this.targetX += dx;
        this.targetY += dy;
        this.velocityX += dx * 0.5;
        this.velocityY += dy * 0.5;
    }
    
    zoom(delta) {
        this.targetZ = Math.min(this.maxZoom, Math.max(this.minZoom, this.targetZ + delta));
    }
}

const camera = new Camera();

let drag = false;
let lx = 0, ly = 0;
let lastMouseX = 0, lastMouseY = 0;

let hoverRow = -1, hoverCol = -1;
let selected = null;

let particles = [];

// –ö–ª–∞—Å—Å –¥–ª—è 3D-–º–æ–¥–µ–ª–µ–π –∑–¥–∞–Ω–∏–π
class Building3D {
    constructor(type, level, color, accent) {
        this.type = type;
        this.level = level;
        this.color = color;
        this.accent = accent;
        this.details = [];
        this.generateDetails();
    }
    
    generateDetails() {
        const level = this.level;
        
        // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω—ã–µ –¥–µ—Ç–∞–ª–∏ –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ç–∏–ø–∞ –∏ —É—Ä–æ–≤–Ω—è
        switch(this.type) {
            case 'res': // –ñ–∏–ª—ã–µ –∫–æ–º–ø–ª–µ–∫—Å—ã
                this.details = {
                    balconies: Math.floor(level * 1.5),
                    windows: 6 + level * 2,
                    floors: 3 + level,
                    roofStyle: 'flat',
                    hasChimney: level > 2,
                    hasAntenna: level > 3
                };
                break;
                
            case 'com': // –¢–æ—Ä–≥–æ–≤—ã–µ —Ü–µ–Ω—Ç—Ä—ã
                this.details = {
                    entrances: 2 + Math.floor(level / 2),
                    windows: 8 + level * 3,
                    signs: level,
                    roofStyle: 'curved',
                    hasLights: true,
                    hasBillboard: level > 2
                };
                break;
                
            case 'ind': // –ü—Ä–æ–º—ã—à–ª–µ–Ω–Ω—ã–µ
                this.details = {
                    chimneys: 1 + Math.floor(level / 2),
                    pipes: level,
                    windows: 4 + level,
                    roofStyle: 'pointed',
                    hasSmoke: true,
                    hasTanks: level > 2
                };
                break;
                
            case 'fun': // –†–∞–∑–≤–ª–µ–∫–∞—Ç–µ–ª—å–Ω—ã–µ
                this.details = {
                    towers: 2 + Math.floor(level / 2),
                    lights: 10 + level * 2,
                    flags: level,
                    roofStyle: 'dome',
                    hasSpires: true,
                    hasNeon: true
                };
                break;
                
            case 'gov': // –ì–æ—Å—É–¥–∞—Ä—Å—Ç–≤–µ–Ω–Ω—ã–µ
                this.details = {
                    columns: 4 + Math.floor(level / 2),
                    dome: level > 1,
                    windows: 10 + level * 2,
                    roofStyle: 'grand',
                    hasStatues: level > 2,
                    hasClock: level > 3
                };
                break;
        }
    }
}

// –•—Ä–∞–Ω–∏–ª–∏—â–µ 3D-–º–æ–¥–µ–ª–µ–π
const buildingModels = {};

let game = {
    money: 50000000,
    pop: 0,
    cnt: 0,
    weather: 0,
    time: 0.6,
    grid: []
};

for (let r = 0; r < GRID; r++) {
    game.grid[r] = [];
    for (let c = 0; c < GRID; c++) {
        game.grid[r][c] = null;
    }
}

// –ö–∞—Ç–µ–≥–æ—Ä–∏–∏ —Å —É–Ω–∏–∫–∞–ª—å–Ω—ã–º–∏ —Ü–≤–µ—Ç–∞–º–∏
const cats = [
    { id: 'res', n: '–ñ–ò–õ–´–ï', e: 'üèòÔ∏è', color: '#4CAF50', accent: '#81C784', dark: '#2E7D32' },
    { id: 'com', n: '–¢–û–†–ì–û–í–´–ï', e: 'üè¨', color: '#FF9800', accent: '#FFB74D', dark: '#F57C00' },
    { id: 'ind', n: '–ü–†–û–ú–´–®–õ–ï–ù–ù–´–ï', e: 'üè≠', color: '#F44336', accent: '#E57373', dark: '#C62828' },
    { id: 'fun', n: '–†–ê–ó–í–õ–ï–ß–ï–ù–ò–Ø', e: 'üé™', color: '#9C27B0', accent: '#BA68C8', dark: '#6A1B9A' },
    { id: 'gov', n: '–ì–û–°–£–î–ê–†–°–¢–í–ï–ù–ù–´–ï', e: 'üèõÔ∏è', color: '#2196F3', accent: '#64B5F6', dark: '#1565C0' }
];

// –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∑–¥–∞–Ω–∏–π —Å 3D-–º–æ–¥–µ–ª—è–º–∏
const buildings = {};
let id = 0;
cats.forEach((c, ci) => {
    for (let i = 0; i < 15; i++) {
        const level = i + 1;
        const basePrice = c.p * level * 1000;
        
        const buildingId = 'b' + id;
        
        // –°–æ–∑–¥–∞–µ–º 3D-–º–æ–¥–µ–ª—å –¥–ª—è –∑–¥–∞–Ω–∏—è
        buildingModels[buildingId] = new Building3D(c.id, level, c.color, c.accent);
        
        buildings[buildingId] = {
            id: buildingId,
            cat: c.id,
            name: `${c.n} ${getRomanNumeral(level)}`,
            price: Math.floor(basePrice),
            inc: Math.floor(basePrice * 0.12),
            pop: Math.floor(basePrice * 0.008),
            level: level,
            emoji: c.e,
            color: c.color,
            accent: c.accent,
            dark: c.dark,
            height: 40 + level * 12,
            width: 45 + level * 6,
            depth: 45 + level * 6
        };
        id++;
    }
});

function getRomanNumeral(num) {
    const roman = ['I', 'II', 'III', 'IV', 'V', 'VI', 'VII', 'VIII', 'IX', 'X', 'XI', 'XII', 'XIII', 'XIV', 'XV'];
    return roman[num - 1] || num;
}

const all = Object.values(buildings);

function resize() {
    canvas.width = window.innerWidth;
    canvas.height = window.innerHeight;
}

window.addEventListener('resize', resize);
resize();

function iso(r, c) {
    return {
        x: (c - r) * CELL / 2 * camera.z + camera.x + canvas.width / 2,
        y: (c + r) * CELL / 4 * camera.z + camera.y + canvas.height / 3
    };
}

// –û—Ç—Ä–∏—Å–æ–≤–∫–∞ –∑–¥–∞–Ω–∏—è —Å –≤—ã—Å–æ–∫–∏–º —É—Ä–æ–≤–Ω–µ–º –¥–µ—Ç–∞–ª–∏–∑–∞—Ü–∏–∏
function drawBuilding3D(r, c, building, model, isHover) {
    const p = iso(r, c);
    const h = building.height * camera.z;
    const w = building.width * camera.z;
    const d = building.depth * camera.z;
    
    const x1 = p.x - w/2;
    const x2 = p.x + w/2;
    const yBase = p.y;
    const yTop = yBase - h;
    
    ctx.save();
    
    // –¢–µ–Ω–∏ –¥–ª—è –æ–±—ä–µ–º–∞
    ctx.shadowColor = 'rgba(0, 0, 0, 0.6)';
    ctx.shadowBlur = 25 * camera.z;
    ctx.shadowOffsetX = 8 * camera.z;
    ctx.shadowOffsetY = 8 * camera.z;
    
    // –û–°–ù–û–í–ù–û–ô –ö–û–†–ü–£–° (—Ñ–∞—Å–∞–¥)
    ctx.fillStyle = building.color;
    ctx.beginPath();
    ctx.moveTo(x1, yBase);
    ctx.lineTo(x2, yBase);
    ctx.lineTo(x2 - 20 * camera.z, yBase + 20 * camera.z);
    ctx.lineTo(x1 - 20 * camera.z, yBase + 20 * camera.z);
    ctx.closePath();
    ctx.fill();
    
    // –ë–û–ö–û–í–ê–Ø –°–¢–ï–ù–ê (–ø—Ä–∞–≤–∞—è)
    ctx.fillStyle = building.dark;
    ctx.beginPath();
    ctx.moveTo(x2, yBase);
    ctx.lineTo(x2 + 20 * camera.z, yBase + 15 * camera.z);
    ctx.lineTo(x2 + 20 * camera.z, yTop + 15 * camera.z);
    ctx.lineTo(x2, yTop);
    ctx.closePath();
    ctx.fill();
    
    // –ë–û–ö–û–í–ê–Ø –°–¢–ï–ù–ê (–ª–µ–≤–∞—è)
    ctx.fillStyle = adjustColor(building.dark, 10);
    ctx.beginPath();
    ctx.moveTo(x1, yBase);
    ctx.lineTo(x1 - 20 * camera.z, yBase + 15 * camera.z);
    ctx.lineTo(x1 - 20 * camera.z, yTop + 15 * camera.z);
    ctx.lineTo(x1, yTop);
    ctx.closePath();
    ctx.fill();
    
    // –ö–†–´–®–ê (–æ—Å–Ω–æ–≤–Ω–∞—è)
    ctx.fillStyle = building.accent;
    ctx.shadowBlur = 30 * camera.z;
    ctx.beginPath();
    ctx.moveTo(x1 - 10 * camera.z, yTop + 5 * camera.z);
    ctx.lineTo(x2 - 10 * camera.z, yTop + 5 * camera.z);
    ctx.lineTo(x2 + 10 * camera.z, yTop - 20 * camera.z);
    ctx.lineTo(x1 + 10 * camera.z, yTop - 20 * camera.z);
    ctx.closePath();
    ctx.fill();
    
    // –ê–†–•–ò–¢–ï–ö–¢–£–†–ù–´–ï –î–ï–¢–ê–õ–ò –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ç–∏–ø–∞ –∑–¥–∞–Ω–∏—è
    ctx.shadowBlur = 15 * camera.z;
    
    // –û–ö–ù–ê (–¥–µ—Ç–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ)
    for (let floor = 0; floor < Math.min(4, building.level); floor++) {
        for (let win = 0; win < 4; win++) {
            const winX = x1 + 25 * camera.z + win * 20 * camera.z;
            const winY = yBase - 30 * camera.z - floor * 25 * camera.z;
            
            // –†–∞–º–∞ –æ–∫–Ω–∞
            ctx.fillStyle = '#8B4513';
            ctx.fillRect(winX - 3 * camera.z, winY - 8 * camera.z, 14 * camera.z, 20 * camera.z);
            
            // –°—Ç–µ–∫–ª–æ —Å –æ—Ç—Ä–∞–∂–µ–Ω–∏–µ–º
            ctx.fillStyle = `rgba(255, 255, 220, ${0.7 + Math.sin(game.time * Math.PI) * 0.2})`;
            ctx.fillRect(winX, winY - 5 * camera.z, 8 * camera.z, 14 * camera.z);
            
            // –ë–ª–∏–∫
            ctx.fillStyle = 'rgba(255, 255, 255, 0.4)';
            ctx.fillRect(winX + 2 * camera.z, winY - 8 * camera.z, 2 * camera.z, 3 * camera.z);
        }
    }
    
    // –î–í–ï–†–ò (—Ä–∞–∑–Ω—ã–µ –¥–ª—è –∫–∞–∂–¥–æ–≥–æ —Ç–∏–ø–∞)
    ctx.fillStyle = '#5D4037';
    ctx.fillRect(x1 + w/2 - 8 * camera.z, yBase - 25 * camera.z, 16 * camera.z, 25 * camera.z);
    
    // –†—É—á–∫–∞
    ctx.fillStyle = '#ffd700';
    ctx.beginPath();
    ctx.arc(x1 + w/2 + 5 * camera.z, yBase - 15 * camera.z, 2 * camera.z, 0, Math.PI * 2);
    ctx.fill();
    
    // –£–ù–ò–ö–ê–õ–¨–ù–´–ï –≠–õ–ï–ú–ï–ù–¢–´ –¥–ª—è –∫–∞–∂–¥–æ–≥–æ —Ç–∏–ø–∞
    switch(building.cat) {
        case 'res': // –ë–∞–ª–∫–æ–Ω—ã
            ctx.fillStyle = '#A1887F';
            for (let i = 0; i < 3; i++) {
                ctx.fillRect(x1 + 15 * camera.z + i * 25 * camera.z, yBase - 40 * camera.z, 15 * camera.z, 5 * camera.z);
            }
            break;
            
        case 'com': // –í—ã–≤–µ—Å–∫–∏
            ctx.fillStyle = '#ffd700';
            ctx.font = `bold ${16 * camera.z}px Arial`;
            ctx.fillText('üõçÔ∏è', x1 + w/2, yBase - 50 * camera.z);
            break;
            
        case 'ind': // –¢—Ä—É–±—ã
            ctx.fillStyle = '#795548';
            ctx.fillRect(x2 - 15 * camera.z, yTop - 30 * camera.z, 8 * camera.z, 30 * camera.z);
            break;
            
        case 'fun': // –û–≥–Ω–∏
            ctx.fillStyle = '#ffd700';
            for (let i = 0; i < 4; i++) {
                ctx.beginPath();
                ctx.arc(x1 + 10 * camera.z + i * 25 * camera.z, yTop - 25 * camera.z, 3 * camera.z, 0, Math.PI * 2);
                ctx.fill();
            }
            break;
            
        case 'gov': // –ö–æ–ª–æ–Ω–Ω—ã
            ctx.fillStyle = '#9E9E9E';
            for (let i = 0; i < 2; i++) {
                ctx.fillRect(x1 + 10 * camera.z + i * 40 * camera.z, yBase - 40 * camera.z, 8 * camera.z, 40 * camera.z);
            }
            break;
    }
    
    // –≠–ú–û–î–ó–ò (–ø–∞—Ä–∏—Ç –Ω–∞–¥ –∑–¥–∞–Ω–∏–µ–º)
    ctx.restore();
    ctx.save();
    ctx.shadowColor = 'rgba(0,0,0,0.8)';
    ctx.shadowBlur = 25;
    ctx.font = `bold ${32 * camera.z}px 'Segoe UI Emoji'`;
    ctx.fillStyle = '#fff';
    ctx.textAlign = 'center';
    ctx.textBaseline = 'middle';
    ctx.fillText(building.emoji, p.x, p.y - h - 20 * camera.z);
    ctx.restore();
    
    // –ü–û–î–°–í–ï–¢–ö–ê –ü–†–ò –ù–ê–í–ï–î–ï–ù–ò–ò
    if (isHover) {
        ctx.save();
        ctx.strokeStyle = '#ffd700';
        ctx.lineWidth = 5 * camera.z;
        ctx.shadowColor = '#ffd700';
        ctx.shadowBlur = 40;
        
        // –ö–æ–Ω—Ç—É—Ä –∑–¥–∞–Ω–∏—è
        ctx.beginPath();
        ctx.moveTo(x1, yBase);
        ctx.lineTo(x2, yBase);
        ctx.lineTo(x2 + 20 * camera.z, yBase + 20 * camera.z);
        ctx.lineTo(x2 + 20 * camera.z, yTop + 20 * camera.z);
        ctx.lineTo(x2, yTop);
        ctx.lineTo(x1, yTop);
        ctx.lineTo(x1 - 20 * camera.z, yTop - 20 * camera.z);
        ctx.lineTo(x1 - 20 * camera.z, yBase - 20 * camera.z);
        ctx.closePath();
        ctx.stroke();
        ctx.restore();
    }
}

function adjustColor(color, percent) {
    const num = parseInt(color.replace('#', ''), 16);
    const r = Math.min(255, Math.max(0, (num >> 16) + percent));
    const g = Math.min(255, Math.max(0, ((num >> 8) & 0x00FF) + percent));
    const b = Math.min(255, Math.max(0, (num & 0x0000FF) + percent));
    return '#' + (0x1000000 + (r << 16) + (g << 8) + b).toString(16).slice(1);
}

function drawCell(r, c) {
    const p = iso(r, c);
    
    // –¢–µ–∫—Å—Ç—É—Ä–∞ –∑–µ–º–ª–∏ —Å –≥—Ä–∞–¥–∏–µ–Ω—Ç–æ–º
    let baseColor = '#7cb57c';
    if (game.weather === 1) baseColor = '#5a8f5a';
    if (game.weather === 2) baseColor = '#d8e8f0';
    
    ctx.save();
    
    // –ì—Ä–∞–¥–∏–µ–Ω—Ç –¥–ª—è –æ–±—ä–µ–º–∞
    const gradient = ctx.createLinearGradient(p.x - 20, p.y - 10, p.x + 20, p.y + 10);
    gradient.addColorStop(0, adjustColor(baseColor, 20));
    gradient.addColorStop(1, adjustColor(baseColor, -20));
    
    ctx.fillStyle = gradient;
    ctx.shadowColor = 'rgba(0,0,0,0.4)';
    ctx.shadowBlur = 8;
    ctx.shadowOffsetX = 3;
    ctx.shadowOffsetY = 3;
    
    ctx.beginPath();
    ctx.moveTo(p.x, p.y);
    ctx.lineTo(p.x + CELL/2 * camera.z, p.y + CELL/4 * camera.z);
    ctx.lineTo(p.x, p.y + CELL/2 * camera.z);
    ctx.lineTo(p.x - CELL/2 * camera.z, p.y + CELL/4 * camera.z);
    ctx.closePath();
    ctx.fill();
    
    // –¢–µ–∫—Å—Ç—É—Ä–∞
    ctx.strokeStyle = 'rgba(0,0,0,0.15)';
    ctx.lineWidth = 1;
    for (let i = 0; i < 4; i++) {
        ctx.beginPath();
        ctx.moveTo(p.x - 12 * camera.z + i * 15 * camera.z, p.y + 5 * camera.z);
        ctx.lineTo(p.x - 18 * camera.z + i * 15 * camera.z, p.y + 15 * camera.z);
        ctx.stroke();
    }
    
    ctx.restore();
}

function draw() {
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    
    // –ù–µ–±–æ —Å –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–º –≥—Ä–∞–¥–∏–µ–Ω—Ç–æ–º
    const skyGradient = ctx.createLinearGradient(0, 0, 0, canvas.height);
    const nightColor = '#0a1a2a';
    const dayColor = '#87CEEB';
    const sunsetColor = '#FF7F50';
    
    let skyTop, skyBottom;
    if (game.time < 0.25) { skyTop = nightColor; skyBottom = '#1a2a3a'; }
    else if (game.time < 0.5) { skyTop = sunsetColor; skyBottom = dayColor; }
    else if (game.time < 0.75) { skyTop = dayColor; skyBottom = '#B0E0E6'; }
    else { skyTop = sunsetColor; skyBottom = nightColor; }
    
    skyGradient.addColorStop(0, skyTop);
    skyGradient.addColorStop(1, skyBottom);
    ctx.fillStyle = skyGradient;
    ctx.fillRect(0, 0, canvas.width, canvas.height);
    
    // –°–æ–ª–Ω—Ü–µ/–õ—É–Ω–∞
    ctx.save();
    ctx.shadowBlur = 70;
    ctx.shadowColor = '#ffd700';
    ctx.beginPath();
    ctx.arc(canvas.width - 120, 120, 70, 0, Math.PI * 2);
    ctx.fillStyle = game.time < 0.5 || game.time > 0.75 ? '#ffd700' : '#fff';
    ctx.globalAlpha = 0.9;
    ctx.fill();
    ctx.restore();
    
    // –û—Ç—Ä–∏—Å–æ–≤–∫–∞ –º–∏—Ä–∞
    for (let r = 0; r < GRID; r++) {
        for (let c = 0; c < GRID; c++) {
            drawCell(r, c);
            
            const buildingId = game.grid[r][c];
            if (buildingId) {
                const building = buildings[buildingId];
                const model = buildingModels[buildingId];
                drawBuilding3D(r, c, building, model, r === hoverRow && c === hoverCol);
            }
        }
    }
    
    // –ü–æ–≥–æ–¥–Ω—ã–µ —ç—Ñ—Ñ–µ–∫—Ç—ã
    if (game.weather === 1) { // –î–æ–∂–¥—å
        for (let i = 0; i < 80; i++) {
            if (Math.random() < 0.1) {
                ctx.save();
                ctx.strokeStyle = 'rgba(255, 255, 255, 0.3)';
                ctx.lineWidth = 2;
                ctx.beginPath();
                ctx.moveTo(Math.random() * canvas.width, Math.random() * canvas.height);
                ctx.lineTo(Math.random() * canvas.width + 15, Math.random() * canvas.height + 30);
                ctx.stroke();
                ctx.restore();
            }
        }
    } else if (game.weather === 2) { // –°–Ω–µ–≥
        for (let i = 0; i < 50; i++) {
            if (Math.random() < 0.05) {
                ctx.save();
                ctx.fillStyle = 'rgba(255, 255, 255, 0.7)';
                ctx.shadowBlur = 15;
                ctx.shadowColor = '#fff';
                ctx.beginPath();
                ctx.arc(Math.random() * canvas.width, Math.random() * canvas.height, 4, 0, Math.PI * 2);
                ctx.fill();
                ctx.restore();
            }
        }
    }
    
    updateTimeIndicator();
}

// –û—Å–Ω–æ–≤–Ω–æ–π —Ü–∏–∫–ª —Å –ø–ª–∞–≤–Ω–æ–π –∫–∞–º–µ—Ä–æ–π
function gameLoop() {
    camera.update();
    draw();
    requestAnimationFrame(gameLoop);
}

gameLoop();

// –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è
canvas.onmousedown = (e) => {
    drag = true;
    lx = e.clientX;
    ly = e.clientY;
    lastMouseX = e.clientX;
    lastMouseY = e.clientY;
};

canvas.onmouseup = () => {
    drag = false;
};

canvas.onmousemove = (e) => {
    if (drag) {
        const dx = e.clientX - lx;
        const dy = e.clientY - ly;
        camera.move(dx, dy);
        lx = e.clientX;
        ly = e.clientY;
    }
    
    // –•–æ–≤–µ—Ä
    const rect = canvas.getBoundingClientRect();
    let mx = e.clientX - rect.left;
    let my = e.clientY - rect.top;
    
    hoverRow = -1;
    hoverCol = -1;
    let bestDist = Infinity;
    
    for (let r = 0; r < GRID; r++) {
        for (let c = 0; c < GRID; c++) {
            const p = iso(r, c);
            const dist = Math.hypot(mx - p.x, my - p.y);
            if (dist < 60 && dist < bestDist) {
                bestDist = dist;
                hoverRow = r;
                hoverCol = c;
            }
        }
    }
};

canvas.onwheel = (e) => {
    e.preventDefault();
    camera.zoom(e.deltaY > 0 ? -0.12 : 0.12);
};

canvas.onclick = (e) => {
    if (hoverRow !== -1 && hoverCol !== -1 && selected) {
        build(hoverRow, hoverCol);
    }
};

// –ò–≥—Ä–æ–≤—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏
function build(r, c) {
    const building = buildings[selected];
    if (!building) return;
    
    if (game.money < building.price) {
        info.innerText = '‚ùå –ù–ï–î–û–°–¢–ê–¢–û–ß–ù–û –°–†–ï–î–°–¢–í!';
        return;
    }
    
    if (game.grid[r][c]) {
        info.innerText = '‚ùå –ö–õ–ï–¢–ö–ê –ó–ê–ù–Ø–¢–ê!';
        return;
    }
    
    game.money -= building.price;
    game.grid[r][c] = building.id;
    game.pop += building.pop;
    game.cnt++;
    
    info.innerText = `‚úÖ –ü–û–°–¢–†–û–ï–ù–û: ${building.name}`;
    update();
}

function collect() {
    let total = 0;
    for (let r = 0; r < GRID; r++) {
        for (let c = 0; c < GRID; c++) {
            const id = game.grid[r][c];
            if (id) total += buildings[id].inc;
        }
    }
    game.money += total;
    info.innerText = `üí∞ –°–û–ë–†–ê–ù–û: ${total.toLocaleString()}`;
    update();
}

function weather() {
    game.weather = (game.weather + 1) % 3;
    const weatherNames = ['‚òÄÔ∏è –Ø–°–ù–û', 'üåßÔ∏è –î–û–ñ–î–¨', '‚ùÑÔ∏è –°–ù–ï–ì'];
    info.innerText = weatherNames[game.weather];
}

function timeDay() {
    game.time = (game.time + 0.2) % 1;
    updateTimeIndicator();
}

function cancel() {
    selected = null;
    info.innerText = 'üèóÔ∏è –í–´–ë–ï–†–ò–¢–ï –ó–î–ê–ù–ò–ï';
    document.querySelectorAll('.item').forEach(i => i.classList.remove('selected'));
}

function resetGame() {
    if (confirm('üí∞ –ù–ê–ß–ê–¢–¨ –ù–û–í–´–ô –ì–û–†–û–î?')) {
        location.reload();
    }
}

function update() {
    document.getElementById('money').innerText = game.money.toLocaleString();
    document.getElementById('pop').innerText = game.pop.toLocaleString();
    
    let totalInc = 0;
    for (let r = 0; r < GRID; r++) {
        for (let c = 0; c < GRID; c++) {
            const id = game.grid[r][c];
            if (id) totalInc += buildings[id].inc;
        }
    }
    document.getElementById('inc').innerText = totalInc.toLocaleString();
    document.getElementById('cnt').innerText = `${game.cnt}/1600`;
}

function updateTimeIndicator() {
    const indicator = document.getElementById('timeIndicator');
    if (game.time < 0.2) indicator.innerHTML = 'üåô –ù–û–ß–¨';
    else if (game.time < 0.4) indicator.innerHTML = 'üåÖ –£–¢–†–û';
    else if (game.time < 0.6) indicator.innerHTML = '‚òÄÔ∏è –ü–û–õ–î–ï–ù–¨';
    else if (game.time < 0.8) indicator.innerHTML = 'üåÜ –í–ï–ß–ï–†';
    else indicator.innerHTML = 'üåô –ù–û–ß–¨';
}

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è UI
const catsDiv = document.getElementById('cats');
const listDiv = document.getElementById('list');
const info = document.getElementById('info');

cats.forEach(cat => {
    const btn = document.createElement('button');
    btn.innerHTML = `${cat.e} ${cat.n}`;
    btn.style.background = `linear-gradient(135deg, ${cat.color}40, ${cat.dark}40)`;
    btn.onclick = () => {
        listDiv.innerHTML = '';
        const filtered = all.filter(b => b.cat === cat.id);
        
        filtered.forEach(building => {
            const item = document.createElement('div');
            item.className = 'item';
            item.innerHTML = `
                <div class="building-preview" style="background: linear-gradient(135deg, ${building.color}80, ${building.dark}80)">
                    ${building.emoji}
                </div>
                <div style="flex:1">
                    <div style="font-weight:bold; font-size:20px; color:#ffd700">${building.name}</div>
                    <div style="display:flex; gap:20px; margin-top:8px; font-size:16px;">
                        <span style="color:#ffd700">üí∞ ${building.price.toLocaleString()}</span>
                        <span style="color:#4CAF50">‚ö° ${building.inc}</span>
                        <span style="color:#2196F3">üë• ${building.pop}</span>
                    </div>
                </div>
            `;
            
            item.onclick = (e) => {
                e.stopPropagation();
                document.querySelectorAll('.item').forEach(i => i.classList.remove('selected'));
                item.classList.add('selected');
                selected = building.id;
                info.innerText = `üèóÔ∏è –í–´–ë–†–ê–ù–û: ${building.name}`;
            };
            
            listDiv.appendChild(item);
        });
    };
    catsDiv.appendChild(btn);
});

update();
</script>
</body>
</html>
