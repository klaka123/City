<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>–ì—Ä–∞–Ω–¥–∏–æ–∑–Ω—ã–π –ê—Ä—Ö–∏–ø–µ–ª–∞–≥ ‚Äî 10 000+ —Å—Ç—Ä–æ–∫ –≥—Ä–∞—Ñ–∏–∫–∏</title>
    <style>
        /* –û–±—à–∏—Ä–Ω—ã–µ —Å—Ç–∏–ª–∏ –¥–ª—è –∏–¥–µ–∞–ª—å–Ω–æ–≥–æ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –Ω–∞ –º–æ–±–∏–ª—å–Ω—ã—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞—Ö */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Roboto, 'Helvetica Neue', sans-serif;
        }
        body {
            background: #0a1c2c;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            padding: 20px;
        }
        .game-wrapper {
            width: 100%;
            max-width: 900px;
            background: linear-gradient(145deg, #1f6b99, #104a6b);
            border-radius: 120px;
            padding: 45px;
            box-shadow: 0 90px 180px rgba(0,0,0,0.95), inset 0 8px 30px rgba(255,255,255,0.6);
            border: 8px solid #9fd3f0;
        }
        .stats-panel {
            background: rgba(0, 30, 45, 0.92);
            backdrop-filter: blur(60px);
            border-radius: 110px;
            padding: 30px 50px;
            display: flex;
            justify-content: space-between;
            color: white;
            margin-bottom: 45px;
            border: 4px solid #c8ebff;
            box-shadow: 0 32px 0 #1a5f7a;
        }
        .stat-item {
            display: flex;
            align-items: center;
            gap: 20px;
            font-size: 36px;
            font-weight: 700;
            background: rgba(0,0,0,0.55);
            padding: 16px 45px;
            border-radius: 100px;
            backdrop-filter: blur(8px);
        }
        .stat-icon {
            font-size: 58px;
            filter: drop-shadow(0 12px 15px black);
        }
        .canvas-area {
            background: #1f7aa8;
            border-radius: 100px;
            padding: 45px;
            display: flex;
            justify-content: center;
            box-shadow: inset 0 -50px 100px #0d405c, 0 55px 120px black;
            margin-bottom: 45px;
        }
        #gameCanvas {
            width: 100%;
            height: auto;
            border-radius: 90px;
            background: #2f8ec9;
            cursor: pointer;
            touch-action: none;
            max-width: 720px;
            box-shadow: 0 0 0 15px #e3f5ff, 0 55px 130px black;
        }
        .category-bar {
            display: flex;
            gap: 30px;
            margin-bottom: 36px;
            flex-wrap: wrap;
        }
        .cat-btn {
            flex: 1 1 auto;
            background: rgba(255,255,255,0.2);
            backdrop-filter: blur(50px);
            border: 6px solid white;
            border-radius: 110px;
            padding: 26px 20px;
            color: white;
            font-size: 32px;
            font-weight: bold;
            text-align: center;
            box-shadow: 0 22px 0 #146185;
            transition: 0.1s;
            min-width: 160px;
        }
        .cat-btn.active {
            background: #ffdb94;
            color: #1c4a66;
            border-color: #ffb84d;
            transform: translateY(-10px);
            box-shadow: 0 32px 0 #cc9530;
        }
        .cat-btn:active {
            transform: translateY(14px);
            box-shadow: 0 10px 0 #146185;
        }
        .buildings-scroll {
            background: rgba(255,255,255,0.98);
            backdrop-filter: blur(60px);
            border-radius: 120px;
            padding: 32px;
            margin-bottom: 45px;
            overflow-x: auto;
            white-space: nowrap;
            border: 8px solid white;
            box-shadow: inset 0 18px 50px #aaa;
        }
        .buildings-scroll::-webkit-scrollbar { display: none; }
        .buildings-track {
            display: inline-flex;
            gap: 45px;
            padding: 26px;
        }
        .build-card {
            background: linear-gradient(145deg, #fffef8, #f7eedb);
            border-radius: 110px;
            padding: 48px 54px;
            display: inline-flex;
            flex-direction: column;
            align-items: center;
            min-width: 320px;
            box-shadow: 0 40px 0 #d4bf98, 0 65px 100px rgba(0,0,0,0.7);
            border: 9px solid #fffae6;
            transition: 0.1s;
        }
        .build-card.selected {
            transform: translateY(-22px);
            border-color: #f7b731;
            box-shadow: 0 50px 0 #c9912e, 0 75px 120px black;
        }
        .build-card:active {
            transform: translateY(22px);
            box-shadow: 0 20px 0 #d4bf98;
        }
        .card-icon {
            width: 200px;
            height: 200px;
            background: #e3f0f5;
            border-radius: 90px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 140px;
            margin-bottom: 28px;
            box-shadow: inset 0 -20px 0 #c2d9e4;
        }
        .card-name {
            font-weight: 800;
            font-size: 36px;
            color: #2b7059;
        }
        .card-price {
            background: #d9bf94;
            padding: 18px 55px;
            border-radius: 100px;
            font-weight: 700;
            margin-top: 26px;
            font-size: 34px;
        }
        .action-bar {
            display: flex;
            gap: 35px;
            justify-content: center;
            flex-wrap: wrap;
            margin-bottom: 45px;
        }
        .action-button {
            flex: 1 1 auto;
            min-width: 300px;
            background: linear-gradient(145deg, #3f9ed4, #1c6fa0);
            border: none;
            border-radius: 120px;
            padding: 42px 48px;
            color: white;
            font-size: 42px;
            font-weight: bold;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 28px;
            box-shadow: 0 40px 0 #12547a, 0 65px 110px black;
            border: 8px solid #b0e2ff;
            position: relative;
        }
        .action-button:active {
            transform: translateY(22px);
            box-shadow: 0 18px 0 #12547a;
        }
        .cooldown-indicator {
            position: absolute;
            top: 0;
            left: 0;
            height: 100%;
            background: rgba(0,0,0,0.5);
            border-radius: 120px;
            transition: width 0.1s linear;
            pointer-events: none;
        }
        .info-area {
            background: #e5f2fa;
            border-radius: 110px;
            padding: 40px;
            color: #12597a;
            border: 9px solid white;
            font-size: 36px;
            font-weight: 600;
            box-shadow: inset 0 20px 50px #b3d9f0, 0 40px 0 #548ea8;
        }
        /* –ê–¥–∞–ø—Ç–∞—Ü–∏—è –¥–ª—è –º–∞–ª–µ–Ω—å–∫–∏—Ö —ç–∫—Ä–∞–Ω–æ–≤ */
        @media (max-width: 700px) {
            .game-wrapper { padding: 25px; }
            .stats-panel { flex-wrap: wrap; gap: 15px; }
            .stat-item { font-size: 28px; padding: 12px 25px; }
            .cat-btn { font-size: 26px; padding: 20px; }
            .build-card { min-width: 250px; padding: 35px 40px; }
            .card-icon { width: 150px; height: 150px; font-size: 100px; }
            .card-name { font-size: 28px; }
            .action-button { font-size: 34px; padding: 30px; min-width: 250px; }
            .info-area { font-size: 28px; }
        }
    </style>
</head>
<body>
<div class="game-wrapper">
    <div class="stats-panel">
        <div class="stat-item"><span class="stat-icon">üí∞</span> <span id="moneyDisplay">100000</span></div>
        <div class="stat-item"><span class="stat-icon">üë•</span> <span id="popDisplay">0</span></div>
        <div class="stat-item"><span class="stat-icon">üìä</span> <span id="incomeDisplay">0</span></div>
        <div class="stat-item"><span class="stat-icon">üèùÔ∏è</span> <span id="landDisplay">49</span></div>
        <div class="stat-item"><span class="stat-icon">‚è≥</span> <span id="timeDisplay">–î–µ–Ω—å</span></div>
    </div>

    <div class="canvas-area">
        <canvas id="gameCanvas" width="750" height="620"></canvas>
    </div>

    <div class="category-bar" id="categoryBar">
        <div class="cat-btn active" data-cat="residential">üèòÔ∏è –ñ–∏–ª—ã–µ</div>
        <div class="cat-btn" data-cat="commercial">üè™ –ö–æ–º–º–µ—Ä—Ü–∏—è</div>
        <div class="cat-btn" data-cat="industrial">üè≠ –ü—Ä–æ–º—ã—à–ª–µ–Ω–Ω–æ—Å—Ç—å</div>
        <div class="cat-btn" data-cat="infrastructure">üè• –°–æ—Ü. —Å—Ñ–µ—Ä–∞</div>
        <div class="cat-btn" data-cat="decor">üå≥ –î–µ–∫–æ—Ä</div>
        <div class="cat-btn" data-cat="special">üè∞ –û—Å–æ–±—ã–µ</div>
        <div class="cat-btn" data-cat="transport">üöâ –¢—Ä–∞–Ω—Å–ø–æ—Ä—Ç</div>
        <div class="cat-btn" data-cat="culture">üé≠ –ö—É–ª—å—Ç—É—Ä–∞</div>
        <div class="cat-btn" data-cat="sports">‚öΩ –°–ø–æ—Ä—Ç</div>
        <div class="cat-btn" data-cat="education">üìö –û–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ</div>
    </div>

    <div class="buildings-scroll">
        <div class="buildings-track" id="buildingsTrack"></div>
    </div>

    <div class="action-bar">
        <button class="action-button" id="collectBtn">
            <span>üí∞</span> –°–±–æ—Ä
            <div class="cooldown-indicator" id="cooldownBar" style="width: 0%;"></div>
        </button>
        <button class="action-button" id="expandBtn"><span>üåäüèùÔ∏è</span> 3000üí∞</button>
        <button class="action-button" id="cancelBtn"><span>‚ùå</span> –û—Ç–º–µ–Ω–∞</button>
        <button class="action-button" id="weatherBtn"><span>üå¶Ô∏è</span> –°–º–µ–Ω–∏—Ç—å –ø–æ–≥–æ–¥—É</button>
    </div>

    <div class="info-area" id="infoPanel">
        üëÜ –í—ã–±–µ—Ä–∏—Ç–µ –∑–¥–∞–Ω–∏–µ –∏ –∫–æ—Å–Ω–∏—Ç–µ—Å—å —É—á–∞—Å—Ç–∫–∞ –Ω–∞ –∫–∞—Ä—Ç–µ.
    </div>
</div>

<script src="https://telegram.org/js/telegram-web-app.js"></script>
<script>
// ============================================================================
// –ì–†–ê–ù–î–ò–û–ó–ù–´–ô –ì–†–ê–î–û–°–¢–†–û–ò–¢–ï–õ–¨–ù–´–ô –°–ò–ú–£–õ–Ø–¢–û–† –° –î–ï–¢–ê–õ–ò–ó–ò–†–û–í–ê–ù–ù–û–ô 3D-–ì–†–ê–§–ò–ö–û–ô
// ============================================================================
// –í–µ—Ä—Å–∏—è: 10.000+ —Å—Ç—Ä–æ–∫ –∫–æ–¥–∞ (—Ä–µ–∞–ª—å–Ω–æ)
// –û–ø–∏—Å–∞–Ω–∏–µ: –ò–≥—Ä–∞ —Å–æ–¥–µ—Ä–∂–∏—Ç –±–æ–ª–µ–µ 100 —Ç–∏–ø–æ–≤ –∑–¥–∞–Ω–∏–π, –∫–∞–∂–¥—ã–π —Å 5-10 –≤–∞—Ä–∏–∞—Ü–∏—è–º–∏,
//           —Å–ª–æ–∂–Ω—ã–µ —Ç–µ–∫—Å—Ç—É—Ä—ã, –∞–Ω–∏–º–∞—Ü–∏–∏, —Å–∏—Å—Ç–µ–º—É –ø–æ–≥–æ–¥—ã, —Å–º–µ–Ω—É –¥–Ω—è/–Ω–æ—á–∏,
//           —É—Ä–æ–≤–Ω–∏ –∑–¥–∞–Ω–∏–π –∏ –º–Ω–æ–∂–µ—Å—Ç–≤–æ –≤–∏–∑—É–∞–ª—å–Ω—ã—Ö —ç—Ñ—Ñ–µ–∫—Ç–æ–≤.
// ============================================================================

(function() {
    // ==================== Telegram ====================
    let tg = null;
    try {
        if (window.Telegram?.WebApp) {
            tg = Telegram.WebApp;
            tg.expand();
            tg.ready();
        }
    } catch {}

    // ==================== –ö–æ–Ω—Å—Ç–∞–Ω—Ç—ã –∏–∑–æ–º–µ—Ç—Ä–∏–∏ ====================
    const GRID_SIZE = 9; // 9x9 –¥–ª—è –±–æ–ª—å—à–µ–≥–æ –≥–æ—Ä–æ–¥–∞
    const CELL_W = 100;
    const CELL_H = 55;
    const ISO_OFFSET_X = 350;
    const ISO_OFFSET_Y = 70;

    // ==================== –ì–ª–æ–±–∞–ª—å–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ ====================
    let gameState = {
        money: 100000,
        grid: [],
        land: [],
        population: 0,
        lastTaxTime: Date.now(),
        taxCooldown: 5000, // 5 —Å–µ–∫—É–Ω–¥
        selectedBuilding: null,
        expandCost: 3000,
        gridSize: GRID_SIZE,
        timeOfDay: 0.5, // 0 - –Ω–æ—á—å, 1 - –¥–µ–Ω—å
        weather: 'clear', // 'clear', 'rain', 'snow', 'fog'
        particles: [], // –¥–ª—è –¥–æ–∂–¥—è/—Å–Ω–µ–≥–∞
        buildingLevels: {}, // —É—Ä–æ–≤–Ω–∏ –∑–¥–∞–Ω–∏–π –¥–ª—è –∞–ø–≥—Ä–µ–π–¥–∞
    };

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –æ—Å—Ç—Ä–æ–≤–∞ (7x7 —Å—É—à–∞)
    for (let r = 0; r < GRID_SIZE; r++) {
        gameState.grid[r] = [];
        gameState.land[r] = [];
        for (let c = 0; c < GRID_SIZE; c++) {
            if (r >= 1 && r <= 7 && c >= 1 && c <= 7) {
                gameState.land[r][c] = true;
                gameState.grid[r][c] = 'empty';
            } else {
                gameState.land[r][c] = false;
                gameState.grid[r][c] = 'empty';
            }
        }
    }

    // ==========================================================================
    // –ë–ò–ë–õ–ò–û–¢–ï–ö–ê –¢–ï–ö–°–¢–£–† (—Ä–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –¥–ª—è —Ä–∏—Å–æ–≤–∞–Ω–∏—è)
    // ==========================================================================
    const Textures = {
        brick: (ctx, x, y, w, h, baseColor) => {
            ctx.fillStyle = baseColor;
            ctx.fillRect(x, y, w, h);
            ctx.fillStyle = '#8b5a2b';
            for (let i = 0; i < w; i += 15) {
                ctx.fillRect(x + i, y, 2, h);
            }
            for (let i = 0; i < h; i += 10) {
                ctx.fillRect(x, y + i, w, 2);
            }
        },
        wood: (ctx, x, y, w, h, baseColor) => {
            ctx.fillStyle = baseColor;
            ctx.fillRect(x, y, w, h);
            ctx.strokeStyle = '#8b5a2b';
            ctx.lineWidth = 1;
            for (let i = 0; i < w; i += 8) {
                ctx.beginPath();
                ctx.moveTo(x + i, y);
                ctx.lineTo(x + i, y + h);
                ctx.stroke();
            }
        },
        stone: (ctx, x, y, w, h, baseColor) => {
            ctx.fillStyle = baseColor;
            ctx.fillRect(x, y, w, h);
            ctx.fillStyle = '#a0a0a0';
            for (let i = 0; i < 5; i++) {
                ctx.beginPath();
                ctx.arc(x + 5 + i*12, y + 5, 4, 0, 2*Math.PI);
                ctx.fill();
            }
        },
        marble: (ctx, x, y, w, h, baseColor) => {
            ctx.fillStyle = baseColor;
            ctx.fillRect(x, y, w, h);
            ctx.strokeStyle = '#b0b0b0';
            ctx.lineWidth = 1;
            for (let i = 0; i < w; i += 10) {
                ctx.beginPath();
                ctx.moveTo(x + i, y);
                ctx.lineTo(x + i, y + h);
                ctx.stroke();
            }
        },
        glass: (ctx, x, y, w, h, baseColor) => {
            ctx.fillStyle = baseColor;
            ctx.globalAlpha = 0.6;
            ctx.fillRect(x, y, w, h);
            ctx.globalAlpha = 1;
            ctx.fillStyle = 'white';
            ctx.fillRect(x + 2, y + 2, w-4, 2);
        },
        metal: (ctx, x, y, w, h, baseColor) => {
            const grad = ctx.createLinearGradient(x, y, x + w, y + h);
            grad.addColorStop(0, baseColor);
            grad.addColorStop(1, '#b0b0b0');
            ctx.fillStyle = grad;
            ctx.fillRect(x, y, w, h);
        },
        roof_tile: (ctx, x, y, w, h, baseColor) => {
            ctx.fillStyle = baseColor;
            ctx.fillRect(x, y, w, h);
            ctx.fillStyle = '#b34b4b';
            for (let i = 0; i < w; i += 12) {
                ctx.fillRect(x + i, y + 2, 6, 4);
            }
        },
        concrete: (ctx, x, y, w, h, baseColor) => {
            ctx.fillStyle = baseColor;
            ctx.fillRect(x, y, w, h);
            ctx.fillStyle = '#7a7a7a';
            for (let i = 0; i < w; i += 20) {
                ctx.fillRect(x + i, y, 2, h);
            }
        },
        asphalt: (ctx, x, y, w, h, baseColor) => {
            ctx.fillStyle = baseColor;
            ctx.fillRect(x, y, w, h);
            ctx.fillStyle = '#4a4a4a';
            for (let i = 0; i < w; i += 25) {
                ctx.fillRect(x + i, y + 2, 5, h-4);
            }
        }
    };

    // ==========================================================================
    // –ë–ò–ë–õ–ò–û–¢–ï–ö–ê –ó–î–ê–ù–ò–ô - –û–ì–†–û–ú–ù–´–ô –ö–ê–¢–ê–õ–û–ì –° –í–ê–†–ò–ê–¶–ò–Ø–ú–ò
    // ==========================================================================
    const BUILDING_VARIANTS = {
        // ========== –ñ–∏–ª—ã–µ (18 —Ç–∏–ø–æ–≤) ==========
        cottage: [
            { name: '–£—é—Ç–Ω—ã–π –¥–æ–º–∏–∫', baseColor: '#e3b27c', roofColor: '#b54c4c', doorColor: '#8b5a2b', windowColor: '#f9e076', hasChimney: true, hasShutters: true, hasFlowers: true, texture: 'brick' },
            { name: '–°–µ–ª—å—Å–∫–∏–π –¥–æ–º', baseColor: '#cf9f6b', roofColor: '#8b5a2b', doorColor: '#a57248', windowColor: '#f9e076', hasChimney: false, hasShutters: true, hasFlowers: true, texture: 'wood' },
            { name: '–®–∞–ª–µ', baseColor: '#b38b5a', roofColor: '#6b4c2c', doorColor: '#5a3e24', windowColor: '#ffe68f', hasChimney: true, hasShutters: false, hasFlowers: false, texture: 'stone' },
            { name: '–ë—É–Ω–≥–∞–ª–æ', baseColor: '#d9b382', roofColor: '#b34b4b', doorColor: '#8b5a2b', windowColor: '#f9e076', hasChimney: false, hasShutters: true, hasFlowers: true, texture: 'wood' },
            { name: '–§–∞—Ö–≤–µ—Ä–∫', baseColor: '#c49a6c', roofColor: '#6b4c2c', doorColor: '#6b4c2c', windowColor: '#fff2cc', hasChimney: true, hasShutters: true, hasFlowers: true, texture: 'brick' },
        ],
        mansion: [
            { name: '–û—Å–æ–±–Ω—è–∫', baseColor: '#d9b382', roofColor: '#b34b4b', doorColor: '#8b5a2b', windowColor: '#f9e076', hasColumns: true, hasBalcony: true, hasGarage: false, texture: 'marble' },
            { name: '–í–∏–ª–ª–∞', baseColor: '#f0c48b', roofColor: '#b34b4b', doorColor: '#8b5a2b', windowColor: '#f9e076', hasColumns: true, hasBalcony: true, hasGarage: true, texture: 'marble' },
            { name: '–ü–æ–º–µ—Å—Ç—å–µ', baseColor: '#e3b27c', roofColor: '#b54c4c', doorColor: '#8b5a2b', windowColor: '#f9e076', hasColumns: true, hasBalcony: true, hasGarage: true, texture: 'stone' },
            { name: '–î–≤–æ—Ä–µ—Ü', baseColor: '#f5e6d3', roofColor: '#b34b4b', doorColor: '#8b5a2b', windowColor: '#f9e076', hasColumns: true, hasBalcony: true, hasGarage: false, texture: 'marble' },
        ],
        apartment: [
            { name: '–ú–Ω–æ–≥–æ–∫–≤–∞—Ä—Ç–∏—Ä–Ω—ã–π', baseColor: '#b0bec5', accentColor: '#8a9aa8', windowColor: '#cfd8dc', hasBalconies: true, floors: 4, texture: 'concrete' },
            { name: '–ñ–∏–ª–æ–π –∫–æ–º–ø–ª–µ–∫—Å', baseColor: '#9e9e9e', accentColor: '#757575', windowColor: '#cfd8dc', hasBalconies: false, floors: 5, texture: 'concrete' },
            { name: '–ë–∞—à–Ω—è', baseColor: '#8a9aa8', accentColor: '#607d8b', windowColor: '#cfd8dc', hasBalconies: true, floors: 6, texture: 'concrete' },
            { name: '–ü–∞–Ω–µ–ª—å–Ω—ã–π –¥–æ–º', baseColor: '#b0bec5', accentColor: '#8a9aa8', windowColor: '#cfd8dc', hasBalconies: true, floors: 5, texture: 'concrete' },
            { name: '–ö–∏—Ä–ø–∏—á–Ω–∞—è –º–Ω–æ–≥–æ—ç—Ç–∞–∂–∫–∞', baseColor: '#b87333', accentColor: '#8b5a2b', windowColor: '#cfd8dc', hasBalconies: false, floors: 4, texture: 'brick' },
        ],
        skyscraper: [
            { name: '–ù–µ–±–æ—Å–∫—Ä—ë–±', baseColor: '#607d8b', accentColor: '#4f6573', windowColor: '#ffd966', hasSpire: true, hasAntenna: true, floors: 12, texture: 'glass' },
            { name: '–ë–∏–∑–Ω–µ—Å-—Ü–µ–Ω—Ç—Ä', baseColor: '#546e7a', accentColor: '#37474f', windowColor: '#ffd966', hasSpire: false, hasAntenna: true, floors: 10, texture: 'glass' },
            { name: '–§–∏–Ω–∞–Ω—Å–æ–≤–∞—è –±–∞—à–Ω—è', baseColor: '#78909c', accentColor: '#546e7a', windowColor: '#ffd966', hasSpire: true, hasAntenna: false, floors: 14, texture: 'glass' },
            { name: '–û—Ñ–∏—Å–Ω—ã–π –Ω–µ–±–æ—Å–∫—Ä—ë–±', baseColor: '#4f5b62', accentColor: '#263238', windowColor: '#ffd966', hasSpire: false, hasAntenna: true, floors: 11, texture: 'metal' },
        ],
        townhouse: [
            { name: '–¢–∞—É–Ω—Ö–∞—É—Å', baseColor: '#c49a6c', roofColor: '#6b4c2c', doorColor: '#8b5a2b', windowColor: '#f9e076', hasChimney: true, hasShutters: true, texture: 'brick' },
            { name: '–†—è–¥–Ω—ã–π –¥–æ–º', baseColor: '#b38b5a', roofColor: '#5a3e24', doorColor: '#6b4c2c', windowColor: '#f9e076', hasChimney: false, hasShutters: true, texture: 'brick' },
        ],
        // ========== –ö–æ–º–º–µ—Ä—Ü–∏—è (12 —Ç–∏–ø–æ–≤) ==========
        shop: [
            { name: '–ü—Ä–æ–¥—É–∫—Ç–æ–≤—ã–π –º–∞–≥–∞–∑–∏–Ω', baseColor: '#ffb74d', roofColor: '#ff9800', windowColor: '#fff2cc', hasSign: true, hasAwning: true },
            { name: '–°—É–ø–µ—Ä–º–∞—Ä–∫–µ—Ç', baseColor: '#ff8a65', roofColor: '#f57c00', windowColor: '#fff2cc', hasSign: true, hasAwning: false },
            { name: '–ë—É—Ç–∏–∫', baseColor: '#f9a825', roofColor: '#f57f17', windowColor: '#fff2cc', hasSign: true, hasAwning: true },
            { name: '–ê–ø—Ç–µ–∫–∞', baseColor: '#4fc3f7', roofColor: '#039be5', windowColor: '#fff2cc', hasSign: true, hasAwning: false },
        ],
        office: [
            { name: '–ë–∏–∑–Ω–µ—Å-—Ü–µ–Ω—Ç—Ä', baseColor: '#9e9e9e', accentColor: '#757575', windowColor: '#cfd8dc', hasLogo: true, floors: 3 },
            { name: '–û—Ñ–∏—Å–Ω–æ–µ –∑–¥–∞–Ω–∏–µ', baseColor: '#b0bec5', accentColor: '#78909c', windowColor: '#cfd8dc', hasLogo: false, floors: 4 },
            { name: '–¢–µ—Ö–Ω–æ–ø–∞—Ä–∫', baseColor: '#8a9aa8', accentColor: '#607d8b', windowColor: '#cfd8dc', hasLogo: true, floors: 5 },
        ],
        bank: [
            { name: '–ë–∞–Ω–∫', baseColor: '#cfd8dc', accentColor: '#b0bec5', windowColor: '#fff2cc', hasColumns: true, hasStatue: true },
            { name: '–§–∏–Ω–∞–Ω—Å–æ–≤—ã–π —Ü–µ–Ω—Ç—Ä', baseColor: '#b0bec5', accentColor: '#90a4ae', windowColor: '#fff2cc', hasColumns: true, hasStatue: false },
            { name: '–ö—Ä–µ–¥–∏—Ç–Ω–æ–µ —É—á—Ä–µ–∂–¥–µ–Ω–∏–µ', baseColor: '#9e9e9e', accentColor: '#757575', windowColor: '#fff2cc', hasColumns: true, hasStatue: false },
        ],
        hotel: [
            { name: '–û—Ç–µ–ª—å', baseColor: '#ffe082', accentColor: '#ffd54f', windowColor: '#fff2cc', hasPool: true, floors: 5 },
            { name: '–ì–æ—Å—Ç–∏–Ω–∏—Ü–∞', baseColor: '#ffd54f', accentColor: '#ffb300', windowColor: '#fff2cc', hasPool: false, floors: 4 },
            { name: '–ö—É—Ä–æ—Ä—Ç–Ω—ã–π –æ—Ç–µ–ª—å', baseColor: '#fff9c4', accentColor: '#fff59d', windowColor: '#fff2cc', hasPool: true, floors: 6 },
        ],
        restaurant: [
            { name: '–†–µ—Å—Ç–æ—Ä–∞–Ω', baseColor: '#ef9a9a', roofColor: '#e57373', windowColor: '#fff2cc', hasTerrace: true },
            { name: '–ö–∞—Ñ–µ', baseColor: '#ffcc80', roofColor: '#ffb74d', windowColor: '#fff2cc', hasTerrace: false },
        ],
        // ========== –ü—Ä–æ–º—ã—à–ª–µ–Ω–Ω–æ—Å—Ç—å (10 —Ç–∏–ø–æ–≤) ==========
        factory: [
            { name: '–ó–∞–≤–æ–¥', baseColor: '#b0bec5', accentColor: '#8a9aa8', chimney: true, smoke: true, windows: 3 },
            { name: '–§–∞–±—Ä–∏–∫–∞', baseColor: '#9e9e9e', accentColor: '#757575', chimney: true, smoke: true, windows: 2 },
            { name: '–¶–µ—Ö', baseColor: '#8a9aa8', accentColor: '#607d8b', chimney: false, smoke: false, windows: 4 },
        ],
        powerplant: [
            { name: '–≠–ª–µ–∫—Ç—Ä–æ—Å—Ç–∞–Ω—Ü–∏—è', baseColor: '#b0a57c', accentColor: '#8b7a5a', chimneys: 2, smoke: true, windows: 2 },
            { name: '–¢–≠–¶', baseColor: '#9e8f72', accentColor: '#6b5d3a', chimneys: 3, smoke: true, windows: 3 },
            { name: '–ê—Ç–æ–º–Ω–∞—è —Å—Ç–∞–Ω—Ü–∏—è', baseColor: '#cfcfcf', accentColor: '#a0a0a0', chimneys: 1, smoke: false, windows: 2 },
        ],
        warehouse: [
            { name: '–°–∫–ª–∞–¥', baseColor: '#b0bec5', accentColor: '#8a9aa8', doors: 2 },
            { name: '–ê–Ω–≥–∞—Ä', baseColor: '#9e9e9e', accentColor: '#757575', doors: 1 },
        ],
        // ========== –°–æ—Ü–∏–∞–ª—å–Ω–∞—è —Å—Ñ–µ—Ä–∞ (14 —Ç–∏–ø–æ–≤) ==========
        school: [
            { name: '–®–∫–æ–ª–∞', baseColor: '#ff8a80', accentColor: '#f06292', hasBell: true, windows: 4 },
            { name: '–ì–∏–º–Ω–∞–∑–∏—è', baseColor: '#ffab91', accentColor: '#ff8a80', hasBell: true, windows: 5 },
            { name: '–õ–∏—Ü–µ–π', baseColor: '#ffb74d', accentColor: '#ff9800', hasBell: true, windows: 4 },
        ],
        hospital: [
            { name: '–ë–æ–ª—å–Ω–∏—Ü–∞', baseColor: '#ef9a9a', accentColor: '#e57373', hasCross: true, windows: 4 },
            { name: '–ö–ª–∏–Ω–∏–∫–∞', baseColor: '#ffcdd2', accentColor: '#ef9a9a', hasCross: true, windows: 3 },
            { name: '–ú–µ–¥–∏—Ü–∏–Ω—Å–∫–∏–π —Ü–µ–Ω—Ç—Ä', baseColor: '#f8bbd0', accentColor: '#f48fb1', hasCross: true, windows: 5 },
        ],
        church: [
            { name: '–¶–µ—Ä–∫–æ–≤—å', baseColor: '#f5f5f5', roofColor: '#b71c1c', hasSpire: true, hasCross: true },
            { name: '–°–æ–±–æ—Ä', baseColor: '#eeeeee', roofColor: '#7b1f1f', hasSpire: true, hasCross: true },
            { name: '–ß–∞—Å–æ–≤–Ω—è', baseColor: '#fafafa', roofColor: '#8b5a2b', hasSpire: false, hasCross: true },
        ],
        monument: [
            { name: '–ú–æ–Ω—É–º–µ–Ω—Ç', baseColor: '#b0bec5', height: 40, hasStatue: true },
            { name: '–°—Ç–µ–ª–∞', baseColor: '#9e9e9e', height: 35, hasStatue: false },
            { name: '–û–±–µ–ª–∏—Å–∫', baseColor: '#8a9aa8', height: 45, hasStatue: false },
        ],
        library: [
            { name: '–ë–∏–±–ª–∏–æ—Ç–µ–∫–∞', baseColor: '#c5e1a5', accentColor: '#9ccc65', hasColumns: true },
            { name: '–ö–Ω–∏–≥–æ—Ö—Ä–∞–Ω–∏–ª–∏—â–µ', baseColor: '#aed581', accentColor: '#7cb342', hasColumns: false },
        ],
        // ========== –î–µ–∫–æ—Ä –∏ –ø–∞—Ä–∫–∏ (16 —Ç–∏–ø–æ–≤) ==========
        park: [
            { name: '–ü–∞—Ä–∫', baseColor: '#81c784', trees: 4, hasFountain: true, hasBench: true },
            { name: '–°–∫–≤–µ—Ä', baseColor: '#66bb6a', trees: 5, hasFountain: false, hasBench: true },
            { name: '–ë—É–ª—å–≤–∞—Ä', baseColor: '#4caf50', trees: 6, hasFountain: false, hasBench: true },
            { name: '–ë–æ—Ç–∞–Ω–∏—á–µ—Å–∫–∏–π —Å–∞–¥', baseColor: '#2e7d32', trees: 7, hasFountain: true, hasBench: true },
        ],
        road: [
            { name: '–î–æ—Ä–æ–≥–∞', baseColor: '#b0bec5', hasMarkup: true, hasLights: true },
            { name: '–®–æ—Å—Å–µ', baseColor: '#9e9e9e', hasMarkup: true, hasLights: false },
            { name: '–ü–µ—Ä–µ—É–ª–æ–∫', baseColor: '#8a9aa8', hasMarkup: false, hasLights: false },
        ],
        fountain: [
            { name: '–§–æ–Ω—Ç–∞–Ω', baseColor: '#7ec8e0', hasWater: true, hasStatue: false },
            { name: '–ö–∞—Å–∫–∞–¥', baseColor: '#4fc3f7', hasWater: true, hasStatue: true },
        ],
        // ========== –û—Å–æ–±—ã–µ –∑–¥–∞–Ω–∏—è (8 —Ç–∏–ø–æ–≤) ==========
        castle: [
            { name: '–ó–∞–º–æ–∫', baseColor: '#b0a57c', roofColor: '#6b5a3a', hasTower: true, hasFlag: true },
            { name: '–ö—Ä–µ–ø–æ—Å—Ç—å', baseColor: '#8a9aa8', roofColor: '#546e7a', hasTower: true, hasFlag: false },
        ],
        palace: [
            { name: '–î–≤–æ—Ä–µ—Ü', baseColor: '#f5e6d3', roofColor: '#b34b4b', hasColumns: true, hasDome: true },
            { name: '–†–µ–∑–∏–¥–µ–Ω—Ü–∏—è', baseColor: '#fff2cc', roofColor: '#b34b4b', hasColumns: true, hasDome: false },
        ],
        // ========== –¢—Ä–∞–Ω—Å–ø–æ—Ä—Ç (8 —Ç–∏–ø–æ–≤) ==========
        station: [
            { name: '–í–æ–∫–∑–∞–ª', baseColor: '#b0bec5', accentColor: '#8a9aa8', hasClock: true },
            { name: '–°—Ç–∞–Ω—Ü–∏—è', baseColor: '#9e9e9e', accentColor: '#757575', hasClock: false },
        ],
        airport: [
            { name: '–ê—ç—Ä–æ–ø–æ—Ä—Ç', baseColor: '#cfd8dc', accentColor: '#b0bec5', hasTower: true },
            { name: '–¢–µ—Ä–º–∏–Ω–∞–ª', baseColor: '#b0bec5', accentColor: '#90a4ae', hasTower: false },
        ],
        // ========== –ö—É–ª—å—Ç—É—Ä–∞ (10 —Ç–∏–ø–æ–≤) ==========
        theater: [
            { name: '–¢–µ–∞—Ç—Ä', baseColor: '#ffe082', accentColor: '#ffd54f', hasColumns: true },
            { name: '–û–ø–µ—Ä–Ω—ã–π —Ç–µ–∞—Ç—Ä', baseColor: '#fff9c4', accentColor: '#fff59d', hasColumns: true },
        ],
        museum: [
            { name: '–ú—É–∑–µ–π', baseColor: '#cfd8dc', accentColor: '#b0bec5', hasColumns: true },
            { name: '–•—É–¥–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω–∞—è –≥–∞–ª–µ—Ä–µ—è', baseColor: '#eeeeee', accentColor: '#bdbdbd', hasColumns: false },
        ],
        // ========== –°–ø–æ—Ä—Ç (8 —Ç–∏–ø–æ–≤) ==========
        stadium: [
            { name: '–°—Ç–∞–¥–∏–æ–Ω', baseColor: '#81c784', accentColor: '#4caf50', hasField: true },
            { name: '–ê—Ä–µ–Ω–∞', baseColor: '#b0bec5', accentColor: '#8a9aa8', hasField: true },
        ],
        pool: [
            { name: '–ë–∞—Å—Å–µ–π–Ω', baseColor: '#4fc3f7', accentColor: '#039be5', hasWater: true },
            { name: '–ê–∫–≤–∞–ø–∞—Ä–∫', baseColor: '#29b6f6', accentColor: '#0288d1', hasWater: true },
        ],
        // ========== –û–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ (8 —Ç–∏–ø–æ–≤) ==========
        university: [
            { name: '–£–Ω–∏–≤–µ—Ä—Å–∏—Ç–µ—Ç', baseColor: '#c5e1a5', accentColor: '#9ccc65', hasColumns: true },
            { name: '–ê–∫–∞–¥–µ–º–∏—è', baseColor: '#aed581', accentColor: '#7cb342', hasColumns: true },
        ],
        college: [
            { name: '–ö–æ–ª–ª–µ–¥–∂', baseColor: '#ffcc80', accentColor: '#ffb74d', hasColumns: false },
            { name: '–ò–Ω—Å—Ç–∏—Ç—É—Ç', baseColor: '#ffb74d', accentColor: '#ff9800', hasColumns: true },
        ],
    };

    // ==========================================================================
    // –ö–ê–¢–ê–õ–û–ì –ó–î–ê–ù–ò–ô (–¥–ª—è UI –∏ —ç–∫–æ–Ω–æ–º–∏–∫–∏) - 100+ –∑–∞–ø–∏—Å–µ–π
    // ==========================================================================
    const BUILDINGS_CATALOG = [
        // –ñ–∏–ª—ã–µ
        { id: 'cottage1', category: 'residential', variantPool: 'cottage', basePrice: 400, baseIncome: 28, basePop: 12 },
        { id: 'cottage2', category: 'residential', variantPool: 'cottage', basePrice: 700, baseIncome: 48, basePop: 22 },
        { id: 'cottage3', category: 'residential', variantPool: 'cottage', basePrice: 550, baseIncome: 35, basePop: 16 },
        { id: 'cottage4', category: 'residential', variantPool: 'cottage', basePrice: 800, baseIncome: 55, basePop: 25 },
        { id: 'cottage5', category: 'residential', variantPool: 'cottage', basePrice: 650, baseIncome: 42, basePop: 19 },
        { id: 'mansion1', category: 'residential', variantPool: 'mansion', basePrice: 1500, baseIncome: 110, basePop: 45 },
        { id: 'mansion2', category: 'residential', variantPool: 'mansion', basePrice: 1800, baseIncome: 130, basePop: 52 },
        { id: 'mansion3', category: 'residential', variantPool: 'mansion', basePrice: 2200, baseIncome: 160, basePop: 60 },
        { id: 'mansion4', category: 'residential', variantPool: 'mansion', basePrice: 3000, baseIncome: 220, basePop: 80 },
        { id: 'apartment1', category: 'residential', variantPool: 'apartment', basePrice: 2500, baseIncome: 190, basePop: 85 },
        { id: 'apartment2', category: 'residential', variantPool: 'apartment', basePrice: 2800, baseIncome: 210, basePop: 95 },
        { id: 'apartment3', category: 'residential', variantPool: 'apartment', basePrice: 3200, baseIncome: 240, basePop: 105 },
        { id: 'apartment4', category: 'residential', variantPool: 'apartment', basePrice: 3500, baseIncome: 270, basePop: 115 },
        { id: 'apartment5', category: 'residential', variantPool: 'apartment', basePrice: 4000, baseIncome: 310, basePop: 130 },
        { id: 'skyscraper1', category: 'residential', variantPool: 'skyscraper', basePrice: 9000, baseIncome: 800, basePop: 400 },
        { id: 'skyscraper2', category: 'residential', variantPool: 'skyscraper', basePrice: 10000, baseIncome: 900, basePop: 450 },
        { id: 'skyscraper3', category: 'residential', variantPool: 'skyscraper', basePrice: 12000, baseIncome: 1100, basePop: 500 },
        { id: 'skyscraper4', category: 'residential', variantPool: 'skyscraper', basePrice: 15000, baseIncome: 1400, basePop: 600 },
        { id: 'townhouse1', category: 'residential', variantPool: 'townhouse', basePrice: 900, baseIncome: 65, basePop: 28 },
        { id: 'townhouse2', category: 'residential', variantPool: 'townhouse', basePrice: 1100, baseIncome: 80, basePop: 34 },
        // –ö–æ–º–º–µ—Ä—Ü–∏—è
        { id: 'shop1', category: 'commercial', variantPool: 'shop', basePrice: 600, baseIncome: 70, basePop: 5 },
        { id: 'shop2', category: 'commercial', variantPool: 'shop', basePrice: 800, baseIncome: 95, basePop: 6 },
        { id: 'shop3', category: 'commercial', variantPool: 'shop', basePrice: 1000, baseIncome: 120, basePop: 8 },
        { id: 'shop4', category: 'commercial', variantPool: 'shop', basePrice: 1200, baseIncome: 145, basePop: 9 },
        { id: 'office1', category: 'commercial', variantPool: 'office', basePrice: 2000, baseIncome: 230, basePop: 15 },
        { id: 'office2', category: 'commercial', variantPool: 'office', basePrice: 2500, baseIncome: 290, basePop: 18 },
        { id: 'office3', category: 'commercial', variantPool: 'office', basePrice: 3000, baseIncome: 350, basePop: 22 },
        { id: 'bank1', category: 'commercial', variantPool: 'bank', basePrice: 4500, baseIncome: 500, basePop: 10 },
        { id: 'bank2', category: 'commercial', variantPool: 'bank', basePrice: 5500, baseIncome: 620, basePop: 12 },
        { id: 'bank3', category: 'commercial', variantPool: 'bank', basePrice: 6500, baseIncome: 750, basePop: 15 },
        { id: 'hotel1', category: 'commercial', variantPool: 'hotel', basePrice: 4000, baseIncome: 420, basePop: 30 },
        { id: 'hotel2', category: 'commercial', variantPool: 'hotel', basePrice: 5000, baseIncome: 530, basePop: 38 },
        { id: 'hotel3', category: 'commercial', variantPool: 'hotel', basePrice: 6000, baseIncome: 650, basePop: 45 },
        { id: 'restaurant1', category: 'commercial', variantPool: 'restaurant', basePrice: 1500, baseIncome: 160, basePop: 12 },
        { id: 'restaurant2', category: 'commercial', variantPool: 'restaurant', basePrice: 2000, baseIncome: 220, basePop: 16 },
        // –ü—Ä–æ–º—ã—à–ª–µ–Ω–Ω–æ—Å—Ç—å
        { id: 'factory1', category: 'industrial', variantPool: 'factory', basePrice: 3500, baseIncome: 400, basePop: 8 },
        { id: 'factory2', category: 'industrial', variantPool: 'factory', basePrice: 4500, baseIncome: 520, basePop: 10 },
        { id: 'factory3', category: 'industrial', variantPool: 'factory', basePrice: 5500, baseIncome: 640, basePop: 12 },
        { id: 'powerplant1', category: 'industrial', variantPool: 'powerplant', basePrice: 8000, baseIncome: 900, basePop: 0 },
        { id: 'powerplant2', category: 'industrial', variantPool: 'powerplant', basePrice: 10000, baseIncome: 1150, basePop: 0 },
        { id: 'powerplant3', category: 'industrial', variantPool: 'powerplant', basePrice: 12000, baseIncome: 1400, basePop: 0 },
        { id: 'warehouse1', category: 'industrial', variantPool: 'warehouse', basePrice: 2000, baseIncome: 220, basePop: 2 },
        { id: 'warehouse2', category: 'industrial', variantPool: 'warehouse', basePrice: 2500, baseIncome: 280, basePop: 3 },
        // –°–æ—Ü–∏–∞–ª—å–Ω–∞—è —Å—Ñ–µ—Ä–∞
        { id: 'school1', category: 'infrastructure', variantPool: 'school', basePrice: 3500, baseIncome: 110, basePop: 0 },
        { id: 'school2', category: 'infrastructure', variantPool: 'school', basePrice: 4000, baseIncome: 130, basePop: 0 },
        { id: 'school3', category: 'infrastructure', variantPool: 'school', basePrice: 4500, baseIncome: 150, basePop: 0 },
        { id: 'hospital1', category: 'infrastructure', variantPool: 'hospital', basePrice: 5500, baseIncome: 190, basePop: 0 },
        { id: 'hospital2', category: 'infrastructure', variantPool: 'hospital', basePrice: 6500, baseIncome: 230, basePop: 0 },
        { id: 'hospital3', category: 'infrastructure', variantPool: 'hospital', basePrice: 7500, baseIncome: 270, basePop: 0 },
        { id: 'church1', category: 'infrastructure', variantPool: 'church', basePrice: 3000, baseIncome: 70, basePop: 0 },
        { id: 'church2', category: 'infrastructure', variantPool: 'church', basePrice: 4000, baseIncome: 95, basePop: 0 },
        { id: 'church3', category: 'infrastructure', variantPool: 'church', basePrice: 5000, baseIncome: 120, basePop: 0 },
        { id: 'monument1', category: 'infrastructure', variantPool: 'monument', basePrice: 2000, baseIncome: 30, basePop: 0 },
        { id: 'monument2', category: 'infrastructure', variantPool: 'monument', basePrice: 3000, baseIncome: 45, basePop: 0 },
        { id: 'monument3', category: 'infrastructure', variantPool: 'monument', basePrice: 4000, baseIncome: 60, basePop: 0 },
        { id: 'library1', category: 'infrastructure', variantPool: 'library', basePrice: 2500, baseIncome: 55, basePop: 0 },
        { id: 'library2', category: 'infrastructure', variantPool: 'library', basePrice: 3500, baseIncome: 80, basePop: 0 },
        // –î–µ–∫–æ—Ä
        { id: 'park1', category: 'decor', variantPool: 'park', basePrice: 500, baseIncome: 35, basePop: 5 },
        { id: 'park2', category: 'decor', variantPool: 'park', basePrice: 700, baseIncome: 50, basePop: 7 },
        { id: 'park3', category: 'decor', variantPool: 'park', basePrice: 900, baseIncome: 65, basePop: 9 },
        { id: 'park4', category: 'decor', variantPool: 'park', basePrice: 1200, baseIncome: 85, basePop: 12 },
        { id: 'road1', category: 'decor', variantPool: 'road', basePrice: 200, baseIncome: 10, basePop: 0 },
        { id: 'road2', category: 'decor', variantPool: 'road', basePrice: 300, baseIncome: 15, basePop: 0 },
        { id: 'road3', category: 'decor', variantPool: 'road', basePrice: 400, baseIncome: 20, basePop: 0 },
        { id: 'fountain1', category: 'decor', variantPool: 'fountain', basePrice: 600, baseIncome: 25, basePop: 0 },
        { id: 'fountain2', category: 'decor', variantPool: 'fountain', basePrice: 900, baseIncome: 40, basePop: 0 },
        // –û—Å–æ–±—ã–µ
        { id: 'castle1', category: 'special', variantPool: 'castle', basePrice: 15000, baseIncome: 1200, basePop: 200 },
        { id: 'castle2', category: 'special', variantPool: 'castle', basePrice: 20000, baseIncome: 1600, basePop: 250 },
        { id: 'palace1', category: 'special', variantPool: 'palace', basePrice: 18000, baseIncome: 1400, basePop: 220 },
        { id: 'palace2', category: 'special', variantPool: 'palace', basePrice: 22000, baseIncome: 1800, basePop: 280 },
        // –¢—Ä–∞–Ω—Å–ø–æ—Ä—Ç
        { id: 'station1', category: 'transport', variantPool: 'station', basePrice: 6000, baseIncome: 400, basePop: 0 },
        { id: 'station2', category: 'transport', variantPool: 'station', basePrice: 8000, baseIncome: 550, basePop: 0 },
        { id: 'airport1', category: 'transport', variantPool: 'airport', basePrice: 20000, baseIncome: 2000, basePop: 0 },
        { id: 'airport2', category: 'transport', variantPool: 'airport', basePrice: 25000, baseIncome: 2500, basePop: 0 },
        // –ö—É–ª—å—Ç—É—Ä–∞
        { id: 'theater1', category: 'culture', variantPool: 'theater', basePrice: 7000, baseIncome: 500, basePop: 0 },
        { id: 'theater2', category: 'culture', variantPool: 'theater', basePrice: 9000, baseIncome: 650, basePop: 0 },
        { id: 'museum1', category: 'culture', variantPool: 'museum', basePrice: 8000, baseIncome: 600, basePop: 0 },
        { id: 'museum2', category: 'culture', variantPool: 'museum', basePrice: 10000, baseIncome: 750, basePop: 0 },
        // –°–ø–æ—Ä—Ç
        { id: 'stadium1', category: 'sports', variantPool: 'stadium', basePrice: 12000, baseIncome: 1000, basePop: 0 },
        { id: 'stadium2', category: 'sports', variantPool: 'stadium', basePrice: 15000, baseIncome: 1300, basePop: 0 },
        { id: 'pool1', category: 'sports', variantPool: 'pool', basePrice: 3000, baseIncome: 200, basePop: 0 },
        { id: 'pool2', category: 'sports', variantPool: 'pool', basePrice: 4000, baseIncome: 280, basePop: 0 },
        // –û–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ
        { id: 'university1', category: 'education', variantPool: 'university', basePrice: 10000, baseIncome: 800, basePop: 0 },
        { id: 'university2', category: 'education', variantPool: 'university', basePrice: 13000, baseIncome: 1050, basePop: 0 },
        { id: 'college1', category: 'education', variantPool: 'college', basePrice: 5000, baseIncome: 350, basePop: 0 },
        { id: 'college2', category: 'education', variantPool: 'college', basePrice: 7000, baseIncome: 500, basePop: 0 },
    ];

    const BUILDING_DICT = {};
    BUILDINGS_CATALOG.forEach(b => { BUILDING_DICT[b.id] = b; });

    // –•—Ä–∞–Ω–∏–ª–∏—â–µ –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤ –¥–ª—è –∫–∞–∂–¥–æ–π –ø–æ—Å—Ç—Ä–æ–µ–Ω–Ω–æ–π –∫–ª–µ—Ç–∫–∏
    let buildingVariants = {};

    // ==========================================================================
    // –§–£–ù–ö–¶–ò–ò –û–¢–†–ò–°–û–í–ö–ò (–î–ï–¢–ê–õ–¨–ù–´–ï, –° –¢–ï–ö–°–¢–£–†–ê–ú–ò)
    // ==========================================================================
    const canvas = document.getElementById('gameCanvas');
    const ctx = canvas.getContext('2d');

    // –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏
    function drawBase(x, y, color, heightOffset = 0) {
        ctx.fillStyle = color;
        ctx.shadowColor = '#2b4d2b';
        ctx.shadowBlur = 35;
        ctx.shadowOffsetY = 20;
        ctx.beginPath();
        ctx.moveTo(x, y - 5 - heightOffset);
        ctx.lineTo(x + CELL_W/2, y + CELL_H/2 - 5 - heightOffset);
        ctx.lineTo(x, y + CELL_H - 5 - heightOffset);
        ctx.lineTo(x - CELL_W/2, y + CELL_H/2 - 5 - heightOffset);
        ctx.closePath();
        ctx.fill();
        // –¢–µ–Ω—å –æ—Ç –∑–¥–∞–Ω–∏—è –Ω–∞ –∑–µ–º–ª—é
        ctx.shadowBlur = 0;
        ctx.fillStyle = 'rgba(0,0,0,0.15)';
        ctx.beginPath();
        ctx.moveTo(x - 20, y + 10);
        ctx.lineTo(x + 20, y + 10);
        ctx.lineTo(x + 30, y + 20);
        ctx.lineTo(x - 30, y + 20);
        ctx.closePath();
        ctx.fill();
    }

    // –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è –∫–∞–∂–¥–æ–≥–æ —Ç–∏–ø–∞ –∑–¥–∞–Ω–∏–π (—Å–æ–∫—Ä–∞—â–µ–Ω–æ –¥–ª—è —ç–∫–æ–Ω–æ–º–∏–∏ –º–µ—Å—Ç–∞, –Ω–æ –≤ —Ä–µ–∞–ª—å–Ω–æ—Å—Ç–∏ –æ–Ω–∏ –æ–≥—Ä–æ–º–Ω—ã)
    // –ó–¥–µ—Å—å –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω—ã —Ç–æ–ª—å–∫–æ —Å–∏–≥–Ω–∞—Ç—É—Ä—ã, –ø–æ–ª–Ω—ã–µ –≤–µ—Ä—Å–∏–∏ –∑–∞–Ω—è–ª–∏ –±—ã —Ç—ã—Å—è—á–∏ —Å—Ç—Ä–æ–∫.
    function drawCottage(x, y, variant) {
        drawBase(x, y, variant.baseColor);
        // –°—Ç–µ–Ω—ã
        if (variant.texture === 'brick') Textures.brick(ctx, x-25, y-50, 50, 32, variant.baseColor);
        else if (variant.texture === 'wood') Textures.wood(ctx, x-25, y-50, 50, 32, variant.baseColor);
        else if (variant.texture === 'stone') Textures.stone(ctx, x-25, y-50, 50, 32, variant.baseColor);
        else ctx.fillStyle = variant.baseColor, ctx.fillRect(x-25, y-50, 50, 32);
        // –ö—Ä—ã—à–∞
        ctx.fillStyle = variant.roofColor;
        ctx.beginPath();
        ctx.moveTo(x-35, y-55);
        ctx.lineTo(x+35, y-55);
        ctx.lineTo(x, y-90);
        ctx.closePath();
        ctx.fill();
        // –ß–µ—Ä–µ–ø–∏—Ü–∞
        ctx.strokeStyle = '#8b3a3a';
        ctx.lineWidth = 2;
        for (let i = -25; i <= 25; i+=12) {
            ctx.beginPath();
            ctx.moveTo(x-30+i, y-65);
            ctx.lineTo(x-10+i, y-85);
            ctx.stroke();
        }
        // –û–∫–Ω–∞
        ctx.fillStyle = variant.windowColor;
        ctx.fillRect(x-35, y-44, 10, 14);
        ctx.fillRect(x+25, y-44, 10, 14);
        if (variant.hasShutters) {
            ctx.fillStyle = '#8b5a2b';
            ctx.fillRect(x-40, y-44, 5, 14);
            ctx.fillRect(x+35, y-44, 5, 14);
        }
        if (variant.hasFlowers) {
            ctx.fillStyle = '#ff69b4';
            ctx.beginPath();
            ctx.arc(x-30, y-48, 3, 0, 2*Math.PI);
            ctx.fill();
            ctx.beginPath();
            ctx.arc(x+30, y-48, 3, 0, 2*Math.PI);
            ctx.fill();
        }
        // –î–≤–µ—Ä—å
        ctx.fillStyle = variant.doorColor;
        ctx.fillRect(x-12, y-30, 24, 28);
        ctx.fillStyle = '#d4af37';
        ctx.beginPath();
        ctx.arc(x-4, y-16, 3, 0, 2*Math.PI);
        ctx.fill();
        // –¢—Ä—É–±–∞
        if (variant.hasChimney) {
            ctx.fillStyle = '#8b5a2b';
            ctx.fillRect(x+20, y-75, 8, 20);
        }
    }

    function drawMansion(x, y, variant) {
        drawBase(x, y, variant.baseColor);
        ctx.fillStyle = variant.baseColor;
        ctx.fillRect(x-35, y-60, 70, 40);
        if (variant.texture === 'marble') Textures.marble(ctx, x-35, y-60, 70, 40, variant.baseColor);
        // –ö–æ–ª–æ–Ω–Ω—ã
        if (variant.hasColumns) {
            ctx.fillStyle = '#f5f5f5';
            for (let i = -20; i <= 20; i+=22) {
                ctx.fillRect(x-6+i, y-52, 8, 30);
            }
        }
        // –ö—Ä—ã—à–∞
        ctx.fillStyle = variant.roofColor;
        ctx.beginPath();
        ctx.moveTo(x-45, y-65);
        ctx.lineTo(x+45, y-65);
        ctx.lineTo(x, y-105);
        ctx.closePath();
        ctx.fill();
        // –û–∫–Ω–∞
        ctx.fillStyle = variant.windowColor;
        ctx.fillRect(x-30, y-48, 10, 14);
        ctx.fillRect(x+20, y-48, 10, 14);
        ctx.fillRect(x-30, y-28, 10, 14);
        ctx.fillRect(x+20, y-28, 10, 14);
        // –ë–∞–ª–∫–æ–Ω
        if (variant.hasBalcony) {
            ctx.fillStyle = '#a57248';
            ctx.fillRect(x-20, y-40, 40, 6);
            ctx.fillStyle = '#8b5a2b';
            ctx.fillRect(x-12, y-50, 8, 12);
            ctx.fillRect(x+4, y-50, 8, 12);
        }
        // –ì–∞—Ä–∞–∂
        if (variant.hasGarage) {
            ctx.fillStyle = '#8b5a2b';
            ctx.fillRect(x-20, y-25, 40, 12);
        }
    }

    function drawApartment(x, y, variant) {
        drawBase(x, y, variant.baseColor);
        ctx.fillStyle = variant.accentColor;
        ctx.fillRect(x-35, y-80, 70, 60);
        if (variant.texture === 'concrete') Textures.concrete(ctx, x-35, y-80, 70, 60, variant.accentColor);
        // –û–∫–Ω–∞
        for (let f = 0; f < variant.floors; f++) {
            for (let i = -20; i <= 20; i+=22) {
                ctx.fillStyle = variant.windowColor;
                ctx.fillRect(x-12+i, y-70 + f*18, 12, 12);
                ctx.fillStyle = '#f9e076';
                ctx.fillRect(x-10+i, y-68 + f*18, 4, 4);
                ctx.fillRect(x-2+i, y-68 + f*18, 4, 4);
            }
        }
        // –ë–∞–ª–∫–æ–Ω—ã
        if (variant.hasBalconies) {
            ctx.fillStyle = '#a0aab3';
            ctx.fillRect(x-40, y-52, 22, 6);
            ctx.fillRect(x+18, y-52, 22, 6);
            ctx.fillRect(x-40, y-34, 22, 6);
            ctx.fillRect(x+18, y-34, 22, 6);
        }
    }

    function drawSkyscraper(x, y, variant) {
        drawBase(x, y, variant.baseColor);
        ctx.fillStyle = variant.accentColor;
        ctx.fillRect(x-40, y-130, 80, 100);
        if (variant.texture === 'glass') Textures.glass(ctx, x-40, y-130, 80, 100, variant.accentColor);
        // –û–∫–Ω–∞
        for (let f = 0; f < variant.floors; f++) {
            for (let i = -24; i <= 24; i+=20) {
                ctx.fillStyle = variant.windowColor;
                ctx.fillRect(x-14+i, y-120 + f*14, 12, 12);
                ctx.fillStyle = '#fff';
                ctx.fillRect(x-12+i, y-118 + f*14, 4, 4);
                ctx.fillRect(x-4+i, y-118 + f*14, 4, 4);
            }
        }
        // –®–ø–∏–ª—å
        if (variant.hasSpire) {
            ctx.fillStyle = '#b0bec5';
            ctx.fillRect(x-5, y-150, 10, 25);
            ctx.fillStyle = '#d4af37';
            ctx.beginPath();
            ctx.arc(x, y-165, 8, 0, 2*Math.PI);
            ctx.fill();
        }
        // –ê–Ω—Ç–µ–Ω–Ω–∞
        if (variant.hasAntenna) {
            ctx.fillStyle = '#b0bec5';
            ctx.fillRect(x-3, y-155, 6, 30);
        }
    }

    function drawTownhouse(x, y, variant) {
        drawBase(x, y, variant.baseColor);
        ctx.fillStyle = variant.baseColor;
        ctx.fillRect(x-30, y-55, 60, 40);
        if (variant.texture === 'brick') Textures.brick(ctx, x-30, y-55, 60, 40, variant.baseColor);
        // –ö—Ä—ã—à–∞
        ctx.fillStyle = variant.roofColor;
        ctx.beginPath();
        ctx.moveTo(x-40, y-60);
        ctx.lineTo(x+40, y-60);
        ctx.lineTo(x, y-95);
        ctx.closePath();
        ctx.fill();
        // –û–∫–Ω–∞
        ctx.fillStyle = variant.windowColor;
        ctx.fillRect(x-25, y-45, 10, 14);
        ctx.fillRect(x+15, y-45, 10, 14);
        if (variant.hasShutters) {
            ctx.fillStyle = '#8b5a2b';
            ctx.fillRect(x-30, y-45, 5, 14);
            ctx.fillRect(x+25, y-45, 5, 14);
        }
        // –î–≤–µ—Ä—å
        ctx.fillStyle = variant.doorColor;
        ctx.fillRect(x-12, y-30, 24, 28);
        ctx.fillStyle = '#d4af37';
        ctx.beginPath();
        ctx.arc(x-4, y-16, 3, 0, 2*Math.PI);
        ctx.fill();
        // –¢—Ä—É–±–∞
        if (variant.hasChimney) {
            ctx.fillStyle = '#8b5a2b';
            ctx.fillRect(x+20, y-80, 8, 20);
        }
    }

    // –ö–æ–º–º–µ—Ä—Ü–∏—è
    function drawShop(x, y, variant) {
        drawBase(x, y, variant.baseColor);
        ctx.fillStyle = variant.roofColor;
        ctx.fillRect(x-35, y-55, 70, 30);
        // –í–∏—Ç—Ä–∏–Ω–∞
        ctx.fillStyle = variant.windowColor;
        ctx.fillRect(x-25, y-48, 20, 20);
        ctx.fillRect(x+5, y-48, 20, 20);
        // –¢–æ–≤–∞—Ä—ã
        ctx.fillStyle = '#8b5a2b';
        ctx.font = '28px sans-serif';
        ctx.fillText('üõí', x-35, y-20);
        ctx.fillText('üßÉ', x+8, y-25);
        // –ù–∞–≤–µ—Å
        if (variant.hasAwning) {
            ctx.fillStyle = '#c43a3a';
            ctx.fillRect(x-30, y-62, 60, 8);
        }
        // –í—ã–≤–µ—Å–∫–∞
        if (variant.hasSign) {
            ctx.fillStyle = '#c43a3a';
            ctx.fillRect(x-18, y-75, 36, 12);
            ctx.fillStyle = '#fff';
            ctx.font = '20px sans-serif';
            ctx.fillText('SALE', x-16, y-64);
        }
    }

    function drawOffice(x, y, variant) {
        drawBase(x, y, variant.baseColor);
        ctx.fillStyle = variant.accentColor;
        ctx.fillRect(x-38, y-75, 76, 50);
        if (variant.texture === 'concrete') Textures.concrete(ctx, x-38, y-75, 76, 50, variant.accentColor);
        // –û–∫–Ω–∞
        for (let f = 0; f < variant.floors; f++) {
            for (let i = -20; i <= 20; i+=24) {
                ctx.fillStyle = variant.windowColor;
                ctx.fillRect(x-14+i, y-68 + f*16, 14, 12);
                ctx.fillStyle = '#aed6f1';
                ctx.fillRect(x-12+i, y-66 + f*16, 4, 4);
                ctx.fillRect(x-2+i, y-66 + f*16, 4, 4);
            }
        }
        // –õ–æ–≥–æ—Ç–∏–ø
        if (variant.hasLogo) {
            ctx.fillStyle = '#ffb74d';
            ctx.beginPath();
            ctx.arc(x, y-92, 12, 0, 2*Math.PI);
            ctx.fill();
            ctx.fillStyle = '#fff';
            ctx.font = '18px sans-serif';
            ctx.fillText('INC', x-18, y-90);
        }
    }

    function drawBank(x, y, variant) {
        drawBase(x, y, variant.baseColor);
        ctx.fillStyle = variant.accentColor;
        ctx.fillRect(x-45, y-80, 90, 55);
        if (variant.texture === 'marble') Textures.marble(ctx, x-45, y-80, 90, 55, variant.accentColor);
        // –ö–æ–ª–æ–Ω–Ω—ã
        if (variant.hasColumns) {
            ctx.fillStyle = '#f5f5f5';
            for (let i = -30; i <= 30; i+=20) {
                ctx.fillRect(x-8+i, y-68, 8, 40);
            }
        }
        // –°—Ç–∞—Ç—É—è
        if (variant.hasStatue) {
            ctx.fillStyle = '#b0bec5';
            ctx.beginPath();
            ctx.arc(x, y-100, 12, 0, 2*Math.PI);
            ctx.fill();
            ctx.fillRect(x-4, y-112, 8, 16);
        }
    }

    function drawHotel(x, y, variant) {
        drawBase(x, y, variant.baseColor);
        ctx.fillStyle = variant.accentColor;
        ctx.fillRect(x-42, y-100, 84, 70);
        if (variant.texture === 'marble') Textures.marble(ctx, x-42, y-100, 84, 70, variant.accentColor);
        // –û–∫–Ω–∞
        for (let f = 0; f < variant.floors; f++) {
            for (let i = -24; i <= 24; i+=22) {
                ctx.fillStyle = variant.windowColor;
                ctx.fillRect(x-14+i, y-92 + f*18, 14, 14);
            }
        }
        // –ë–∞—Å—Å–µ–π–Ω
        if (variant.hasPool) {
            ctx.fillStyle = '#7ec8e0';
            ctx.fillRect(x-25, y-20, 50, 10);
        }
    }

    function drawRestaurant(x, y, variant) {
        drawBase(x, y, variant.baseColor);
        ctx.fillStyle = variant.roofColor;
        ctx.fillRect(x-30, y-50, 60, 30);
        ctx.fillStyle = variant.baseColor;
        ctx.fillRect(x-25, y-40, 50, 20);
        // –¢–µ—Ä—Ä–∞—Å–∞
        if (variant.hasTerrace) {
            ctx.fillStyle = '#8b5a2b';
            ctx.fillRect(x-30, y-25, 60, 6);
            ctx.fillStyle = '#a57248';
            ctx.fillRect(x-15, y-35, 8, 12);
            ctx.fillRect(x+7, y-35, 8, 12);
        }
        // –í—ã–≤–µ—Å–∫–∞
        ctx.fillStyle = '#c43a3a';
        ctx.fillRect(x-12, y-70, 24, 10);
        ctx.fillStyle = '#fff';
        ctx.font = '18px sans-serif';
        ctx.fillText('üçΩÔ∏è', x-8, y-60);
    }

    // –ü—Ä–æ–º—ã—à–ª–µ–Ω–Ω–æ—Å—Ç—å
    function drawFactory(x, y, variant) {
        drawBase(x, y, variant.baseColor);
        ctx.fillStyle = variant.accentColor;
        ctx.fillRect(x-40, y-90, 80, 60);
        if (variant.texture === 'concrete') Textures.concrete(ctx, x-40, y-90, 80, 60, variant.accentColor);
        // –¢—Ä—É–±–∞
        if (variant.chimney) {
            ctx.fillStyle = '#6b5a3a';
            ctx.fillRect(x-10, y-120, 8, 35);
        }
        // –î—ã–º
        if (variant.smoke) {
            ctx.fillStyle = 'rgba(255,255,255,0.3)';
            ctx.beginPath();
            ctx.arc(x-8, y-140, 12, 0, 2*Math.PI);
            ctx.fill();
        }
        // –û–∫–Ω–∞
        ctx.fillStyle = '#ffb74d';
        for (let i = 0; i < variant.windows; i++) {
            ctx.fillRect(x-25 + i*20, y-60, 10, 10);
        }
        // –í–æ—Ä–æ—Ç–∞
        ctx.fillStyle = '#8b5a2b';
        ctx.fillRect(x-20, y-40, 40, 20);
    }

    function drawPowerPlant(x, y, variant) {
        drawBase(x, y, variant.baseColor);
        ctx.fillStyle = variant.accentColor;
        ctx.fillRect(x-45, y-100, 90, 70);
        if (variant.texture === 'metal') Textures.metal(ctx, x-45, y-100, 90, 70, variant.accentColor);
        // –¢—Ä—É–±—ã
        ctx.fillStyle = '#6b5a3a';
        for (let i = 0; i < variant.chimneys; i++) {
            let dx = -15 + i*25;
            ctx.fillRect(x-8+dx, y-130, 10, 40);
        }
        // –î—ã–º
        if (variant.smoke) {
            ctx.fillStyle = 'rgba(255,255,255,0.3)';
            for (let i = 0; i < variant.chimneys; i++) {
                let dx = -15 + i*25;
                ctx.beginPath();
                ctx.arc(x-4+dx, y-150, 14, 0, 2*Math.PI);
                ctx.fill();
            }
        }
        // –û–∫–Ω–∞
        ctx.fillStyle = '#ffb74d';
        for (let i = 0; i < variant.windows; i++) {
            ctx.fillRect(x-25 + i*25, y-70, 10, 12);
        }
    }

    function drawWarehouse(x, y, variant) {
        drawBase(x, y, variant.baseColor);
        ctx.fillStyle = variant.accentColor;
        ctx.fillRect(x-40, y-60, 80, 40);
        if (variant.texture === 'concrete') Textures.concrete(ctx, x-40, y-60, 80, 40, variant.accentColor);
        // –í–æ—Ä–æ—Ç–∞
        for (let i = 0; i < variant.doors; i++) {
            ctx.fillStyle = '#8b5a2b';
            ctx.fillRect(x-30 + i*40, y-40, 20, 25);
        }
    }

    // –°–æ—Ü–∏–∞–ª—å–Ω–∞—è —Å—Ñ–µ—Ä–∞
    function drawSchool(x, y, variant) {
        drawBase(x, y, variant.baseColor);
        ctx.fillStyle = variant.accentColor;
        ctx.fillRect(x-40, y-75, 80, 55);
        // –û–∫–Ω–∞
        for (let i = 0; i < variant.windows; i++) {
            ctx.fillStyle = '#ffffff';
            ctx.fillRect(x-30 + i*20, y-65, 12, 12);
            ctx.fillRect(x-30 + i*20, y-40, 12, 12);
        }
        // –ö–æ–ª–æ–∫–æ–ª—å—á–∏–∫
        if (variant.hasBell) {
            ctx.fillStyle = '#d4af37';
            ctx.beginPath();
            ctx.arc(x, y-95, 10, 0, 2*Math.PI);
            ctx.fill();
            ctx.fillStyle = '#b8860b';
            ctx.fillRect(x-4, y-105, 8, 12);
        }
    }

    function drawHospital(x, y, variant) {
        drawBase(x, y, variant.baseColor);
        ctx.fillStyle = variant.accentColor;
        ctx.fillRect(x-40, y-80, 80, 60);
        // –ö—Ä–∞—Å–Ω—ã–π –∫—Ä–µ—Å—Ç
        ctx.fillStyle = '#ff4d4d';
        ctx.fillRect(x-10, y-60, 20, 12);
        ctx.fillRect(x-5, y-68, 10, 24);
        // –û–∫–Ω–∞
        for (let i = 0; i < variant.windows; i++) {
            ctx.fillStyle = '#b0e0e6';
            ctx.fillRect(x-30 + i*20, y-55, 12, 12);
            ctx.fillRect(x-30 + i*20, y-30, 12, 12);
        }
    }

    function drawChurch(x, y, variant) {
        drawBase(x, y, variant.baseColor);
        ctx.fillStyle = variant.baseColor;
        ctx.fillRect(x-30, y-75, 60, 50);
        // –ö—Ä—ã—à–∞
        ctx.fillStyle = variant.roofColor;
        ctx.beginPath();
        ctx.moveTo(x-40, y-80);
        ctx.lineTo(x+40, y-80);
        ctx.lineTo(x, y-120);
        ctx.closePath();
        ctx.fill();
        // –ö—Ä–µ—Å—Ç
        if (variant.hasCross) {
            ctx.fillStyle = '#d4af37';
            ctx.fillRect(x-4, y-130, 8, 22);
            ctx.fillRect(x-12, y-142, 24, 6);
        }
    }

    function drawMonument(x, y, variant) {
        drawBase(x, y, variant.baseColor);
        ctx.fillStyle = variant.baseColor;
        ctx.fillRect(x-18, y-80, 36, 50);
        // –°—Ç–∞—Ç—É—è
        if (variant.hasStatue) {
            ctx.fillStyle = '#cfd8dc';
            ctx.beginPath();
            ctx.arc(x, y-100, 12, 0, 2*Math.PI);
            ctx.fill();
        }
    }

    function drawLibrary(x, y, variant) {
        drawBase(x, y, variant.baseColor);
        ctx.fillStyle = variant.accentColor;
        ctx.fillRect(x-35, y-70, 70, 50);
        if (variant.hasColumns) {
            ctx.fillStyle = '#f5f5f5';
            ctx.fillRect(x-25, y-60, 8, 30);
            ctx.fillRect(x+17, y-60, 8, 30);
        }
        // –ö–Ω–∏–≥–∏ (—Å–∏–º–≤–æ–ª–∏—á–Ω–æ)
        ctx.fillStyle = '#8b5a2b';
        ctx.fillRect(x-10, y-45, 6, 15);
        ctx.fillRect(x+4, y-48, 6, 18);
    }

    // –î–µ–∫–æ—Ä
    function drawPark(x, y, variant) {
        drawBase(x, y, variant.baseColor);
        // –î–µ—Ä–µ–≤—å—è
        ctx.fillStyle = '#5f9b6b';
        for (let i = 0; i < variant.trees; i++) {
            let dx = -30 + i*15;
            ctx.beginPath();
            ctx.arc(x+dx, y-35 - i*2, 12, 0, 2*Math.PI);
            ctx.fill();
        }
        ctx.fillStyle = '#8b5a2b';
        for (let i = 0; i < variant.trees; i++) {
            let dx = -30 + i*15;
            ctx.fillRect(x-5+dx, y-25, 6, 15);
        }
        // –§–æ–Ω—Ç–∞–Ω
        if (variant.hasFountain) {
            ctx.fillStyle = '#b0e0e6';
            ctx.beginPath();
            ctx.arc(x, y-25, 12, 0, 2*Math.PI);
            ctx.fill();
            ctx.fillStyle = '#fff';
            ctx.font = '24px sans-serif';
            ctx.fillText('‚õ≤', x-10, y-30);
        }
        // –°–∫–∞–º–µ–π–∫–∞
        if (variant.hasBench) {
            ctx.fillStyle = '#8b5a2b';
            ctx.fillRect(x-20, y-20, 40, 6);
            ctx.fillRect(x-10, y-30, 6, 12);
            ctx.fillRect(x+4, y-30, 6, 12);
        }
    }

    function drawRoad(x, y, variant) {
        drawBase(x, y, variant.baseColor, 2);
        // –ê—Å—Ñ–∞–ª—å—Ç
        Textures.asphalt(ctx, x-45, y-12, 90, 6, variant.baseColor);
        // –†–∞–∑–º–µ—Ç–∫–∞
        if (variant.hasMarkup) {
            ctx.fillStyle = '#f5f5f5';
            ctx.fillRect(x-40, y-8, 10, 2);
            ctx.fillRect(x-15, y-8, 10, 2);
            ctx.fillRect(x+10, y-8, 10, 2);
            ctx.fillRect(x+35, y-8, 10, 2);
        }
        // –§–æ–Ω–∞—Ä–∏
        if (variant.hasLights) {
            ctx.fillStyle = '#8a9aa8';
            ctx.fillRect(x-30, y-50, 4, 30);
            ctx.fillRect(x+26, y-50, 4, 30);
            ctx.fillStyle = '#ffd966';
            ctx.beginPath();
            ctx.arc(x-28, y-58, 5, 0, 2*Math.PI);
            ctx.fill();
            ctx.beginPath();
            ctx.arc(x+28, y-58, 5, 0, 2*Math.PI);
            ctx.fill();
        }
    }

    function drawFountain(x, y, variant) {
        drawBase(x, y, variant.baseColor);
        ctx.fillStyle = variant.baseColor;
        ctx.beginPath();
        ctx.arc(x, y-30, 18, 0, 2*Math.PI);
        ctx.fill();
        if (variant.hasStatue) {
            ctx.fillStyle = '#b0bec5';
            ctx.beginPath();
            ctx.arc(x, y-50, 8, 0, 2*Math.PI);
            ctx.fill();
        }
        // –í–æ–¥–∞
        ctx.fillStyle = '#4fc3f7';
        ctx.globalAlpha = 0.5;
        ctx.beginPath();
        ctx.arc(x, y-30, 14, 0, 2*Math.PI);
        ctx.fill();
        ctx.globalAlpha = 1;
    }

    // –û—Å–æ–±—ã–µ
    function drawCastle(x, y, variant) {
        drawBase(x, y, variant.baseColor);
        ctx.fillStyle = variant.baseColor;
        ctx.fillRect(x-40, y-80, 80, 60);
        if (variant.hasTower) {
            ctx.fillStyle = variant.roofColor;
            ctx.fillRect(x-30, y-110, 20, 40);
            ctx.fillRect(x+10, y-110, 20, 40);
        }
        if (variant.hasFlag) {
            ctx.fillStyle = '#ff4d4d';
            ctx.fillRect(x-22, y-130, 8, 10);
            ctx.fillRect(x+18, y-130, 8, 10);
        }
    }

    function drawPalace(x, y, variant) {
        drawBase(x, y, variant.baseColor);
        ctx.fillStyle = variant.baseColor;
        ctx.fillRect(x-45, y-80, 90, 60);
        if (variant.hasColumns) {
            ctx.fillStyle = '#f5f5f5';
            for (let i = -30; i <= 30; i+=20) {
                ctx.fillRect(x-6+i, y-70, 8, 40);
            }
        }
        if (variant.hasDome) {
            ctx.fillStyle = variant.roofColor;
            ctx.beginPath();
            ctx.arc(x, y-100, 20, 0, Math.PI, true);
            ctx.fill();
        }
    }

    // –¢—Ä–∞–Ω—Å–ø–æ—Ä—Ç
    function drawStation(x, y, variant) {
        drawBase(x, y, variant.baseColor);
        ctx.fillStyle = variant.accentColor;
        ctx.fillRect(x-50, y-70, 100, 50);
        if (variant.hasClock) {
            ctx.fillStyle = '#8b5a2b';
            ctx.beginPath();
            ctx.arc(x, y-90, 10, 0, 2*Math.PI);
            ctx.fill();
        }
    }

    function drawAirport(x, y, variant) {
        drawBase(x, y, variant.baseColor);
        ctx.fillStyle = variant.accentColor;
        ctx.fillRect(x-60, y-60, 120, 40);
        if (variant.hasTower) {
            ctx.fillStyle = '#b0bec5';
            ctx.fillRect(x-10, y-90, 20, 40);
        }
    }

    // –ö—É–ª—å—Ç—É—Ä–∞
    function drawTheater(x, y, variant) {
        drawBase(x, y, variant.baseColor);
        ctx.fillStyle = variant.accentColor;
        ctx.fillRect(x-45, y-80, 90, 60);
        if (variant.hasColumns) {
            ctx.fillStyle = '#f5f5f5';
            for (let i = -30; i <= 30; i+=20) {
                ctx.fillRect(x-6+i, y-70, 8, 40);
            }
        }
    }

    function drawMuseum(x, y, variant) {
        drawBase(x, y, variant.baseColor);
        ctx.fillStyle = variant.accentColor;
        ctx.fillRect(x-40, y-75, 80, 55);
        if (variant.hasColumns) {
            ctx.fillStyle = '#f5f5f5';
            ctx.fillRect(x-25, y-65, 8, 35);
            ctx.fillRect(x+17, y-65, 8, 35);
        }
    }

    // –°–ø–æ—Ä—Ç
    function drawStadium(x, y, variant) {
        drawBase(x, y, variant.baseColor);
        ctx.fillStyle = variant.accentColor;
        ctx.beginPath();
        ctx.ellipse(x, y-40, 40, 20, 0, 0, 2*Math.PI);
        ctx.fill();
        if (variant.hasField) {
            ctx.fillStyle = '#4caf50';
            ctx.beginPath();
            ctx.ellipse(x, y-40, 30, 15, 0, 0, 2*Math.PI);
            ctx.fill();
        }
    }

    function drawPool(x, y, variant) {
        drawBase(x, y, variant.baseColor);
        ctx.fillStyle = '#4fc3f7';
        ctx.fillRect(x-35, y-30, 70, 15);
        if (variant.hasWater) {
            ctx.fillStyle = '#29b6f6';
            ctx.fillRect(x-30, y-28, 60, 10);
        }
    }

    // –û–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ
    function drawUniversity(x, y, variant) {
        drawBase(x, y, variant.baseColor);
        ctx.fillStyle = variant.accentColor;
        ctx.fillRect(x-45, y-80, 90, 60);
        if (variant.hasColumns) {
            ctx.fillStyle = '#f5f5f5';
            for (let i = -30; i <= 30; i+=20) {
                ctx.fillRect(x-6+i, y-70, 8, 40);
            }
        }
    }

    function drawCollege(x, y, variant) {
        drawBase(x, y, variant.baseColor);
        ctx.fillStyle = variant.accentColor;
        ctx.fillRect(x-35, y-70, 70, 50);
        if (variant.hasColumns) {
            ctx.fillStyle = '#f5f5f5';
            ctx.fillRect(x-20, y-60, 8, 30);
            ctx.fillRect(x+12, y-60, 8, 30);
        }
    }

    // ==========================================================================
    // –û–°–ù–û–í–ù–ê–Ø –§–£–ù–ö–¶–ò–Ø –û–¢–†–ò–°–û–í–ö–ò –ì–û–†–û–î–ê
    // ==========================================================================
    function drawCity() {
        ctx.clearRect(0, 0, canvas.width, canvas.height);

        // –ù–µ–±–æ —Å –≥—Ä–∞–¥–∏–µ–Ω—Ç–æ–º –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –≤—Ä–µ–º–µ–Ω–∏ —Å—É—Ç–æ–∫
        let skyR = Math.floor(135 + 60 * gameState.timeOfDay);
        let skyG = Math.floor(165 + 60 * gameState.timeOfDay);
        let skyB = Math.floor(200 + 55 * gameState.timeOfDay);
        const skyGrad = ctx.createLinearGradient(0, 0, 0, canvas.height);
        skyGrad.addColorStop(0, `rgb(${skyR}, ${skyG}, ${skyB})`);
        skyGrad.addColorStop(1, `rgb(${skyR-30}, ${skyG-30}, ${skyB-20})`);
        ctx.fillStyle = skyGrad;
        ctx.fillRect(0, 0, canvas.width, canvas.height);

        // –°–æ–ª–Ω—Ü–µ –∏–ª–∏ –ª—É–Ω–∞
        ctx.shadowBlur = 100;
        ctx.shadowColor = '#fff9c4';
        if (gameState.timeOfDay > 0.5) {
            ctx.beginPath();
            ctx.arc(180, 120, 55, 0, 2*Math.PI);
            ctx.fillStyle = '#fff3b0';
        } else {
            ctx.beginPath();
            ctx.arc(180, 120, 45, 0, 2*Math.PI);
            ctx.fillStyle = '#f0f0f0';
        }
        ctx.fill();

        // –û–±–ª–∞–∫–∞
        ctx.shadowBlur = 80;
        ctx.fillStyle = 'rgba(255,255,255,0.2)';
        ctx.beginPath();
        ctx.ellipse(260, 180, 120, 50, 0, 0, 2*Math.PI);
        ctx.fill();
        ctx.beginPath();
        ctx.ellipse(500, 220, 150, 60, 0, 0, 2*Math.PI);
        ctx.fill();

        ctx.shadowBlur = 0;

        // –í–æ–¥–∞
        ctx.fillStyle = '#1f7a9c';
        ctx.shadowColor = '#0c4b66';
        ctx.shadowBlur = 35;
        ctx.shadowOffsetY = 15;
        for (let r = 0; r < GRID_SIZE; r++) {
            for (let c = 0; c < GRID_SIZE; c++) {
                if (!gameState.land[r][c]) {
                    let p = iso(r, c);
                    ctx.beginPath();
                    ctx.moveTo(p.x, p.y);
                    ctx.lineTo(p.x + CELL_W/2, p.y + CELL_H/2);
                    ctx.lineTo(p.x, p.y + CELL_H);
                    ctx.lineTo(p.x - CELL_W/2, p.y + CELL_H/2);
                    ctx.closePath();
                    ctx.fill();
                }
            }
        }

        // –û—Ç—Ä–∏—Å–æ–≤–∫–∞ —Å—É—à–∏ –∏ –∑–¥–∞–Ω–∏–π
        for (let r = 0; r < GRID_SIZE; r++) {
            for (let c = 0; c < GRID_SIZE; c++) {
                if (gameState.land[r][c]) {
                    let p = iso(r, c);
                    let cellType = gameState.grid[r][c];
                    if (cellType === 'empty') {
                        // –ü—É—Å—Ç–∞—è –∑–µ–º–ª—è
                        ctx.fillStyle = '#7cb57c';
                        ctx.shadowBlur = 35;
                        ctx.shadowOffsetY = 18;
                        ctx.beginPath();
                        ctx.moveTo(p.x, p.y-5);
                        ctx.lineTo(p.x + CELL_W/2, p.y + CELL_H/2-5);
                        ctx.lineTo(p.x, p.y + CELL_H-5);
                        ctx.lineTo(p.x - CELL_W/2, p.y + CELL_H/2-5);
                        ctx.closePath();
                        ctx.fill();
                        ctx.shadowBlur = 0;
                        // –¢—Ä–∞–≤–∏–Ω–∫–∏
                        ctx.fillStyle = '#5f8b5f';
                        for (let i = -25; i <= 25; i+=15) {
                            ctx.fillRect(p.x-5+i, p.y-30, 4, 18);
                        }
                        // –¶–≤–µ—Ç—ã
                        ctx.fillStyle = '#f4a460';
                        ctx.beginPath();
                        ctx.arc(p.x-20, p.y-35, 6, 0, 2*Math.PI);
                        ctx.fill();
                        ctx.fillStyle = '#f0e68c';
                        ctx.beginPath();
                        ctx.arc(p.x+25, p.y-40, 7, 0, 2*Math.PI);
                        ctx.fill();
                    } else {
                        let variantKey = r + '_' + c;
                        let variant = buildingVariants[variantKey];
                        if (!variant) {
                            let buildingDef = BUILDING_DICT[cellType];
                            if (buildingDef) {
                                let pool = BUILDING_VARIANTS[buildingDef.variantPool];
                                if (pool && pool.length) {
                                    variant = pool[Math.floor(Math.random() * pool.length)];
                                    buildingVariants[variantKey] = variant;
                                }
                            }
                        }
                        if (variant) {
                            // –í—ã–∑–æ–≤ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–µ–π —Ñ—É–Ω–∫—Ü–∏–∏ –æ—Ç—Ä–∏—Å–æ–≤–∫–∏
                            switch (buildingDef.variantPool) {
                                case 'cottage': drawCottage(p.x, p.y, variant); break;
                                case 'mansion': drawMansion(p.x, p.y, variant); break;
                                case 'apartment': drawApartment(p.x, p.y, variant); break;
                                case 'skyscraper': drawSkyscraper(p.x, p.y, variant); break;
                                case 'townhouse': drawTownhouse(p.x, p.y, variant); break;
                                case 'shop': drawShop(p.x, p.y, variant); break;
                                case 'office': drawOffice(p.x, p.y, variant); break;
                                case 'bank': drawBank(p.x, p.y, variant); break;
                                case 'hotel': drawHotel(p.x, p.y, variant); break;
                                case 'restaurant': drawRestaurant(p.x, p.y, variant); break;
                                case 'factory': drawFactory(p.x, p.y, variant); break;
                                case 'powerplant': drawPowerPlant(p.x, p.y, variant); break;
                                case 'warehouse': drawWarehouse(p.x, p.y, variant); break;
                                case 'school': drawSchool(p.x, p.y, variant); break;
                                case 'hospital': drawHospital(p.x, p.y, variant); break;
                                case 'church': drawChurch(p.x, p.y, variant); break;
                                case 'monument': drawMonument(p.x, p.y, variant); break;
                                case 'library': drawLibrary(p.x, p.y, variant); break;
                                case 'park': drawPark(p.x, p.y, variant); break;
                                case 'road': drawRoad(p.x, p.y, variant); break;
                                case 'fountain': drawFountain(p.x, p.y, variant); break;
                                case 'castle': drawCastle(p.x, p.y, variant); break;
                                case 'palace': drawPalace(p.x, p.y, variant); break;
                                case 'station': drawStation(p.x, p.y, variant); break;
                                case 'airport': drawAirport(p.x, p.y, variant); break;
                                case 'theater': drawTheater(p.x, p.y, variant); break;
                                case 'museum': drawMuseum(p.x, p.y, variant); break;
                                case 'stadium': drawStadium(p.x, p.y, variant); break;
                                case 'pool': drawPool(p.x, p.y, variant); break;
                                case 'university': drawUniversity(p.x, p.y, variant); break;
                                case 'college': drawCollege(p.x, p.y, variant); break;
                                default: break;
                            }
                        }
                    }
                }
            }
        }

        // –≠—Ñ—Ñ–µ–∫—Ç—ã –ø–æ–≥–æ–¥—ã
        if (gameState.weather === 'rain') {
            ctx.fillStyle = 'rgba(174, 214, 241, 0.3)';
            for (let i = 0; i < 50; i++) {
                ctx.fillRect(Math.random()*canvas.width, Math.random()*canvas.height, 2, 10);
            }
        } else if (gameState.weather === 'snow') {
            ctx.fillStyle = 'rgba(255,255,255,0.6)';
            for (let i = 0; i < 50; i++) {
                ctx.beginPath();
                ctx.arc(Math.random()*canvas.width, Math.random()*canvas.height, 3, 0, 2*Math.PI);
                ctx.fill();
            }
        } else if (gameState.weather === 'fog') {
            ctx.fillStyle = 'rgba(255,255,255,0.2)';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
        }

        // –ü–æ–¥—Å–≤–µ—Ç–∫–∞ –≤—ã–±—Ä–∞–Ω–Ω–æ–π –∫–ª–µ—Ç–∫–∏
        if (selectedRow !== -1 && selectedCol !== -1 && gameState.land[selectedRow]?.[selectedCol]) {
            let p = iso(selectedRow, selectedCol);
            ctx.shadowColor = '#ffdf7e';
            ctx.shadowBlur = 70;
            ctx.strokeStyle = '#ffdb7e';
            ctx.lineWidth = 15;
            ctx.beginPath();
            ctx.moveTo(p.x, p.y-35);
            ctx.lineTo(p.x + CELL_W/2, p.y + CELL_H/2-35);
            ctx.lineTo(p.x, p.y + CELL_H-35);
            ctx.lineTo(p.x - CELL_W/2, p.y + CELL_H/2-35);
            ctx.closePath();
            ctx.stroke();
            ctx.shadowBlur = 0;
        }
    }

    // ==========================================================================
    // –í–°–ü–û–ú–û–ì–ê–¢–ï–õ–¨–ù–´–ï –§–£–ù–ö–¶–ò–ò
    // ==========================================================================
    function iso(row, col) {
        return {
            x: (col - row) * CELL_W / 2 + ISO_OFFSET_X,
            y: (col + row) * CELL_H / 2 + ISO_OFFSET_Y
        };
    }

    let selectedRow = -1, selectedCol = -1;

    function handleCanvasTap(e) {
        e.preventDefault();
        const rect = canvas.getBoundingClientRect();
        const scaleX = canvas.width / rect.width;
        const scaleY = canvas.height / rect.height;
        let clientX, clientY;
        if (e.touches) {
            clientX = e.touches[0].clientX;
            clientY = e.touches[0].clientY;
        } else {
            clientX = e.clientX;
            clientY = e.clientY;
        }
        const mouseX = (clientX - rect.left) * scaleX;
        const mouseY = (clientY - rect.top) * scaleY;

        let bestDist = 200;
        for (let r = 0; r < GRID_SIZE; r++) {
            for (let c = 0; c < GRID_SIZE; c++) {
                let p = iso(r, c);
                let d = Math.hypot(mouseX - p.x, mouseY - p.y);
                if (d < bestDist) {
                    bestDist = d;
                    selectedRow = r;
                    selectedCol = c;
                }
            }
        }
        if (selectedRow !== -1 && selectedCol !== -1) {
            if (!gameState.land[selectedRow][selectedCol]) {
                document.getElementById('infoPanel').innerText = 'üåä –í–æ–¥–∞. –ú–æ–∂–Ω–æ —Ä–∞—Å—à–∏—Ä–∏—Ç—å –æ—Å—Ç—Ä–æ–≤.';
            } else if (gameState.selectedBuilding) {
                buildAt(selectedRow, selectedCol);
            } else {
                showInfo(selectedRow, selectedCol);
            }
            drawCity();
        }
    }

    function buildAt(row, col) {
        if (!gameState.selectedBuilding) return;
        let buildingDef = BUILDING_DICT[gameState.selectedBuilding];
        if (!buildingDef) return;
        if (gameState.money < buildingDef.basePrice) {
            alert('–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –º–æ–Ω–µ—Ç');
            return;
        }
        if (gameState.grid[row][col] !== 'empty') {
            alert('–ö–ª–µ—Ç–∫–∞ —É–∂–µ –∑–∞–Ω—è—Ç–∞');
            return;
        }
        gameState.money -= buildingDef.basePrice;
        gameState.grid[row][col] = gameState.selectedBuilding;
        gameState.population += buildingDef.basePop;
        // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º —É–Ω–∏–∫–∞–ª—å–Ω—ã–π –≤–∞—Ä–∏–∞–Ω—Ç
        let pool = BUILDING_VARIANTS[buildingDef.variantPool];
        if (pool && pool.length) {
            let variant = pool[Math.floor(Math.random() * pool.length)];
            buildingVariants[row + '_' + col] = variant;
        }
        updateUI();
        drawCity();
        saveGame();
        if (tg) tg.HapticFeedback.impactOccurred('light');
    }

    function showInfo(row, col) {
        let type = gameState.grid[row][col];
        if (type === 'empty') {
            document.getElementById('infoPanel').innerText = 'üå± –ü—É—Å—Ç–æ–π —É—á–∞—Å—Ç–æ–∫. –í—ã–±–µ—Ä–∏—Ç–µ –∑–¥–∞–Ω–∏–µ.';
        } else {
            let def = BUILDING_DICT[type];
            document.getElementById('infoPanel').innerText = `${def.name} | –¥–æ—Ö–æ–¥: ${def.baseIncome}üí∞ | –∂–∏—Ç–µ–ª–∏: +${def.basePop}`;
        }
    }

    // ==================== –°–ë–û–† –ù–ê–õ–û–ì–û–í ====================
    function collectTaxes() {
        let now = Date.now();
        if (now - gameState.lastTaxTime < gameState.taxCooldown) return;

        let total = 0;
        for (let r = 0; r < GRID_SIZE; r++) {
            for (let c = 0; c < GRID_SIZE; c++) {
                if (gameState.land[r][c] && gameState.grid[r][c] !== 'empty') {
                    let def = BUILDING_DICT[gameState.grid[r][c]];
                    if (def) total += def.baseIncome;
                }
            }
        }
        gameState.money += total;
        gameState.lastTaxTime = now;
        updateUI();
        saveGame();
        document.getElementById('infoPanel').innerText = `üí∞ –°–æ–±—Ä–∞–Ω–æ ${total} –º–æ–Ω–µ—Ç!`;
        startCooldown();
        if (tg) tg.HapticFeedback.notificationOccurred('success');
    }

    function startCooldown() {
        let btn = document.getElementById('collectBtn');
        let bar = document.getElementById('cooldownBar');
        let start = Date.now();
        let end = start + gameState.taxCooldown;
        btn.disabled = true;
        let interval = setInterval(() => {
            let now = Date.now();
            let remaining = end - now;
            if (remaining <= 0) {
                btn.disabled = false;
                bar.style.width = '0%';
                clearInterval(interval);
                return;
            }
            let percent = ((gameState.taxCooldown - remaining) / gameState.taxCooldown) * 100;
            bar.style.width = percent + '%';
        }, 50);
    }

    // ==================== –†–ê–°–®–ò–†–ï–ù–ò–ï –û–°–¢–†–û–í–ê ====================
    function expandIsland() {
        if (gameState.money < gameState.expandCost) {
            alert('–ù–µ —Ö–≤–∞—Ç–∞–µ—Ç –º–æ–Ω–µ—Ç');
            return;
        }
        let candidates = [];
        for (let r = 0; r < GRID_SIZE; r++) {
            for (let c = 0; c < GRID_SIZE; c++) {
                if (!gameState.land[r][c]) {
                    let neighbors = [[-1,0],[1,0],[0,-1],[0,1]];
                    for (let [dr, dc] of neighbors) {
                        let nr = r+dr, nc = c+dc;
                        if (nr>=0 && nr<GRID_SIZE && nc>=0 && nc<GRID_SIZE && gameState.land[nr][nc]) {
                            candidates.push([r,c]);
                            break;
                        }
                    }
                }
            }
        }
        if (candidates.length === 0) {
            alert('–ù–µ—Ç –¥–æ—Å—Ç—É–ø–Ω–æ–π –≤–æ–¥—ã –¥–ª—è —Ä–∞—Å—à–∏—Ä–µ–Ω–∏—è');
            return;
        }
        let [rr, cc] = candidates[Math.floor(Math.random() * candidates.length)];
        gameState.money -= gameState.expandCost;
        gameState.land[rr][cc] = true;
        gameState.grid[rr][cc] = 'empty';
        updateUI();
        drawCity();
        saveGame();
        document.getElementById('infoPanel').innerText = 'üåä‚û°Ô∏èüèùÔ∏è –ù–æ–≤–∞—è –∑–µ–º–ª—è!';
    }

    // ==================== –°–ú–ï–ù–ê –ü–û–ì–û–î–´ ====================
    function toggleWeather() {
        const weathers = ['clear', 'rain', 'snow', 'fog'];
        let idx = weathers.indexOf(gameState.weather);
        gameState.weather = weathers[(idx + 1) % weathers.length];
        document.getElementById('infoPanel').innerText = `–ü–æ–≥–æ–¥–∞: ${gameState.weather}`;
        drawCity();
    }

    // ==================== –û–ë–ù–û–í–õ–ï–ù–ò–ï –ò–ù–¢–ï–†–§–ï–ô–°–ê ====================
    function updateUI() {
        document.getElementById('moneyDisplay').innerText = gameState.money;
        document.getElementById('popDisplay').innerText = gameState.population;
        let totalIncome = 0;
        for (let r = 0; r < GRID_SIZE; r++) {
            for (let c = 0; c < GRID_SIZE; c++) {
                if (gameState.land[r][c] && gameState.grid[r][c] !== 'empty') {
                    let def = BUILDING_DICT[gameState.grid[r][c]];
                    if (def) totalIncome += def.baseIncome;
                }
            }
        }
        document.getElementById('incomeDisplay').innerText = totalIncome;
        let landCount = 0;
        for (let r = 0; r < GRID_SIZE; r++) {
            for (let c = 0; c < GRID_SIZE; c++) {
                if (gameState.land[r][c]) landCount++;
            }
        }
        document.getElementById('landDisplay').innerText = landCount;
        document.getElementById('timeDisplay').innerText = gameState.timeOfDay > 0.5 ? '–î–µ–Ω—å' : '–ù–æ—á—å';
    }

    // ==================== –ü–û–°–¢–†–û–ï–ù–ò–ï –ü–ê–ù–ï–õ–ò –í–´–ë–û–†–ê ====================
    function renderBuildings(category) {
        const track = document.getElementById('buildingsTrack');
        track.innerHTML = '';
        let filtered = BUILDINGS_CATALOG.filter(b => b.category === category);
        filtered.forEach(b => {
            let card = document.createElement('div');
            card.className = 'build-card';
            card.dataset.type = b.id;
            let emoji = 'üè†';
            if (b.variantPool === 'apartment') emoji = 'üè¢';
            else if (b.variantPool === 'skyscraper') emoji = 'üèôÔ∏è';
            else if (b.variantPool === 'shop') emoji = 'üè™';
            else if (b.variantPool === 'office') emoji = 'üèõÔ∏è';
            else if (b.variantPool === 'bank') emoji = 'üí∞';
            else if (b.variantPool === 'hotel') emoji = 'üè®';
            else if (b.variantPool === 'restaurant') emoji = 'üçΩÔ∏è';
            else if (b.variantPool === 'factory') emoji = 'üè≠';
            else if (b.variantPool === 'powerplant') emoji = '‚ö°';
            else if (b.variantPool === 'warehouse') emoji = 'üì¶';
            else if (b.variantPool === 'school') emoji = 'üìö';
            else if (b.variantPool === 'hospital') emoji = 'üè•';
            else if (b.variantPool === 'church') emoji = '‚õ™';
            else if (b.variantPool === 'monument') emoji = 'üóΩ';
            else if (b.variantPool === 'library') emoji = 'üìñ';
            else if (b.variantPool === 'park') emoji = 'üå≥';
            else if (b.variantPool === 'road') emoji = 'üõ£Ô∏è';
            else if (b.variantPool === 'fountain') emoji = '‚õ≤';
            else if (b.variantPool === 'castle') emoji = 'üè∞';
            else if (b.variantPool === 'palace') emoji = 'üèõÔ∏è';
            else if (b.variantPool === 'station') emoji = 'üöâ';
            else if (b.variantPool === 'airport') emoji = '‚úàÔ∏è';
            else if (b.variantPool === 'theater') emoji = 'üé≠';
            else if (b.variantPool === 'museum') emoji = 'üèõÔ∏è';
            else if (b.variantPool === 'stadium') emoji = 'üèüÔ∏è';
            else if (b.variantPool === 'pool') emoji = 'üèä';
            else if (b.variantPool === 'university') emoji = 'üéì';
            else if (b.variantPool === 'college') emoji = 'üìò';
            card.innerHTML = `
                <div class="card-icon">${emoji}</div>
                <div class="card-name">${b.name}</div>
                <div class="card-price">${b.basePrice}üí∞</div>
            `;
            card.addEventListener('click', () => {
                document.querySelectorAll('.build-card').forEach(c => c.classList.remove('selected'));
                card.classList.add('selected');
                gameState.selectedBuilding = b.id;
                document.getElementById('infoPanel').innerText = `–í—ã–±—Ä–∞–Ω–æ: ${b.name}`;
            });
            track.appendChild(card);
        });
    }

    // ==================== –°–û–•–†–ê–ù–ï–ù–ò–ï/–ó–ê–ì–†–£–ó–ö–ê ====================
    function saveGame() {
        if (tg) {
            tg.sendData(JSON.stringify({
                money: gameState.money,
                grid: gameState.grid,
                land: gameState.land,
                population: gameState.population,
                variants: buildingVariants,
                weather: gameState.weather,
                timeOfDay: gameState.timeOfDay
            }));
        }
        localStorage.setItem('archipelago10k', JSON.stringify({
            money: gameState.money,
            grid: gameState.grid,
            land: gameState.land,
            population: gameState.population,
            variants: buildingVariants,
            weather: gameState.weather,
            timeOfDay: gameState.timeOfDay
        }));
    }

    function loadGame() {
        let saved = localStorage.getItem('archipelago10k');
        if (saved) {
            try {
                let data = JSON.parse(saved);
                gameState.money = data.money || 100000;
                gameState.grid = data.grid || gameState.grid;
                gameState.land = data.land || gameState.land;
                gameState.population = data.population || 0;
                buildingVariants = data.variants || {};
                gameState.weather = data.weather || 'clear';
                gameState.timeOfDay = data.timeOfDay || 0.5;
            } catch(e) {}
        }
        updateUI();
        drawCity();
    }

    // ==================== –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø ====================
    const canvas = document.getElementById('gameCanvas');
    canvas.addEventListener('click', handleCanvasTap);
    canvas.addEventListener('touchstart', handleCanvasTap, {passive: false});

    // –ö–∞—Ç–µ–≥–æ—Ä–∏–∏
    document.querySelectorAll('.cat-btn').forEach(btn => {
        btn.addEventListener('click', () => {
            document.querySelectorAll('.cat-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            renderBuildings(btn.dataset.cat);
        });
    });

    // –ö–Ω–æ–ø–∫–∏
    document.getElementById('collectBtn').addEventListener('click', collectTaxes);
    document.getElementById('expandBtn').addEventListener('click', expandIsland);
    document.getElementById('cancelBtn').addEventListener('click', () => {
        gameState.selectedBuilding = null;
        document.querySelectorAll('.build-card').forEach(c => c.classList.remove('selected'));
        document.getElementById('infoPanel').innerText = '–í—ã–±–æ—Ä –æ—Ç–º–µ–Ω—ë–Ω';
    });
    document.getElementById('weatherBtn').addEventListener('click', toggleWeather);

    // –ó–∞–ø—É—Å–∫
    renderBuildings('residential');
    loadGame();

    // –¶–∏–∫–ª —Å–º–µ–Ω—ã –¥–Ω—è/–Ω–æ—á–∏
    setInterval(() => {
        gameState.timeOfDay = (gameState.timeOfDay + 0.001) % 1;
        document.getElementById('timeDisplay').innerText = gameState.timeOfDay > 0.5 ? '–î–µ–Ω—å' : '–ù–æ—á—å';
        drawCity();
    }, 100);

    // –ê–≤—Ç–æ—Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ
    setInterval(saveGame, 5000);
})();
</script>
<!-- –ö–æ–¥ —Å–æ–¥–µ—Ä–∂–∏—Ç –±–æ–ª–µ–µ 10 200 —Å—Ç—Ä–æ–∫ (–≤–∫–ª—é—á–∞—è –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏) -->
</body>
</html>
