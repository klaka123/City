<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Island Empire ‚Äî —Å—Ç—Ä–æ–∏—Ç–µ–ª—å—Å—Ç–≤–æ –º–µ–≥–∞–ø–æ–ª–∏—Å–∞</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Roboto, system-ui, sans-serif;
        }
        body {
            background: #0a1c2a;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            padding: 8px;
        }
        .game-wrapper {
            width: 100%;
            max-width: 560px;
            background: linear-gradient(145deg, #1f5575, #123d57);
            border-radius: 48px;
            padding: 16px;
            box-shadow: 0 30px 50px rgba(0,0,0,0.8), inset 0 2px 5px rgba(255,255,255,0.15);
            border: 2px solid #4f8aab;
        }
        /* –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ */
        .resource-panel {
            background: rgba(0, 20, 30, 0.7);
            backdrop-filter: blur(15px);
            border-radius: 60px;
            padding: 14px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            color: white;
            margin-bottom: 18px;
            border: 1px solid #7eb6d0;
            box-shadow: 0 8px 0 #0e3a4f;
        }
        .resource-item {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 20px;
            font-weight: 600;
            text-shadow: 0 2px 3px black;
        }
        .resource-icon {
            font-size: 28px;
            filter: drop-shadow(0 4px 4px black);
        }
        /* –ò–∑–æ–º–µ—Ç—Ä–∏—á–µ—Å–∫–∏–π —Ö–æ–ª—Å—Ç */
        .canvas-container {
            background: #1f6f9c;
            border-radius: 40px;
            padding: 15px;
            display: flex;
            justify-content: center;
            box-shadow: inset 0 -15px 30px #0b4057, 0 10px 20px black;
            margin-bottom: 18px;
            touch-action: none;
        }
        #gameCanvas {
            width: 100%;
            height: auto;
            border-radius: 30px;
            background: #317fb0;
            cursor: pointer;
            image-rendering: crisp-edges;
            touch-action: none;
            max-width: 500px;
            box-shadow: 0 0 0 3px #7fc1e0, 0 15px 30px black;
        }
        /* –ü–∞–Ω–µ–ª—å –≤—ã–±–æ—Ä–∞ –ø–æ—Å—Ç—Ä–æ–µ–∫ (–≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω—ã–π —Å–∫—Ä–æ–ª–ª) */
        .build-scroll {
            background: rgba(255, 255, 255, 0.85);
            backdrop-filter: blur(15px);
            border-radius: 60px;
            padding: 12px;
            margin-bottom: 18px;
            overflow-x: auto;
            white-space: nowrap;
            -webkit-overflow-scrolling: touch;
            scrollbar-width: none;
            border: 2px solid white;
        }
        .build-scroll::-webkit-scrollbar { display: none; }
        .build-track {
            display: inline-flex;
            gap: 14px;
            padding: 6px;
        }
        .build-card {
            background: linear-gradient(145deg, #faf3e0, #e6d9b8);
            border-radius: 40px;
            padding: 16px 20px;
            display: inline-flex;
            flex-direction: column;
            align-items: center;
            min-width: 120px;
            box-shadow: 0 8px 0 #ad9f7c, 0 12px 25px rgba(0,0,0,0.4);
            border: 3px solid #fff6dc;
            transition: 0.1s;
            touch-action: manipulation;
        }
        .build-card.selected {
            transform: translateY(-4px);
            border-color: #ffb851;
            box-shadow: 0 10px 0 #c58e38, 0 18px 30px black;
        }
        .build-card:active {
            transform: translateY(5px);
            box-shadow: 0 3px 0 #ad9f7c;
        }
        .card-emoji {
            font-size: 48px;
            filter: drop-shadow(0 8px 8px rgba(0,0,0,0.3));
        }
        .card-name {
            font-weight: 800;
            font-size: 15px;
            color: #1d503a;
            letter-spacing: 0.5px;
        }
        .card-price {
            background: #c9b27c;
            padding: 5px 16px;
            border-radius: 40px;
            font-weight: 700;
            margin-top: 6px;
            font-size: 15px;
            color: #2d2d2d;
        }
        /* –ö–Ω–æ–ø–∫–∏ –¥–µ–π—Å—Ç–≤–∏–π */
        .action-grid {
            display: flex;
            gap: 12px;
            justify-content: center;
            flex-wrap: wrap;
            margin-bottom: 16px;
        }
        .big-btn {
            flex: 1 1 auto;
            min-width: 140px;
            background: linear-gradient(145deg, #3c88b0, #195a7a);
            border: none;
            border-radius: 60px;
            padding: 18px 20px;
            color: white;
            font-size: 22px;
            font-weight: bold;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            box-shadow: 0 9px 0 #0d405b, 0 15px 30px black;
            border: 2px solid #7abfdf;
            touch-action: manipulation;
        }
        .big-btn:active {
            transform: translateY(6px);
            box-shadow: 0 3px 0 #0d405b;
        }
        .big-btn:disabled {
            opacity: 0.5;
            transform: none;
            pointer-events: none;
        }
        /* –ò–Ω—Ñ–æ-–ø–∞–Ω–µ–ª—å */
        .detail-panel {
            background: #d6edf8;
            border-radius: 40px;
            padding: 18px;
            color: #0b3a50;
            border: 3px solid white;
            font-size: 16px;
            font-weight: 500;
            box-shadow: inset 0 5px 10px #9fc8dd, 0 8px 0 #54849b;
        }
    </style>
</head>
<body>
<div class="game-wrapper">
    <!-- –†–µ—Å—É—Ä—Å—ã -->
    <div class="resource-panel">
        <div class="resource-item"><span class="resource-icon">üí∞</span> <span id="moneyDisplay">10000</span></div>
        <div class="resource-item"><span class="resource-icon">üë®‚Äçüë©‚Äçüëß</span> <span id="popDisplay">0</span></div>
        <div class="resource-item"><span class="resource-icon">üìä</span> <span id="incomeDisplay">0</span></div>
        <div class="resource-item"><span class="resource-icon">üèùÔ∏è</span> <span id="landDisplay">25</span></div>
    </div>

    <!-- –ò–∑–æ–º–µ—Ç—Ä–∏—á–µ—Å–∫–∞—è –∫–∞—Ä—Ç–∞ -->
    <div class="canvas-container">
        <canvas id="gameCanvas" width="600" height="500"></canvas>
    </div>

    <!-- –í—ã–±–æ—Ä –∑–¥–∞–Ω–∏–π (—Å–∫—Ä–æ–ª–ª) -->
    <div class="build-scroll">
        <div class="build-track" id="buildTrack"></div>
    </div>

    <!-- –î–µ–π—Å—Ç–≤–∏—è -->
    <div class="action-grid">
        <button class="big-btn" id="collectBtn"><span>üí∞</span> –°–±–æ—Ä</button>
        <button class="big-btn" id="expandBtn"><span>üåä‚ÜíüèùÔ∏è</span> 800ü™ô</button>
        <button class="big-btn" id="cancelBtn"><span>‚ùå</span> –û—Ç–º–µ–Ω–∞</button>
    </div>

    <!-- –î–µ—Ç–∞–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è -->
    <div class="detail-panel" id="infoPanel">
        üëÜ –í—ã–±–µ—Ä–∏—Ç–µ –∑–¥–∞–Ω–∏–µ –∏ –∫–æ—Å–Ω–∏—Ç–µ—Å—å –∫–ª–µ—Ç–∫–∏ –Ω–∞ –∫–∞—Ä—Ç–µ.
    </div>
</div>

<script src="https://telegram.org/js/telegram-web-app.js"></script>
<script>
    (function() {
        // ==================== Telegram ====================
        let tg = null;
        try {
            if (window.Telegram && Telegram.WebApp) {
                tg = Telegram.WebApp;
                tg.expand();
                tg.ready();
            }
        } catch(e) { console.log('No Telegram'); }

        // ==================== –ü–∞—Ä–∞–º–µ—Ç—Ä—ã –º–∏—Ä–∞ ====================
        const BASE_SIZE = 7;          // 7x7 –Ω–∞—á–∞–ª—å–Ω—ã–π –æ—Å—Ç—Ä–æ–≤
        const CELL_W = 80;            // —à–∏—Ä–∏–Ω–∞ —Ç–∞–π–ª–∞ (–∏–∑–æ–º–µ—Ç—Ä–∏—á–µ—Å–∫–∞—è)
        const CELL_H = 45;            // –≤—ã—Å–æ—Ç–∞ —Ç–∞–π–ª–∞
        const ISO_OFFSET_X = 280;     // —Ü–µ–Ω—Ç—Ä–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–∞ canvas
        const ISO_OFFSET_Y = 60;

        // ==================== –¢–∏–ø—ã –∑–¥–∞–Ω–∏–π (—Å –¥–µ—Ç–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–æ–π –æ—Ç—Ä–∏—Å–æ–≤–∫–æ–π) ====================
        const BUILDINGS = {
            empty: {
                name: '–ü—É—Å—Ç–æ', price: 0, income: 0, pop: 0, level: 0,
                draw: function(ctx, x, y, isLand) {
                    // –û—Å–Ω–æ–≤–∞–Ω–∏–µ (–∑–µ–º–ª—è)
                    ctx.fillStyle = '#7cb57c';
                    ctx.shadowColor = '#3a6b3a';
                    ctx.shadowBlur = 10;
                    ctx.shadowOffsetY = 4;
                    ctx.beginPath();
                    ctx.moveTo(x, y-5);
                    ctx.lineTo(x + CELL_W/2, y + CELL_H/2-5);
                    ctx.lineTo(x, y + CELL_H-5);
                    ctx.lineTo(x - CELL_W/2, y + CELL_H/2-5);
                    ctx.closePath();
                    ctx.fill();
                    ctx.shadowBlur = 0;
                    // –¢–µ–∫—Å—Ç—É—Ä–∫–∞ —Ç—Ä–∞–≤—ã
                    ctx.fillStyle = '#6aa56a';
                    ctx.font = '22px sans-serif';
                    ctx.fillText('üåø', x-15, y-5);
                }
            },
            house1: {
                name: '–î–æ–º', price: 150, income: 12, pop: 5, level: 1,
                draw: function(ctx, x, y) {
                    // –§—É–Ω–¥–∞–º–µ–Ω—Ç
                    ctx.fillStyle = '#d6b17e';
                    ctx.shadowColor = '#7b5a3a';
                    ctx.shadowBlur = 14;
                    ctx.shadowOffsetY = 6;
                    ctx.beginPath();
                    ctx.moveTo(x, y-18);
                    ctx.lineTo(x + CELL_W/2, y + CELL_H/2-18);
                    ctx.lineTo(x, y + CELL_H-18);
                    ctx.lineTo(x - CELL_W/2, y + CELL_H/2-18);
                    ctx.closePath();
                    ctx.fill();
                    // –ö—Ä—ã—à–∞ (–∫—Ä–∞—Å–Ω–∞—è —á–µ—Ä–µ–ø–∏—Ü–∞)
                    ctx.fillStyle = '#b34b4b';
                    ctx.shadowBlur = 12;
                    ctx.beginPath();
                    ctx.moveTo(x-20, y-38);
                    ctx.lineTo(x+20, y-38);
                    ctx.lineTo(x, y-58);
                    ctx.closePath();
                    ctx.fill();
                    // –î–≤–µ—Ä—å
                    ctx.fillStyle = '#6b4226';
                    ctx.shadowBlur = 8;
                    ctx.fillRect(x-8, y-24, 16, 24);
                    // –û–∫–Ω–∞
                    ctx.fillStyle = '#f9e076';
                    ctx.fillRect(x-18, y-30, 10, 10);
                    ctx.fillRect(x+8, y-30, 10, 10);
                    ctx.shadowBlur = 0;
                }
            },
            house2: {
                name: '–ö–æ—Ç—Ç–µ–¥–∂', price: 400, income: 30, pop: 15, level: 2,
                draw: function(ctx, x, y) {
                    ctx.fillStyle = '#c99f6b';
                    ctx.shadowColor = '#7b5a3a';
                    ctx.shadowBlur = 14;
                    ctx.shadowOffsetY = 6;
                    ctx.beginPath();
                    ctx.moveTo(x, y-22);
                    ctx.lineTo(x + CELL_W/2, y + CELL_H/2-22);
                    ctx.lineTo(x, y + CELL_H-22);
                    ctx.lineTo(x - CELL_W/2, y + CELL_H/2-22);
                    ctx.closePath();
                    ctx.fill();
                    // –î–≤—É—Ö—Å–∫–∞—Ç–Ω–∞—è –∫—Ä—ã—à–∞
                    ctx.fillStyle = '#7a4c4c';
                    ctx.beginPath();
                    ctx.moveTo(x-28, y-42);
                    ctx.lineTo(x+28, y-42);
                    ctx.lineTo(x, y-72);
                    ctx.closePath();
                    ctx.fill();
                    // –≠—Ç–∞–∂–∏
                    ctx.fillStyle = '#a57248';
                    ctx.fillRect(x-22, y-38, 44, 18);
                    ctx.fillStyle = '#f9e076';
                    for (let i = -12; i <= 12; i+=14) {
                        ctx.fillRect(x-6+i, y-32, 8, 8);
                    }
                    ctx.shadowBlur = 0;
                }
            },
            house3: {
                name: '–ú–Ω–æ–≥–æ–∫–≤–∞—Ä—Ç–∏—Ä–Ω—ã–π', price: 1000, income: 80, pop: 45, level: 3,
                draw: function(ctx, x, y) {
                    ctx.fillStyle = '#b0bec5';
                    ctx.shadowColor = '#5a6b7a';
                    ctx.shadowBlur = 16;
                    ctx.shadowOffsetY = 8;
                    ctx.beginPath();
                    ctx.moveTo(x, y-28);
                    ctx.lineTo(x + CELL_W/2, y + CELL_H/2-28);
                    ctx.lineTo(x, y + CELL_H-28);
                    ctx.lineTo(x - CELL_W/2, y + CELL_H/2-28);
                    ctx.closePath();
                    ctx.fill();
                    // –ë–∞—à–Ω—è
                    ctx.fillStyle = '#8a9aa8';
                    ctx.fillRect(x-24, y-60, 48, 42);
                    for (let i = -16; i <= 16; i+=18) {
                        ctx.fillStyle = '#cfd8dc';
                        ctx.fillRect(x-8+i, y-52, 10, 14);
                        ctx.fillRect(x-8+i, y-32, 10, 14);
                    }
                    ctx.shadowBlur = 0;
                }
            },
            skyscraper: {
                name: '–ù–µ–±–æ—Å–∫—Ä—ë–±', price: 3000, income: 250, pop: 150, level: 4,
                draw: function(ctx, x, y) {
                    ctx.fillStyle = '#607d8b';
                    ctx.shadowColor = '#1f3a47';
                    ctx.shadowBlur = 18;
                    ctx.shadowOffsetY = 10;
                    ctx.beginPath();
                    ctx.moveTo(x, y-40);
                    ctx.lineTo(x + CELL_W/2, y + CELL_H/2-40);
                    ctx.lineTo(x, y + CELL_H-40);
                    ctx.lineTo(x - CELL_W/2, y + CELL_H/2-40);
                    ctx.closePath();
                    ctx.fill();
                    // –í—ã—Å–æ—Ç–Ω–∞—è —á–∞—Å—Ç—å
                    ctx.fillStyle = '#4f6573';
                    ctx.fillRect(x-28, y-90, 56, 70);
                    // –û–∫–Ω–∞
                    ctx.fillStyle = '#ffd966';
                    for (let i = -20; i <= 20; i+=15) {
                        for (let j = -70; j <= -10; j+=20) {
                            ctx.fillRect(x-6+i, y+j-2, 8, 12);
                        }
                    }
                    // –ê–Ω—Ç–µ–Ω–Ω–∞
                    ctx.fillStyle = '#b0bec5';
                    ctx.fillRect(x-2, y-100, 4, 20);
                    ctx.shadowBlur = 0;
                }
            },
            shop: {
                name: '–ú–∞–≥–∞–∑–∏–Ω', price: 280, income: 35, pop: 2, level: 1,
                draw: function(ctx, x, y) {
                    ctx.fillStyle = '#ffb74d';
                    ctx.shadowColor = '#b46f1a';
                    ctx.shadowBlur = 14;
                    ctx.shadowOffsetY = 6;
                    ctx.beginPath();
                    ctx.moveTo(x, y-18);
                    ctx.lineTo(x + CELL_W/2, y + CELL_H/2-18);
                    ctx.lineTo(x, y + CELL_H-18);
                    ctx.lineTo(x - CELL_W/2, y + CELL_H/2-18);
                    ctx.closePath();
                    ctx.fill();
                    ctx.fillStyle = '#ff9800';
                    ctx.fillRect(x-22, y-34, 44, 24);
                    ctx.fillStyle = '#ffffff';
                    ctx.font = '26px sans-serif';
                    ctx.fillText('üõí', x-16, y-14);
                    ctx.shadowBlur = 0;
                }
            },
            office: {
                name: '–û—Ñ–∏—Å', price: 750, income: 90, pop: 5, level: 2,
                draw: function(ctx, x, y) {
                    ctx.fillStyle = '#9e9e9e';
                    ctx.shadowColor = '#5a5a5a';
                    ctx.shadowBlur = 15;
                    ctx.shadowOffsetY = 7;
                    ctx.beginPath();
                    ctx.moveTo(x, y-25);
                    ctx.lineTo(x + CELL_W/2, y + CELL_H/2-25);
                    ctx.lineTo(x, y + CELL_H-25);
                    ctx.lineTo(x - CELL_W/2, y + CELL_H/2-25);
                    ctx.closePath();
                    ctx.fill();
                    ctx.fillStyle = '#757575';
                    ctx.fillRect(x-24, y-50, 48, 35);
                    for (let i = -12; i <= 12; i+=14) {
                        ctx.fillStyle = '#cfd8dc';
                        ctx.fillRect(x-8+i, y-42, 10, 10);
                        ctx.fillRect(x-8+i, y-24, 10, 10);
                    }
                    ctx.shadowBlur = 0;
                }
            },
            school: {
                name: '–®–∫–æ–ª–∞', price: 1500, income: 40, pop: 0, level: 2,
                draw: function(ctx, x, y) {
                    ctx.fillStyle = '#ff8a80';
                    ctx.shadowColor = '#b2453a';
                    ctx.shadowBlur = 16;
                    ctx.shadowOffsetY = 7;
                    ctx.beginPath();
                    ctx.moveTo(x, y-22);
                    ctx.lineTo(x + CELL_W/2, y + CELL_H/2-22);
                    ctx.lineTo(x, y + CELL_H-22);
                    ctx.lineTo(x - CELL_W/2, y + CELL_H/2-22);
                    ctx.closePath();
                    ctx.fill();
                    ctx.fillStyle = '#f06292';
                    ctx.fillRect(x-26, y-48, 52, 34);
                    ctx.fillStyle = '#ffffff';
                    ctx.font = '28px sans-serif';
                    ctx.fillText('üìö', x-18, y-22);
                    ctx.shadowBlur = 0;
                }
            },
            hospital: {
                name: '–ë–æ–ª—å–Ω–∏—Ü–∞', price: 2200, income: 65, pop: 0, level: 3,
                draw: function(ctx, x, y) {
                    ctx.fillStyle = '#ef9a9a';
                    ctx.shadowColor = '#a54444';
                    ctx.shadowBlur = 16;
                    ctx.shadowOffsetY = 7;
                    ctx.beginPath();
                    ctx.moveTo(x, y-25);
                    ctx.lineTo(x + CELL_W/2, y + CELL_H/2-25);
                    ctx.lineTo(x, y + CELL_H-25);
                    ctx.lineTo(x - CELL_W/2, y + CELL_H/2-25);
                    ctx.closePath();
                    ctx.fill();
                    ctx.fillStyle = '#e57373';
                    ctx.fillRect(x-26, y-52, 52, 40);
                    ctx.fillStyle = '#ffffff';
                    ctx.font = '30px sans-serif';
                    ctx.fillText('üè•', x-20, y-22);
                    ctx.shadowBlur = 0;
                }
            },
            park: {
                name: '–ü–∞—Ä–∫', price: 200, income: 18, pop: 2, level: 1,
                draw: function(ctx, x, y) {
                    ctx.fillStyle = '#81c784';
                    ctx.shadowColor = '#3f7840';
                    ctx.shadowBlur = 14;
                    ctx.shadowOffsetY = 5;
                    ctx.beginPath();
                    ctx.moveTo(x, y-10);
                    ctx.lineTo(x + CELL_W/2, y + CELL_H/2-10);
                    ctx.lineTo(x, y + CELL_H-10);
                    ctx.lineTo(x - CELL_W/2, y + CELL_H/2-10);
                    ctx.closePath();
                    ctx.fill();
                    ctx.fillStyle = '#5f9b6b';
                    ctx.font = '32px sans-serif';
                    ctx.fillText('üå≥', x-20, y-14);
                    ctx.fillStyle = '#c5e1a5';
                    ctx.beginPath();
                    ctx.arc(x+6, y-16, 8, 0, Math.PI*2);
                    ctx.fill();
                    ctx.shadowBlur = 0;
                }
            },
            road: {
                name: '–î–æ—Ä–æ–≥–∞', price: 80, income: 4, pop: 0, level: 0,
                draw: function(ctx, x, y) {
                    ctx.fillStyle = '#b0bec5';
                    ctx.shadowColor = '#6e7b8c';
                    ctx.shadowBlur = 10;
                    ctx.shadowOffsetY = 4;
                    ctx.beginPath();
                    ctx.moveTo(x, y-5);
                    ctx.lineTo(x + CELL_W/2, y + CELL_H/2-5);
                    ctx.lineTo(x, y + CELL_H-5);
                    ctx.lineTo(x - CELL_W/2, y + CELL_H/2-5);
                    ctx.closePath();
                    ctx.fill();
                    ctx.fillStyle = '#90a4ae';
                    ctx.fillRect(x-24, y-12, 48, 8);
                    ctx.fillRect(x-8, y-24, 8, 30);
                    ctx.shadowBlur = 0;
                }
            },
            powerplant: {
                name: '–≠–ª–µ–∫—Ç—Ä–æ—Å—Ç–∞–Ω—Ü–∏—è', price: 3500, income: 350, pop: 0, level: 4,
                draw: function(ctx, x, y) {
                    ctx.fillStyle = '#b0a57c';
                    ctx.shadowColor = '#6b5d3a';
                    ctx.shadowBlur = 18;
                    ctx.shadowOffsetY = 9;
                    ctx.beginPath();
                    ctx.moveTo(x, y-30);
                    ctx.lineTo(x + CELL_W/2, y + CELL_H/2-30);
                    ctx.lineTo(x, y + CELL_H-30);
                    ctx.lineTo(x - CELL_W/2, y + CELL_H/2-30);
                    ctx.closePath();
                    ctx.fill();
                    ctx.fillStyle = '#8b7a5a';
                    ctx.fillRect(x-26, y-68, 52, 50);
                    // –¢—Ä—É–±–∞
                    ctx.fillStyle = '#6b5a3a';
                    ctx.fillRect(x-6, y-98, 12, 40);
                    ctx.fillStyle = '#ffb74d';
                    ctx.font = '28px sans-serif';
                    ctx.fillText('‚ö°', x-16, y-36);
                    ctx.shadowBlur = 0;
                }
            }
        };

        // ==================== –°–æ—Å—Ç–æ—è–Ω–∏–µ –∏–≥—Ä—ã ====================
        let gameState = {
            balance: 10000,
            gridSize: 7,
            grid: [],           // —Ç–∏–ø –∑–¥–∞–Ω–∏—è –¥–ª—è –∫–∞–∂–¥–æ–π –∫–ª–µ—Ç–∫–∏
            land: [],            // true = —Å—É—à–∞, false = –≤–æ–¥–∞
            population: 0,
            lastTaxTime: Date.now(),
            taxCooldown: 30000,
            selectedBuilding: null,
            expandCost: 800,
        };

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è: —Ü–µ–Ω—Ç—Ä–∞–ª—å–Ω—ã–π –æ—Å—Ç—Ä–æ–≤ 5x5
        function initLand() {
            for (let r = 0; r < gameState.gridSize; r++) {
                gameState.grid[r] = [];
                gameState.land[r] = [];
                for (let c = 0; c < gameState.gridSize; c++) {
                    // –æ—Å—Ç—Ä–æ–≤ –ø—Ä–∏–º–µ—Ä–Ω–æ –≤ —Ü–µ–Ω—Ç—Ä–µ (r,c –æ—Ç 1 –¥–æ 5)
                    if (r >= 1 && r <= 5 && c >= 1 && c <= 5) {
                        gameState.land[r][c] = true;
                        gameState.grid[r][c] = 'empty';
                    } else {
                        gameState.land[r][c] = false;
                        gameState.grid[r][c] = 'empty';
                    }
                }
            }
        }
        initLand();

        // ==================== –ò–∑–æ–º–µ—Ç—Ä–∏—á–µ—Å–∫–∏–µ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã ====================
        function gridToIso(row, col) {
            const x = (col - row) * CELL_W / 2 + ISO_OFFSET_X;
            const y = (col + row) * CELL_H / 2 + ISO_OFFSET_Y;
            return { x, y };
        }

        // ==================== –û—Ç—Ä–∏—Å–æ–≤–∫–∞ ====================
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');

        function drawCity() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);

            // –ú–æ—Ä–µ (–≥—Ä–∞–¥–∏–µ–Ω—Ç)
            const seaGrad = ctx.createLinearGradient(0, 0, 0, canvas.height);
            seaGrad.addColorStop(0, '#2a7faa');
            seaGrad.addColorStop(1, '#115b82');
            ctx.fillStyle = seaGrad;
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            // –í–æ–ª–Ω—ã
            ctx.fillStyle = '#3d9acf';
            ctx.globalAlpha = 0.15;
            for (let i=0; i<10; i++) {
                ctx.beginPath();
                ctx.arc(70 + i*70, 400 + Math.sin(i)*12, 35, 0, Math.PI*2);
                ctx.fill();
            }
            ctx.globalAlpha = 1;

            // –†–∏—Å—É–µ–º –≤—Å–µ –∫–ª–µ—Ç–∫–∏
            for (let r = 0; r < gameState.gridSize; r++) {
                for (let c = 0; c < gameState.gridSize; c++) {
                    const iso = gridToIso(r, c);
                    if (!gameState.land[r][c]) {
                        // –í–æ–¥–∞
                        ctx.fillStyle = '#1f7a9c';
                        ctx.shadowColor = '#0c4b66';
                        ctx.shadowBlur = 12;
                        ctx.shadowOffsetY = 5;
                        ctx.beginPath();
                        ctx.moveTo(iso.x, iso.y);
                        ctx.lineTo(iso.x + CELL_W/2, iso.y + CELL_H/2);
                        ctx.lineTo(iso.x, iso.y + CELL_H);
                        ctx.lineTo(iso.x - CELL_W/2, iso.y + CELL_H/2);
                        ctx.closePath();
                        ctx.fill();
                        // –†—è–±—å
                        ctx.fillStyle = '#48b5e0';
                        ctx.globalAlpha = 0.2;
                        ctx.font = '20px sans-serif';
                        ctx.fillText('üíß', iso.x-12, iso.y-4);
                        ctx.globalAlpha = 1;
                        continue;
                    }
                    const type = gameState.grid[r][c];
                    const b = BUILDINGS[type] || BUILDINGS.empty;
                    if (b.draw) {
                        b.draw(ctx, iso.x, iso.y, true);
                    }
                }
            }

            // –ü–æ–¥—Å–≤–µ—Ç–∫–∞ –≤—ã–±—Ä–∞–Ω–Ω–æ–π –∫–ª–µ—Ç–∫–∏
            if (selRow !== -1 && selCol !== -1 && gameState.land[selRow] && gameState.land[selRow][selCol]) {
                const iso = gridToIso(selRow, selCol);
                ctx.strokeStyle = '#ffdb7c';
                ctx.lineWidth = 5;
                ctx.shadowColor = '#ffb300';
                ctx.shadowBlur = 20;
                ctx.beginPath();
                ctx.moveTo(iso.x, iso.y-15);
                ctx.lineTo(iso.x + CELL_W/2, iso.y + CELL_H/2-15);
                ctx.lineTo(iso.x, iso.y + CELL_H-15);
                ctx.lineTo(iso.x - CELL_W/2, iso.y + CELL_H/2-15);
                ctx.closePath();
                ctx.stroke();
                ctx.shadowBlur = 0;
            }
        }

        // ==================== –í–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏–µ —Å –∫–∞—Ä—Ç–æ–π ====================
        let selRow = -1, selCol = -1;

        canvas.addEventListener('click', handleCanvasTouch);
        canvas.addEventListener('touchstart', handleCanvasTouch, {passive: false});

        function handleCanvasTouch(e) {
            e.preventDefault();
            const rect = canvas.getBoundingClientRect();
            const scaleX = canvas.width / rect.width;
            const scaleY = canvas.height / rect.height;

            let clientX, clientY;
            if (e.touches) {
                clientX = e.touches[0].clientX;
                clientY = e.touches[0].clientY;
            } else {
                clientX = e.clientX;
                clientY = e.clientY;
            }

            const mouseX = (clientX - rect.left) * scaleX;
            const mouseY = (clientY - rect.top) * scaleY;

            let bestDist = 80;
            for (let r=0; r<gameState.gridSize; r++) {
                for (let c=0; c<gameState.gridSize; c++) {
                    const iso = gridToIso(r, c);
                    const dx = mouseX - iso.x;
                    const dy = mouseY - iso.y;
                    const dist = Math.sqrt(dx*dx + dy*dy);
                    if (dist < bestDist) {
                        bestDist = dist;
                        selRow = r;
                        selCol = c;
                    }
                }
            }

            if (selRow !== -1 && selCol !== -1) {
                if (!gameState.land[selRow][selCol]) {
                    document.getElementById('infoPanel').innerHTML = 'üåä –≠—Ç–æ –≤–æ–¥–∞. –ö—É–ø–∏—Ç–µ —É—á–∞—Å—Ç–æ–∫ –∑–∞ 800üí∞.';
                } else if (gameState.selectedBuilding) {
                    buildAt(selRow, selCol);
                } else {
                    showInfo(selRow, selCol);
                }
                drawCity();
            }
        }

        function buildAt(row, col) {
            if (!gameState.selectedBuilding) return;
            const type = gameState.selectedBuilding;
            const b = BUILDINGS[type];
            if (!b) return;
            if (gameState.balance < b.price) {
                alert('–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –º–æ–Ω–µ—Ç');
                return;
            }
            if (gameState.grid[row][col] !== 'empty') {
                alert('–ö–ª–µ—Ç–∫–∞ –∑–∞–Ω—è—Ç–∞');
                return;
            }
            gameState.balance -= b.price;
            gameState.grid[row][col] = type;
            gameState.population += b.pop || 0;
            updateUI();
            drawCity();
            saveGame();
        }

        function showInfo(row, col) {
            const type = gameState.grid[row][col];
            if (type === 'empty') {
                document.getElementById('infoPanel').innerHTML = 'üå± –ü—É—Å—Ç–æ–π —É—á–∞—Å—Ç–æ–∫. –í—ã–±–µ—Ä–∏—Ç–µ –∑–¥–∞–Ω–∏–µ –∏ –Ω–∞–∂–º–∏—Ç–µ —Å–Ω–æ–≤–∞.';
            } else {
                const b = BUILDINGS[type];
                document.getElementById('infoPanel').innerHTML = `${b.name} | –î–æ—Ö–æ–¥: ${b.income}üí∞/—Å–±–æ—Ä | –ñ–∏—Ç–µ–ª–∏: +${b.pop}`;
            }
        }

        // ==================== –°–±–æ—Ä –Ω–∞–ª–æ–≥–æ–≤ ====================
        function collectTax() {
            const now = Date.now();
            if (now - gameState.lastTaxTime < gameState.taxCooldown) {
                alert('–ù–∞–ª–æ–≥–∏ –º–æ–∂–Ω–æ —Å–æ–±–∏—Ä–∞—Ç—å —Ä–∞–∑ –≤ 30 —Å–µ–∫—É–Ω–¥');
                return;
            }
            let total = 0;
            for (let r=0; r<gameState.gridSize; r++) {
                for (let c=0; c<gameState.gridSize; c++) {
                    if (gameState.land[r][c] && gameState.grid[r][c] !== 'empty') {
                        total += BUILDINGS[gameState.grid[r][c]].income;
                    }
                }
            }
            gameState.balance += total;
            gameState.lastTaxTime = now;
            updateUI();
            saveGame();
            document.getElementById('infoPanel').innerHTML = `üí∞ –°–æ–±—Ä–∞–Ω–æ ${total} –º–æ–Ω–µ—Ç!`;
            if (tg) tg.HapticFeedback.notificationOccurred('success');
        }

        // ==================== –†–∞—Å—à–∏—Ä–µ–Ω–∏–µ –æ—Å—Ç—Ä–æ–≤–∞ ====================
        function expandIsland() {
            if (gameState.balance < gameState.expandCost) {
                alert('–ù–µ —Ö–≤–∞—Ç–∞–µ—Ç –º–æ–Ω–µ—Ç');
                return;
            }
            // –ù–∞–π—Ç–∏ –≤—Å–µ –∫–ª–µ—Ç–∫–∏ –≤–æ–¥—ã, –≥—Ä–∞–Ω–∏—á–∞—â–∏–µ —Å —Å—É—à–µ–π
            let candidates = [];
            for (let r=0; r<gameState.gridSize; r++) {
                for (let c=0; c<gameState.gridSize; c++) {
                    if (!gameState.land[r][c]) {
                        const neighbors = [[-1,0],[1,0],[0,-1],[0,1]];
                        for (let [dr,dc] of neighbors) {
                            let nr = r+dr, nc = c+dc;
                            if (nr>=0 && nr<gameState.gridSize && nc>=0 && nc<gameState.gridSize && gameState.land[nr][nc]) {
                                candidates.push([r,c]);
                                break;
                            }
                        }
                    }
                }
            }
            if (candidates.length === 0) {
                alert('–ù–µ—Ç –¥–æ—Å—Ç—É–ø–Ω–æ–π –≤–æ–¥—ã –¥–ª—è —Ä–∞—Å—à–∏—Ä–µ–Ω–∏—è');
                return;
            }
            const [rr,cc] = candidates[Math.floor(Math.random() * candidates.length)];
            gameState.balance -= gameState.expandCost;
            gameState.land[rr][cc] = true;
            gameState.grid[rr][cc] = 'empty';
            updateUI();
            drawCity();
            saveGame();
            document.getElementById('infoPanel').innerHTML = 'üåä‚û°Ô∏èüèùÔ∏è –ù–æ–≤–∞—è –∑–µ–º–ª—è –ø—Ä–∏–æ–±—Ä–µ—Ç–µ–Ω–∞!';
        }

        // ==================== –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞ ====================
        function updateUI() {
            document.getElementById('moneyDisplay').innerText = gameState.balance;
            document.getElementById('popDisplay').innerText = gameState.population;
            let totalIncome = 0;
            for (let r=0; r<gameState.gridSize; r++) {
                for (let c=0; c<gameState.gridSize; c++) {
                    if (gameState.land[r][c] && gameState.grid[r][c] !== 'empty') {
                        totalIncome += BUILDINGS[gameState.grid[r][c]].income;
                    }
                }
            }
            document.getElementById('incomeDisplay').innerText = totalIncome;
            let landCount = 0;
            for (let r=0; r<gameState.gridSize; r++) {
                for (let c=0; c<gameState.gridSize; c++) {
                    if (gameState.land[r][c]) landCount++;
                }
            }
            document.getElementById('landDisplay').innerText = landCount;
        }

        // ==================== –ü–æ—Å—Ç—Ä–æ–µ–Ω–∏–µ –ø–∞–Ω–µ–ª–∏ –≤—ã–±–æ—Ä–∞ ====================
        function buildSelectionPanel() {
            const track = document.getElementById('buildTrack');
            track.innerHTML = '';
            const entries = [
                ['house1','üè†','–î–æ–º',150],
                ['house2','üè°','–ö–æ—Ç—Ç–µ–¥–∂',400],
                ['house3','üè¢','–ú–Ω–æ–≥–æ–∫–≤.',1000],
                ['skyscraper','üèôÔ∏è','–ù–µ–±–æ—Å–∫—Ä—ë–±',3000],
                ['shop','üè™','–ú–∞–≥–∞–∑–∏–Ω',280],
                ['office','üèõÔ∏è','–û—Ñ–∏—Å',750],
                ['school','üè´','–®–∫–æ–ª–∞',1500],
                ['hospital','üè•','–ë–æ–ª—å–Ω–∏—Ü–∞',2200],
                ['park','üå≥','–ü–∞—Ä–∫',200],
                ['road','üõ£Ô∏è','–î–æ—Ä–æ–≥–∞',80],
                ['powerplant','‚ö°','–≠–ª–µ–∫—Ç—Ä–æ',3500]
            ];
            entries.forEach(([key, emoji, name, price]) => {
                const card = document.createElement('div');
                card.className = 'build-card';
                card.setAttribute('data-type', key);
                card.innerHTML = `<div class="card-emoji">${emoji}</div><div class="card-name">${name}</div><div class="card-price">${price}üí∞</div>`;
                card.addEventListener('click', (e) => {
                    e.stopPropagation();
                    document.querySelectorAll('.build-card').forEach(c => c.classList.remove('selected'));
                    card.classList.add('selected');
                    gameState.selectedBuilding = key;
                    document.getElementById('infoPanel').innerHTML = `–í—ã–±—Ä–∞–Ω–æ: ${name}`;
                });
                track.appendChild(card);
            });
        }

        // ==================== –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ/–∑–∞–≥—Ä—É–∑–∫–∞ ====================
        function saveGame() {
            if (tg) {
                tg.sendData(JSON.stringify({
                    balance: gameState.balance,
                    grid: gameState.grid,
                    land: gameState.land,
                    population: gameState.population
                }));
            }
            localStorage.setItem('islandEmpire', JSON.stringify(gameState));
        }

        function loadGame() {
            const saved = localStorage.getItem('islandEmpire');
            if (saved) {
                try {
                    const data = JSON.parse(saved);
                    gameState = {...gameState, ...data};
                } catch(e) {}
            }
            updateUI();
            drawCity();
        }

        // ==================== –°–±—Ä–æ—Å –∏–≥—Ä—ã ====================
        function resetGame() {
            if (confirm('–ù–∞—á–∞—Ç—å –∑–∞–Ω–æ–≤–æ?')) {
                gameState = {
                    balance: 10000,
                    gridSize: 7,
                    grid: [],
                    land: [],
                    population: 0,
                    lastTaxTime: Date.now(),
                    taxCooldown: 30000,
                    selectedBuilding: null,
                    expandCost: 800,
                };
                initLand();
                updateUI();
                drawCity();
                saveGame();
            }
        }

        // ==================== –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∏ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ ====================
        buildSelectionPanel();
        loadGame();

        document.getElementById('collectBtn').addEventListener('click', collectTax);
        document.getElementById('expandBtn').addEventListener('click', expandIsland);
        document.getElementById('cancelBtn').addEventListener('click', () => {
            gameState.selectedBuilding = null;
            document.querySelectorAll('.build-card').forEach(c => c.classList.remove('selected'));
            document.getElementById('infoPanel').innerHTML = '–í—ã–±–æ—Ä —Å–±—Ä–æ—à–µ–Ω';
        });

        // –ê–≤—Ç–æ—Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∫–∞–∂–¥—ã–µ 10 —Å–µ–∫—É–Ω–¥
        setInterval(saveGame, 10000);
    })();
</script>
</body>
</html>
