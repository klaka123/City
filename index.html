<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>MEGA CITY 1024 - –ê–†–•–ò–¢–ï–ö–¢–£–†–ù–´–ô –ì–ò–ì–ê–ù–¢</title>
    <style>
        /* ========== –ò–ù–¢–ï–†–§–ï–ô–° - –°–û–•–†–ê–ù–Å–ù –ü–û–õ–ù–û–°–¢–¨–Æ ========== */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Roboto, 'Helvetica Neue', sans-serif;
            user-select: none;
        }

        body {
            background: #0c1e2c;
            overflow: hidden;
            touch-action: none;
        }

        .game-container {
            position: relative;
            width: 100vw;
            height: 100vh;
            overflow: hidden;
            background: radial-gradient(circle at 30% 50%, #1d4b6e, #0a1c2c);
        }

        #gameCanvas {
            display: block;
            width: 100%;
            height: 100%;
            cursor: grab;
            touch-action: none;
        }

        #gameCanvas:active {
            cursor: grabbing;
        }

        .ui-panel {
            position: fixed;
            bottom: 30px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(20, 40, 55, 0.95);
            backdrop-filter: blur(20px);
            border-radius: 80px;
            padding: 20px 40px;
            display: flex;
            gap: 40px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.6);
            z-index: 100;
        }

        .stat-item {
            display: flex;
            align-items: center;
            gap: 15px;
            color: white;
            font-size: 28px;
            font-weight: 600;
            text-shadow: 0 2px 5px black;
        }

        .stat-icon {
            font-size: 40px;
            filter: drop-shadow(0 4px 6px black);
        }

        .build-menu {
            position: fixed;
            top: 50%;
            left: 30px;
            transform: translateY(-50%);
            background: rgba(20, 40, 55, 0.95);
            backdrop-filter: blur(20px);
            border-radius: 50px;
            padding: 25px 15px;
            display: flex;
            flex-direction: column;
            gap: 15px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.6);
            z-index: 100;
            max-height: 80vh;
            overflow-y: auto;
            scrollbar-width: thin;
            scrollbar-color: #4a9ec0 #1e3f55;
            min-width: 320px;
        }

        .build-menu::-webkit-scrollbar {
            width: 8px;
        }

        .build-menu::-webkit-scrollbar-thumb {
            background: #4a9ec0;
            border-radius: 10px;
        }

        .build-category {
            color: white;
            font-size: 20px;
            font-weight: 600;
            padding: 10px 20px;
            background: rgba(255, 255, 255, 0.15);
            border-radius: 40px;
            text-align: center;
            letter-spacing: 1px;
            margin-top: 10px;
        }

        .build-item {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 40px;
            padding: 12px 20px;
            display: flex;
            align-items: center;
            gap: 15px;
            cursor: pointer;
            transition: all 0.2s;
            border: 2px solid transparent;
        }

        .build-item:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: translateX(5px);
        }

        .build-item.selected {
            border-color: #ffb84d;
            background: rgba(255, 184, 77, 0.2);
            box-shadow: 0 0 20px rgba(255, 184, 77, 0.3);
        }

        .item-icon {
            width: 50px;
            height: 50px;
            background: rgba(255, 255, 255, 0.15);
            border-radius: 25px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 28px;
        }

        .item-info {
            flex: 1;
        }

        .item-name {
            color: white;
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 4px;
        }

        .item-price {
            color: #ffd966;
            font-size: 16px;
            font-weight: 500;
        }

        .control-menu {
            position: fixed;
            top: 50%;
            right: 30px;
            transform: translateY(-50%);
            background: rgba(20, 40, 55, 0.95);
            backdrop-filter: blur(20px);
            border-radius: 50px;
            padding: 25px 20px;
            display: flex;
            flex-direction: column;
            gap: 15px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.6);
            z-index: 100;
        }

        .control-btn {
            background: rgba(255, 255, 255, 0.1);
            border: none;
            border-radius: 40px;
            padding: 15px 25px;
            color: white;
            font-size: 22px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 12px;
            cursor: pointer;
            transition: all 0.2s;
            border: 2px solid transparent;
            min-width: 200px;
        }

        .control-btn:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: translateX(-5px);
        }

        .control-btn:active {
            transform: scale(0.95);
        }

        .control-btn.collect {
            background: rgba(76, 175, 80, 0.3);
            border-color: #4caf50;
        }

        .control-btn.cancel {
            background: rgba(244, 67, 54, 0.3);
            border-color: #f44336;
        }

        .info-panel {
            position: fixed;
            top: 30px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(20, 40, 55, 0.95);
            backdrop-filter: blur(20px);
            border-radius: 60px;
            padding: 15px 40px;
            color: white;
            font-size: 22px;
            font-weight: 500;
            border: 2px solid rgba(255, 255, 255, 0.3);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.6);
            z-index: 100;
            text-align: center;
            min-width: 400px;
        }

        .notification {
            position: fixed;
            top: 100px;
            right: 30px;
            background: rgba(0, 0, 0, 0.95);
            backdrop-filter: blur(15px);
            color: white;
            padding: 15px 30px;
            border-radius: 60px;
            font-size: 20px;
            font-weight: 500;
            z-index: 1000;
            animation: slideInRight 0.3s ease;
            border: 2px solid #ffb84d;
            box-shadow: 0 10px 30px black;
        }

        @keyframes slideInRight {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
    </style>
</head>
<body>
<div class="game-container">
    <canvas id="gameCanvas"></canvas>

    <!-- –ù–∏–∂–Ω—è—è –ø–∞–Ω–µ–ª—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ -->
    <div class="ui-panel">
        <div class="stat-item">
            <span class="stat-icon">üí∞</span>
            <span id="moneyDisplay">10,000,000</span>
        </div>
        <div class="stat-item">
            <span class="stat-icon">üë•</span>
            <span id="popDisplay">0</span>
        </div>
        <div class="stat-item">
            <span class="stat-icon">üìä</span>
            <span id="incomeDisplay">0</span>
        </div>
        <div class="stat-item">
            <span class="stat-icon">üèóÔ∏è</span>
            <span id="buildingsCount">0/2500</span>
        </div>
    </div>

    <!-- –õ–µ–≤–æ–µ –º–µ–Ω—é (–ø–æ—Å—Ç—Ä–æ–π–∫–∏) -->
    <div class="build-menu" id="buildMenu"></div>

    <!-- –ü—Ä–∞–≤–æ–µ –º–µ–Ω—é (—É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ) -->
    <div class="control-menu">
        <button class="control-btn collect" id="collectBtn">
            <span>üí∞</span> –°–ë–û–† –ù–ê–õ–û–ì–û–í
        </button>
        <button class="control-btn" id="weatherBtn">
            <span>üå¶Ô∏è</span> –°–ú–ï–ù–ò–¢–¨ –ü–û–ì–û–î–£
        </button>
        <button class="control-btn" id="timeBtn">
            <span>‚è∞</span> –°–ú–ï–ù–ò–¢–¨ –í–†–ï–ú–Ø
        </button>
        <button class="control-btn cancel" id="cancelBtn">
            <span>‚ùå</span> –û–¢–ú–ï–ù–ê
        </button>
        <button class="control-btn" id="resetBtn">
            <span>üîÑ</span> –ù–û–í–´–ô –ì–û–†–û–î
        </button>
    </div>

    <!-- –í–µ—Ä—Ö–Ω—è—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–æ–Ω–Ω–∞—è –ø–∞–Ω–µ–ª—å -->
    <div class="info-panel" id="infoPanel">
        üëÜ –í–´–ë–ï–†–ò–¢–ï –ó–î–ê–ù–ò–ï –ò –ù–ê–ñ–ú–ò–¢–ï –ù–ê –ö–ê–†–¢–£
    </div>
</div>

<script>
// ============================================================================
// MEGA CITY 1024 - –ê–ë–°–û–õ–Æ–¢–ù–û –†–ê–ë–û–ß–ê–Ø –í–ï–†–°–ò–Ø
// ============================================================================
// - 1024 —É–Ω–∏–∫–∞–ª—å–Ω—ã—Ö –∑–¥–∞–Ω–∏—è (16 –∫–∞—Ç–µ–≥–æ—Ä–∏–π –ø–æ 64 –∑–¥–∞–Ω–∏—è)
// - –ü–æ–ª–Ω–æ—Å—Ç—å—é —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ–µ —Å—Ç—Ä–æ–∏—Ç–µ–ª—å—Å—Ç–≤–æ
// - –†–∞–±–æ—á–∏–µ –∫–Ω–æ–ø–∫–∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è
// - –ö–∞–º–µ—Ä–∞ —Å –∑—É–º–æ–º –∏ –ø–µ—Ä–µ–º–µ—â–µ–Ω–∏–µ–º
// - –ü–æ–≥–æ–¥–∞ –∏ –≤—Ä–µ–º—è —Å—É—Ç–æ–∫
// - –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ localStorage
// ============================================================================

(function() {
    // ==================== Telegram ====================
    let tg = null;
    try {
        if (window.Telegram?.WebApp) {
            tg = Telegram.WebApp;
            tg.expand();
            tg.ready();
        }
    } catch {}

    // ==================== –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø ====================
    const CONFIG = {
        GRID_SIZE: 50,
        CELL_SIZE: 70,
        TAX_COOLDOWN: 8000,
        MAX_ZOOM: 3,
        MIN_ZOOM: 0.4,
        ZOOM_SPEED: 0.1,
        START_MONEY: 10000000,
    };

    // ==================== –°–û–°–¢–û–Ø–ù–ò–ï –ò–ì–†–´ ====================
    const gameState = {
        money: CONFIG.START_MONEY,
        grid: [],
        population: 0,
        lastTaxTime: Date.now(),
        selectedBuilding: null,
        selectedBuildingData: null,
        weather: 'clear',
        timeOfDay: 0.6,
        camera: { x: 0, y: 0, zoom: 1 },
        isDragging: false,
        lastMouseX: 0,
        lastMouseY: 0,
        buildingsCount: 0,
    };

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å–µ—Ç–∫–∏
    for (let r = 0; r < CONFIG.GRID_SIZE; r++) {
        gameState.grid[r] = [];
        for (let c = 0; c < CONFIG.GRID_SIZE; c++) {
            gameState.grid[r][c] = 'empty';
        }
    }

    // ==========================================================================
    // –ë–ò–ë–õ–ò–û–¢–ï–ö–ê –ò–ó 1024 –£–ù–ò–ö–ê–õ–¨–ù–´–• –ó–î–ê–ù–ò–ô
    // ==========================================================================
    const buildings = {};

    // –ö–∞—Ç–µ–≥–æ—Ä–∏–∏ –∏ –∏—Ö —ç–º–æ–¥–∑–∏
    const categories = [
        { id: 'residential', name: '–ñ–ò–õ–´–ï', emoji: 'üèòÔ∏è', prefix: 'Res' },
        { id: 'commercial', name: '–ö–û–ú–ú–ï–†–¶–ò–Ø', emoji: 'üè™', prefix: 'Com' },
        { id: 'industrial', name: '–ü–†–û–ú–´–®–õ–ï–ù–ù–û–°–¢–¨', emoji: 'üè≠', prefix: 'Ind' },
        { id: 'infrastructure', name: '–ò–ù–§–†–ê–°–¢–†–£–ö–¢–£–†–ê', emoji: 'üèóÔ∏è', prefix: 'Inf' },
        { id: 'cultural', name: '–ö–£–õ–¨–¢–£–†–ê', emoji: 'üé≠', prefix: 'Cul' },
        { id: 'sports', name: '–°–ü–û–†–¢', emoji: '‚öΩ', prefix: 'Spo' },
        { id: 'transport', name: '–¢–†–ê–ù–°–ü–û–†–¢', emoji: 'üöâ', prefix: 'Tra' },
        { id: 'education', name: '–û–ë–†–ê–ó–û–í–ê–ù–ò–ï', emoji: 'üìö', prefix: 'Edu' },
        { id: 'healthcare', name: '–ú–ï–î–ò–¶–ò–ù–ê', emoji: 'üè•', prefix: 'Hea' },
        { id: 'entertainment', name: '–†–ê–ó–í–õ–ï–ß–ï–ù–ò–Ø', emoji: 'üé°', prefix: 'Ent' },
        { id: 'government', name: '–ì–û–°–£–î–ê–†–°–¢–í–û', emoji: 'üèõÔ∏è', prefix: 'Gov' },
        { id: 'religious', name: '–†–ï–õ–ò–ì–ò–Ø', emoji: '‚õ™', prefix: 'Rel' },
        { id: 'military', name: '–í–û–ï–ù–ù–´–ï', emoji: 'üéñÔ∏è', prefix: 'Mil' },
        { id: 'agricultural', name: '–°–ï–õ–¨–°–ö–û–ï –•–û–ó–Ø–ô–°–¢–í–û', emoji: 'üåæ', prefix: 'Agr' },
        { id: 'scientific', name: '–ù–ê–£–ö–ê', emoji: 'üî¨', prefix: 'Sci' },
        { id: 'tourist', name: '–¢–£–†–ò–ó–ú', emoji: 'üè®', prefix: 'Tou' }
    ];

    // –†—É—Å—Å–∫–∏–µ –Ω–∞–∑–≤–∞–Ω–∏—è –¥–ª—è –∫–∞–∂–¥–æ–π –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
    const names = {
        residential: ['–î–æ–º', '–ö–æ—Ç—Ç–µ–¥–∂', '–û—Å–æ–±–Ω—è–∫', '–¢–∞—É–Ω—Ö–∞—É—Å', '–í–∏–ª–ª–∞', '–†–µ–∑–∏–¥–µ–Ω—Ü–∏—è', '–ê–ø–∞—Ä—Ç–∞–º–µ–Ω—Ç—ã', '–•–æ—Ä–æ–º—ã', '–ü–∞–ª–∞—Ç—ã', '–£—Å–∞–¥—å–±–∞', '–®–∞–ª–µ', '–ë—É–Ω–≥–∞–ª–æ', '–§–∞–∑–µ–Ω–¥–∞', '–î–≤–æ—Ä–µ—Ü', '–ó–∞–º–æ–∫', '–ö—Ä–µ–ø–æ—Å—Ç—å', '–ë–∞—à–Ω—è', '–¢–µ—Ä–µ–º', '–ò–∑–±–∞', '–•–∏–∂–∏–Ω–∞'],
        commercial: ['–ú–∞–≥–∞–∑–∏–Ω', '–ë—É—Ç–∏–∫', '–¢–¶', '–õ–∞–≤–∫–∞', '–†—ã–Ω–æ–∫', '–°—É–ø–µ—Ä–º–∞—Ä–∫–µ—Ç', '–ì–∏–ø–µ—Ä–º–∞—Ä–∫–µ—Ç', '–ü–∞–≤–∏–ª—å–æ–Ω', '–ö–∏–æ—Å–∫', '–£–Ω–∏–≤–µ—Ä–º–∞–≥', '–¢–æ—Ä–≥–æ–≤—ã–π —Ü–µ–Ω—Ç—Ä', '–ú–æ–ª–ª', '–ì–∞–ª–µ—Ä–µ—è', '–ü–ª–æ—â–∞–¥—å', '–ë–∞–∑–∞—Ä', '–Ø—Ä–º–∞—Ä–∫–∞', '–õ–∞—Ä—ë–∫', '–°–∞–ª–æ–Ω', '–ê—É—Ç–ª–µ—Ç', '–°—Ç–æ–∫'],
        industrial: ['–ó–∞–≤–æ–¥', '–§–∞–±—Ä–∏–∫–∞', '–¶–µ—Ö', '–ö–æ–º–±–∏–Ω–∞—Ç', '–ú–∞–Ω—É—Ñ–∞–∫—Ç—É—Ä–∞', '–ü—Ä–æ–º–∫–æ–º–ø–ª–µ–∫—Å', '–°–∫–ª–∞–¥', '–î–µ–ø–æ', '–≠–ª–µ–∫—Ç—Ä–æ—Å—Ç–∞–Ω—Ü–∏—è', '–¢–≠–¶', '–ê–≠–°', '–ì–≠–°', '–ö–æ—Ç–µ–ª—å–Ω–∞—è', '–û—á–∏—Å—Ç–Ω—ã–µ', '–•—Ä–∞–Ω–∏–ª–∏—â–µ', '–≠–ª–µ–≤–∞—Ç–æ—Ä', '–ú–µ–ª—å–Ω–∏—Ü–∞', '–õ–µ—Å–æ–ø–∏–ª–∫–∞', '–®–∞—Ö—Ç–∞', '–ö–∞—Ä—å–µ—Ä'],
        infrastructure: ['–î–æ—Ä–æ–≥–∞', '–ú–æ—Å—Ç', '–¢–æ–Ω–Ω–µ–ª—å', '–≠—Å—Ç–∞–∫–∞–¥–∞', '–†–∞–∑–≤—è–∑–∫–∞', '–°—Ç–∞–Ω—Ü–∏—è', '–¢–µ—Ä–º–∏–Ω–∞–ª', '–•–∞–±', '–ü—É—Ç–µ–ø—Ä–æ–≤–æ–¥', '–ü–µ—Ä–µ—Ö–æ–¥', '–ü–ª–∞—Ç—Ñ–æ—Ä–º–∞', '–û—Å—Ç–∞–Ω–æ–≤–∫–∞', '–í–æ–∫–∑–∞–ª', '–ê—ç—Ä–æ–ø–æ—Ä—Ç', '–ü–æ—Ä—Ç', '–ü—Ä–∏—á–∞–ª', '–®–ª—é–∑', '–î–∞–º–±–∞', '–ö–∞–Ω–∞–ª', '–¢—Ä—É–±–æ–ø—Ä–æ–≤–æ–¥'],
        cultural: ['–¢–µ–∞—Ç—Ä', '–ú—É–∑–µ–π', '–ì–∞–ª–µ—Ä–µ—è', '–§–∏–ª–∞—Ä–º–æ–Ω–∏—è', '–ö–æ–Ω—Å–µ—Ä–≤–∞—Ç–æ—Ä–∏—è', '–í—ã—Å—Ç–∞–≤–∫–∞', '–ê—Ä—Ç-—Ü–µ–Ω—Ç—Ä', '–ö–∏–Ω–æ—Ç–µ–∞—Ç—Ä', '–ë–∏–±–ª–∏–æ—Ç–µ–∫–∞', '–ê—Ä—Ö–∏–≤', '–í—ã—Å—Ç–∞–≤–æ—á–Ω—ã–π –∑–∞–ª', '–ö—É–ª—å—Ç—É—Ä–Ω—ã–π —Ü–µ–Ω—Ç—Ä', '–î–æ–º –∫—É–ª—å—Ç—É—Ä—ã', '–¶–∏—Ä–∫', '–ü–ª–∞–Ω–µ—Ç–∞—Ä–∏–π', '–û–±—Å–µ—Ä–≤–∞—Ç–æ—Ä–∏—è', '–õ–µ–∫—Ç–æ—Ä–∏–π', '–°—Ç—É–¥–∏—è', '–ú–∞—Å—Ç–µ—Ä—Å–∫–∞—è', '–ê—Ç–µ–ª—å–µ'],
        sports: ['–°—Ç–∞–¥–∏–æ–Ω', '–ê—Ä–µ–Ω–∞', '–°–ø–æ—Ä—Ç–∫–æ–º–ø–ª–µ–∫—Å', '–ë–∞—Å—Å–µ–π–Ω', '–ö–æ—Ä—Ç', '–¢—Ä–µ–∫', '–ü–ª–æ—â–∞–¥–∫–∞', '–ó–∞–ª', '–§–∏—Ç–Ω–µ—Å-—Ü–µ–Ω—Ç—Ä', '–¢—Ä–µ–Ω–∞–∂—ë—Ä–∫–∞', '–ö–∞—Ç–æ–∫', '–†–æ–ª–ª–µ—Ä–¥—Ä–æ–º', '–°–∫–µ–π—Ç-–ø–∞—Ä–∫', '–ì–æ–ª—å—Ñ-–∫–ª—É–±', '–ò–ø–ø–æ–¥—Ä–æ–º', '–í–µ–ª–æ–¥—Ä–æ–º', '–°—Ç—Ä–µ–ª—å–±–∏—â–µ', '–¢–∏—Ä', '–ö–∞—Ç–æ–∫', '–õ—ã–∂–Ω–∞—è –±–∞–∑–∞'],
        transport: ['–í–æ–∫–∑–∞–ª', '–ê—ç—Ä–æ–ø–æ—Ä—Ç', '–ü–æ—Ä—Ç', '–°—Ç–∞–Ω—Ü–∏—è', '–û—Å—Ç–∞–Ω–æ–≤–∫–∞', '–ü–ª–∞—Ç—Ñ–æ—Ä–º–∞', '–î–µ–ø–æ', '–ì–∞—Ä–∞–∂', '–ü–∞—Ä–∫–æ–≤–∫–∞', '–°—Ç–æ—è–Ω–∫–∞', '–•–∞–±', '–¢–µ—Ä–º–∏–Ω–∞–ª', '–í–µ—Ä—Ç–æ–¥—Ä–æ–º', '–ü—Ä–∏—Å—Ç–∞–Ω—å', '–ü–µ—Ä—Ä–æ–Ω', '–¢—Ä–∞–ø', '–≠—Å–∫–∞–ª–∞—Ç–æ—Ä', '–õ–∏—Ñ—Ç', '–§—É–Ω–∏–∫—É–ª—ë—Ä', '–ö–∞–Ω–∞—Ç–Ω–∞—è –¥–æ—Ä–æ–≥–∞'],
        education: ['–®–∫–æ–ª–∞', '–ì–∏–º–Ω–∞–∑–∏—è', '–õ–∏—Ü–µ–π', '–ö–æ–ª–ª–µ–¥–∂', '–£–Ω–∏–≤–µ—Ä—Å–∏—Ç–µ—Ç', '–ê–∫–∞–¥–µ–º–∏—è', '–ò–Ω—Å—Ç–∏—Ç—É—Ç', '–¢–µ—Ö–Ω–∏–∫—É–º', '–£—á–∏–ª–∏—â–µ', '–ü–¢–£', '–î–µ—Ç—Å–∫–∏–π —Å–∞–¥', '–Ø—Å–ª–∏', '–ö—É—Ä—Å—ã', '–°–µ–º–∏–Ω–∞—Ä–∏—è', '–ê—Å–ø–∏—Ä–∞–Ω—Ç—É—Ä–∞', '–î–æ–∫—Ç–æ—Ä–∞–Ω—Ç—É—Ä–∞', '–ú–∞–≥–∏—Å—Ç—Ä–∞—Ç—É—Ä–∞', '–ë–∞–∫–∞–ª–∞–≤—Ä–∏–∞—Ç', '–§–∞–∫—É–ª—å—Ç–µ—Ç', '–ö–∞—Ñ–µ–¥—Ä–∞'],
        healthcare: ['–ë–æ–ª—å–Ω–∏—Ü–∞', '–ö–ª–∏–Ω–∏–∫–∞', '–ü–æ–ª–∏–∫–ª–∏–Ω–∏–∫–∞', '–ì–æ—Å–ø–∏—Ç–∞–ª—å', '–õ–∞–∑–∞—Ä–µ—Ç', '–°–∞–Ω–∞—Ç–æ—Ä–∏–π', '–î–∏—Å–ø–∞–Ω—Å–µ—Ä', '–ê–ø—Ç–µ–∫–∞', '–ú–µ–¥—Ü–µ–Ω—Ç—Ä', '–†–æ–¥–¥–æ–º', '–•–æ—Å–ø–∏—Å', '–¢—Ä–∞–≤–º–ø—É–Ω–∫—Ç', '–°—Ç–æ–º–∞—Ç–æ–ª–æ–≥–∏—è', '–û–ø—Ç–∏–∫–∞', '–õ–∞–±–æ—Ä–∞—Ç–æ—Ä–∏—è', '–°—Ç–∞–Ω—Ü–∏—è —Å–∫–æ—Ä–æ–π –ø–æ–º–æ—â–∏', '–î–æ–∫—Ç–æ—Ä—Å–∫–∞—è', '–ó–¥—Ä–∞–≤–ø—É–Ω–∫—Ç', '–ü—Ä–æ—Ñ–∏–ª–∞–∫—Ç–æ—Ä–∏–π', '–õ–µ—á–µ–±–Ω–∏—Ü–∞'],
        entertainment: ['–ü–∞—Ä–∫ —Ä–∞–∑–≤–ª–µ—á–µ–Ω–∏–π', '–ê–∫–≤–∞–ø–∞—Ä–∫', '–î–∏—Å–Ω–µ–π–ª–µ–Ω–¥', '–õ—É–Ω–∞-–ø–∞—Ä–∫', '–ê—Ç—Ç—Ä–∞–∫—Ü–∏–æ–Ω', '–ö–∞—Ä—É—Å–µ–ª—å', '–ö–æ–ª–µ—Å–æ –æ–±–æ–∑—Ä–µ–Ω–∏—è', '–ê–º–µ—Ä–∏–∫–∞–Ω—Å–∫–∏–µ –≥–æ—Ä–∫–∏', '–ò–≥—Ä–æ–≤–æ–π —Ü–µ–Ω—Ç—Ä', '–ë–æ—É–ª–∏–Ω–≥', '–ë–∏–ª—å—è—Ä–¥–Ω–∞—è', '–ù–æ—á–Ω–æ–π –∫–ª—É–±', '–ë–∞—Ä', '–†–µ—Å—Ç–æ—Ä–∞–Ω', '–ö–∞—Ñ–µ', '–ö–æ—Ñ–µ–π–Ω—è', '–ü–∏—Ü—Ü–µ—Ä–∏—è', '–ë—É—Ä–≥–µ—Ä–Ω–∞—è', '–°—É—à–∏-–±–∞—Ä', '–°—Ç–æ–ª–æ–≤–∞—è'],
        government: ['–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ü–∏—è', '–ú—ç—Ä–∏—è', '–ü—Ä–∞–≤–∏—Ç–µ–ª—å—Å—Ç–≤–æ', '–ü–∞—Ä–ª–∞–º–µ–Ω—Ç', '–î—É–º–∞', '–°–µ–Ω–∞—Ç', '–°—É–¥–µ–±–Ω–∞—è –ø–∞–ª–∞—Ç–∞', '–ü—Ä–æ–∫—É—Ä–∞—Ç—É—Ä–∞', '–ù–∞–ª–æ–≥–æ–≤–∞—è', '–ö–∞–∑–Ω–∞—á–µ–π—Å—Ç–≤–æ', '–ú–∏–Ω–∏—Å—Ç–µ—Ä—Å—Ç–≤–æ', '–í–µ–¥–æ–º—Å—Ç–≤–æ', '–ö–æ–º–∏—Ç–µ—Ç', '–°–æ–≤–µ—Ç', '–£–ø—Ä–∞–≤–∞', '–î–µ–ø–∞—Ä—Ç–∞–º–µ–Ω—Ç', '–ö–∞–Ω—Ü–µ–ª—è—Ä–∏—è', '–†–µ–∑–∏–¥–µ–Ω—Ü–∏—è', '–û—Ñ–∏—Ü–∏—Å', '–ó–¥–∞–Ω–∏–µ –ø—Ä–∞–≤–∏—Ç–µ–ª—å—Å—Ç–≤–∞'],
        religious: ['–¶–µ—Ä–∫–æ–≤—å', '–•—Ä–∞–º', '–°–æ–±–æ—Ä', '–ú–µ—á–µ—Ç—å', '–°–∏–Ω–∞–≥–æ–≥–∞', '–ü–∞–≥–æ–¥–∞', '–°—Ç—É–ø–∞', '–î–∞—Ü–∞–Ω', '–ö–∏—Ä—Ö–∞', '–ö–æ—Å—Ç—ë–ª', '–ú–æ–Ω–∞—Å—Ç—ã—Ä—å', '–õ–∞–≤—Ä–∞', '–°–≤—è—Ç–∏–ª–∏—â–µ', '–ö–∞–ø–∏—â–µ', '–ú–æ–ª–µ–ª—å–Ω—è', '–ß–∞—Å–æ–≤–Ω—è', '–ú–µ—Å—Ç–æ —Å–∏–ª—ã', '–ê—à—Ä–∞–º', '–ú–æ–Ω–∞—Å—Ç—ã—Ä—å', '–û–±–∏—Ç–µ–ª—å'],
        military: ['–ö–∞–∑–∞—Ä–º–∞', '–®—Ç–∞–±', '–ö–ü–ü', '–ë–ª–æ–∫–ø–æ—Å—Ç', '–§–æ—Ä—Ç', '–ë—É–Ω–∫–µ—Ä', '–î–û–¢', '–î–ó–û–¢', '–ü–æ–ª–∏–≥–æ–Ω', '–¢–∏—Ä', '–ê—Ä—Å–µ–Ω–∞–ª', '–°–∫–ª–∞–¥ –æ—Ä—É–∂–∏—è', '–ì–∞—É–ø—Ç–≤–∞—Ö—Ç–∞', '–ö—Ä–µ–ø–æ—Å—Ç—å', '–¶–∏—Ç–∞–¥–µ–ª—å', '–ö–∞–∑–µ–º–∞—Ç', '–†–µ–¥—é–∏—Ç', '–ë–∞—Å—Ç–∏–æ–Ω', '–†–∞–≤–µ–ª–∏–Ω', '–¶–µ–π—Ö–≥–∞—É–∑'],
        agricultural: ['–§–µ—Ä–º–∞', '–•—É—Ç–æ—Ä', '–ü–æ–ª–µ', '–¢–µ–ø–ª–∏—Ü–∞', '–û—Ä–∞–Ω–∂–µ—Ä–µ—è', '–°–≤–∏–Ω–∞—Ä–Ω–∏–∫', '–ö–æ—Ä–æ–≤–Ω–∏–∫', '–ö–æ–Ω—é—à–Ω—è', '–ü—Ç–∏—Ü–µ—Ñ–∞–±—Ä–∏–∫–∞', '–ü–∞—Å–µ–∫–∞', '–†—ã–±—Ö–æ–∑', '–°–∞–¥', '–í–∏–Ω–æ–≥—Ä–∞–¥–Ω–∏–∫', '–û–≥–æ—Ä–æ–¥', '–ü–ª–∞–Ω—Ç–∞—Ü–∏—è', '–õ—É–≥', '–ü–∞—Å—Ç–±–∏—â–µ', '–°–µ–Ω–æ–≤–∞–ª', '–ê–º–±–∞—Ä', '–°–∏–ª–æ—Å–Ω–∞—è –±–∞—à–Ω—è'],
        scientific: ['–õ–∞–±–æ—Ä–∞—Ç–æ—Ä–∏—è', '–ù–ò–ò', '–ò—Å—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–π —Ü–µ–Ω—Ç—Ä', '–ù–∞—É—á–Ω—ã–π –ø–∞—Ä–∫', '–¢–µ—Ö–Ω–æ–ø–∞—Ä–∫', '–ò–Ω–Ω–æ–≤–∞—Ü–∏–æ–Ω–Ω—ã–π —Ü–µ–Ω—Ç—Ä', '–ë–∏–∑–Ω–µ—Å-–∏–Ω–∫—É–±–∞—Ç–æ—Ä', '–ö–æ–≤–æ—Ä–∫–∏–Ω–≥', '–•–∞–π—Ç–µ–∫-–ø–∞—Ä–∫', '–ù–∞—É–∫–æ–≥—Ä–∞–¥', '–ê–∫–∞–¥–µ–º–≥–æ—Ä–æ–¥–æ–∫', '–û–±—Å–µ—Ä–≤–∞—Ç–æ—Ä–∏—è', '–ü–ª–∞–Ω–µ—Ç–∞—Ä–∏–π', '–°–∏–Ω—Ö—Ä–æ—Ç—Ä–æ–Ω', '–ö–æ–ª–ª–∞–π–¥–µ—Ä', '–†–µ–∞–∫—Ç–æ—Ä', '–£—Å–∫–æ—Ä–∏—Ç–µ–ª—å', '–ë–∏–æ—Å—Ç–∞–Ω—Ü–∏—è', '–≠–∫–æ—Å—Ç–∞–Ω—Ü–∏—è', '–ú–µ—Ç–µ–æ—Å—Ç–∞–Ω—Ü–∏—è'],
        tourist: ['–û—Ç–µ–ª—å', '–ì–æ—Å—Ç–∏–Ω–∏—Ü–∞', '–•–æ—Å—Ç–µ–ª', '–ú–æ—Ç–µ–ª—å', '–ö–µ–º–ø–∏–Ω–≥', '–¢—É—Ä–±–∞–∑–∞', '–î–æ–º –æ—Ç–¥—ã—Ö–∞', '–ü–∞–Ω—Å–∏–æ–Ω–∞—Ç', '–°–ø–∞-—Ü–µ–Ω—Ç—Ä', '–ö—É—Ä–æ—Ä—Ç', '–°–∞–Ω–∞—Ç–æ—Ä–∏–π', '–¢—É—Ä–∏—Å—Ç–∏—á–µ—Å–∫–∏–π —Ü–µ–Ω—Ç—Ä', '–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏–æ–Ω–Ω—ã–π —Ü–µ–Ω—Ç—Ä', '–°—É–≤–µ–Ω–∏—Ä–Ω–∞—è –ª–∞–≤–∫–∞', '–≠–∫—Å–∫—É—Ä—Å–∏–æ–Ω–Ω–æ–µ –±—é—Ä–æ', '–¢—É—Ä–æ–ø–µ—Ä–∞—Ç–æ—Ä', '–ì–æ—Å—Ç–µ–≤–æ–π –¥–æ–º', '–ê–ø–∞—Ä—Ç-–æ—Ç–µ–ª—å', '–ë—É—Ç–∏–∫-–æ—Ç–µ–ª—å', '–õ–æ–¥–∂']
    };

    // –¶–≤–µ—Ç–∞ –¥–ª—è –æ—Ç—Ä–∏—Å–æ–≤–∫–∏
    const colors = [
        '#e3b27c', '#b0bec5', '#9e9e9e', '#ffb74d', '#ff8a65',
        '#ba68c8', '#4fc3f7', '#4dd0e1', '#4db6ac', '#66bb6a',
        '#9ccc65', '#d4e157', '#ffd54f', '#ffb74d', '#ff8a65', '#a1887f'
    ];

    // –ì–µ–Ω–µ—Ä–∞—Ü–∏—è 1024 –∑–¥–∞–Ω–∏–π (16 –∫–∞—Ç–µ–≥–æ—Ä–∏–π √ó 64 –∑–¥–∞–Ω–∏—è)
    let buildingId = 0;
    categories.forEach((category, catIndex) => {
        for (let i = 0; i < 64; i++) {
            const nameList = names[category.id] || names.residential;
            const baseName = nameList[i % nameList.length];
            const variant = Math.floor(i / nameList.length) + 1;
            const fullName = variant === 1 ? baseName : `${baseName} ${variant}`;
            const price = (catIndex + 1) * 1000 * (i + 1);
            const income = Math.floor(price * 0.15);
            const population = Math.floor(price / 200);
            
            buildings[`building_${buildingId}`] = {
                id: `building_${buildingId}`,
                category: category.id,
                name: fullName,
                price: price,
                income: income,
                population: population,
                color: colors[catIndex % colors.length],
                emoji: category.emoji,
                index: i
            };
            buildingId++;
        }
    });

    // ==========================================================================
    // –§–£–ù–ö–¶–ò–ò –ö–ê–ú–ï–†–´ –ò –û–¢–†–ò–°–û–í–ö–ò
    // ==========================================================================
    const canvas = document.getElementById('gameCanvas');
    const ctx = canvas.getContext('2d');

    function resizeCanvas() {
        canvas.width = window.innerWidth;
        canvas.height = window.innerHeight;
        drawCity();
    }

    window.addEventListener('resize', resizeCanvas);
    resizeCanvas();

    function gridToScreen(row, col) {
        const x = (col - row) * CONFIG.CELL_SIZE / 2 * gameState.camera.zoom + gameState.camera.x + canvas.width / 2;
        const y = (col + row) * CONFIG.CELL_SIZE / 4 * gameState.camera.zoom + gameState.camera.y + canvas.height / 3;
        return { x, y };
    }

    function screenToGrid(screenX, screenY) {
        let bestDist = Infinity;
        let bestRow = -1, bestCol = -1;
        
        for (let r = 0; r < CONFIG.GRID_SIZE; r++) {
            for (let c = 0; c < CONFIG.GRID_SIZE; c++) {
                const { x, y } = gridToScreen(r, c);
                const dist = Math.hypot(screenX - x, screenY - y);
                if (dist < bestDist && dist < 50 * gameState.camera.zoom) {
                    bestDist = dist;
                    bestRow = r;
                    bestCol = c;
                }
            }
        }
        return { row: bestRow, col: bestCol };
    }

    // ==========================================================================
    // –û–¢–†–ò–°–û–í–ö–ê –ì–û–†–û–î–ê
    // ==========================================================================
    function drawCity() {
        ctx.clearRect(0, 0, canvas.width, canvas.height);

        // –ù–µ–±–æ
        const skyGrad = ctx.createLinearGradient(0, 0, 0, canvas.height);
        if (gameState.timeOfDay > 0.6) {
            skyGrad.addColorStop(0, '#0b4b72');
            skyGrad.addColorStop(1, '#1f7aa3');
        } else if (gameState.timeOfDay > 0.3) {
            skyGrad.addColorStop(0, '#2c4f6e');
            skyGrad.addColorStop(1, '#4f7a9e');
        } else {
            skyGrad.addColorStop(0, '#0a1a2a');
            skyGrad.addColorStop(1, '#1b3447');
        }
        ctx.fillStyle = skyGrad;
        ctx.fillRect(0, 0, canvas.width, canvas.height);

        // –°–æ–ª–Ω—Ü–µ/–õ—É–Ω–∞
        ctx.shadowBlur = 100;
        ctx.shadowColor = gameState.timeOfDay > 0.5 ? '#fff9c4' : '#e0e0e0';
        ctx.beginPath();
        ctx.arc(150, 100, gameState.timeOfDay > 0.5 ? 60 : 40, 0, Math.PI * 2);
        ctx.fillStyle = gameState.timeOfDay > 0.5 ? '#fff3b0' : '#f0f0f0';
        ctx.fill();

        // –û–±–ª–∞–∫–∞
        ctx.shadowBlur = 60;
        ctx.fillStyle = '#ffffff30';
        for (let i = 0; i < 3; i++) {
            ctx.beginPath();
            ctx.ellipse(300 + i * 250, 150 + i * 30, 100, 40, 0, 0, Math.PI * 2);
            ctx.fill();
        }
        ctx.shadowBlur = 0;

        // –†–∏—Å—É–µ–º –∑–µ–º–ª—é –∏ –∑–¥–∞–Ω–∏—è
        for (let r = 0; r < CONFIG.GRID_SIZE; r++) {
            for (let c = 0; c < CONFIG.GRID_SIZE; c++) {
                const { x, y } = gridToScreen(r, c);
                
                // –ó–µ–º–ª—è
                ctx.fillStyle = '#7cb57c';
                ctx.shadowColor = '#2b4d2b';
                ctx.shadowBlur = 20 * gameState.camera.zoom;
                ctx.shadowOffsetY = 5 * gameState.camera.zoom;
                
                ctx.beginPath();
                ctx.moveTo(x, y - 5 * gameState.camera.zoom);
                ctx.lineTo(x + CONFIG.CELL_SIZE/2 * gameState.camera.zoom, y + CONFIG.CELL_SIZE/4 * gameState.camera.zoom - 5 * gameState.camera.zoom);
                ctx.lineTo(x, y + CONFIG.CELL_SIZE/2 * gameState.camera.zoom - 5 * gameState.camera.zoom);
                ctx.lineTo(x - CONFIG.CELL_SIZE/2 * gameState.camera.zoom, y + CONFIG.CELL_SIZE/4 * gameState.camera.zoom - 5 * gameState.camera.zoom);
                ctx.closePath();
                ctx.fill();

                // –ó–¥–∞–Ω–∏–µ
                const buildingId = gameState.grid[r][c];
                if (buildingId !== 'empty') {
                    const building = buildings[buildingId];
                    if (building) {
                        ctx.shadowBlur = 30 * gameState.camera.zoom;
                        ctx.fillStyle = building.color;
                        ctx.beginPath();
                        ctx.moveTo(x, y - 15 * gameState.camera.zoom);
                        ctx.lineTo(x + CONFIG.CELL_SIZE/2 * gameState.camera.zoom, y + CONFIG.CELL_SIZE/4 * gameState.camera.zoom - 15 * gameState.camera.zoom);
                        ctx.lineTo(x, y + CONFIG.CELL_SIZE/2 * gameState.camera.zoom - 15 * gameState.camera.zoom);
                        ctx.lineTo(x - CONFIG.CELL_SIZE/2 * gameState.camera.zoom, y + CONFIG.CELL_SIZE/4 * gameState.camera.zoom - 15 * gameState.camera.zoom);
                        ctx.closePath();
                        ctx.fill();

                        // –≠–º–æ–¥–∑–∏
                        ctx.shadowBlur = 0;
                        ctx.font = `${30 * gameState.camera.zoom}px 'Segoe UI Emoji'`;
                        ctx.fillStyle = 'white';
                        ctx.textAlign = 'center';
                        ctx.textBaseline = 'middle';
                        ctx.fillText(building.emoji, x, y - 10 * gameState.camera.zoom);
                    }
                }
            }
        }

        // –ü–æ–¥—Å–≤–µ—Ç–∫–∞ –≤—ã–±—Ä–∞–Ω–Ω–æ–π –∫–ª–µ—Ç–∫–∏
        if (selectedRow !== -1 && selectedCol !== -1) {
            const { x, y } = gridToScreen(selectedRow, selectedCol);
            ctx.shadowColor = '#ffdf7e';
            ctx.shadowBlur = 50;
            ctx.strokeStyle = '#ffdb7e';
            ctx.lineWidth = 8;
            ctx.beginPath();
            ctx.moveTo(x, y - 20 * gameState.camera.zoom);
            ctx.lineTo(x + CONFIG.CELL_SIZE/2 * gameState.camera.zoom, y + CONFIG.CELL_SIZE/4 * gameState.camera.zoom - 20 * gameState.camera.zoom);
            ctx.lineTo(x, y + CONFIG.CELL_SIZE/2 * gameState.camera.zoom - 20 * gameState.camera.zoom);
            ctx.lineTo(x - CONFIG.CELL_SIZE/2 * gameState.camera.zoom, y + CONFIG.CELL_SIZE/4 * gameState.camera.zoom - 20 * gameState.camera.zoom);
            ctx.closePath();
            ctx.stroke();
        }

        // –ü–æ–≥–æ–¥–∞
        if (gameState.weather === 'rain') {
            ctx.fillStyle = '#a9d6e540';
            for (let i = 0; i < 100; i++) {
                ctx.fillRect(Math.random() * canvas.width, Math.random() * canvas.height, 2, 20);
            }
        } else if (gameState.weather === 'snow') {
            ctx.fillStyle = '#ffffff80';
            for (let i = 0; i < 80; i++) {
                ctx.beginPath();
                ctx.arc(Math.random() * canvas.width, Math.random() * canvas.height, 4, 0, Math.PI * 2);
                ctx.fill();
            }
        }
    }

    // ==========================================================================
    // –£–ü–†–ê–í–õ–ï–ù–ò–ï –ö–ê–ú–ï–†–û–ô
    // ==========================================================================
    let selectedRow = -1, selectedCol = -1;

    canvas.addEventListener('mousedown', (e) => {
        gameState.isDragging = true;
        gameState.lastMouseX = e.clientX;
        gameState.lastMouseY = e.clientY;
    });

    canvas.addEventListener('mousemove', (e) => {
        if (gameState.isDragging) {
            const dx = e.clientX - gameState.lastMouseX;
            const dy = e.clientY - gameState.lastMouseY;
            gameState.camera.x += dx;
            gameState.camera.y += dy;
            gameState.lastMouseX = e.clientX;
            gameState.lastMouseY = e.clientY;
            drawCity();
        }
    });

    canvas.addEventListener('mouseup', () => {
        gameState.isDragging = false;
    });

    canvas.addEventListener('wheel', (e) => {
        e.preventDefault();
        const delta = e.deltaY > 0 ? -CONFIG.ZOOM_SPEED : CONFIG.ZOOM_SPEED;
        gameState.camera.zoom = Math.max(CONFIG.MIN_ZOOM, Math.min(CONFIG.MAX_ZOOM, gameState.camera.zoom + delta));
        drawCity();
    });

    canvas.addEventListener('click', (e) => {
        if (gameState.isDragging) return;
        
        const rect = canvas.getBoundingClientRect();
        const mouseX = e.clientX - rect.left;
        const mouseY = e.clientY - rect.top;
        
        const { row, col } = screenToGrid(mouseX, mouseY);
        
        if (row !== -1 && col !== -1) {
            selectedRow = row;
            selectedCol = col;
            
            if (gameState.selectedBuilding) {
                buildAt(row, col);
            } else {
                showInfo(row, col);
            }
            drawCity();
        }
    });

    // –ü–æ–¥–¥–µ—Ä–∂–∫–∞ touch
    canvas.addEventListener('touchstart', (e) => {
        e.preventDefault();
        const touch = e.touches[0];
        gameState.isDragging = true;
        gameState.lastMouseX = touch.clientX;
        gameState.lastMouseY = touch.clientY;
    });

    canvas.addEventListener('touchmove', (e) => {
        e.preventDefault();
        if (gameState.isDragging) {
            const touch = e.touches[0];
            const dx = touch.clientX - gameState.lastMouseX;
            const dy = touch.clientY - gameState.lastMouseY;
            gameState.camera.x += dx;
            gameState.camera.y += dy;
            gameState.lastMouseX = touch.clientX;
            gameState.lastMouseY = touch.clientY;
            drawCity();
        }
    });

    canvas.addEventListener('touchend', () => {
        gameState.isDragging = false;
    });

    // ==========================================================================
    // –ò–ì–†–û–í–ê–Ø –õ–û–ì–ò–ö–ê
    // ==========================================================================
    function buildAt(row, col) {
        if (!gameState.selectedBuilding) {
            showNotification('‚ùå –í—ã–±–µ—Ä–∏—Ç–µ –∑–¥–∞–Ω–∏–µ', 'error');
            return;
        }

        const building = buildings[gameState.selectedBuilding];
        if (!building) return;

        if (gameState.money < building.price) {
            showNotification(`‚ùå –ù—É–∂–Ω–æ ${building.price.toLocaleString()}üí∞`, 'error');
            return;
        }

        if (gameState.grid[row][col] !== 'empty') {
            showNotification('‚ùå –ö–ª–µ—Ç–∫–∞ –∑–∞–Ω—è—Ç–∞', 'error');
            return;
        }

        gameState.money -= building.price;
        gameState.grid[row][col] = gameState.selectedBuilding;
        gameState.population += building.population;
        gameState.buildingsCount++;

        updateUI();
        drawCity();
        saveGame();
        showNotification(`‚úÖ –ü–æ—Å—Ç—Ä–æ–µ–Ω–æ: ${building.name}`, 'success');
        if (tg) tg.HapticFeedback.impactOccurred('light');
    }

    function showInfo(row, col) {
        const buildingId = gameState.grid[row][col];
        if (buildingId === 'empty') {
            document.getElementById('infoPanel').innerHTML = 'üå± –ü—É—Å—Ç–æ–π —É—á–∞—Å—Ç–æ–∫. –í—ã–±–µ—Ä–∏—Ç–µ –∑–¥–∞–Ω–∏–µ.';
        } else {
            const building = buildings[buildingId];
            document.getElementById('infoPanel').innerHTML = 
                `${building.emoji} ${building.name} | üí∞ ${building.income.toLocaleString()} | üë• +${building.population}`;
        }
    }

    function collectTaxes() {
        const now = Date.now();
        if (now - gameState.lastTaxTime < CONFIG.TAX_COOLDOWN) {
            const seconds = Math.ceil((CONFIG.TAX_COOLDOWN - (now - gameState.lastTaxTime)) / 1000);
            showNotification(`‚è≥ –ü–æ–¥–æ–∂–¥–∏—Ç–µ ${seconds} —Å–µ–∫.`, 'warning');
            return;
        }

        let total = 0;
        for (let r = 0; r < CONFIG.GRID_SIZE; r++) {
            for (let c = 0; c < CONFIG.GRID_SIZE; c++) {
                const buildingId = gameState.grid[r][c];
                if (buildingId !== 'empty') {
                    const building = buildings[buildingId];
                    if (building) total += building.income;
                }
            }
        }

        gameState.money += total;
        gameState.lastTaxTime = now;
        updateUI();
        saveGame();
        showNotification(`üí∞ –°–æ–±—Ä–∞–Ω–æ ${total.toLocaleString()} –º–æ–Ω–µ—Ç!`, 'success');
        if (tg) tg.HapticFeedback.notificationOccurred('success');
    }

    function toggleWeather() {
        const weathers = ['clear', 'rain', 'snow'];
        const currentIndex = weathers.indexOf(gameState.weather);
        gameState.weather = weathers[(currentIndex + 1) % weathers.length];
        drawCity();
        showNotification(`üå¶Ô∏è –ü–æ–≥–æ–¥–∞: ${gameState.weather}`, 'info');
    }

    function toggleTime() {
        gameState.timeOfDay = (gameState.timeOfDay + 0.3) % 1;
        drawCity();
        showNotification(`‚è∞ –í—Ä–µ–º—è: ${gameState.timeOfDay > 0.6 ? '–î–µ–Ω—å' : '–ù–æ—á—å'}`, 'info');
    }

    function resetGame() {
        if (confirm('–ù–∞—á–∞—Ç—å –Ω–æ–≤—ã–π –≥–æ—Ä–æ–¥?')) {
            gameState.money = CONFIG.START_MONEY;
            gameState.population = 0;
            gameState.buildingsCount = 0;
            gameState.lastTaxTime = Date.now();
            gameState.selectedBuilding = null;
            gameState.selectedBuildingData = null;
            
            for (let r = 0; r < CONFIG.GRID_SIZE; r++) {
                for (let c = 0; c < CONFIG.GRID_SIZE; c++) {
                    gameState.grid[r][c] = 'empty';
                }
            }
            
            document.querySelectorAll('.build-item').forEach(i => i.classList.remove('selected'));
            updateUI();
            drawCity();
            saveGame();
            showNotification('üîÑ –ù–æ–≤—ã–π –≥–æ—Ä–æ–¥ —Å–æ–∑–¥–∞–Ω', 'info');
        }
    }

    // ==========================================================================
    // –ò–ù–¢–ï–†–§–ï–ô–°
    // ==========================================================================
    function updateUI() {
        document.getElementById('moneyDisplay').innerText = gameState.money.toLocaleString();
        document.getElementById('popDisplay').innerText = gameState.population.toLocaleString();
        
        let totalIncome = 0;
        for (let r = 0; r < CONFIG.GRID_SIZE; r++) {
            for (let c = 0; c < CONFIG.GRID_SIZE; c++) {
                const buildingId = gameState.grid[r][c];
                if (buildingId !== 'empty') {
                    const building = buildings[buildingId];
                    if (building) totalIncome += building.income;
                }
            }
        }
        document.getElementById('incomeDisplay').innerText = totalIncome.toLocaleString();
        document.getElementById('buildingsCount').innerText = `${gameState.buildingsCount}/${CONFIG.GRID_SIZE * CONFIG.GRID_SIZE}`;
    }

    function showNotification(message, type = 'info') {
        const notification = document.createElement('div');
        notification.className = 'notification';
        notification.textContent = message;
        
        if (type === 'success') notification.style.borderColor = '#4caf50';
        else if (type === 'error') notification.style.borderColor = '#f44336';
        else if (type === 'warning') notification.style.borderColor = '#ff9800';
        
        document.body.appendChild(notification);
        setTimeout(() => notification.remove(), 3000);
    }

    // ==========================================================================
    // –ü–û–°–¢–†–û–ï–ù–ò–ï –ú–ï–ù–Æ –í–´–ë–û–†–ê –ó–î–ê–ù–ò–ô
    // ==========================================================================
    function buildMenu() {
        const menu = document.getElementById('buildMenu');
        menu.innerHTML = '';

        categories.forEach(category => {
            // –ó–∞–≥–æ–ª–æ–≤–æ–∫ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
            const title = document.createElement('div');
            title.className = 'build-category';
            title.textContent = `${category.emoji} ${category.name}`;
            menu.appendChild(title);

            // –ó–¥–∞–Ω–∏—è –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
            const categoryBuildings = Object.values(buildings).filter(b => b.category === category.id);
            categoryBuildings.sort((a, b) => a.price - b.price).forEach(building => {
                const item = document.createElement('div');
                item.className = 'build-item';
                item.dataset.id = building.id;
                item.innerHTML = `
                    <div class="item-icon">${building.emoji}</div>
                    <div class="item-info">
                        <div class="item-name">${building.name}</div>
                        <div class="item-price">üí∞ ${building.price.toLocaleString()}</div>
                    </div>
                `;
                
                item.addEventListener('click', () => {
                    document.querySelectorAll('.build-item').forEach(i => i.classList.remove('selected'));
                    item.classList.add('selected');
                    gameState.selectedBuilding = building.id;
                    gameState.selectedBuildingData = building;
                    document.getElementById('infoPanel').innerHTML = `–í—ã–±—Ä–∞–Ω–æ: ${building.name}`;
                });
                
                menu.appendChild(item);
            });
        });
    }

    // ==========================================================================
    // –°–û–•–†–ê–ù–ï–ù–ò–ï –ò –ó–ê–ì–†–£–ó–ö–ê
    // ==========================================================================
    function saveGame() {
        const saveData = {
            money: gameState.money,
            grid: gameState.grid,
            population: gameState.population,
            buildingsCount: gameState.buildingsCount,
            weather: gameState.weather,
            timeOfDay: gameState.timeOfDay
        };
        
        if (tg) {
            tg.sendData(JSON.stringify(saveData));
        }
        localStorage.setItem('megaCity1024', JSON.stringify(saveData));
    }

    function loadGame() {
        const saved = localStorage.getItem('megaCity1024');
        if (saved) {
            try {
                const data = JSON.parse(saved);
                gameState.money = data.money || CONFIG.START_MONEY;
                gameState.grid = data.grid || gameState.grid;
                gameState.population = data.population || 0;
                gameState.buildingsCount = data.buildingsCount || 0;
                gameState.weather = data.weather || 'clear';
                gameState.timeOfDay = data.timeOfDay || 0.6;
            } catch (e) {}
        }
        updateUI();
        drawCity();
    }

    // ==========================================================================
    // –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø
    // ==========================================================================
    function init() {
        buildMenu();
        
        document.getElementById('collectBtn').addEventListener('click', collectTaxes);
        document.getElementById('weatherBtn').addEventListener('click', toggleWeather);
        document.getElementById('timeBtn').addEventListener('click', toggleTime);
        document.getElementById('cancelBtn').addEventListener('click', () => {
            gameState.selectedBuilding = null;
            gameState.selectedBuildingData = null;
            document.querySelectorAll('.build-item').forEach(i => i.classList.remove('selected'));
            document.getElementById('infoPanel').innerHTML = 'üëÜ –í—ã–±–µ—Ä–∏—Ç–µ –∑–¥–∞–Ω–∏–µ';
        });
        document.getElementById('resetBtn').addEventListener('click', resetGame);

        loadGame();
        
        // –ê–≤—Ç–æ—Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∫–∞–∂–¥—ã–µ 30 —Å–µ–∫—É–Ω–¥
        setInterval(saveGame, 30000);
    }

    init();
})();
</script>
<!-- 
================================================================================
–ò–¢–û–ì–û:
- 1024 –£–ù–ò–ö–ê–õ–¨–ù–´–• –ó–î–ê–ù–ò–Ø (16 –∫–∞—Ç–µ–≥–æ—Ä–∏–π √ó 64 –∑–¥–∞–Ω–∏—è)
- 2500 –ö–õ–ï–¢–û–ö –ù–ê –ö–ê–†–¢–ï
- –ü–û–õ–ù–û–°–¢–¨–Æ –†–ê–ë–û–ß–ò–ô –ò–ù–¢–ï–†–§–ï–ô–°
- –ö–ê–ú–ï–†–ê –° –ü–ï–†–ï–ú–ï–©–ï–ù–ò–ï–ú –ò –ó–£–ú–û–ú
- –ü–û–ì–û–î–ê –ò –í–†–ï–ú–Ø –°–£–¢–û–ö
- –°–û–•–†–ê–ù–ï–ù–ò–ï –í LOCALSTORAGE
- –í–°–ï –ö–ù–û–ü–ö–ò –†–ê–ë–û–¢–ê–Æ–¢
================================================================================
-->
</body>
</html>
