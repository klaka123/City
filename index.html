<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Island Empire ‚Äî –≥—Ä–∞—Ñ–∏–∫–∞ –ø—Ä–µ–º–∏—É–º</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Roboto, system-ui, -apple-system, sans-serif;
        }
        body {
            background: #0a1a28;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            padding: 12px;
        }
        .game-frame {
            width: 100%;
            max-width: 640px;
            background: linear-gradient(145deg, #1d4f6e, #123e58);
            border-radius: 64px;
            padding: 24px;
            box-shadow: 0 40px 70px rgba(0,0,0,0.9), inset 0 3px 8px rgba(255,255,255,0.3);
            border: 4px solid #4d8bb0;
        }
        .resource-bar {
            background: rgba(0, 25, 40, 0.8);
            backdrop-filter: blur(25px);
            border-radius: 60px;
            padding: 18px 28px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            color: white;
            margin-bottom: 24px;
            border: 2px solid #8ec9e0;
            box-shadow: 0 12px 0 #0b4057;
        }
        .resource {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 24px;
            font-weight: 700;
            text-shadow: 0 4px 6px black;
            background: rgba(0,0,0,0.4);
            padding: 8px 22px;
            border-radius: 50px;
            backdrop-filter: blur(5px);
        }
        .resource-icon {
            font-size: 34px;
            filter: drop-shadow(0 5px 5px black);
        }
        .canvas-holder {
            background: #1a6d94;
            border-radius: 56px;
            padding: 24px;
            display: flex;
            justify-content: center;
            box-shadow: inset 0 -25px 50px #0a4057, 0 25px 40px black;
            margin-bottom: 24px;
        }
        #gameCanvas {
            width: 100%;
            height: auto;
            border-radius: 48px;
            background: #2f86b3;
            cursor: pointer;
            touch-action: none;
            max-width: 560px;
            box-shadow: 0 0 0 6px #b2e2ff, 0 25px 50px black;
        }
        .category-tabs {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
        }
        .tab {
            flex: 1;
            background: rgba(255,255,255,0.2);
            backdrop-filter: blur(20px);
            border: 3px solid white;
            border-radius: 60px;
            padding: 16px;
            color: white;
            font-weight: bold;
            font-size: 20px;
            text-align: center;
            box-shadow: 0 8px 0 #0b4057;
            transition: 0.1s;
            touch-action: manipulation;
        }
        .tab.active {
            background: #ffdb8e;
            color: #1d3b4f;
            border-color: #ffb347;
            transform: translateY(-4px);
            box-shadow: 0 12px 0 #b87c1b;
        }
        .tab:active {
            transform: translateY(5px);
            box-shadow: 0 3px 0 #0b4057;
        }
        .build-scroll {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(25px);
            border-radius: 70px;
            padding: 16px;
            margin-bottom: 24px;
            overflow-x: auto;
            white-space: nowrap;
            -webkit-overflow-scrolling: touch;
            scrollbar-width: none;
            border: 4px solid white;
            box-shadow: inset 0 8px 20px #c0c0c0;
        }
        .build-scroll::-webkit-scrollbar { display: none; }
        .build-track {
            display: inline-flex;
            gap: 20px;
            padding: 10px;
        }
        .build-card {
            background: linear-gradient(145deg, #fffbf0, #f2e6ce);
            border-radius: 60px;
            padding: 24px 28px;
            display: inline-flex;
            flex-direction: column;
            align-items: center;
            min-width: 160px;
            box-shadow: 0 15px 0 #b3a07e, 0 22px 40px rgba(0,0,0,0.5);
            border: 5px solid #fff9e0;
            transition: 0.1s;
            touch-action: manipulation;
        }
        .build-card.selected {
            transform: translateY(-8px);
            border-color: #f7b731;
            box-shadow: 0 18px 0 #c9912e, 0 30px 45px black;
        }
        .build-card:active {
            transform: translateY(8px);
            box-shadow: 0 7px 0 #b3a07e;
        }
        .card-preview {
            width: 90px;
            height: 90px;
            background: #d9e9f0;
            border-radius: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 54px;
            margin-bottom: 12px;
            box-shadow: inset 0 -8px 0 #a0c4d0;
        }
        .card-name {
            font-weight: 800;
            font-size: 18px;
            color: #2b5a4a;
        }
        .card-price {
            background: #cfb385;
            padding: 8px 22px;
            border-radius: 50px;
            font-weight: 700;
            margin-top: 10px;
            font-size: 18px;
            color: #2d2d2d;
        }
        .action-row {
            display: flex;
            gap: 18px;
            justify-content: center;
            flex-wrap: wrap;
            margin-bottom: 24px;
        }
        .primary-btn {
            flex: 1 1 auto;
            min-width: 180px;
            background: linear-gradient(145deg, #3d93c0, #19658a);
            border: none;
            border-radius: 70px;
            padding: 22px 24px;
            color: white;
            font-size: 26px;
            font-weight: bold;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 14px;
            box-shadow: 0 15px 0 #0f4b6b, 0 25px 40px black;
            border: 4px solid #9fd3ff;
            touch-action: manipulation;
        }
        .primary-btn:active {
            transform: translateY(8px);
            box-shadow: 0 7px 0 #0f4b6b;
        }
        .info-card {
            background: #e5f2fa;
            border-radius: 60px;
            padding: 24px;
            color: #124257;
            border: 5px solid white;
            font-size: 20px;
            font-weight: 600;
            box-shadow: inset 0 8px 20px #b3d9f0, 0 15px 0 #548ea8;
        }
    </style>
</head>
<body>
<div class="game-frame">
    <div class="resource-bar">
        <div class="resource"><span class="resource-icon">üí∞</span> <span id="moneyDisplay">15000</span></div>
        <div class="resource"><span class="resource-icon">üë™</span> <span id="popDisplay">0</span></div>
        <div class="resource"><span class="resource-icon">üìà</span> <span id="incomeDisplay">0</span></div>
        <div class="resource"><span class="resource-icon">üèùÔ∏è</span> <span id="landDisplay">25</span></div>
    </div>

    <div class="canvas-holder">
        <canvas id="gameCanvas" width="600" height="500"></canvas>
    </div>

    <div class="category-tabs">
        <div class="tab active" id="tabResidential">üèòÔ∏è –ñ–∏–ª—ã–µ</div>
        <div class="tab" id="tabCommercial">üè™ –ö–æ–º–º–µ—Ä—Ü–∏—è</div>
        <div class="tab" id="tabInfra">üè• –ò–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä–∞</div>
    </div>

    <div class="build-scroll">
        <div class="build-track" id="buildTrack"></div>
    </div>

    <div class="action-row">
        <button class="primary-btn" id="collectBtn"><span>üí∞</span> –°–±–æ—Ä</button>
        <button class="primary-btn" id="expandBtn"><span>üåä‚ÜíüèùÔ∏è</span> 1000üí∞</button>
        <button class="primary-btn" id="cancelBtn"><span>‚ùå</span> –û—Ç–º–µ–Ω–∞</button>
    </div>

    <div class="info-card" id="infoPanel">
        üëâ –í—ã–±–µ—Ä–∏—Ç–µ –∑–¥–∞–Ω–∏–µ –∏ –∫–æ—Å–Ω–∏—Ç–µ—Å—å —É—á–∞—Å—Ç–∫–∞.
    </div>
</div>

<script src="https://telegram.org/js/telegram-web-app.js"></script>
<script>
    (function() {
        // Telegram
        let tg = null;
        try {
            if (window.Telegram && Telegram.WebApp) {
                tg = Telegram.WebApp;
                tg.expand();
                tg.ready();
            }
        } catch(e) { console.log('No TG'); }

        // –ò–∑–æ–º–µ—Ç—Ä–∏—á–µ—Å–∫–∏–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã
        const GRID_SIZE = 7;
        const CELL_W = 90;
        const CELL_H = 52;
        const ISO_X0 = 280;
        const ISO_Y0 = 60;

        // ---- –£–ª—å—Ç—Ä–∞-–¥–µ—Ç–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –∑–¥–∞–Ω–∏—è ----
        const BUILDINGS = {
            empty: {
                name: '–ü—É—Å—Ç–æ', price: 0, income: 0, pop: 0,
                draw: function(ctx, x, y) {
                    // –û—Å–Ω–æ–≤–∞–Ω–∏–µ —Å —Ç–µ–∫—Å—Ç—É—Ä–æ–π —Ç—Ä–∞–≤—ã
                    ctx.fillStyle = '#7cb57c';
                    ctx.shadowColor = '#3a6b3a';
                    ctx.shadowBlur = 12;
                    ctx.shadowOffsetY = 8;
                    ctx.beginPath();
                    ctx.moveTo(x, y-5);
                    ctx.lineTo(x + CELL_W/2, y + CELL_H/2-5);
                    ctx.lineTo(x, y + CELL_H-5);
                    ctx.lineTo(x - CELL_W/2, y + CELL_H/2-5);
                    ctx.closePath();
                    ctx.fill();
                    ctx.shadowBlur = 0;
                    // –¢—Ä–∞–≤–∞ (—à—Ç—Ä–∏—Ö–∏)
                    ctx.fillStyle = '#5f8b5f';
                    for (let i = -15; i <= 15; i+=8) {
                        ctx.fillRect(x-4+i, y-18, 3, 12);
                    }
                    // –¶–≤–µ—Ç–æ—á–∫–∏
                    ctx.fillStyle = '#f4a460';
                    ctx.beginPath();
                    ctx.arc(x-12, y-22, 4, 0, 2*Math.PI);
                    ctx.fill();
                    ctx.fillStyle = '#f0e68c';
                    ctx.beginPath();
                    ctx.arc(x+14, y-28, 5, 0, 2*Math.PI);
                    ctx.fill();
                }
            },
            house1: { // –î–æ–º —Å —á–µ—Ä–µ–ø–∏—á–Ω–æ–π –∫—Ä—ã—à–µ–π –∏ —Å–∞–¥–æ–º
                name: '–î–æ–º', price: 200, income: 16, pop: 7,
                draw: (ctx, x, y) => {
                    // –§—É–Ω–¥–∞–º–µ–Ω—Ç
                    ctx.fillStyle = '#dbbÂçÅ‰∏É';
                    ctx.shadowColor = '#8b6b4a';
                    ctx.shadowBlur = 18;
                    ctx.shadowOffsetY = 10;
                    ctx.beginPath();
                    ctx.moveTo(x, y-20);
                    ctx.lineTo(x + CELL_W/2, y + CELL_H/2-20);
                    ctx.lineTo(x, y + CELL_H-20);
                    ctx.lineTo(x - CELL_W/2, y + CELL_H/2-20);
                    ctx.closePath();
                    ctx.fill();

                    // –ö—Ä—ã—à–∞ (—á–µ—Ä–µ–ø–∏—Ü–∞)
                    ctx.fillStyle = '#b54c4c';
                    ctx.shadowBlur = 16;
                    ctx.beginPath();
                    ctx.moveTo(x-24, y-44);
                    ctx.lineTo(x+24, y-44);
                    ctx.lineTo(x, y-70);
                    ctx.closePath();
                    ctx.fill();
                    // –ß–µ—Ä–µ–ø–∏—Ü–∞ (–ø–æ–ª–æ—Å–∫–∏)
                    ctx.strokeStyle = '#8b3a3a';
                    ctx.lineWidth = 2;
                    for (let i = -18; i <= 18; i+=12) {
                        ctx.beginPath();
                        ctx.moveTo(x-24+i, y-48);
                        ctx.lineTo(x-6+i, y-64);
                        ctx.stroke();
                    }

                    // –î–≤–µ—Ä—å
                    ctx.fillStyle = '#8b5a2b';
                    ctx.fillRect(x-10, y-28, 20, 28);
                    ctx.fillStyle = '#c49a6c';
                    ctx.beginPath();
                    ctx.arc(x-2, y-14, 3, 0, 2*Math.PI);
                    ctx.fill(); // —Ä—É—á–∫–∞

                    // –û–∫–Ω–∞
                    ctx.fillStyle = '#f9e076';
                    ctx.shadowBlur = 8;
                    ctx.fillRect(x-22, y-34, 10, 12);
                    ctx.fillRect(x+12, y-34, 10, 12);
                    // –ü–µ—Ä–µ–ø–ª—ë—Ç—ã
                    ctx.strokeStyle = '#6b4c2c';
                    ctx.lineWidth = 2;
                    ctx.strokeRect(x-22, y-34, 10, 12);
                    ctx.strokeRect(x+12, y-34, 10, 12);
                    ctx.beginPath();
                    ctx.moveTo(x-17, y-28);
                    ctx.lineTo(x-12, y-28);
                    ctx.moveTo(x+17, y-28);
                    ctx.lineTo(x+22, y-28);
                    ctx.stroke();

                    // –¢—Ä—É–±–∞
                    ctx.fillStyle = '#8b5a2b';
                    ctx.fillRect(x+8, y-60, 8, 16);
                    ctx.shadowBlur = 0;
                }
            },
            house2: { // –ö–æ—Ç—Ç–µ–¥–∂ —Å –±–∞–ª–∫–æ–Ω–æ–º
                name: '–ö–æ—Ç—Ç–µ–¥–∂', price: 550, income: 42, pop: 20,
                draw: (ctx, x, y) => {
                    ctx.fillStyle = '#cf9f6b';
                    ctx.shadowColor = '#8b6b4a';
                    ctx.shadowBlur = 18;
                    ctx.shadowOffsetY = 10;
                    ctx.beginPath();
                    ctx.moveTo(x, y-26);
                    ctx.lineTo(x + CELL_W/2, y + CELL_H/2-26);
                    ctx.lineTo(x, y + CELL_H-26);
                    ctx.lineTo(x - CELL_W/2, y + CELL_H/2-26);
                    ctx.closePath();
                    ctx.fill();

                    // –û—Å–Ω–æ–≤–Ω–∞—è –∫—Ä—ã—à–∞
                    ctx.fillStyle = '#8b5a2b';
                    ctx.beginPath();
                    ctx.moveTo(x-30, y-52);
                    ctx.lineTo(x+30, y-52);
                    ctx.lineTo(x, y-84);
                    ctx.closePath();
                    ctx.fill();

                    // –ú–∞–Ω—Å–∞—Ä–¥–Ω–æ–µ –æ–∫–Ω–æ
                    ctx.fillStyle = '#c49a6c';
                    ctx.fillRect(x-8, y-58, 16, 14);
                    ctx.fillStyle = '#f9e076';
                    ctx.fillRect(x-6, y-56, 4, 4);
                    ctx.fillRect(x+2, y-56, 4, 4);

                    // –ë–∞–ª–∫–æ–Ω
                    ctx.fillStyle = '#a57248';
                    ctx.fillRect(x-20, y-36, 40, 8);
                    for (let i = -12; i <= 12; i+=12) {
                        ctx.fillStyle = '#8b5a2b';
                        ctx.fillRect(x-4+i, y-44, 6, 10);
                    }

                    // –û–∫–Ω–∞ –ø–µ—Ä–≤–æ–≥–æ —ç—Ç–∞–∂–∞
                    ctx.fillStyle = '#f9e076';
                    ctx.fillRect(x-18, y-30, 8, 12);
                    ctx.fillRect(x+10, y-30, 8, 12);
                    ctx.shadowBlur = 0;
                }
            },
            house3: { // –ú–Ω–æ–≥–æ–∫–≤–∞—Ä—Ç–∏—Ä–Ω—ã–π –¥–æ–º
                name: '–ú–Ω–æ–≥–æ–∫–≤.', price: 1500, income: 120, pop: 65,
                draw: (ctx, x, y) => {
                    ctx.fillStyle = '#b0bec5';
                    ctx.shadowColor = '#6b7a8a';
                    ctx.shadowBlur = 22;
                    ctx.shadowOffsetY = 12;
                    ctx.beginPath();
                    ctx.moveTo(x, y-32);
                    ctx.lineTo(x + CELL_W/2, y + CELL_H/2-32);
                    ctx.lineTo(x, y + CELL_H-32);
                    ctx.lineTo(x - CELL_W/2, y + CELL_H/2-32);
                    ctx.closePath();
                    ctx.fill();

                    ctx.fillStyle = '#8a9aa8';
                    ctx.fillRect(x-30, y-70, 60, 48);

                    // –û–∫–Ω–∞ (—Ä—è–¥—ã)
                    ctx.fillStyle = '#cfd8dc';
                    for (let i = -18; i <= 18; i+=22) {
                        for (let j = -62; j <= -22; j+=22) {
                            ctx.fillRect(x-10+i, y+j, 12, 14);
                            ctx.fillStyle = '#f9e076';
                            ctx.fillRect(x-8+i, y+j+2, 4, 4);
                            ctx.fillRect(x+0+i, y+j+2, 4, 4);
                            ctx.fillStyle = '#cfd8dc';
                        }
                    }

                    // –ë–∞–ª–∫–æ–Ω—ã
                    ctx.fillStyle = '#a0aab3';
                    ctx.fillRect(x-24, y-48, 20, 6);
                    ctx.fillRect(x+4, y-48, 20, 6);
                    ctx.shadowBlur = 0;
                }
            },
            skyscraper: { // –ù–µ–±–æ—Å–∫—Ä—ë–± —Å –∞–Ω—Ç–µ–Ω–Ω–æ–π
                name: '–ù–µ–±–æ—Å–∫—Ä—ë–±', price: 5000, income: 400, pop: 250,
                draw: (ctx, x, y) => {
                    ctx.fillStyle = '#607d8b';
                    ctx.shadowColor = '#2f4a5a';
                    ctx.shadowBlur = 26;
                    ctx.shadowOffsetY = 16;
                    ctx.beginPath();
                    ctx.moveTo(x, y-48);
                    ctx.lineTo(x + CELL_W/2, y + CELL_H/2-48);
                    ctx.lineTo(x, y + CELL_H-48);
                    ctx.lineTo(x - CELL_W/2, y + CELL_H/2-48);
                    ctx.closePath();
                    ctx.fill();

                    ctx.fillStyle = '#4f6573';
                    ctx.fillRect(x-34, y-120, 68, 80);

                    // –û–∫–Ω–∞ —Å –ø–æ–¥—Å–≤–µ—Ç–∫–æ–π
                    for (let i = -22; i <= 22; i+=18) {
                        for (let j = -105; j <= -25; j+=22) {
                            ctx.fillStyle = '#ffd966';
                            ctx.fillRect(x-10+i, y+j-5, 12, 16);
                            ctx.fillStyle = '#ffffff';
                            ctx.fillRect(x-8+i, y+j-3, 4, 6);
                            ctx.fillRect(x+0+i, y+j-3, 4, 6);
                        }
                    }

                    // –ê–Ω—Ç–µ–Ω–Ω–∞
                    ctx.fillStyle = '#b0bec5';
                    ctx.fillRect(x-4, y-138, 8, 22);
                    ctx.fillStyle = '#d4af37';
                    ctx.beginPath();
                    ctx.arc(x, y-148, 6, 0, 2*Math.PI);
                    ctx.fill();

                    // –®–ø–∏–ª—å
                    ctx.fillStyle = '#cfd8dc';
                    ctx.fillRect(x-2, y-152, 4, 16);
                    ctx.shadowBlur = 0;
                }
            },
            shop: { // –ú–∞–≥–∞–∑–∏–Ω —Å –≤–∏—Ç—Ä–∏–Ω–æ–π
                name: '–ú–∞–≥–∞–∑–∏–Ω', price: 380, income: 50, pop: 4,
                draw: (ctx, x, y) => {
                    ctx.fillStyle = '#ffb74d';
                    ctx.shadowColor = '#b46f1a';
                    ctx.shadowBlur = 18;
                    ctx.shadowOffsetY = 9;
                    ctx.beginPath();
                    ctx.moveTo(x, y-20);
                    ctx.lineTo(x + CELL_W/2, y + CELL_H/2-20);
                    ctx.lineTo(x, y + CELL_H-20);
                    ctx.lineTo(x - CELL_W/2, y + CELL_H/2-20);
                    ctx.closePath();
                    ctx.fill();

                    ctx.fillStyle = '#ff9800';
                    ctx.fillRect(x-28, y-42, 56, 30);

                    // –í–∏—Ç—Ä–∏–Ω–∞
                    ctx.fillStyle = '#fff2cc';
                    ctx.fillRect(x-18, y-36, 12, 16);
                    ctx.fillRect(x+6, y-36, 12, 16);
                    // –¢–æ–≤–∞—Ä—ã
                    ctx.font = '24px sans-serif';
                    ctx.fillStyle = '#8b5a2b';
                    ctx.fillText('üõí', x-28, y-16);
                    ctx.fillText('üßÉ', x+12, y-20);

                    // –í—ã–≤–µ—Å–∫–∞
                    ctx.fillStyle = '#c43a3a';
                    ctx.fillRect(x-12, y-62, 24, 10);
                    ctx.fillStyle = '#fff';
                    ctx.font = '18px sans-serif';
                    ctx.fillText('SALE', x-10, y-52);
                    ctx.shadowBlur = 0;
                }
            },
            office: { // –û—Ñ–∏—Å–Ω–æ–µ –∑–¥–∞–Ω–∏–µ
                name: '–û—Ñ–∏—Å', price: 1100, income: 130, pop: 10,
                draw: (ctx, x, y) => {
                    ctx.fillStyle = '#9e9e9e';
                    ctx.shadowColor = '#6b6b6b';
                    ctx.shadowBlur = 22;
                    ctx.shadowOffsetY = 11;
                    ctx.beginPath();
                    ctx.moveTo(x, y-28);
                    ctx.lineTo(x + CELL_W/2, y + CELL_H/2-28);
                    ctx.lineTo(x, y + CELL_H-28);
                    ctx.lineTo(x - CELL_W/2, y + CELL_H/2-28);
                    ctx.closePath();
                    ctx.fill();

                    ctx.fillStyle = '#757575';
                    ctx.fillRect(x-30, y-60, 60, 42);

                    // –û–∫–Ω–∞
                    for (let i = -18; i <= 18; i+=20) {
                        ctx.fillStyle = '#cfd8dc';
                        ctx.fillRect(x-12+i, y-52, 14, 10);
                        ctx.fillRect(x-12+i, y-34, 14, 10);
                        ctx.fillStyle = '#aed6f1';
                        ctx.fillRect(x-10+i, y-50, 6, 6);
                        ctx.fillRect(x-10+i, y-32, 6, 6);
                    }

                    // –õ–æ–≥–æ—Ç–∏–ø
                    ctx.fillStyle = '#ffb74d';
                    ctx.beginPath();
                    ctx.arc(x, y-72, 8, 0, 2*Math.PI);
                    ctx.fill();
                    ctx.fillStyle = '#fff';
                    ctx.font = '16px sans-serif';
                    ctx.fillText('LLC', x-12, y-70);
                    ctx.shadowBlur = 0;
                }
            },
            school: { // –®–∫–æ–ª–∞ —Å –∫–æ–ª–æ–∫–æ–ª—å—á–∏–∫–æ–º
                name: '–®–∫–æ–ª–∞', price: 2500, income: 70, pop: 0,
                draw: (ctx, x, y) => {
                    ctx.fillStyle = '#ff8a80';
                    ctx.shadowColor = '#b2453a';
                    ctx.shadowBlur = 22;
                    ctx.shadowOffsetY = 10;
                    ctx.beginPath();
                    ctx.moveTo(x, y-26);
                    ctx.lineTo(x + CELL_W/2, y + CELL_H/2-26);
                    ctx.lineTo(x, y + CELL_H-26);
                    ctx.lineTo(x - CELL_W/2, y + CELL_H/2-26);
                    ctx.closePath();
                    ctx.fill();

                    ctx.fillStyle = '#f06292';
                    ctx.fillRect(x-32, y-58, 64, 44);

                    // –û–∫–Ω–∞
                    for (let i = -18; i <= 18; i+=22) {
                        ctx.fillStyle = '#ffffff';
                        ctx.fillRect(x-12+i, y-50, 14, 14);
                        ctx.fillRect(x-12+i, y-28, 14, 14);
                    }

                    // –ö—Ä—ã–ª—å—Ü–æ
                    ctx.fillStyle = '#8b5a2b';
                    ctx.fillRect(x-16, y-22, 32, 8);

                    // –ö–æ–ª–æ–∫–æ–ª—å—á–∏–∫
                    ctx.fillStyle = '#d4af37';
                    ctx.beginPath();
                    ctx.arc(x, y-78, 8, 0, 2*Math.PI);
                    ctx.fill();
                    ctx.fillStyle = '#b8860b';
                    ctx.fillRect(x-2, y-86, 4, 10);
                    ctx.shadowBlur = 0;
                }
            },
            hospital: { // –ë–æ–ª—å–Ω–∏—Ü–∞ —Å –∫—Ä–µ—Å—Ç–æ–º
                name: '–ë–æ–ª—å–Ω–∏—Ü–∞', price: 3200, income: 105, pop: 0,
                draw: (ctx, x, y) => {
                    ctx.fillStyle = '#ef9a9a';
                    ctx.shadowColor = '#a54444';
                    ctx.shadowBlur = 22;
                    ctx.shadowOffsetY = 10;
                    ctx.beginPath();
                    ctx.moveTo(x, y-28);
                    ctx.lineTo(x + CELL_W/2, y + CELL_H/2-28);
                    ctx.lineTo(x, y + CELL_H-28);
                    ctx.lineTo(x - CELL_W/2, y + CELL_H/2-28);
                    ctx.closePath();
                    ctx.fill();

                    ctx.fillStyle = '#e57373';
                    ctx.fillRect(x-32, y-62, 64, 46);

                    // –ö—Ä–µ—Å—Ç
                    ctx.fillStyle = '#ffffff';
                    ctx.fillRect(x-8, y-52, 16, 8);
                    ctx.fillRect(x-4, y-58, 8, 20);

                    // –û–∫–Ω–∞
                    for (let i = -18; i <= 18; i+=22) {
                        ctx.fillStyle = '#b0e0e6';
                        ctx.fillRect(x-12+i, y-44, 10, 10);
                        ctx.fillRect(x-12+i, y-24, 10, 10);
                    }

                    // –í—Ö–æ–¥
                    ctx.fillStyle = '#8b5a2b';
                    ctx.fillRect(x-10, y-22, 20, 16);
                    ctx.shadowBlur = 0;
                }
            },
            park: { // –ü–∞—Ä–∫ —Å –¥–µ—Ä–µ–≤—å—è–º–∏ –∏ —Ü–≤–µ—Ç–∞–º–∏
                name: '–ü–∞—Ä–∫', price: 280, income: 26, pop: 4,
                draw: (ctx, x, y) => {
                    ctx.fillStyle = '#81c784';
                    ctx.shadowColor = '#3f7840';
                    ctx.shadowBlur = 18;
                    ctx.shadowOffsetY = 8;
                    ctx.beginPath();
                    ctx.moveTo(x, y-10);
                    ctx.lineTo(x + CELL_W/2, y + CELL_H/2-10);
                    ctx.lineTo(x, y + CELL_H-10);
                    ctx.lineTo(x - CELL_W/2, y + CELL_H/2-10);
                    ctx.closePath();
                    ctx.fill();

                    // –î–µ—Ä–µ–≤—å—è
                    ctx.fillStyle = '#5f9b6b';
                    ctx.beginPath();
                    ctx.arc(x-18, y-30, 12, 0, 2*Math.PI);
                    ctx.fill();
                    ctx.fillStyle = '#8b5a2b';
                    ctx.fillRect(x-24, y-20, 6, 18);
                    ctx.fillRect(x-16, y-20, 6, 18);

                    ctx.fillStyle = '#5f9b6b';
                    ctx.beginPath();
                    ctx.arc(x+18, y-38, 10, 0, 2*Math.PI);
                    ctx.fill();
                    ctx.fillStyle = '#8b5a2b';
                    ctx.fillRect(x+14, y-28, 6, 16);

                    // –¶–≤–µ—Ç—ã
                    ctx.fillStyle = '#f4a460';
                    for (let i = -10; i <= 10; i+=10) {
                        ctx.beginPath();
                        ctx.arc(x+i, y-18, 4, 0, 2*Math.PI);
                        ctx.fill();
                    }
                    ctx.fillStyle = '#f0e68c';
                    ctx.beginPath();
                    ctx.arc(x-5, y-24, 4, 0, 2*Math.PI);
                    ctx.fill();
                    ctx.shadowBlur = 0;
                }
            },
            road: { // –î–æ—Ä–æ–≥–∞ —Å —Ä–∞–∑–º–µ—Ç–∫–æ–π
                name: '–î–æ—Ä–æ–≥–∞', price: 120, income: 6, pop: 0,
                draw: (ctx, x, y) => {
                    ctx.fillStyle = '#b0bec5';
                    ctx.shadowColor = '#6e7b8c';
                    ctx.shadowBlur = 14;
                    ctx.shadowOffsetY = 6;
                    ctx.beginPath();
                    ctx.moveTo(x, y-6);
                    ctx.lineTo(x + CELL_W/2, y + CELL_H/2-6);
                    ctx.lineTo(x, y + CELL_H-6);
                    ctx.lineTo(x - CELL_W/2, y + CELL_H/2-6);
                    ctx.closePath();
                    ctx.fill();

                    // –†–∞–∑–º–µ—Ç–∫–∞
                    ctx.fillStyle = '#f5f5f5';
                    ctx.fillRect(x-30, y-12, 60, 4);
                    ctx.fillRect(x-10, y-26, 4, 20);
                    ctx.fillStyle = '#ffd966';
                    ctx.beginPath();
                    ctx.arc(x-15, y-18, 4, 0, 2*Math.PI);
                    ctx.fill();
                    ctx.beginPath();
                    ctx.arc(x+15, y-18, 4, 0, 2*Math.PI);
                    ctx.fill();

                    // –ë–æ—Ä–¥—é—Ä
                    ctx.fillStyle = '#8a9aa8';
                    ctx.fillRect(x-34, y-4, 68, 4);
                    ctx.shadowBlur = 0;
                }
            },
            powerplant: { // –≠–ª–µ–∫—Ç—Ä–æ—Å—Ç–∞–Ω—Ü–∏—è —Å –¥—ã–º–æ–º
                name: '–≠–ª–µ–∫—Ç—Ä–æ', price: 5500, income: 520, pop: 0,
                draw: (ctx, x, y) => {
                    ctx.fillStyle = '#b0a57c';
                    ctx.shadowColor = '#6b5d3a';
                    ctx.shadowBlur = 26;
                    ctx.shadowOffsetY = 14;
                    ctx.beginPath();
                    ctx.moveTo(x, y-38);
                    ctx.lineTo(x + CELL_W/2, y + CELL_H/2-38);
                    ctx.lineTo(x, y + CELL_H-38);
                    ctx.lineTo(x - CELL_W/2, y + CELL_H/2-38);
                    ctx.closePath();
                    ctx.fill();

                    ctx.fillStyle = '#8b7a5a';
                    ctx.fillRect(x-34, y-90, 68, 62);

                    // –¢—Ä—É–±—ã
                    ctx.fillStyle = '#6b5a3a';
                    ctx.fillRect(x-20, y-122, 12, 40);
                    ctx.fillRect(x+8, y-132, 12, 50);

                    // –î—ã–º (–ø–æ–ª—É–ø—Ä–æ–∑—Ä–∞—á–Ω—ã–π)
                    ctx.fillStyle = 'rgba(255,255,255,0.3)';
                    ctx.shadowBlur = 20;
                    ctx.beginPath();
                    ctx.arc(x-14, y-142, 12, 0, 2*Math.PI);
                    ctx.fill();
                    ctx.beginPath();
                    ctx.arc(x+14, y-152, 10, 0, 2*Math.PI);
                    ctx.fill();

                    // –û–∫–Ω–∞
                    ctx.fillStyle = '#ffb74d';
                    for (let i = -16; i <= 16; i+=20) {
                        ctx.fillRect(x-8+i, y-60, 8, 10);
                    }

                    // –ú–æ–ª–Ω–∏—è
                    ctx.fillStyle = '#ffeb3b';
                    ctx.font = '32px sans-serif';
                    ctx.fillText('‚ö°', x-20, y-30);
                    ctx.shadowBlur = 0;
                }
            }
        };

        // –°–æ—Å—Ç–æ—è–Ω–∏–µ –∏–≥—Ä—ã
        let gameState = {
            balance: 15000,
            gridSize: 7,
            grid: [],
            land: [],
            population: 0,
            lastTaxTime: Date.now(),
            taxCooldown: 30000,
            selectedBuilding: null,
            expandCost: 1000,
        };

        function initLand() {
            for (let r = 0; r < gameState.gridSize; r++) {
                gameState.grid[r] = [];
                gameState.land[r] = [];
                for (let c = 0; c < gameState.gridSize; c++) {
                    if (r >= 1 && r <= 5 && c >= 1 && c <= 5) {
                        gameState.land[r][c] = true;
                        gameState.grid[r][c] = 'empty';
                    } else {
                        gameState.land[r][c] = false;
                        gameState.grid[r][c] = 'empty';
                    }
                }
            }
        }
        initLand();

        function gridToIso(row, col) {
            return {
                x: (col - row) * CELL_W / 2 + ISO_X0,
                y: (col + row) * CELL_H / 2 + ISO_Y0
            };
        }

        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');

        let timeOfDay = 0.5; // –¥–ª—è —Å–º–µ–Ω—ã –Ω–µ–±–∞

        function drawCity() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);

            // –ù–µ–±–æ —Å –≥—Ä–∞–¥–∏–µ–Ω—Ç–æ–º (–∑–∞–∫–∞—Ç/—Ä–∞—Å—Å–≤–µ—Ç)
            const gradSky = ctx.createLinearGradient(0, 0, 0, canvas.height);
            gradSky.addColorStop(0, '#1b4f72');
            gradSky.addColorStop(0.5, '#3d8bb9');
            gradSky.addColorStop(1, '#16638a');
            ctx.fillStyle = gradSky;
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            // –°–æ–ª–Ω—Ü–µ/–ª—É–Ω–∞
            ctx.shadowBlur = 40;
            ctx.shadowColor = '#fffbc2';
            ctx.beginPath();
            ctx.arc(100, 80, 30, 0, 2*Math.PI);
            ctx.fillStyle = '#fff3b0';
            ctx.fill();

            // –û–±–ª–∞–∫–∞
            ctx.shadowBlur = 30;
            ctx.fillStyle = 'rgba(255,255,255,0.2)';
            ctx.beginPath();
            ctx.ellipse(200, 120, 50, 25, 0, 0, 2*Math.PI);
            ctx.fill();
            ctx.beginPath();
            ctx.ellipse(400, 150, 60, 30, 0, 0, 2*Math.PI);
            ctx.fill();

            ctx.shadowBlur = 0;

            // –í–æ–¥–∞ —Å –∞–Ω–∏–º–∞—Ü–∏–µ–π
            let wave = Date.now() / 300;
            for (let i = 0; i < 10; i++) {
                ctx.fillStyle = `rgba(100, 200, 255, ${0.1 + Math.sin(wave + i)*0.05})`;
                ctx.beginPath();
                ctx.ellipse(100 + i*70, 400 + Math.sin(wave + i)*10, 50, 15, 0, 0, 2*Math.PI);
                ctx.fill();
            }

            // –†–∏—Å—É–µ–º –≤—Å–µ –∫–ª–µ—Ç–∫–∏
            for (let r = 0; r < gameState.gridSize; r++) {
                for (let c = 0; c < gameState.gridSize; c++) {
                    const iso = gridToIso(r, c);
                    if (!gameState.land[r][c]) {
                        // –í–æ–¥–∞ —Å —Ç–µ–∫—Å—Ç—É—Ä–æ–π
                        ctx.fillStyle = '#1f7a9c';
                        ctx.shadowColor = '#0c4b66';
                        ctx.shadowBlur = 14;
                        ctx.shadowOffsetY = 6;
                        ctx.beginPath();
                        ctx.moveTo(iso.x, iso.y);
                        ctx.lineTo(iso.x + CELL_W/2, iso.y + CELL_H/2);
                        ctx.lineTo(iso.x, iso.y + CELL_H);
                        ctx.lineTo(iso.x - CELL_W/2, iso.y + CELL_H/2);
                        ctx.closePath();
                        ctx.fill();

                        // –†—è–±—å
                        ctx.fillStyle = '#48b5e0';
                        ctx.globalAlpha = 0.4 + Math.sin(wave + r*2)*0.1;
                        ctx.font = '24px sans-serif';
                        ctx.fillText('üíß', iso.x-16, iso.y-6);
                        ctx.globalAlpha = 1;
                        continue;
                    }
                    const type = gameState.grid[r][c];
                    const b = BUILDINGS[type] || BUILDINGS.empty;
                    b.draw(ctx, iso.x, iso.y);
                }
            }

            // –ü–æ–¥—Å–≤–µ—Ç–∫–∞ –≤—ã–±—Ä–∞–Ω–Ω–æ–π –∫–ª–µ—Ç–∫–∏
            if (selRow !== -1 && selCol !== -1 && gameState.land[selRow] && gameState.land[selRow][selCol]) {
                const iso = gridToIso(selRow, selCol);
                ctx.shadowColor = '#ffdf7e';
                ctx.shadowBlur = 35;
                ctx.strokeStyle = '#ffdb7e';
                ctx.lineWidth = 8;
                ctx.beginPath();
                ctx.moveTo(iso.x, iso.y-22);
                ctx.lineTo(iso.x + CELL_W/2, iso.y + CELL_H/2-22);
                ctx.lineTo(iso.x, iso.y + CELL_H-22);
                ctx.lineTo(iso.x - CELL_W/2, iso.y + CELL_H/2-22);
                ctx.closePath();
                ctx.stroke();
                ctx.shadowBlur = 0;
            }
        }

        let selRow = -1, selCol = -1;
        canvas.addEventListener('click', handleTap);
        canvas.addEventListener('touchstart', handleTap, {passive: false});

        function handleTap(e) {
            e.preventDefault();
            const rect = canvas.getBoundingClientRect();
            const scaleX = canvas.width / rect.width;
            const scaleY = canvas.height / rect.height;
            let clientX, clientY;
            if (e.touches) {
                clientX = e.touches[0].clientX;
                clientY = e.touches[0].clientY;
            } else {
                clientX = e.clientX;
                clientY = e.clientY;
            }
            const mouseX = (clientX - rect.left) * scaleX;
            const mouseY = (clientY - rect.top) * scaleY;

            let bestDist = 100;
            for (let r = 0; r < gameState.gridSize; r++) {
                for (let c = 0; c < gameState.gridSize; c++) {
                    const iso = gridToIso(r, c);
                    const dx = mouseX - iso.x;
                    const dy = mouseY - iso.y;
                    const dist = Math.sqrt(dx*dx + dy*dy);
                    if (dist < bestDist) {
                        bestDist = dist;
                        selRow = r;
                        selCol = c;
                    }
                }
            }
            if (selRow !== -1 && selCol !== -1) {
                if (!gameState.land[selRow][selCol]) {
                    document.getElementById('infoPanel').innerHTML = 'üåä –≠—Ç–æ –≤–æ–¥–∞. –ú–æ–∂–Ω–æ —Ä–∞—Å—à–∏—Ä–∏—Ç—å –æ—Å—Ç—Ä–æ–≤.';
                } else if (gameState.selectedBuilding) {
                    buildAt(selRow, selCol);
                } else {
                    showInfo(selRow, selCol);
                }
                drawCity();
            }
        }

        function buildAt(row, col) {
            if (!gameState.selectedBuilding) return;
            const type = gameState.selectedBuilding;
            const b = BUILDINGS[type];
            if (!b) return;
            if (gameState.balance < b.price) {
                alert('–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –º–æ–Ω–µ—Ç');
                return;
            }
            if (gameState.grid[row][col] !== 'empty') {
                alert('–ö–ª–µ—Ç–∫–∞ –∑–∞–Ω—è—Ç–∞');
                return;
            }
            gameState.balance -= b.price;
            gameState.grid[row][col] = type;
            gameState.population += b.pop || 0;
            updateUI();
            drawCity();
            saveGame();
            if (tg) tg.HapticFeedback.impactOccurred('light');
        }

        function showInfo(row, col) {
            const type = gameState.grid[row][col];
            if (type === 'empty') {
                document.getElementById('infoPanel').innerHTML = 'üå± –ü—É—Å—Ç–æ–π —É—á–∞—Å—Ç–æ–∫. –í—ã–±–µ—Ä–∏—Ç–µ –∑–¥–∞–Ω–∏–µ.';
            } else {
                const b = BUILDINGS[type];
                document.getElementById('infoPanel').innerHTML = `${b.name} | –î–æ—Ö–æ–¥: ${b.income}üí∞ | –ñ–∏—Ç–µ–ª–∏: +${b.pop}`;
            }
        }

        function collectTax() {
            const now = Date.now();
            if (now - gameState.lastTaxTime < gameState.taxCooldown) {
                alert('–ù–∞–ª–æ–≥–∏ –º–æ–∂–Ω–æ —Å–æ–±–∏—Ä–∞—Ç—å —Ä–∞–∑ –≤ 30 —Å–µ–∫—É–Ω–¥');
                return;
            }
            let total = 0;
            for (let r = 0; r < gameState.gridSize; r++) {
                for (let c = 0; c < gameState.gridSize; c++) {
                    if (gameState.land[r][c] && gameState.grid[r][c] !== 'empty') {
                        total += BUILDINGS[gameState.grid[r][c]].income;
                    }
                }
            }
            gameState.balance += total;
            gameState.lastTaxTime = now;
            updateUI();
            saveGame();
            document.getElementById('infoPanel').innerHTML = `üí∞ –°–æ–±—Ä–∞–Ω–æ ${total} –º–æ–Ω–µ—Ç!`;
            if (tg) tg.HapticFeedback.notificationOccurred('success');
        }

        function expandIsland() {
            if (gameState.balance < gameState.expandCost) {
                alert('–ù–µ —Ö–≤–∞—Ç–∞–µ—Ç –º–æ–Ω–µ—Ç');
                return;
            }
            let candidates = [];
            for (let r = 0; r < gameState.gridSize; r++) {
                for (let c = 0; c < gameState.gridSize; c++) {
                    if (!gameState.land[r][c]) {
                        const neighbors = [[-1,0],[1,0],[0,-1],[0,1]];
                        for (let [dr, dc] of neighbors) {
                            let nr = r+dr, nc = c+dc;
                            if (nr>=0 && nr<gameState.gridSize && nc>=0 && nc<gameState.gridSize && gameState.land[nr][nc]) {
                                candidates.push([r,c]);
                                break;
                            }
                        }
                    }
                }
            }
            if (candidates.length === 0) {
                alert('–ù–µ—Ç –¥–æ—Å—Ç—É–ø–Ω–æ–π –≤–æ–¥—ã –¥–ª—è —Ä–∞—Å—à–∏—Ä–µ–Ω–∏—è');
                return;
            }
            const [rr, cc] = candidates[Math.floor(Math.random() * candidates.length)];
            gameState.balance -= gameState.expandCost;
            gameState.land[rr][cc] = true;
            gameState.grid[rr][cc] = 'empty';
            updateUI();
            drawCity();
            saveGame();
            document.getElementById('infoPanel').innerHTML = 'üåä‚û°Ô∏èüèùÔ∏è –ù–æ–≤–∞—è –∑–µ–º–ª—è!';
        }

        function updateUI() {
            document.getElementById('moneyDisplay').innerText = gameState.balance;
            document.getElementById('popDisplay').innerText = gameState.population;
            let totalIncome = 0;
            for (let r = 0; r < gameState.gridSize; r++) {
                for (let c = 0; c < gameState.gridSize; c++) {
                    if (gameState.land[r][c] && gameState.grid[r][c] !== 'empty') {
                        totalIncome += BUILDINGS[gameState.grid[r][c]].income;
                    }
                }
            }
            document.getElementById('incomeDisplay').innerText = totalIncome;
            let landCount = 0;
            for (let r = 0; r < gameState.gridSize; r++) {
                for (let c = 0; c < gameState.gridSize; c++) {
                    if (gameState.land[r][c]) landCount++;
                }
            }
            document.getElementById('landDisplay').innerText = landCount;
        }

        const categories = {
            residential: ['house1', 'house2', 'house3', 'skyscraper'],
            commercial: ['shop', 'office'],
            infra: ['school', 'hospital', 'park', 'road', 'powerplant']
        };
        let currentCategory = 'residential';

        function renderBuildings(category) {
            const track = document.getElementById('buildTrack');
            track.innerHTML = '';
            const keys = categories[category];
            keys.forEach(key => {
                const b = BUILDINGS[key];
                const card = document.createElement('div');
                card.className = 'build-card';
                card.setAttribute('data-type', key);
                card.innerHTML = `
                    <div class="card-preview">${b.name === '–î–æ—Ä–æ–≥–∞' ? 'üõ£Ô∏è' : (b.name === '–ü–∞—Ä–∫' ? 'üå≥' : (b.name === '–≠–ª–µ–∫—Ç—Ä–æ' ? '‚ö°' : (b.name === '–®–∫–æ–ª–∞' ? 'üìö' : (b.name === '–ë–æ–ª—å–Ω–∏—Ü–∞' ? 'üè•' : (b.name === '–ú–∞–≥–∞–∑–∏–Ω' ? 'üè™' : (b.name === '–û—Ñ–∏—Å' ? 'üèõÔ∏è' : (b.name.includes('–ù–µ–±–æ') ? 'üèôÔ∏è' : (b.name.includes('–ú–Ω–æ–≥–æ') ? 'üè¢' : (b.name.includes('–ö–æ—Ç') ? 'üè°' : 'üè†')))))))))}</div>
                    <div class="card-name">${b.name}</div>
                    <div class="card-price">${b.price}üí∞</div>
                `;
                card.addEventListener('click', (e) => {
                    e.stopPropagation();
                    document.querySelectorAll('.build-card').forEach(c => c.classList.remove('selected'));
                    card.classList.add('selected');
                    gameState.selectedBuilding = key;
                    document.getElementById('infoPanel').innerHTML = `–í—ã–±—Ä–∞–Ω–æ: ${b.name}`;
                });
                track.appendChild(card);
            });
        }

        document.getElementById('tabResidential').addEventListener('click', () => {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.getElementById('tabResidential').classList.add('active');
            currentCategory = 'residential';
            renderBuildings('residential');
        });
        document.getElementById('tabCommercial').addEventListener('click', () => {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.getElementById('tabCommercial').classList.add('active');
            currentCategory = 'commercial';
            renderBuildings('commercial');
        });
        document.getElementById('tabInfra').addEventListener('click', () => {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.getElementById('tabInfra').classList.add('active');
            currentCategory = 'infra';
            renderBuildings('infra');
        });

        function saveGame() {
            if (tg) {
                tg.sendData(JSON.stringify({
                    balance: gameState.balance,
                    grid: gameState.grid,
                    land: gameState.land,
                    population: gameState.population
                }));
            }
            localStorage.setItem('islandEmpireUltra', JSON.stringify(gameState));
        }

        function loadGame() {
            const saved = localStorage.getItem('islandEmpireUltra');
            if (saved) {
                try {
                    const data = JSON.parse(saved);
                    gameState = {...gameState, ...data};
                } catch(e) {}
            }
            updateUI();
            drawCity();
        }

        renderBuildings('residential');
        loadGame();

        document.getElementById('collectBtn').addEventListener('click', collectTax);
        document.getElementById('expandBtn').addEventListener('click', expandIsland);
        document.getElementById('cancelBtn').addEventListener('click', () => {
            gameState.selectedBuilding = null;
            document.querySelectorAll('.build-card').forEach(c => c.classList.remove('selected'));
            document.getElementById('infoPanel').innerHTML = '–í—ã–±–æ—Ä –æ—Ç–º–µ–Ω—ë–Ω';
        });

        setInterval(() => {
            drawCity();
            saveGame();
        }, 100);
    })();
</script>
</body>
</html>
