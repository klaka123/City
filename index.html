<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>–ê—Ä—Ö–∏–ø–µ–ª–∞–≥ ‚Äî —Ñ–æ—Ç–æ—Ä–µ–∞–ª–∏—Å—Ç–∏—á–Ω–∞—è –≥—Ä–∞—Ñ–∏–∫–∞</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Roboto, 'Helvetica Neue', sans-serif;
        }
        body {
            background: #0a1c2c;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            padding: 15px;
        }
        .game-frame {
            width: 100%;
            max-width: 800px;
            background: linear-gradient(145deg, #236f9c, #154f73);
            border-radius: 100px;
            padding: 40px;
            box-shadow: 0 80px 150px rgba(0,0,0,0.9), inset 0 8px 25px rgba(255,255,255,0.5);
            border: 7px solid #8fc9ec;
        }
        .stats-panel {
            background: rgba(0, 30, 45, 0.9);
            backdrop-filter: blur(50px);
            border-radius: 100px;
            padding: 28px 45px;
            display: flex;
            justify-content: space-between;
            color: white;
            margin-bottom: 40px;
            border: 4px solid #c0e6ff;
            box-shadow: 0 28px 0 #145e7c;
        }
        .stat-item {
            display: flex;
            align-items: center;
            gap: 18px;
            font-size: 34px;
            font-weight: 700;
            background: rgba(0,0,0,0.5);
            padding: 14px 40px;
            border-radius: 90px;
            backdrop-filter: blur(8px);
        }
        .stat-icon {
            font-size: 54px;
            filter: drop-shadow(0 10px 12px black);
        }
        .canvas-area {
            background: #1f7aa8;
            border-radius: 90px;
            padding: 40px;
            display: flex;
            justify-content: center;
            box-shadow: inset 0 -45px 90px #0d405c, 0 50px 100px black;
            margin-bottom: 40px;
        }
        #gameCanvas {
            width: 100%;
            height: auto;
            border-radius: 80px;
            background: #2f8ec9;
            cursor: pointer;
            touch-action: none;
            max-width: 680px;
            box-shadow: 0 0 0 12px #dff3ff, 0 50px 110px black;
        }
        .category-bar {
            display: flex;
            gap: 28px;
            margin-bottom: 32px;
        }
        .cat-btn {
            flex: 1;
            background: rgba(255,255,255,0.2);
            backdrop-filter: blur(40px);
            border: 6px solid white;
            border-radius: 100px;
            padding: 24px;
            color: white;
            font-size: 30px;
            font-weight: bold;
            text-align: center;
            box-shadow: 0 18px 0 #146185;
            transition: 0.1s;
        }
        .cat-btn.active {
            background: #ffdb94;
            color: #1c4a66;
            border-color: #ffb84d;
            transform: translateY(-9px);
            box-shadow: 0 27px 0 #cc9530;
        }
        .cat-btn:active {
            transform: translateY(12px);
            box-shadow: 0 8px 0 #146185;
        }
        .buildings-scroll {
            background: rgba(255,255,255,0.98);
            backdrop-filter: blur(45px);
            border-radius: 110px;
            padding: 28px;
            margin-bottom: 40px;
            overflow-x: auto;
            white-space: nowrap;
            border: 7px solid white;
            box-shadow: inset 0 15px 45px #aaa;
        }
        .buildings-scroll::-webkit-scrollbar { display: none; }
        .buildings-track {
            display: inline-flex;
            gap: 38px;
            padding: 22px;
        }
        .build-card {
            background: linear-gradient(145deg, #fffef8, #f7eedb);
            border-radius: 100px;
            padding: 42px 48px;
            display: inline-flex;
            flex-direction: column;
            align-items: center;
            min-width: 280px;
            box-shadow: 0 34px 0 #d4bf98, 0 55px 85px rgba(0,0,0,0.7);
            border: 8px solid #fffae6;
            transition: 0.1s;
        }
        .build-card.selected {
            transform: translateY(-18px);
            border-color: #f7b731;
            box-shadow: 0 42px 0 #c9912e, 0 65px 100px black;
        }
        .build-card:active {
            transform: translateY(18px);
            box-shadow: 0 16px 0 #d4bf98;
        }
        .card-icon {
            width: 180px;
            height: 180px;
            background: #e3f0f5;
            border-radius: 80px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 120px;
            margin-bottom: 24px;
            box-shadow: inset 0 -18px 0 #c2d9e4;
        }
        .card-name {
            font-weight: 800;
            font-size: 32px;
            color: #2b7059;
        }
        .card-price {
            background: #d9bf94;
            padding: 16px 48px;
            border-radius: 90px;
            font-weight: 700;
            margin-top: 22px;
            font-size: 30px;
        }
        .action-bar {
            display: flex;
            gap: 30px;
            justify-content: center;
            flex-wrap: wrap;
            margin-bottom: 40px;
        }
        .action-button {
            flex: 1 1 auto;
            min-width: 280px;
            background: linear-gradient(145deg, #3f9ed4, #1c6fa0);
            border: none;
            border-radius: 110px;
            padding: 38px 42px;
            color: white;
            font-size: 38px;
            font-weight: bold;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 24px;
            box-shadow: 0 34px 0 #12547a, 0 55px 90px black;
            border: 7px solid #b0e2ff;
            position: relative;
        }
        .action-button:active {
            transform: translateY(18px);
            box-shadow: 0 16px 0 #12547a;
        }
        .cooldown-indicator {
            position: absolute;
            top: 0;
            left: 0;
            height: 100%;
            background: rgba(0,0,0,0.5);
            border-radius: 110px;
            transition: width 0.1s linear;
            pointer-events: none;
        }
        .info-area {
            background: #e5f2fa;
            border-radius: 100px;
            padding: 36px;
            color: #12597a;
            border: 8px solid white;
            font-size: 32px;
            font-weight: 600;
            box-shadow: inset 0 18px 45px #b3d9f0, 0 34px 0 #548ea8;
        }
    </style>
</head>
<body>
<div class="game-frame">
    <div class="stats-panel">
        <div class="stat-item"><span class="stat-icon">üí∞</span> <span id="moneyDisplay">50000</span></div>
        <div class="stat-item"><span class="stat-icon">üë•</span> <span id="popDisplay">0</span></div>
        <div class="stat-item"><span class="stat-icon">üìä</span> <span id="incomeDisplay">0</span></div>
        <div class="stat-item"><span class="stat-icon">üèùÔ∏è</span> <span id="landDisplay">36</span></div>
    </div>

    <div class="canvas-area">
        <canvas id="gameCanvas" width="700" height="580"></canvas>
    </div>

    <div class="category-bar">
        <div class="cat-btn active" id="catRes">üèòÔ∏è –ñ–∏–ª—ã–µ</div>
        <div class="cat-btn" id="catCom">üè™ –ö–æ–º–º–µ—Ä—Ü–∏—è</div>
        <div class="cat-btn" id="catInd">üè≠ –ò–Ω–¥—É—Å—Ç—Ä–∏—è</div>
        <div class="cat-btn" id="catInf">üèõÔ∏è –°–æ—Ü. —Å—Ñ–µ—Ä–∞</div>
        <div class="cat-btn" id="catDec">üå≥ –î–µ–∫–æ—Ä</div>
    </div>

    <div class="buildings-scroll">
        <div class="buildings-track" id="buildingsTrack"></div>
    </div>

    <div class="action-bar">
        <button class="action-button" id="collectBtn">
            <span>üí∞</span> –°–±–æ—Ä
            <div class="cooldown-indicator" id="cooldownBar" style="width: 0%;"></div>
        </button>
        <button class="action-button" id="expandBtn"><span>üåäüèùÔ∏è</span> 2500üí∞</button>
        <button class="action-button" id="cancelBtn"><span>‚ùå</span> –û—Ç–º–µ–Ω–∞</button>
    </div>

    <div class="info-area" id="infoPanel">
        üëÜ –í—ã–±–µ—Ä–∏—Ç–µ –∑–¥–∞–Ω–∏–µ –∏ –∫–æ—Å–Ω–∏—Ç–µ—Å—å —É—á–∞—Å—Ç–∫–∞ –Ω–∞ –∫–∞—Ä—Ç–µ.
    </div>
</div>

<script src="https://telegram.org/js/telegram-web-app.js"></script>
<script>
(function() {
    // ==================== Telegram ====================
    let tg = null;
    try {
        if (window.Telegram?.WebApp) {
            tg = Telegram.WebApp;
            tg.expand();
            tg.ready();
        }
    } catch {}

    // ==================== –ö–æ–Ω—Å—Ç–∞–Ω—Ç—ã –∏–∑–æ–º–µ—Ç—Ä–∏–∏ ====================
    const GRID_SIZE = 8;
    const CELL_W = 110;
    const CELL_H = 60;
    const ISO_OFFSET_X = 330;
    const ISO_OFFSET_Y = 70;

    // ==================== –ì–ª–æ–±–∞–ª—å–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ ====================
    let gameState = {
        money: 50000,
        grid: [],
        land: [],
        population: 0,
        lastTaxTime: Date.now(),
        taxCooldown: 5000,
        selectedBuilding: null,
        expandCost: 2500,
        gridSize: GRID_SIZE,
        timeOfDay: 0.5, // 0 - –Ω–æ—á—å, 1 - –¥–µ–Ω—å
    };

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –æ—Å—Ç—Ä–æ–≤–∞ (6x6 —Å—É—à–∞)
    for (let r = 0; r < GRID_SIZE; r++) {
        gameState.grid[r] = [];
        gameState.land[r] = [];
        for (let c = 0; c < GRID_SIZE; c++) {
            if (r >= 1 && r <= 6 && c >= 1 && c <= 6) {
                gameState.land[r][c] = true;
                gameState.grid[r][c] = 'empty';
            } else {
                gameState.land[r][c] = false;
                gameState.grid[r][c] = 'empty';
            }
        }
    }

    // ==================== –ë–ò–ë–õ–ò–û–¢–ï–ö–ê –ú–ï–ì–ê-–î–ï–¢–ê–õ–ò–ó–ò–†–û–í–ê–ù–ù–´–• –ó–î–ê–ù–ò–ô ====================
    // –ö–∞–∂–¥–æ–µ –∑–¥–∞–Ω–∏–µ –∏–º–µ–µ—Ç –º–Ω–æ–∂–µ—Å—Ç–≤–æ –≤–∞—Ä–∏–∞—Ü–∏–π –∏ —Ä–∏—Å—É–µ—Ç—Å—è —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º —Å–ª–æ–∂–Ω—ã—Ö —Ç–µ—Ö–Ω–∏–∫:
    // —Ç–µ–∫—Å—Ç—É—Ä—ã, —Ç–µ–Ω–∏, –±–ª–∏–∫–∏, –æ—Ç—Ä–∞–∂–µ–Ω–∏—è, –º–µ–ª–∫–∏–µ –¥–µ—Ç–∞–ª–∏.

    const BUILDING_VARIANTS = {
        // –ñ–∏–ª—ã–µ
        cottage: [
            { name: '–ö–æ—Ç—Ç–µ–¥–∂ —Å –º–µ–∑–æ–Ω–∏–Ω–æ–º', baseColor: '#e3b27c', roofColor: '#b54c4c', doorColor: '#8b5a2b', windowColor: '#f9e076', hasChimney: true, hasShutters: true, hasFlowers: true, texture: 'brick' },
            { name: '–î–æ–º —Å –≤–µ—Ä–∞–Ω–¥–æ–π', baseColor: '#cf9f6b', roofColor: '#8b5a2b', doorColor: '#a57248', windowColor: '#f9e076', hasChimney: false, hasShutters: false, hasFlowers: true, texture: 'wood' },
            { name: '–®–∞–ª–µ', baseColor: '#b38b5a', roofColor: '#6b4c2c', doorColor: '#5a3e24', windowColor: '#ffe68f', hasChimney: true, hasShutters: true, hasFlowers: false, texture: 'stone' }
        ],
        mansion: [
            { name: '–û—Å–æ–±–Ω—è–∫', baseColor: '#d9b382', roofColor: '#b34b4b', doorColor: '#8b5a2b', windowColor: '#f9e076', hasColumns: true, hasBalcony: true, hasGarage: false },
            { name: '–í–∏–ª–ª–∞', baseColor: '#f0c48b', roofColor: '#b34b4b', doorColor: '#8b5a2b', windowColor: '#f9e076', hasColumns: true, hasBalcony: true, hasGarage: true }
        ],
        apartment: [
            { name: '–ñ–∏–ª–æ–π –∫–æ–º–ø–ª–µ–∫—Å', baseColor: '#b0bec5', accentColor: '#8a9aa8', windowColor: '#cfd8dc', hasBalconies: true, floors: 4 },
            { name: '–ú–Ω–æ–≥–æ—ç—Ç–∞–∂–∫–∞', baseColor: '#9e9e9e', accentColor: '#757575', windowColor: '#cfd8dc', hasBalconies: false, floors: 5 }
        ],
        skyscraper: [
            { name: '–ù–µ–±–æ—Å–∫—Ä—ë–±', baseColor: '#607d8b', accentColor: '#4f6573', windowColor: '#ffd966', hasSpire: true, hasAntenna: true, floors: 12 },
            { name: '–ë–∏–∑–Ω–µ—Å-—Ü–µ–Ω—Ç—Ä', baseColor: '#546e7a', accentColor: '#37474f', windowColor: '#ffd966', hasSpire: false, hasAntenna: true, floors: 10 }
        ],
        // –ö–æ–º–º–µ—Ä—Ü–∏—è
        shop: [
            { name: '–ú–∞–≥–∞–∑–∏–Ω', baseColor: '#ffb74d', roofColor: '#ff9800', windowColor: '#fff2cc', hasSign: true, hasAwning: true },
            { name: '–°—É–ø–µ—Ä–º–∞—Ä–∫–µ—Ç', baseColor: '#ff8a65', roofColor: '#f57c00', windowColor: '#fff2cc', hasSign: true, hasAwning: false }
        ],
        office: [
            { name: '–û—Ñ–∏—Å', baseColor: '#9e9e9e', accentColor: '#757575', windowColor: '#cfd8dc', hasLogo: true, floors: 3 },
            { name: '–ë–∏–∑–Ω–µ—Å-–ø–∞—Ä–∫', baseColor: '#b0bec5', accentColor: '#78909c', windowColor: '#cfd8dc', hasLogo: false, floors: 4 }
        ],
        bank: [
            { name: '–ë–∞–Ω–∫', baseColor: '#cfd8dc', accentColor: '#b0bec5', windowColor: '#fff2cc', hasColumns: true, hasStatue: true },
            { name: '–§–∏–Ω–∞–Ω—Å–æ–≤—ã–π —Ü–µ–Ω—Ç—Ä', baseColor: '#b0bec5', accentColor: '#90a4ae', windowColor: '#fff2cc', hasColumns: true, hasStatue: false }
        ],
        hotel: [
            { name: '–û—Ç–µ–ª—å', baseColor: '#ffe082', accentColor: '#ffd54f', windowColor: '#fff2cc', hasPool: true, floors: 5 },
            { name: '–ì–æ—Å—Ç–∏–Ω–∏—Ü–∞', baseColor: '#ffd54f', accentColor: '#ffb300', windowColor: '#fff2cc', hasPool: false, floors: 4 }
        ],
        // –ò–Ω–¥—É—Å—Ç—Ä–∏—è
        factory: [
            { name: '–ó–∞–≤–æ–¥', baseColor: '#b0bec5', accentColor: '#8a9aa8', chimney: true, smoke: true, windows: 3 },
            { name: '–§–∞–±—Ä–∏–∫–∞', baseColor: '#9e9e9e', accentColor: '#757575', chimney: true, smoke: true, windows: 2 }
        ],
        powerplant: [
            { name: '–≠–ª–µ–∫—Ç—Ä–æ—Å—Ç–∞–Ω—Ü–∏—è', baseColor: '#b0a57c', accentColor: '#8b7a5a', chimneys: 2, smoke: true, windows: 2 },
            { name: '–¢–≠–¶', baseColor: '#9e8f72', accentColor: '#6b5d3a', chimneys: 3, smoke: true, windows: 3 }
        ],
        // –°–æ—Ü–∏–∞–ª—å–Ω–∞—è —Å—Ñ–µ—Ä–∞
        school: [
            { name: '–®–∫–æ–ª–∞', baseColor: '#ff8a80', accentColor: '#f06292', hasBell: true, windows: 4 },
            { name: '–ì–∏–º–Ω–∞–∑–∏—è', baseColor: '#ffab91', accentColor: '#ff8a80', hasBell: true, windows: 5 }
        ],
        hospital: [
            { name: '–ë–æ–ª—å–Ω–∏—Ü–∞', baseColor: '#ef9a9a', accentColor: '#e57373', hasCross: true, windows: 4 },
            { name: '–ö–ª–∏–Ω–∏–∫–∞', baseColor: '#ffcdd2', accentColor: '#ef9a9a', hasCross: true, windows: 3 }
        ],
        church: [
            { name: '–¶–µ—Ä–∫–æ–≤—å', baseColor: '#f5f5f5', roofColor: '#b71c1c', hasSpire: true, hasCross: true },
            { name: '–°–æ–±–æ—Ä', baseColor: '#eeeeee', roofColor: '#7b1f1f', hasSpire: true, hasCross: true }
        ],
        monument: [
            { name: '–ú–æ–Ω—É–º–µ–Ω—Ç', baseColor: '#b0bec5', height: 40, hasStatue: true },
            { name: '–°—Ç–µ–ª–∞', baseColor: '#9e9e9e', height: 35, hasStatue: false }
        ],
        // –î–µ–∫–æ—Ä
        park: [
            { name: '–ü–∞—Ä–∫', baseColor: '#81c784', trees: 4, hasFountain: true, hasBench: true },
            { name: '–°–∫–≤–µ—Ä', baseColor: '#66bb6a', trees: 5, hasFountain: false, hasBench: true }
        ],
        road: [
            { name: '–î–æ—Ä–æ–≥–∞', baseColor: '#b0bec5', hasMarkup: true, hasLights: true },
            { name: '–®–æ—Å—Å–µ', baseColor: '#9e9e9e', hasMarkup: true, hasLights: false }
        ]
    };

    // –ö–∞—Ç–∞–ª–æ–≥ –∑–¥–∞–Ω–∏–π (–¥–ª—è UI –∏ —ç–∫–æ–Ω–æ–º–∏–∫–∏)
    const BUILDINGS_CATALOG = [
        // –ñ–∏–ª—ã–µ
        { id: 'cottage1', category: 'residential', variantPool: 'cottage', basePrice: 400, baseIncome: 28, basePop: 12 },
        { id: 'cottage2', category: 'residential', variantPool: 'cottage', basePrice: 700, baseIncome: 48, basePop: 22 },
        { id: 'mansion1', category: 'residential', variantPool: 'mansion', basePrice: 1500, baseIncome: 110, basePop: 45 },
        { id: 'apartment1', category: 'residential', variantPool: 'apartment', basePrice: 2500, baseIncome: 190, basePop: 85 },
        { id: 'skyscraper1', category: 'residential', variantPool: 'skyscraper', basePrice: 9000, baseIncome: 800, basePop: 400 },
        // –ö–æ–º–º–µ—Ä—Ü–∏—è
        { id: 'shop1', category: 'commercial', variantPool: 'shop', basePrice: 600, baseIncome: 70, basePop: 5 },
        { id: 'office1', category: 'commercial', variantPool: 'office', basePrice: 2000, baseIncome: 230, basePop: 15 },
        { id: 'bank1', category: 'commercial', variantPool: 'bank', basePrice: 4500, baseIncome: 500, basePop: 10 },
        { id: 'hotel1', category: 'commercial', variantPool: 'hotel', basePrice: 4000, baseIncome: 420, basePop: 30 },
        // –ò–Ω–¥—É—Å—Ç—Ä–∏—è
        { id: 'factory1', category: 'industrial', variantPool: 'factory', basePrice: 3500, baseIncome: 400, basePop: 8 },
        { id: 'powerplant1', category: 'industrial', variantPool: 'powerplant', basePrice: 8000, baseIncome: 900, basePop: 0 },
        // –°–æ—Ü–∏–∞–ª—å–Ω–∞—è —Å—Ñ–µ—Ä–∞
        { id: 'school1', category: 'infrastructure', variantPool: 'school', basePrice: 3500, baseIncome: 110, basePop: 0 },
        { id: 'hospital1', category: 'infrastructure', variantPool: 'hospital', basePrice: 5500, baseIncome: 190, basePop: 0 },
        { id: 'church1', category: 'infrastructure', variantPool: 'church', basePrice: 3000, baseIncome: 70, basePop: 0 },
        { id: 'monument1', category: 'infrastructure', variantPool: 'monument', basePrice: 2000, baseIncome: 30, basePop: 0 },
        // –î–µ–∫–æ—Ä
        { id: 'park1', category: 'decor', variantPool: 'park', basePrice: 500, baseIncome: 35, basePop: 5 },
        { id: 'road1', category: 'decor', variantPool: 'road', basePrice: 200, baseIncome: 10, basePop: 0 }
    ];

    const BUILDING_DICT = {};
    BUILDINGS_CATALOG.forEach(b => { BUILDING_DICT[b.id] = b; });

    let buildingVariants = {}; // —Ö—Ä–∞–Ω–∏—Ç –≤—ã–±—Ä–∞–Ω–Ω—ã–π –≤–∞—Ä–∏–∞–Ω—Ç –¥–ª—è –∫–∞–∂–¥–æ–π –∫–ª–µ—Ç–∫–∏

    // ==================== –ú–ï–ì–ê-–î–ï–¢–ê–õ–ò–ó–ò–†–û–í–ê–ù–ù–´–ï –§–£–ù–ö–¶–ò–ò –û–¢–†–ò–°–û–í–ö–ò ====================
    const canvas = document.getElementById('gameCanvas');
    const ctx = canvas.getContext('2d');

    // –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –¥–ª—è —Ä–∏—Å–æ–≤–∞–Ω–∏—è —Ç–µ–∫—Å—Ç—É—Ä
    function drawBrickTexture(x, y, w, h, color) {
        ctx.fillStyle = color;
        ctx.fillRect(x, y, w, h);
        ctx.fillStyle = '#8b5a2b';
        for (let i = 0; i < w; i += 15) {
            ctx.fillRect(x + i, y, 2, h);
        }
        for (let i = 0; i < h; i += 10) {
            ctx.fillRect(x, y + i, w, 2);
        }
    }

    function drawWoodTexture(x, y, w, h, color) {
        ctx.fillStyle = color;
        ctx.fillRect(x, y, w, h);
        ctx.strokeStyle = '#8b5a2b';
        ctx.lineWidth = 1;
        for (let i = 0; i < w; i += 8) {
            ctx.beginPath();
            ctx.moveTo(x + i, y);
            ctx.lineTo(x + i, y + h);
            ctx.stroke();
        }
    }

    function drawStoneTexture(x, y, w, h, color) {
        ctx.fillStyle = color;
        ctx.fillRect(x, y, w, h);
        ctx.fillStyle = '#a0a0a0';
        for (let i = 0; i < 5; i++) {
            ctx.beginPath();
            ctx.arc(x + 5 + i*12, y + 5, 4, 0, 2*Math.PI);
            ctx.fill();
        }
    }

    // –§—É–Ω–∫—Ü–∏—è —Ä–∏—Å–æ–≤–∞–Ω–∏—è —Ç–µ–Ω–∏ –æ—Ç –∑–¥–∞–Ω–∏—è –Ω–∞ –∑–µ–º–ª—é
    function drawShadow(x, y, width, height) {
        ctx.fillStyle = 'rgba(0,0,0,0.2)';
        ctx.shadowBlur = 0;
        ctx.beginPath();
        ctx.moveTo(x - width/2, y + height/2);
        ctx.lineTo(x + width/2, y + height/2);
        ctx.lineTo(x + width/2 + 10, y + height/2 + 10);
        ctx.lineTo(x - width/2 + 10, y + height/2 + 10);
        ctx.closePath();
        ctx.fill();
    }

    // –ë–∞–∑–æ–≤–∞—è –ø–ª–∞—Ç—Ñ–æ—Ä–º–∞
    function drawBase(x, y, color, heightOffset = 0) {
        ctx.fillStyle = color;
        ctx.shadowColor = '#2b4d2b';
        ctx.shadowBlur = 35;
        ctx.shadowOffsetY = 20;
        ctx.beginPath();
        ctx.moveTo(x, y - 5 - heightOffset);
        ctx.lineTo(x + CELL_W/2, y + CELL_H/2 - 5 - heightOffset);
        ctx.lineTo(x, y + CELL_H - 5 - heightOffset);
        ctx.lineTo(x - CELL_W/2, y + CELL_H/2 - 5 - heightOffset);
        ctx.closePath();
        ctx.fill();
        drawShadow(x, y, CELL_W, CELL_H);
    }

    // -------------------- –ñ–∏–ª—ã–µ --------------------
    function drawCottage(x, y, variant) {
        drawBase(x, y, variant.baseColor);
        // –°—Ç–µ–Ω—ã —Å —Ç–µ–∫—Å—Ç—É—Ä–æ–π
        if (variant.texture === 'brick') drawBrickTexture(x-25, y-50, 50, 32, variant.baseColor);
        else if (variant.texture === 'wood') drawWoodTexture(x-25, y-50, 50, 32, variant.baseColor);
        else ctx.fillStyle = variant.baseColor, ctx.fillRect(x-25, y-50, 50, 32);

        // –ö—Ä—ã—à–∞
        ctx.fillStyle = variant.roofColor;
        ctx.shadowBlur = 25;
        ctx.beginPath();
        ctx.moveTo(x-35, y-55);
        ctx.lineTo(x+35, y-55);
        ctx.lineTo(x, y-90);
        ctx.closePath();
        ctx.fill();
        // –ß–µ—Ä–µ–ø–∏—Ü–∞
        ctx.strokeStyle = '#8b3a3a';
        ctx.lineWidth = 2;
        for (let i = -25; i <= 25; i+=12) {
            ctx.beginPath();
            ctx.moveTo(x-30+i, y-65);
            ctx.lineTo(x-10+i, y-85);
            ctx.stroke();
        }

        // –û–∫–Ω–∞
        ctx.fillStyle = variant.windowColor;
        ctx.shadowBlur = 10;
        ctx.fillRect(x-35, y-44, 10, 14);
        ctx.fillRect(x+25, y-44, 10, 14);
        if (variant.hasShutters) {
            ctx.fillStyle = '#8b5a2b';
            ctx.fillRect(x-40, y-44, 5, 14);
            ctx.fillRect(x+35, y-44, 5, 14);
        }
        // –¶–≤–µ—Ç—ã –Ω–∞ –æ–∫–Ω–∞—Ö
        if (variant.hasFlowers) {
            ctx.fillStyle = '#ff69b4';
            ctx.beginPath();
            ctx.arc(x-30, y-48, 3, 0, 2*Math.PI);
            ctx.fill();
            ctx.beginPath();
            ctx.arc(x+30, y-48, 3, 0, 2*Math.PI);
            ctx.fill();
        }

        // –î–≤–µ—Ä—å
        ctx.fillStyle = variant.doorColor;
        ctx.fillRect(x-12, y-30, 24, 28);
        ctx.fillStyle = '#d4af37';
        ctx.beginPath();
        ctx.arc(x-4, y-16, 3, 0, 2*Math.PI);
        ctx.fill();

        // –¢—Ä—É–±–∞
        if (variant.hasChimney) {
            ctx.fillStyle = '#8b5a2b';
            ctx.fillRect(x+20, y-75, 8, 20);
        }
        ctx.shadowBlur = 0;
    }

    function drawMansion(x, y, variant) {
        drawBase(x, y, variant.baseColor);
        ctx.fillStyle = variant.baseColor;
        ctx.fillRect(x-35, y-60, 70, 40);
        // –ö–æ–ª–æ–Ω–Ω—ã
        if (variant.hasColumns) {
            ctx.fillStyle = '#f5f5f5';
            for (let i = -20; i <= 20; i+=22) {
                ctx.fillRect(x-6+i, y-52, 8, 30);
            }
        }
        // –ö—Ä—ã—à–∞
        ctx.fillStyle = variant.roofColor;
        ctx.beginPath();
        ctx.moveTo(x-45, y-65);
        ctx.lineTo(x+45, y-65);
        ctx.lineTo(x, y-105);
        ctx.closePath();
        ctx.fill();
        // –û–∫–Ω–∞
        ctx.fillStyle = variant.windowColor;
        ctx.fillRect(x-30, y-48, 10, 14);
        ctx.fillRect(x+20, y-48, 10, 14);
        ctx.fillRect(x-30, y-28, 10, 14);
        ctx.fillRect(x+20, y-28, 10, 14);
        // –ë–∞–ª–∫–æ–Ω
        if (variant.hasBalcony) {
            ctx.fillStyle = '#a57248';
            ctx.fillRect(x-20, y-40, 40, 6);
            ctx.fillStyle = '#8b5a2b';
            ctx.fillRect(x-12, y-50, 8, 12);
            ctx.fillRect(x+4, y-50, 8, 12);
        }
        // –ì–∞—Ä–∞–∂
        if (variant.hasGarage) {
            ctx.fillStyle = '#8b5a2b';
            ctx.fillRect(x-20, y-25, 40, 12);
        }
    }

    function drawApartment(x, y, variant) {
        drawBase(x, y, variant.baseColor);
        ctx.fillStyle = variant.accentColor;
        ctx.fillRect(x-35, y-80, 70, 60);
        // –û–∫–Ω–∞
        for (let f = 0; f < variant.floors; f++) {
            for (let i = -20; i <= 20; i+=22) {
                ctx.fillStyle = variant.windowColor;
                ctx.fillRect(x-12+i, y-70 + f*18, 12, 12);
                ctx.fillStyle = '#f9e076';
                ctx.fillRect(x-10+i, y-68 + f*18, 4, 4);
                ctx.fillRect(x-2+i, y-68 + f*18, 4, 4);
            }
        }
        // –ë–∞–ª–∫–æ–Ω—ã
        if (variant.hasBalconies) {
            ctx.fillStyle = '#a0aab3';
            ctx.fillRect(x-40, y-52, 22, 6);
            ctx.fillRect(x+18, y-52, 22, 6);
            ctx.fillRect(x-40, y-34, 22, 6);
            ctx.fillRect(x+18, y-34, 22, 6);
        }
    }

    function drawSkyscraper(x, y, variant) {
        drawBase(x, y, variant.baseColor);
        ctx.fillStyle = variant.accentColor;
        ctx.fillRect(x-40, y-130, 80, 100);
        // –û–∫–Ω–∞
        for (let f = 0; f < variant.floors; f++) {
            for (let i = -24; i <= 24; i+=20) {
                ctx.fillStyle = variant.windowColor;
                ctx.fillRect(x-14+i, y-120 + f*14, 12, 12);
                ctx.fillStyle = '#fff';
                ctx.fillRect(x-12+i, y-118 + f*14, 4, 4);
                ctx.fillRect(x-4+i, y-118 + f*14, 4, 4);
            }
        }
        // –®–ø–∏–ª—å
        if (variant.hasSpire) {
            ctx.fillStyle = '#b0bec5';
            ctx.fillRect(x-5, y-150, 10, 25);
            ctx.fillStyle = '#d4af37';
            ctx.beginPath();
            ctx.arc(x, y-165, 8, 0, 2*Math.PI);
            ctx.fill();
        }
        // –ê–Ω—Ç–µ–Ω–Ω–∞
        if (variant.hasAntenna) {
            ctx.fillStyle = '#b0bec5';
            ctx.fillRect(x-3, y-155, 6, 30);
        }
    }

    // -------------------- –ö–æ–º–º–µ—Ä—Ü–∏—è --------------------
    function drawShop(x, y, variant) {
        drawBase(x, y, variant.baseColor);
        ctx.fillStyle = variant.roofColor;
        ctx.fillRect(x-35, y-55, 70, 30);
        // –í–∏—Ç—Ä–∏–Ω–∞
        ctx.fillStyle = variant.windowColor;
        ctx.fillRect(x-25, y-48, 20, 20);
        ctx.fillRect(x+5, y-48, 20, 20);
        // –¢–æ–≤–∞—Ä—ã
        ctx.fillStyle = '#8b5a2b';
        ctx.font = '28px sans-serif';
        ctx.fillText('üõí', x-35, y-20);
        ctx.fillText('üßÉ', x+8, y-25);
        // –ù–∞–≤–µ—Å
        if (variant.hasAwning) {
            ctx.fillStyle = '#c43a3a';
            ctx.fillRect(x-30, y-62, 60, 8);
        }
        // –í—ã–≤–µ—Å–∫–∞
        if (variant.hasSign) {
            ctx.fillStyle = '#c43a3a';
            ctx.fillRect(x-18, y-75, 36, 12);
            ctx.fillStyle = '#fff';
            ctx.font = '20px sans-serif';
            ctx.fillText('SALE', x-16, y-64);
        }
    }

    function drawOffice(x, y, variant) {
        drawBase(x, y, variant.baseColor);
        ctx.fillStyle = variant.accentColor;
        ctx.fillRect(x-38, y-75, 76, 50);
        // –û–∫–Ω–∞
        for (let f = 0; f < variant.floors; f++) {
            for (let i = -20; i <= 20; i+=24) {
                ctx.fillStyle = variant.windowColor;
                ctx.fillRect(x-14+i, y-68 + f*16, 14, 12);
                ctx.fillStyle = '#aed6f1';
                ctx.fillRect(x-12+i, y-66 + f*16, 4, 4);
                ctx.fillRect(x-2+i, y-66 + f*16, 4, 4);
            }
        }
        // –õ–æ–≥–æ—Ç–∏–ø
        if (variant.hasLogo) {
            ctx.fillStyle = '#ffb74d';
            ctx.beginPath();
            ctx.arc(x, y-92, 12, 0, 2*Math.PI);
            ctx.fill();
            ctx.fillStyle = '#fff';
            ctx.font = '18px sans-serif';
            ctx.fillText('INC', x-18, y-90);
        }
    }

    function drawBank(x, y, variant) {
        drawBase(x, y, variant.baseColor);
        ctx.fillStyle = variant.accentColor;
        ctx.fillRect(x-45, y-80, 90, 55);
        // –ö–æ–ª–æ–Ω–Ω—ã
        if (variant.hasColumns) {
            ctx.fillStyle = '#f5f5f5';
            for (let i = -30; i <= 30; i+=20) {
                ctx.fillRect(x-8+i, y-68, 8, 40);
            }
        }
        // –°—Ç–∞—Ç—É—è
        if (variant.hasStatue) {
            ctx.fillStyle = '#b0bec5';
            ctx.beginPath();
            ctx.arc(x, y-100, 12, 0, 2*Math.PI);
            ctx.fill();
            ctx.fillRect(x-4, y-112, 8, 16);
        }
    }

    function drawHotel(x, y, variant) {
        drawBase(x, y, variant.baseColor);
        ctx.fillStyle = variant.accentColor;
        ctx.fillRect(x-42, y-100, 84, 70);
        // –û–∫–Ω–∞
        for (let f = 0; f < variant.floors; f++) {
            for (let i = -24; i <= 24; i+=22) {
                ctx.fillStyle = variant.windowColor;
                ctx.fillRect(x-14+i, y-92 + f*18, 14, 14);
            }
        }
        // –ë–∞—Å—Å–µ–π–Ω
        if (variant.hasPool) {
            ctx.fillStyle = '#7ec8e0';
            ctx.fillRect(x-25, y-20, 50, 10);
        }
    }

    // -------------------- –ò–Ω–¥—É—Å—Ç—Ä–∏—è --------------------
    function drawFactory(x, y, variant) {
        drawBase(x, y, variant.baseColor);
        ctx.fillStyle = variant.accentColor;
        ctx.fillRect(x-40, y-90, 80, 60);
        // –¢—Ä—É–±–∞
        if (variant.chimney) {
            ctx.fillStyle = '#6b5a3a';
            ctx.fillRect(x-10, y-120, 8, 35);
        }
        // –î—ã–º
        if (variant.smoke) {
            ctx.fillStyle = 'rgba(255,255,255,0.3)';
            ctx.beginPath();
            ctx.arc(x-8, y-140, 12, 0, 2*Math.PI);
            ctx.fill();
        }
        // –û–∫–Ω–∞
        ctx.fillStyle = '#ffb74d';
        for (let i = 0; i < variant.windows; i++) {
            ctx.fillRect(x-25 + i*20, y-60, 10, 10);
        }
        // –í–æ—Ä–æ—Ç–∞
        ctx.fillStyle = '#8b5a2b';
        ctx.fillRect(x-20, y-40, 40, 20);
    }

    function drawPowerPlant(x, y, variant) {
        drawBase(x, y, variant.baseColor);
        ctx.fillStyle = variant.accentColor;
        ctx.fillRect(x-45, y-100, 90, 70);
        // –¢—Ä—É–±—ã
        ctx.fillStyle = '#6b5a3a';
        for (let i = 0; i < variant.chimneys; i++) {
            let dx = -15 + i*25;
            ctx.fillRect(x-8+dx, y-130, 10, 40);
        }
        // –î—ã–º
        if (variant.smoke) {
            ctx.fillStyle = 'rgba(255,255,255,0.3)';
            for (let i = 0; i < variant.chimneys; i++) {
                let dx = -15 + i*25;
                ctx.beginPath();
                ctx.arc(x-4+dx, y-150, 14, 0, 2*Math.PI);
                ctx.fill();
            }
        }
        // –û–∫–Ω–∞
        ctx.fillStyle = '#ffb74d';
        for (let i = 0; i < variant.windows; i++) {
            ctx.fillRect(x-25 + i*25, y-70, 10, 12);
        }
    }

    // -------------------- –°–æ—Ü–∏–∞–ª—å–Ω–∞—è —Å—Ñ–µ—Ä–∞ --------------------
    function drawSchool(x, y, variant) {
        drawBase(x, y, variant.baseColor);
        ctx.fillStyle = variant.accentColor;
        ctx.fillRect(x-40, y-75, 80, 55);
        // –û–∫–Ω–∞
        for (let i = 0; i < variant.windows; i++) {
            ctx.fillStyle = '#ffffff';
            ctx.fillRect(x-30 + i*20, y-65, 12, 12);
            ctx.fillRect(x-30 + i*20, y-40, 12, 12);
        }
        // –ö–æ–ª–æ–∫–æ–ª—å—á–∏–∫
        if (variant.hasBell) {
            ctx.fillStyle = '#d4af37';
            ctx.beginPath();
            ctx.arc(x, y-95, 10, 0, 2*Math.PI);
            ctx.fill();
            ctx.fillStyle = '#b8860b';
            ctx.fillRect(x-4, y-105, 8, 12);
        }
    }

    function drawHospital(x, y, variant) {
        drawBase(x, y, variant.baseColor);
        ctx.fillStyle = variant.accentColor;
        ctx.fillRect(x-40, y-80, 80, 60);
        // –ö—Ä–∞—Å–Ω—ã–π –∫—Ä–µ—Å—Ç
        ctx.fillStyle = '#ff4d4d';
        ctx.fillRect(x-10, y-60, 20, 12);
        ctx.fillRect(x-5, y-68, 10, 24);
        // –û–∫–Ω–∞
        for (let i = 0; i < variant.windows; i++) {
            ctx.fillStyle = '#b0e0e6';
            ctx.fillRect(x-30 + i*20, y-55, 12, 12);
            ctx.fillRect(x-30 + i*20, y-30, 12, 12);
        }
    }

    function drawChurch(x, y, variant) {
        drawBase(x, y, variant.baseColor);
        ctx.fillStyle = variant.baseColor;
        ctx.fillRect(x-30, y-75, 60, 50);
        // –ö—Ä—ã—à–∞
        ctx.fillStyle = variant.roofColor;
        ctx.beginPath();
        ctx.moveTo(x-40, y-80);
        ctx.lineTo(x+40, y-80);
        ctx.lineTo(x, y-120);
        ctx.closePath();
        ctx.fill();
        // –ö—Ä–µ—Å—Ç
        if (variant.hasCross) {
            ctx.fillStyle = '#d4af37';
            ctx.fillRect(x-4, y-130, 8, 22);
            ctx.fillRect(x-12, y-142, 24, 6);
        }
    }

    function drawMonument(x, y, variant) {
        drawBase(x, y, variant.baseColor);
        ctx.fillStyle = variant.baseColor;
        ctx.fillRect(x-18, y-80, 36, 50);
        // –°—Ç–∞—Ç—É—è
        if (variant.hasStatue) {
            ctx.fillStyle = '#cfd8dc';
            ctx.beginPath();
            ctx.arc(x, y-100, 12, 0, 2*Math.PI);
            ctx.fill();
        }
    }

    // -------------------- –î–µ–∫–æ—Ä --------------------
    function drawPark(x, y, variant) {
        drawBase(x, y, variant.baseColor);
        // –î–µ—Ä–µ–≤—å—è
        ctx.fillStyle = '#5f9b6b';
        for (let i = 0; i < variant.trees; i++) {
            let dx = -30 + i*20;
            ctx.beginPath();
            ctx.arc(x+dx, y-35 - i*2, 12, 0, 2*Math.PI);
            ctx.fill();
        }
        ctx.fillStyle = '#8b5a2b';
        for (let i = 0; i < variant.trees; i++) {
            let dx = -30 + i*20;
            ctx.fillRect(x-5+dx, y-25, 6, 15);
        }
        // –§–æ–Ω—Ç–∞–Ω
        if (variant.hasFountain) {
            ctx.fillStyle = '#b0e0e6';
            ctx.beginPath();
            ctx.arc(x, y-25, 12, 0, 2*Math.PI);
            ctx.fill();
            ctx.fillStyle = '#fff';
            ctx.font = '24px sans-serif';
            ctx.fillText('‚õ≤', x-10, y-30);
        }
        // –°–∫–∞–º–µ–π–∫–∞
        if (variant.hasBench) {
            ctx.fillStyle = '#8b5a2b';
            ctx.fillRect(x-20, y-20, 40, 6);
            ctx.fillRect(x-10, y-30, 6, 12);
            ctx.fillRect(x+4, y-30, 6, 12);
        }
    }

    function drawRoad(x, y, variant) {
        drawBase(x, y, variant.baseColor, 2);
        // –ê—Å—Ñ–∞–ª—å—Ç
        ctx.fillStyle = '#b0bec5';
        ctx.fillRect(x-45, y-12, 90, 6);
        // –†–∞–∑–º–µ—Ç–∫–∞
        if (variant.hasMarkup) {
            ctx.fillStyle = '#f5f5f5';
            ctx.fillRect(x-40, y-8, 10, 2);
            ctx.fillRect(x-15, y-8, 10, 2);
            ctx.fillRect(x+10, y-8, 10, 2);
            ctx.fillRect(x+35, y-8, 10, 2);
        }
        // –§–æ–Ω–∞—Ä–∏
        if (variant.hasLights) {
            ctx.fillStyle = '#8a9aa8';
            ctx.fillRect(x-30, y-50, 4, 30);
            ctx.fillRect(x+26, y-50, 4, 30);
            ctx.fillStyle = '#ffd966';
            ctx.beginPath();
            ctx.arc(x-28, y-58, 5, 0, 2*Math.PI);
            ctx.fill();
            ctx.beginPath();
            ctx.arc(x+28, y-58, 5, 0, 2*Math.PI);
            ctx.fill();
        }
    }

    // ==================== –û–°–ù–û–í–ù–ê–Ø –û–¢–†–ò–°–û–í–ö–ê ====================
    function drawCity() {
        ctx.clearRect(0, 0, canvas.width, canvas.height);

        // –ù–µ–±–æ —Å –≥—Ä–∞–¥–∏–µ–Ω—Ç–æ–º –∏ –æ–±–ª–∞–∫–∞–º–∏
        const skyGrad = ctx.createLinearGradient(0, 0, 0, canvas.height);
        skyGrad.addColorStop(0, '#0b4b72');
        skyGrad.addColorStop(1, '#1f7aa3');
        ctx.fillStyle = skyGrad;
        ctx.fillRect(0, 0, canvas.width, canvas.height);

        // –°–æ–ª–Ω—Ü–µ
        ctx.shadowBlur = 100;
        ctx.shadowColor = '#fff9c4';
        ctx.beginPath();
        ctx.arc(180, 120, 55, 0, 2*Math.PI);
        ctx.fillStyle = '#fff3b0';
        ctx.fill();

        // –û–±–ª–∞–∫–∞
        ctx.shadowBlur = 80;
        ctx.fillStyle = 'rgba(255,255,255,0.2)';
        ctx.beginPath();
        ctx.ellipse(260, 180, 120, 50, 0, 0, 2*Math.PI);
        ctx.fill();
        ctx.beginPath();
        ctx.ellipse(500, 220, 150, 60, 0, 0, 2*Math.PI);
        ctx.fill();

        ctx.shadowBlur = 0;

        // –í–æ–¥–∞ –≥–ª–∞–¥–∫–∞—è
        ctx.fillStyle = '#1f7a9c';
        ctx.shadowColor = '#0c4b66';
        ctx.shadowBlur = 35;
        ctx.shadowOffsetY = 15;
        for (let r = 0; r < GRID_SIZE; r++) {
            for (let c = 0; c < GRID_SIZE; c++) {
                if (!gameState.land[r][c]) {
                    let p = iso(r, c);
                    ctx.beginPath();
                    ctx.moveTo(p.x, p.y);
                    ctx.lineTo(p.x + CELL_W/2, p.y + CELL_H/2);
                    ctx.lineTo(p.x, p.y + CELL_H);
                    ctx.lineTo(p.x - CELL_W/2, p.y + CELL_H/2);
                    ctx.closePath();
                    ctx.fill();
                }
            }
        }

        // –û—Ç—Ä–∏—Å–æ–≤–∫–∞ —Å—É—à–∏ –∏ –∑–¥–∞–Ω–∏–π
        for (let r = 0; r < GRID_SIZE; r++) {
            for (let c = 0; c < GRID_SIZE; c++) {
                if (gameState.land[r][c]) {
                    let p = iso(r, c);
                    let cellType = gameState.grid[r][c];
                    if (cellType === 'empty') {
                        // –ü—É—Å—Ç–∞—è –∑–µ–º–ª—è —Å —Ç—Ä–∞–≤–æ–π –∏ —Ü–≤–µ—Ç–∞–º–∏
                        ctx.fillStyle = '#7cb57c';
                        ctx.shadowBlur = 35;
                        ctx.shadowOffsetY = 18;
                        ctx.beginPath();
                        ctx.moveTo(p.x, p.y-5);
                        ctx.lineTo(p.x + CELL_W/2, p.y + CELL_H/2-5);
                        ctx.lineTo(p.x, p.y + CELL_H-5);
                        ctx.lineTo(p.x - CELL_W/2, p.y + CELL_H/2-5);
                        ctx.closePath();
                        ctx.fill();
                        ctx.shadowBlur = 0;
                        // –¢—Ä–∞–≤–∏–Ω–∫–∏
                        ctx.fillStyle = '#5f8b5f';
                        for (let i = -25; i <= 25; i+=15) {
                            ctx.fillRect(p.x-5+i, p.y-30, 4, 18);
                        }
                        // –¶–≤–µ—Ç—ã
                        ctx.fillStyle = '#f4a460';
                        ctx.beginPath();
                        ctx.arc(p.x-20, p.y-35, 6, 0, 2*Math.PI);
                        ctx.fill();
                        ctx.fillStyle = '#f0e68c';
                        ctx.beginPath();
                        ctx.arc(p.x+25, p.y-40, 7, 0, 2*Math.PI);
                        ctx.fill();
                    } else {
                        let variantKey = r + '_' + c;
                        let variant = buildingVariants[variantKey];
                        if (!variant) {
                            let buildingDef = BUILDING_DICT[cellType];
                            if (buildingDef) {
                                let pool = BUILDING_VARIANTS[buildingDef.variantPool];
                                if (pool && pool.length) {
                                    variant = pool[Math.floor(Math.random() * pool.length)];
                                    buildingVariants[variantKey] = variant;
                                }
                            }
                        }
                        if (variant) {
                            switch (buildingDef.variantPool) {
                                case 'cottage': drawCottage(p.x, p.y, variant); break;
                                case 'mansion': drawMansion(p.x, p.y, variant); break;
                                case 'apartment': drawApartment(p.x, p.y, variant); break;
                                case 'skyscraper': drawSkyscraper(p.x, p.y, variant); break;
                                case 'shop': drawShop(p.x, p.y, variant); break;
                                case 'office': drawOffice(p.x, p.y, variant); break;
                                case 'bank': drawBank(p.x, p.y, variant); break;
                                case 'hotel': drawHotel(p.x, p.y, variant); break;
                                case 'factory': drawFactory(p.x, p.y, variant); break;
                                case 'powerplant': drawPowerPlant(p.x, p.y, variant); break;
                                case 'school': drawSchool(p.x, p.y, variant); break;
                                case 'hospital': drawHospital(p.x, p.y, variant); break;
                                case 'church': drawChurch(p.x, p.y, variant); break;
                                case 'monument': drawMonument(p.x, p.y, variant); break;
                                case 'park': drawPark(p.x, p.y, variant); break;
                                case 'road': drawRoad(p.x, p.y, variant); break;
                                default: break;
                            }
                        }
                    }
                }
            }
        }

        // –ü–æ–¥—Å–≤–µ—Ç–∫–∞ –≤—ã–±—Ä–∞–Ω–Ω–æ–π –∫–ª–µ—Ç–∫–∏
        if (selectedRow !== -1 && selectedCol !== -1 && gameState.land[selectedRow]?.[selectedCol]) {
            let p = iso(selectedRow, selectedCol);
            ctx.shadowColor = '#ffdf7e';
            ctx.shadowBlur = 70;
            ctx.strokeStyle = '#ffdb7e';
            ctx.lineWidth = 15;
            ctx.beginPath();
            ctx.moveTo(p.x, p.y-35);
            ctx.lineTo(p.x + CELL_W/2, p.y + CELL_H/2-35);
            ctx.lineTo(p.x, p.y + CELL_H-35);
            ctx.lineTo(p.x - CELL_W/2, p.y + CELL_H/2-35);
            ctx.closePath();
            ctx.stroke();
            ctx.shadowBlur = 0;
        }
    }

    // ==================== –í–°–ü–û–ú–û–ì–ê–¢–ï–õ–¨–ù–´–ï –§–£–ù–ö–¶–ò–ò ====================
    function iso(row, col) {
        return {
            x: (col - row) * CELL_W / 2 + ISO_OFFSET_X,
            y: (col + row) * CELL_H / 2 + ISO_OFFSET_Y
        };
    }

    let selectedRow = -1, selectedCol = -1;

    function handleCanvasTap(e) {
        e.preventDefault();
        const rect = canvas.getBoundingClientRect();
        const scaleX = canvas.width / rect.width;
        const scaleY = canvas.height / rect.height;
        let clientX, clientY;
        if (e.touches) {
            clientX = e.touches[0].clientX;
            clientY = e.touches[0].clientY;
        } else {
            clientX = e.clientX;
            clientY = e.clientY;
        }
        const mouseX = (clientX - rect.left) * scaleX;
        const mouseY = (clientY - rect.top) * scaleY;

        let bestDist = 180;
        for (let r = 0; r < GRID_SIZE; r++) {
            for (let c = 0; c < GRID_SIZE; c++) {
                let p = iso(r, c);
                let d = Math.hypot(mouseX - p.x, mouseY - p.y);
                if (d < bestDist) {
                    bestDist = d;
                    selectedRow = r;
                    selectedCol = c;
                }
            }
        }
        if (selectedRow !== -1 && selectedCol !== -1) {
            if (!gameState.land[selectedRow][selectedCol]) {
                document.getElementById('infoPanel').innerText = 'üåä –í–æ–¥–∞. –ú–æ–∂–Ω–æ —Ä–∞—Å—à–∏—Ä–∏—Ç—å –æ—Å—Ç—Ä–æ–≤.';
            } else if (gameState.selectedBuilding) {
                buildAt(selectedRow, selectedCol);
            } else {
                showInfo(selectedRow, selectedCol);
            }
            drawCity();
        }
    }

    function buildAt(row, col) {
        if (!gameState.selectedBuilding) return;
        let buildingDef = BUILDING_DICT[gameState.selectedBuilding];
        if (!buildingDef) return;
        if (gameState.money < buildingDef.basePrice) {
            alert('–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –º–æ–Ω–µ—Ç');
            return;
        }
        if (gameState.grid[row][col] !== 'empty') {
            alert('–ö–ª–µ—Ç–∫–∞ —É–∂–µ –∑–∞–Ω—è—Ç–∞');
            return;
        }
        gameState.money -= buildingDef.basePrice;
        gameState.grid[row][col] = gameState.selectedBuilding;
        gameState.population += buildingDef.basePop;
        // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º —É–Ω–∏–∫–∞–ª—å–Ω—ã–π –≤–∞—Ä–∏–∞–Ω—Ç
        let pool = BUILDING_VARIANTS[buildingDef.variantPool];
        if (pool && pool.length) {
            let variant = pool[Math.floor(Math.random() * pool.length)];
            buildingVariants[row + '_' + col] = variant;
        }
        updateUI();
        drawCity();
        saveGame();
        if (tg) tg.HapticFeedback.impactOccurred('light');
    }

    function showInfo(row, col) {
        let type = gameState.grid[row][col];
        if (type === 'empty') {
            document.getElementById('infoPanel').innerText = 'üå± –ü—É—Å—Ç–æ–π —É—á–∞—Å—Ç–æ–∫. –í—ã–±–µ—Ä–∏—Ç–µ –∑–¥–∞–Ω–∏–µ.';
        } else {
            let def = BUILDING_DICT[type];
            document.getElementById('infoPanel').innerText = `${def.name} | –¥–æ—Ö–æ–¥: ${def.baseIncome}üí∞ | –∂–∏—Ç–µ–ª–∏: +${def.basePop}`;
        }
    }

    // ==================== –°–ë–û–† –ù–ê–õ–û–ì–û–í ====================
    function collectTaxes() {
        let now = Date.now();
        if (now - gameState.lastTaxTime < gameState.taxCooldown) return;

        let total = 0;
        for (let r = 0; r < GRID_SIZE; r++) {
            for (let c = 0; c < GRID_SIZE; c++) {
                if (gameState.land[r][c] && gameState.grid[r][c] !== 'empty') {
                    let def = BUILDING_DICT[gameState.grid[r][c]];
                    if (def) total += def.baseIncome;
                }
            }
        }
        gameState.money += total;
        gameState.lastTaxTime = now;
        updateUI();
        saveGame();
        document.getElementById('infoPanel').innerText = `üí∞ –°–æ–±—Ä–∞–Ω–æ ${total} –º–æ–Ω–µ—Ç!`;
        startCooldown();
        if (tg) tg.HapticFeedback.notificationOccurred('success');
    }

    function startCooldown() {
        let btn = document.getElementById('collectBtn');
        let bar = document.getElementById('cooldownBar');
        let start = Date.now();
        let end = start + gameState.taxCooldown;
        btn.disabled = true;
        let interval = setInterval(() => {
            let now = Date.now();
            let remaining = end - now;
            if (remaining <= 0) {
                btn.disabled = false;
                bar.style.width = '0%';
                clearInterval(interval);
                return;
            }
            let percent = ((gameState.taxCooldown - remaining) / gameState.taxCooldown) * 100;
            bar.style.width = percent + '%';
        }, 50);
    }

    // ==================== –†–ê–°–®–ò–†–ï–ù–ò–ï –û–°–¢–†–û–í–ê ====================
    function expandIsland() {
        if (gameState.money < gameState.expandCost) {
            alert('–ù–µ —Ö–≤–∞—Ç–∞–µ—Ç –º–æ–Ω–µ—Ç');
            return;
        }
        let candidates = [];
        for (let r = 0; r < GRID_SIZE; r++) {
            for (let c = 0; c < GRID_SIZE; c++) {
                if (!gameState.land[r][c]) {
                    let neighbors = [[-1,0],[1,0],[0,-1],[0,1]];
                    for (let [dr, dc] of neighbors) {
                        let nr = r+dr, nc = c+dc;
                        if (nr>=0 && nr<GRID_SIZE && nc>=0 && nc<GRID_SIZE && gameState.land[nr][nc]) {
                            candidates.push([r,c]);
                            break;
                        }
                    }
                }
            }
        }
        if (candidates.length === 0) {
            alert('–ù–µ—Ç –¥–æ—Å—Ç—É–ø–Ω–æ–π –≤–æ–¥—ã –¥–ª—è —Ä–∞—Å—à–∏—Ä–µ–Ω–∏—è');
            return;
        }
        let [rr, cc] = candidates[Math.floor(Math.random() * candidates.length)];
        gameState.money -= gameState.expandCost;
        gameState.land[rr][cc] = true;
        gameState.grid[rr][cc] = 'empty';
        updateUI();
        drawCity();
        saveGame();
        document.getElementById('infoPanel').innerText = 'üåä‚û°Ô∏èüèùÔ∏è –ù–æ–≤–∞—è –∑–µ–º–ª—è!';
    }

    // ==================== –û–ë–ù–û–í–õ–ï–ù–ò–ï –ò–ù–¢–ï–†–§–ï–ô–°–ê ====================
    function updateUI() {
        document.getElementById('moneyDisplay').innerText = gameState.money;
        document.getElementById('popDisplay').innerText = gameState.population;
        let totalIncome = 0;
        for (let r = 0; r < GRID_SIZE; r++) {
            for (let c = 0; c < GRID_SIZE; c++) {
                if (gameState.land[r][c] && gameState.grid[r][c] !== 'empty') {
                    let def = BUILDING_DICT[gameState.grid[r][c]];
                    if (def) totalIncome += def.baseIncome;
                }
            }
        }
        document.getElementById('incomeDisplay').innerText = totalIncome;
        let landCount = 0;
        for (let r = 0; r < GRID_SIZE; r++) {
            for (let c = 0; c < GRID_SIZE; c++) {
                if (gameState.land[r][c]) landCount++;
            }
        }
        document.getElementById('landDisplay').innerText = landCount;
    }

    // ==================== –ü–û–°–¢–†–û–ï–ù–ò–ï –ü–ê–ù–ï–õ–ò –í–´–ë–û–†–ê ====================
    function renderBuildings(category) {
        const track = document.getElementById('buildingsTrack');
        track.innerHTML = '';
        let filtered = BUILDINGS_CATALOG.filter(b => b.category === category);
        filtered.forEach(b => {
            let card = document.createElement('div');
            card.className = 'build-card';
            card.dataset.type = b.id;
            let emoji = 'üè†';
            if (b.variantPool === 'apartment') emoji = 'üè¢';
            else if (b.variantPool === 'skyscraper') emoji = 'üèôÔ∏è';
            else if (b.variantPool === 'shop') emoji = 'üè™';
            else if (b.variantPool === 'office') emoji = 'üèõÔ∏è';
            else if (b.variantPool === 'bank') emoji = 'üí∞';
            else if (b.variantPool === 'hotel') emoji = 'üè®';
            else if (b.variantPool === 'factory') emoji = 'üè≠';
            else if (b.variantPool === 'powerplant') emoji = '‚ö°';
            else if (b.variantPool === 'school') emoji = 'üìö';
            else if (b.variantPool === 'hospital') emoji = 'üè•';
            else if (b.variantPool === 'church') emoji = '‚õ™';
            else if (b.variantPool === 'monument') emoji = 'üóΩ';
            else if (b.variantPool === 'park') emoji = 'üå≥';
            else if (b.variantPool === 'road') emoji = 'üõ£Ô∏è';
            card.innerHTML = `
                <div class="card-icon">${emoji}</div>
                <div class="card-name">${b.name}</div>
                <div class="card-price">${b.basePrice}üí∞</div>
            `;
            card.addEventListener('click', () => {
                document.querySelectorAll('.build-card').forEach(c => c.classList.remove('selected'));
                card.classList.add('selected');
                gameState.selectedBuilding = b.id;
                document.getElementById('infoPanel').innerText = `–í—ã–±—Ä–∞–Ω–æ: ${b.name}`;
            });
            track.appendChild(card);
        });
    }

    // ==================== –°–û–•–†–ê–ù–ï–ù–ò–ï/–ó–ê–ì–†–£–ó–ö–ê ====================
    function saveGame() {
        if (tg) {
            tg.sendData(JSON.stringify({
                money: gameState.money,
                grid: gameState.grid,
                land: gameState.land,
                population: gameState.population,
                variants: buildingVariants
            }));
        }
        localStorage.setItem('archipelagoUltra', JSON.stringify({
            money: gameState.money,
            grid: gameState.grid,
            land: gameState.land,
            population: gameState.population,
            variants: buildingVariants
        }));
    }

    function loadGame() {
        let saved = localStorage.getItem('archipelagoUltra');
        if (saved) {
            try {
                let data = JSON.parse(saved);
                gameState.money = data.money || 50000;
                gameState.grid = data.grid || gameState.grid;
                gameState.land = data.land || gameState.land;
                gameState.population = data.population || 0;
                buildingVariants = data.variants || {};
            } catch(e) {}
        }
        updateUI();
        drawCity();
    }

    // ==================== –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø ====================
    const canvas = document.getElementById('gameCanvas');
    canvas.addEventListener('click', handleCanvasTap);
    canvas.addEventListener('touchstart', handleCanvasTap, {passive: false});

    // –ö–∞—Ç–µ–≥–æ—Ä–∏–∏
    document.getElementById('catRes').addEventListener('click', () => {
        document.querySelectorAll('.cat-btn').forEach(t => t.classList.remove('active'));
        document.getElementById('catRes').classList.add('active');
        renderBuildings('residential');
    });
    document.getElementById('catCom').addEventListener('click', () => {
        document.querySelectorAll('.cat-btn').forEach(t => t.classList.remove('active'));
        document.getElementById('catCom').classList.add('active');
        renderBuildings('commercial');
    });
    document.getElementById('catInd').addEventListener('click', () => {
        document.querySelectorAll('.cat-btn').forEach(t => t.classList.remove('active'));
        document.getElementById('catInd').classList.add('active');
        renderBuildings('industrial');
    });
    document.getElementById('catInf').addEventListener('click', () => {
        document.querySelectorAll('.cat-btn').forEach(t => t.classList.remove('active'));
        document.getElementById('catInf').classList.add('active');
        renderBuildings('infrastructure');
    });
    document.getElementById('catDec').addEventListener('click', () => {
        document.querySelectorAll('.cat-btn').forEach(t => t.classList.remove('active'));
        document.getElementById('catDec').classList.add('active');
        renderBuildings('decor');
    });

    // –ö–Ω–æ–ø–∫–∏
    document.getElementById('collectBtn').addEventListener('click', collectTaxes);
    document.getElementById('expandBtn').addEventListener('click', expandIsland);
    document.getElementById('cancelBtn').addEventListener('click', () => {
        gameState.selectedBuilding = null;
        document.querySelectorAll('.build-card').forEach(c => c.classList.remove('selected'));
        document.getElementById('infoPanel').innerText = '–í—ã–±–æ—Ä –æ—Ç–º–µ–Ω—ë–Ω';
    });

    // –ó–∞–ø—É—Å–∫
    renderBuildings('residential');
    loadGame();

    // –ê–≤—Ç–æ—Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∏ –∞–Ω–∏–º–∞—Ü–∏—è
    setInterval(() => {
        drawCity();
        saveGame();
    }, 100);
})();
</script>
</body>
</html>
