<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>–ú–µ–≥–∞–ø–æ–ª–∏—Å –Ω–∞ –æ—Å—Ç—Ä–æ–≤–µ</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Roboto, system-ui, sans-serif;
        }
        body {
            background: #0b2b44;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            padding: 8px;
        }
        .game-container {
            width: 100%;
            max-width: 500px; /* –¥–ª—è –º–æ–±–∏–ª—å–Ω–æ–≥–æ */
            background: linear-gradient(145deg, #1d4e6f, #12344d);
            border-radius: 40px;
            padding: 16px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.6), inset 0 2px 4px rgba(255,255,255,0.1);
            border: 1px solid #3d7ea3;
        }
        /* –í–µ—Ä—Ö–Ω—è—è –ø–∞–Ω–µ–ª—å */
        .stats-bar {
            background: rgba(0, 20, 30, 0.7);
            backdrop-filter: blur(10px);
            border-radius: 50px;
            padding: 12px 18px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            color: white;
            margin-bottom: 16px;
            border: 1px solid #5f9ea0;
        }
        .stat-item {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 18px;
            font-weight: 500;
        }
        .stat-icon {
            font-size: 24px;
        }
        /* –ö–∞—Ä—Ç–∞ */
        .canvas-wrapper {
            background: #1f6680;
            border-radius: 40px;
            padding: 15px;
            display: flex;
            justify-content: center;
            box-shadow: inset 0 -10px 20px #0a2a3a;
            margin-bottom: 16px;
            touch-action: none; /* –¥–ª—è canvas */
        }
        #cityCanvas {
            width: 100%;
            height: auto;
            border-radius: 30px;
            background: #317499;
            cursor: pointer;
            image-rendering: crisp-edges;
            touch-action: none;
            max-width: 460px;
        }
        /* –ü–∞–Ω–µ–ª—å —Å—Ç—Ä–æ–∏—Ç–µ–ª—å—Å—Ç–≤–∞ (–≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω—ã–π —Å–∫—Ä–æ–ª–ª) */
        .build-panel {
            background: rgba(255, 255, 255, 0.85);
            backdrop-filter: blur(10px);
            border-radius: 50px;
            padding: 12px;
            margin-bottom: 16px;
            overflow-x: auto;
            white-space: nowrap;
            -webkit-overflow-scrolling: touch;
            scrollbar-width: none;
            border: 1px solid white;
        }
        .build-panel::-webkit-scrollbar {
            display: none;
        }
        .buildings-scroll {
            display: inline-flex;
            gap: 12px;
            padding: 4px;
        }
        .building-card {
            background: linear-gradient(145deg, #f5f0dc, #e0d7b7);
            border-radius: 30px;
            padding: 12px 16px;
            display: inline-flex;
            flex-direction: column;
            align-items: center;
            min-width: 100px;
            box-shadow: 0 6px 0 #a89b7a, 0 8px 15px rgba(0,0,0,0.2);
            border: 2px solid #fff9e6;
            transition: 0.1s;
            touch-action: manipulation;
        }
        .building-card.selected {
            transform: translateY(-3px);
            border-color: #ffb347;
            box-shadow: 0 8px 0 #b88b3a, 0 12px 20px rgba(0,0,0,0.25);
        }
        .building-card:active {
            transform: translateY(4px);
            box-shadow: 0 2px 0 #a89b7a;
        }
        .building-emoji {
            font-size: 36px;
            filter: drop-shadow(2px 6px 6px rgba(0,0,0,0.3));
        }
        .building-name {
            font-weight: bold;
            font-size: 14px;
            color: #2b4b3a;
        }
        .building-price {
            font-size: 13px;
            background: #d4c39a;
            padding: 4px 10px;
            border-radius: 30px;
            margin-top: 5px;
            font-weight: 600;
        }
        /* –ù–∏–∂–Ω—è—è –ø–∞–Ω–µ–ª—å –¥–µ–π—Å—Ç–≤–∏–π */
        .action-bar {
            display: flex;
            gap: 12px;
            justify-content: center;
            flex-wrap: wrap;
        }
        .action-btn {
            flex: 1 1 auto;
            min-width: 140px;
            background: linear-gradient(145deg, #3f7e9c, #1f5575);
            border: none;
            border-radius: 60px;
            padding: 16px 20px;
            color: white;
            font-size: 20px;
            font-weight: bold;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            box-shadow: 0 7px 0 #0f3a55, 0 10px 20px rgba(0,0,0,0.3);
            border: 1px solid #7ab3cc;
            touch-action: manipulation;
        }
        .action-btn:active {
            transform: translateY(5px);
            box-shadow: 0 2px 0 #0f3a55;
        }
        .action-btn:disabled {
            opacity: 0.5;
            transform: none;
            pointer-events: none;
        }
        .info-panel {
            background: #dcedf5;
            border-radius: 40px;
            padding: 15px;
            margin-top: 16px;
            color: #103a50;
            border: 2px solid white;
            font-size: 15px;
        }
    </style>
</head>
<body>
<div class="game-container">
    <!-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ -->
    <div class="stats-bar">
        <div class="stat-item"><span class="stat-icon">ü™ô</span> <span id="moneyDisplay">5000</span></div>
        <div class="stat-item"><span class="stat-icon">üë•</span> <span id="populationDisplay">0</span></div>
        <div class="stat-item"><span class="stat-icon">üìà</span> <span id="incomeDisplay">0</span></div>
        <div class="stat-item"><span class="stat-icon">üèùÔ∏è</span> <span id="landDisplay">16</span></div>
    </div>

    <!-- Canvas —Å –æ—Å—Ç—Ä–æ–≤–æ–º -->
    <div class="canvas-wrapper">
        <canvas id="cityCanvas" width="600" height="500"></canvas>
    </div>

    <!-- –ü–∞–Ω–µ–ª—å –≤—ã–±–æ—Ä–∞ –ø–æ—Å—Ç—Ä–æ–µ–∫ (–≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω–∞—è) -->
    <div class="build-panel" id="buildPanel">
        <div class="buildings-scroll" id="buildingsScroll">
            <!-- –±—É–¥—É—Ç –¥–æ–±–∞–≤–ª–µ–Ω—ã —á–µ—Ä–µ–∑ js -->
        </div>
    </div>

    <!-- –ö–Ω–æ–ø–∫–∏ –¥–µ–π—Å—Ç–≤–∏–π -->
    <div class="action-bar">
        <button class="action-btn" id="collectBtn"><span>üí∞</span> –°–æ–±—Ä–∞—Ç—å –Ω–∞–ª–æ–≥–∏</button>
        <button class="action-btn" id="expandBtn"><span>üåä‚û°Ô∏èüèùÔ∏è</span> –†–∞—Å—à–∏—Ä–∏—Ç—å (500ü™ô)</button>
        <button class="action-btn" id="cancelBtn"><span>‚ùå</span> –û—Ç–º–µ–Ω–∞</button>
    </div>

    <!-- –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏–æ–Ω–Ω–∞—è –ø–∞–Ω–µ–ª—å -->
    <div class="info-panel" id="infoPanel">
        üëÜ –ù–∞–∂–º–∏ –Ω–∞ –∫–ª–µ—Ç–∫—É, –≤—ã–±–µ—Ä–∏ –∑–¥–∞–Ω–∏–µ –∏ —Å—Ç—Ä–æ–π!
    </div>
</div>

<script src="https://telegram.org/js/telegram-web-app.js"></script>
<script>
    (function() {
        // --- Telegram ---
        let tg = null;
        try {
            if (window.Telegram && Telegram.WebApp) {
                tg = Telegram.WebApp;
                tg.expand();
                tg.ready();
            }
        } catch(e) {}

        // --- –†–∞–∑–º–µ—Ä—ã –∫–∞—Ä—Ç—ã –∏ –∏–∑–æ–º–µ—Ç—Ä–∏—è ---
        const GRID_SIZE = 8; // 8x8 (–ø–æ—Å–ª–µ —Ä–∞—Å—à–∏—Ä–µ–Ω–∏—è –º–æ–∂–µ—Ç —Å—Ç–∞—Ç—å –±–æ–ª—å—à–µ, –Ω–æ –Ω–∞—á–Ω—ë–º —Å 8)
        const CELL_W = 70;    // —à–∏—Ä–∏–Ω–∞ –æ—Å–Ω–æ–≤–∞–Ω–∏—è —Ç–∞–π–ª–∞
        const CELL_H = 40;    // –≤—ã—Å–æ—Ç–∞
        const ISO_OFFSET_X = 280; // —Ü–µ–Ω—Ç—Ä–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–∞ canvas 600x500
        const ISO_OFFSET_Y = 70;

        // –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –∑–¥–∞–Ω–∏–π (–¥–µ—Ç–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ)
        const BUILDINGS = {
            empty: { name: '–ü—É—Å—Ç–æ', emoji: 'üåø', color: '#7cb57c', price: 0, income: 0, population: 0, level: 0, reqLand: true, draw: drawEmpty },
            house1: { name: '–î–æ–º–∏–∫', emoji: 'üè†', color: '#f9d79f', price: 120, income: 8, population: 4, level: 1, reqLand: true, draw: drawHouse1 },
            house2: { name: '–ö–æ—Ç—Ç–µ–¥–∂', emoji: 'üè°', color: '#f0c48b', price: 300, income: 20, population: 10, level: 2, reqLand: true, draw: drawHouse2 },
            house3: { name: '–ú–Ω–æ–≥–æ—ç—Ç–∞–∂–∫–∞', emoji: 'üè¢', color: '#b0bec5', price: 800, income: 55, population: 30, level: 3, reqLand: true, draw: drawAppartment },
            skyscraper: { name: '–ù–µ–±–æ—Å–∫—Ä—ë–±', emoji: 'üèôÔ∏è', color: '#607d8b', price: 2000, income: 150, population: 80, level: 4, reqLand: true, draw: drawSkyscraper },
            shop: { name: '–ú–∞–≥–∞–∑–∏–Ω', emoji: 'üè™', color: '#ffb74d', price: 250, income: 30, population: 2, level: 1, reqLand: true, draw: drawShop },
            office: { name: '–û—Ñ–∏—Å', emoji: 'üèõÔ∏è', color: '#9e9e9e', price: 600, income: 70, population: 5, level: 2, reqLand: true, draw: drawOffice },
            school: { name: '–®–∫–æ–ª–∞', emoji: 'üè´', color: '#ff8a80', price: 1000, income: 25, population: 0, reqLand: true, draw: drawSchool },
            hospital: { name: '–ë–æ–ª—å–Ω–∏—Ü–∞', emoji: 'üè•', color: '#ef9a9a', price: 1500, income: 40, population: 0, reqLand: true, draw: drawHospital },
            park: { name: '–ü–∞—Ä–∫', emoji: 'üå≥', color: '#81c784', price: 180, income: 12, population: 1, level: 1, reqLand: true, draw: drawPark },
            road: { name: '–î–æ—Ä–æ–≥–∞', emoji: 'üõ£Ô∏è', color: '#b0bec5', price: 50, income: 2, population: 0, level: 0, reqLand: true, draw: drawRoad },
            powerplant: { name: '–≠–ª–µ–∫—Ç—Ä–æ', emoji: '‚ö°', color: '#ffb74d', price: 2500, income: 200, population: 0, reqLand: true, draw: drawPower }
        };

        // –°–æ—Å—Ç–æ—è–Ω–∏–µ –∏–≥—Ä—ã
        let gameState = {
            balance: 5000,
            grid: [],            // —Ç–∏–ø –∑–¥–∞–Ω–∏—è (string) –¥–ª—è –∫–∞–∂–¥–æ–π –∫–ª–µ—Ç–∫–∏
            land: [],            // true - –∑–µ–º–ª—è, false - –≤–æ–¥–∞
            population: 0,
            lastTaxTime: Date.now(),
            taxCooldown: 30000,  // 30 —Å–µ–∫—É–Ω–¥
            taxEnabled: true,
            selectedBuilding: null,
            expandCost: 500,
            gridSize: GRID_SIZE,
        };

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è: —Ü–µ–Ω—Ç—Ä–∞–ª—å–Ω—ã–π –æ—Å—Ç—Ä–æ–≤ 4x4
        function initGrid() {
            for (let r = 0; r < gameState.gridSize; r++) {
                gameState.grid[r] = [];
                gameState.land[r] = [];
                for (let c = 0; c < gameState.gridSize; c++) {
                    // –æ—Å—Ç—Ä–æ–≤ –≤ —Ü–µ–Ω—Ç—Ä–µ (–æ—Ç 2 –¥–æ 5)
                    if (r >= 2 && r <= 5 && c >= 2 && c <= 5) {
                        gameState.land[r][c] = true;
                        gameState.grid[r][c] = 'empty';
                    } else {
                        gameState.land[r][c] = false;
                        gameState.grid[r][c] = 'empty';
                    }
                }
            }
        }
        initGrid();

        // –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏
        function gridToIso(row, col) {
            const x = (col - row) * CELL_W / 2 + ISO_OFFSET_X;
            const y = (col + row) * CELL_H / 2 + ISO_OFFSET_Y;
            return { x, y };
        }

        // –û—Ç—Ä–∏—Å–æ–≤–∫–∞ canvas
        const canvas = document.getElementById('cityCanvas');
        const ctx = canvas.getContext('2d');

        // –§—É–Ω–∫—Ü–∏–∏ —Ä–∏—Å–æ–≤–∞–Ω–∏—è –∫–∞–∂–¥–æ–≥–æ —Ç–∏–ø–∞ –∑–¥–∞–Ω–∏—è
        function drawEmpty(x, y, cellType) {
            // —Ä–∏—Å—É–µ–º —Ç—Ä–∞–≤—É/–∑–µ–º–ª—é
            ctx.fillStyle = '#7cb57c';
            ctx.beginPath();
            ctx.moveTo(x, y);
            ctx.lineTo(x + CELL_W/2, y + CELL_H/2);
            ctx.lineTo(x, y + CELL_H);
            ctx.lineTo(x - CELL_W/2, y + CELL_H/2);
            ctx.closePath();
            ctx.fill();
            ctx.strokeStyle = '#5f9b6b';
            ctx.lineWidth = 1;
            ctx.stroke();
            // —Ç—Ä–∞–≤–∏–Ω–∫–∏
            ctx.fillStyle = '#5f8b5f';
            ctx.font = '16px sans-serif';
            ctx.fillText('üåø', x-8, y-5);
        }

        function drawHouse1(x, y) {
            // –¥–æ–º–∏–∫: –æ—Å–Ω–æ–≤–∞–Ω–∏–µ
            ctx.fillStyle = '#f9d79f';
            ctx.beginPath();
            ctx.moveTo(x, y-10);
            ctx.lineTo(x + CELL_W/2, y + CELL_H/2-10);
            ctx.lineTo(x, y + CELL_H-10);
            ctx.lineTo(x - CELL_W/2, y + CELL_H/2-10);
            ctx.closePath();
            ctx.fill();
            ctx.fillStyle = '#c49a6c';
            ctx.fillRect(x-12, y-18, 24, 12); // –∫—Ä—ã—à–∞
            ctx.fillStyle = '#8b5a2b';
            ctx.fillRect(x-8, y-8, 16, 18); // —Å—Ç–µ–Ω–∞
            ctx.fillStyle = '#f5f0dc';
            ctx.fillRect(x-4, y-4, 8, 8); // –æ–∫–Ω–æ
        }

        function drawHouse2(x, y) {
            ctx.fillStyle = '#f0c48b';
            ctx.beginPath();
            ctx.moveTo(x, y-15);
            ctx.lineTo(x + CELL_W/2, y + CELL_H/2-15);
            ctx.lineTo(x, y + CELL_H-15);
            ctx.lineTo(x - CELL_W/2, y + CELL_H/2-15);
            ctx.closePath();
            ctx.fill();
            // –¥–≤—É—Ö—ç—Ç–∞–∂–Ω—ã–π
            ctx.fillStyle = '#b87c4b';
            ctx.fillRect(x-16, y-28, 32, 10);
            ctx.fillRect(x-14, y-20, 28, 25);
            for (let i = -8; i <= 8; i+=10) {
                ctx.fillStyle = '#f5f0dc';
                ctx.fillRect(x-4+i, y-12, 6, 8);
            }
        }

        function drawAppartment(x, y) {
            ctx.fillStyle = '#b0bec5';
            ctx.beginPath();
            ctx.moveTo(x, y-20);
            ctx.lineTo(x + CELL_W/2, y + CELL_H/2-20);
            ctx.lineTo(x, y + CELL_H-20);
            ctx.lineTo(x - CELL_W/2, y + CELL_H/2-20);
            ctx.closePath();
            ctx.fill();
            ctx.fillStyle = '#90a4ae';
            ctx.fillRect(x-20, y-40, 40, 30);
            for (let i = -12; i <= 12; i+=12) {
                ctx.fillStyle = '#cfd8dc';
                ctx.fillRect(x-6+i, y-32, 8, 10);
            }
        }

        function drawSkyscraper(x, y) {
            ctx.fillStyle = '#607d8b';
            ctx.beginPath();
            ctx.moveTo(x, y-30);
            ctx.lineTo(x + CELL_W/2, y + CELL_H/2-30);
            ctx.lineTo(x, y + CELL_H-30);
            ctx.lineTo(x - CELL_W/2, y + CELL_H/2-30);
            ctx.closePath();
            ctx.fill();
            ctx.fillStyle = '#455a64';
            ctx.fillRect(x-18, y-60, 36, 50);
            for (let i = -12; i <= 12; i+=12) {
                ctx.fillStyle = '#b0bec5';
                ctx.fillRect(x-6+i, y-50, 8, 12);
                ctx.fillRect(x-6+i, y-30, 8, 12);
            }
        }

        function drawShop(x, y) {
            ctx.fillStyle = '#ffb74d';
            ctx.beginPath();
            ctx.moveTo(x, y-12);
            ctx.lineTo(x + CELL_W/2, y + CELL_H/2-12);
            ctx.lineTo(x, y + CELL_H-12);
            ctx.lineTo(x - CELL_W/2, y + CELL_H/2-12);
            ctx.closePath();
            ctx.fill();
            ctx.fillStyle = '#ff9800';
            ctx.fillRect(x-14, y-22, 28, 20);
            ctx.fillStyle = '#fff';
            ctx.font = '18px sans-serif';
            ctx.fillText('üõí', x-10, y-8);
        }

        function drawOffice(x, y) {
            ctx.fillStyle = '#9e9e9e';
            ctx.beginPath();
            ctx.moveTo(x, y-18);
            ctx.lineTo(x + CELL_W/2, y + CELL_H/2-18);
            ctx.lineTo(x, y + CELL_H-18);
            ctx.lineTo(x - CELL_W/2, y + CELL_H/2-18);
            ctx.closePath();
            ctx.fill();
            ctx.fillStyle = '#757575';
            ctx.fillRect(x-18, y-38, 36, 28);
            for (let i = -8; i <= 8; i+=8) {
                ctx.fillStyle = '#cfd8dc';
                ctx.fillRect(x-6+i, y-30, 8, 10);
            }
        }

        function drawSchool(x, y) {
            ctx.fillStyle = '#ff8a80';
            ctx.beginPath();
            ctx.moveTo(x, y-18);
            ctx.lineTo(x + CELL_W/2, y + CELL_H/2-18);
            ctx.lineTo(x, y + CELL_H-18);
            ctx.lineTo(x - CELL_W/2, y + CELL_H/2-18);
            ctx.closePath();
            ctx.fill();
            ctx.fillStyle = '#f06292';
            ctx.fillRect(x-18, y-36, 36, 28);
            ctx.fillStyle = '#fff';
            ctx.font = '20px sans-serif';
            ctx.fillText('üìö', x-12, y-16);
        }

        function drawHospital(x, y) {
            ctx.fillStyle = '#ef9a9a';
            ctx.beginPath();
            ctx.moveTo(x, y-18);
            ctx.lineTo(x + CELL_W/2, y + CELL_H/2-18);
            ctx.lineTo(x, y + CELL_H-18);
            ctx.lineTo(x - CELL_W/2, y + CELL_H/2-18);
            ctx.closePath();
            ctx.fill();
            ctx.fillStyle = '#e57373';
            ctx.fillRect(x-16, y-36, 32, 28);
            ctx.fillStyle = '#fff';
            ctx.font = '22px sans-serif';
            ctx.fillText('üè•', x-14, y-16);
        }

        function drawPark(x, y) {
            ctx.fillStyle = '#81c784';
            ctx.beginPath();
            ctx.moveTo(x, y-10);
            ctx.lineTo(x + CELL_W/2, y + CELL_H/2-10);
            ctx.lineTo(x, y + CELL_H-10);
            ctx.lineTo(x - CELL_W/2, y + CELL_H/2-10);
            ctx.closePath();
            ctx.fill();
            ctx.fillStyle = '#5f9b6b';
            ctx.font = '24px sans-serif';
            ctx.fillText('üå≥', x-16, y-14);
        }

        function drawRoad(x, y) {
            ctx.fillStyle = '#b0bec5';
            ctx.beginPath();
            ctx.moveTo(x, y-5);
            ctx.lineTo(x + CELL_W/2, y + CELL_H/2-5);
            ctx.lineTo(x, y + CELL_H-5);
            ctx.lineTo(x - CELL_W/2, y + CELL_H/2-5);
            ctx.closePath();
            ctx.fill();
            ctx.fillStyle = '#90a4ae';
            ctx.fillRect(x-20, y-8, 40, 8);
            ctx.fillRect(x-8, y-20, 8, 30);
        }

        function drawPower(x, y) {
            ctx.fillStyle = '#ffb74d';
            ctx.beginPath();
            ctx.moveTo(x, y-25);
            ctx.lineTo(x + CELL_W/2, y + CELL_H/2-25);
            ctx.lineTo(x, y + CELL_H-25);
            ctx.lineTo(x - CELL_W/2, y + CELL_H/2-25);
            ctx.closePath();
            ctx.fill();
            ctx.fillStyle = '#ff9800';
            ctx.fillRect(x-12, y-45, 24, 35);
            ctx.fillStyle = '#ffeb3b';
            ctx.font = '22px sans-serif';
            ctx.fillText('‚ö°', x-10, y-20);
        }

        // –û—Å–Ω–æ–≤–Ω–∞—è –æ—Ç—Ä–∏—Å–æ–≤–∫–∞
        function drawCity() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            // —Ä–∏—Å—É–µ–º –º–æ—Ä–µ —Ñ–æ–Ω–æ–º
            ctx.fillStyle = '#2a7a9c';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            // –≤–æ–ª–Ω—ã
            ctx.fillStyle = '#3d8fb0';
            for (let i=0; i<10; i++) {
                ctx.beginPath();
                ctx.arc(100+i*60, 400+Math.sin(i)*10, 30, 0, Math.PI*2);
                ctx.fillStyle = '#4fa3c4';
                ctx.globalAlpha = 0.3;
                ctx.fill();
            }
            ctx.globalAlpha = 1;

            // –ø—Ä–æ—Ö–æ–¥–∏–º –≤—Å–µ –∫–ª–µ—Ç–∫–∏
            for (let r = 0; r < gameState.gridSize; r++) {
                for (let c = 0; c < gameState.gridSize; c++) {
                    const iso = gridToIso(r, c);
                    if (!gameState.land[r][c]) {
                        // –≤–æ–¥–∞
                        ctx.fillStyle = '#1f6a8c';
                        ctx.beginPath();
                        ctx.moveTo(iso.x, iso.y);
                        ctx.lineTo(iso.x + CELL_W/2, iso.y + CELL_H/2);
                        ctx.lineTo(iso.x, iso.y + CELL_H);
                        ctx.lineTo(iso.x - CELL_W/2, iso.y + CELL_H/2);
                        ctx.closePath();
                        ctx.fill();
                        ctx.strokeStyle = '#4797b5';
                        ctx.stroke();
                        continue;
                    }
                    const type = gameState.grid[r][c];
                    const building = BUILDINGS[type] || BUILDINGS.empty;
                    if (building.draw) {
                        building.draw(iso.x, iso.y, type);
                    } else {
                        drawEmpty(iso.x, iso.y);
                    }
                }
            }

            // –ø–æ–¥—Å–≤–µ—Ç–∫–∞ –≤—ã–±—Ä–∞–Ω–Ω–æ–π –∫–ª–µ—Ç–∫–∏
            if (selectedRow !== -1 && selectedCol !== -1 && gameState.land[selectedRow] && gameState.land[selectedRow][selectedCol]) {
                const iso = gridToIso(selectedRow, selectedCol);
                ctx.strokeStyle = '#ffd966';
                ctx.lineWidth = 4;
                ctx.beginPath();
                ctx.moveTo(iso.x, iso.y-10);
                ctx.lineTo(iso.x + CELL_W/2, iso.y + CELL_H/2-10);
                ctx.lineTo(iso.x, iso.y + CELL_H-10);
                ctx.lineTo(iso.x - CELL_W/2, iso.y + CELL_H/2-10);
                ctx.closePath();
                ctx.stroke();
            }
        }

        // --- –õ–æ–≥–∏–∫–∞ –≤—ã–±–æ—Ä–∞ –∫–ª–µ—Ç–∫–∏ ---
        let selectedRow = -1, selectedCol = -1;

        canvas.addEventListener('click', handleCanvasClick);
        canvas.addEventListener('touchstart', handleCanvasClick, {passive: false});

        function handleCanvasClick(e) {
            e.preventDefault();
            const rect = canvas.getBoundingClientRect();
            const scaleX = canvas.width / rect.width;
            const scaleY = canvas.height / rect.height;

            let clientX, clientY;
            if (e.touches) {
                clientX = e.touches[0].clientX;
                clientY = e.touches[0].clientY;
            } else {
                clientX = e.clientX;
                clientY = e.clientY;
            }

            const mouseX = (clientX - rect.left) * scaleX;
            const mouseY = (clientY - rect.top) * scaleY;

            // –ø–æ–∏—Å–∫ –±–ª–∏–∂–∞–π—à–µ–π –∫–ª–µ—Ç–∫–∏
            let minDist = 80;
            for (let r=0; r<gameState.gridSize; r++) {
                for (let c=0; c<gameState.gridSize; c++) {
                    const iso = gridToIso(r, c);
                    const dx = mouseX - iso.x;
                    const dy = mouseY - iso.y;
                    const dist = Math.sqrt(dx*dx + dy*dy);
                    if (dist < minDist) {
                        minDist = dist;
                        selectedRow = r;
                        selectedCol = c;
                    }
                }
            }

            if (selectedRow !== -1 && selectedCol !== -1) {
                if (!gameState.land[selectedRow][selectedCol]) {
                    document.getElementById('infoPanel').innerText = 'üåä –≠—Ç–æ –≤–æ–¥–∞. –ö—É–ø–∏ –∑–µ–º–ª—é!';
                } else if (gameState.selectedBuilding) {
                    buildAt(selectedRow, selectedCol);
                } else {
                    showCellInfo(selectedRow, selectedCol);
                }
                drawCity();
            }
        }

        function buildAt(row, col) {
            if (!gameState.selectedBuilding) return;
            if (!gameState.land[row][col]) {
                alert('–°–Ω–∞—á–∞–ª–∞ –æ—Å—É—à–∏—Ç–µ –∑–µ–º–ª—é!');
                return;
            }
            const type = gameState.selectedBuilding;
            const building = BUILDINGS[type];
            if (gameState.balance < building.price) {
                alert('–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Å—Ä–µ–¥—Å—Ç–≤');
                return;
            }
            if (gameState.grid[row][col] !== 'empty') {
                alert('–ö–ª–µ—Ç–∫–∞ –∑–∞–Ω—è—Ç–∞');
                return;
            }
            // —Å—Ç—Ä–æ–∏–º
            gameState.balance -= building.price;
            gameState.grid[row][col] = type;
            gameState.population += building.population || 0;
            updateUI();
            drawCity();
            saveToTelegram();
        }

        function showCellInfo(row, col) {
            const type = gameState.grid[row][col];
            if (type === 'empty') {
                document.getElementById('infoPanel').innerHTML = 'üå± –ü—É—Å—Ç–æ–π —É—á–∞—Å—Ç–æ–∫. –í—ã–±–µ—Ä–∏—Ç–µ –∑–¥–∞–Ω–∏–µ –∏ –Ω–∞–∂–º–∏—Ç–µ —Å–Ω–æ–≤–∞.';
            } else {
                const b = BUILDINGS[type];
                document.getElementById('infoPanel').innerHTML = `${b.emoji} ${b.name} | –î–æ—Ö–æ–¥: ${b.income}üí∞ | –ñ–∏—Ç–µ–ª–∏: ${b.population}üë•`;
            }
        }

        // --- –°–±–æ—Ä –Ω–∞–ª–æ–≥–æ–≤ ---
        function collectTaxes() {
            const now = Date.now();
            if (now - gameState.lastTaxTime < gameState.taxCooldown) {
                alert('–ù–∞–ª–æ–≥–∏ –º–æ–∂–Ω–æ —Å–æ–±–∏—Ä–∞—Ç—å —Ä–∞–∑ –≤ 30 —Å–µ–∫—É–Ω–¥');
                return;
            }
            let total = 0;
            for (let r=0; r<gameState.gridSize; r++) {
                for (let c=0; c<gameState.gridSize; c++) {
                    if (gameState.land[r][c] && gameState.grid[r][c] !== 'empty') {
                        total += BUILDINGS[gameState.grid[r][c]].income;
                    }
                }
            }
            gameState.balance += total;
            gameState.lastTaxTime = now;
            updateUI();
            saveToTelegram();
            document.getElementById('infoPanel').innerHTML = `üí∞ –°–æ–±—Ä–∞–Ω–æ ${total} –º–æ–Ω–µ—Ç!`;
            if (tg) tg.HapticFeedback.notificationOccurred('success');
        }

        // --- –†–∞—Å—à–∏—Ä–µ–Ω–∏–µ –æ—Å—Ç—Ä–æ–≤–∞ (–ø–æ–∫—É–ø–∫–∞ –∫–ª–µ—Ç–∫–∏ –≤–æ–¥—ã) ---
        function expandLand() {
            if (gameState.balance < gameState.expandCost) {
                alert('–ù–µ —Ö–≤–∞—Ç–∞–µ—Ç –º–æ–Ω–µ—Ç');
                return;
            }
            // –ø–æ–∏—Å–∫ –∫–ª–µ—Ç–∫–∏ –≤–æ–¥—ã, –≥—Ä–∞–Ω–∏—á–∞—â–µ–π —Å –∑–µ–º–ª—ë–π
            let candidates = [];
            for (let r=0; r<gameState.gridSize; r++) {
                for (let c=0; c<gameState.gridSize; c++) {
                    if (!gameState.land[r][c]) {
                        // –ø—Ä–æ–≤–µ—Ä–∏–º —Å–æ—Å–µ–¥–µ–π
                        const neighbors = [[-1,0],[1,0],[0,-1],[0,1]];
                        for (let [dr,dc] of neighbors) {
                            let nr = r+dr, nc = c+dc;
                            if (nr>=0 && nr<gameState.gridSize && nc>=0 && nc<gameState.gridSize && gameState.land[nr][nc]) {
                                candidates.push([r,c]);
                                break;
                            }
                        }
                    }
                }
            }
            if (candidates.length === 0) {
                alert('–ù–µ—Ç –¥–æ—Å—Ç—É–ø–Ω–æ–π –≤–æ–¥—ã –¥–ª—è —Ä–∞—Å—à–∏—Ä–µ–Ω–∏—è (—Ä—è–¥–æ–º —Å –∑–µ–º–ª—ë–π)');
                return;
            }
            // –≤—ã–±–∏—Ä–∞–µ–º —Å–ª—É—á–∞–π–Ω—É—é
            let [rr,cc] = candidates[Math.floor(Math.random() * candidates.length)];
            gameState.balance -= gameState.expandCost;
            gameState.land[rr][cc] = true;
            gameState.grid[rr][cc] = 'empty';
            updateUI();
            drawCity();
            saveToTelegram();
            document.getElementById('infoPanel').innerHTML = `üåä‚û°Ô∏èüèùÔ∏è –ù–æ–≤–∞—è –∑–µ–º–ª—è –ø—Ä–∏–æ–±—Ä–µ—Ç–µ–Ω–∞!`;
        }

        // --- –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞ ---
        function updateUI() {
            document.getElementById('moneyDisplay').innerText = gameState.balance;
            document.getElementById('populationDisplay').innerText = gameState.population;
            let totalIncome = 0;
            for (let r=0; r<gameState.gridSize; r++) {
                for (let c=0; c<gameState.gridSize; c++) {
                    if (gameState.land[r][c] && gameState.grid[r][c] !== 'empty') {
                        totalIncome += BUILDINGS[gameState.grid[r][c]].income;
                    }
                }
            }
            document.getElementById('incomeDisplay').innerText = totalIncome;
            let landCount = 0;
            for (let r=0; r<gameState.gridSize; r++) {
                for (let c=0; c<gameState.gridSize; c++) {
                    if (gameState.land[r][c]) landCount++;
                }
            }
            document.getElementById('landDisplay').innerText = landCount;
        }

        // --- –ü–æ—Å—Ç—Ä–æ–µ–Ω–∏–µ –ø–∞–Ω–µ–ª–∏ –≤—ã–±–æ—Ä–∞ ---
        function buildBuildingsPanel() {
            const scroll = document.getElementById('buildingsScroll');
            scroll.innerHTML = '';
            const types = ['house1','house2','house3','skyscraper','shop','office','school','hospital','park','road','powerplant'];
            types.forEach(t => {
                const b = BUILDINGS[t];
                const card = document.createElement('div');
                card.className = 'building-card';
                card.setAttribute('data-type', t);
                card.innerHTML = `
                    <div class="building-emoji">${b.emoji}</div>
                    <div class="building-name">${b.name}</div>
                    <div class="building-price">${b.price}ü™ô</div>
                `;
                card.addEventListener('click', (e) => {
                    e.stopPropagation();
                    document.querySelectorAll('.building-card').forEach(c => c.classList.remove('selected'));
                    card.classList.add('selected');
                    gameState.selectedBuilding = t;
                    document.getElementById('infoPanel').innerHTML = `–í—ã–±—Ä–∞–Ω–æ: ${b.name}`;
                });
                scroll.appendChild(card);
            });
        }

        // --- –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ Telegram –∏ localStorage ---
        function saveToTelegram() {
            if (tg) {
                tg.sendData(JSON.stringify({
                    balance: gameState.balance,
                    grid: gameState.grid,
                    land: gameState.land,
                    population: gameState.population
                }));
            }
            localStorage.setItem('cityIsland', JSON.stringify(gameState));
        }

        function loadGame() {
            const saved = localStorage.getItem('cityIsland');
            if (saved) {
                try {
                    const data = JSON.parse(saved);
                    gameState = {...gameState, ...data};
                } catch(e) {}
            }
            updateUI();
            drawCity();
        }

        // --- –°–±—Ä–æ—Å ---
        function resetGame() {
            if (confirm('–ù–∞—á–∞—Ç—å –∑–∞–Ω–æ–≤–æ?')) {
                gameState = {
                    balance: 5000,
                    grid: [],
                    land: [],
                    population: 0,
                    lastTaxTime: Date.now(),
                    taxCooldown: 30000,
                    taxEnabled: true,
                    selectedBuilding: null,
                    expandCost: 500,
                    gridSize: GRID_SIZE,
                };
                initGrid();
                updateUI();
                drawCity();
                saveToTelegram();
            }
        }

        // --- –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –∫–Ω–æ–ø–æ–∫ ---
        document.getElementById('collectBtn').addEventListener('click', collectTaxes);
        document.getElementById('expandBtn').addEventListener('click', expandLand);
        document.getElementById('cancelBtn').addEventListener('click', () => {
            gameState.selectedBuilding = null;
            document.querySelectorAll('.building-card').forEach(c => c.classList.remove('selected'));
            document.getElementById('infoPanel').innerHTML = '–í—ã–±–æ—Ä –æ—Ç–º–µ–Ω—ë–Ω';
        });

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
        buildBuildingsPanel();
        loadGame();
        setInterval(() => {
            // –∞–≤—Ç–æ—Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ
            saveToTelegram();
        }, 10000);
    })();
</script>
</body>
</html>
