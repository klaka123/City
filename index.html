<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>3D Island Empire ‚Äî –Ω–æ–≤–∞—è —ç—Ä–∞</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Roboto, system-ui, sans-serif;
        }
        body {
            background: #0a1c2f;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            padding: 10px;
        }
        .game-frame {
            width: 100%;
            max-width: 660px;
            background: linear-gradient(145deg, #1a4f70, #0f3b55);
            border-radius: 70px;
            padding: 26px;
            box-shadow: 0 50px 80px rgba(0,0,0,0.9), inset 0 4px 10px rgba(255,255,255,0.3);
            border: 5px solid #5a9fc7;
        }
        .resource-panel {
            background: rgba(0, 30, 45, 0.85);
            backdrop-filter: blur(25px);
            border-radius: 70px;
            padding: 20px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            color: white;
            margin-bottom: 28px;
            border: 2px solid #9fd3f0;
            box-shadow: 0 15px 0 #0f3f57;
        }
        .resource {
            display: flex;
            align-items: center;
            gap: 12px;
            font-size: 26px;
            font-weight: 700;
            text-shadow: 0 5px 8px black;
            background: rgba(0,0,0,0.5);
            padding: 10px 26px;
            border-radius: 60px;
            backdrop-filter: blur(5px);
        }
        .resource-icon {
            font-size: 38px;
            filter: drop-shadow(0 6px 6px black);
        }
        .canvas-holder {
            background: #1e6f9a;
            border-radius: 60px;
            padding: 26px;
            display: flex;
            justify-content: center;
            box-shadow: inset 0 -30px 60px #0a3f57, 0 30px 50px black;
            margin-bottom: 28px;
        }
        #gameCanvas {
            width: 100%;
            height: auto;
            border-radius: 52px;
            background: #2e8fc0;
            cursor: pointer;
            touch-action: none;
            max-width: 580px;
            box-shadow: 0 0 0 7px #c2e6ff, 0 30px 60px black;
        }
        .category-tabs {
            display: flex;
            gap: 18px;
            margin-bottom: 22px;
        }
        .tab {
            flex: 1;
            background: rgba(255,255,255,0.2);
            backdrop-filter: blur(20px);
            border: 4px solid white;
            border-radius: 70px;
            padding: 18px;
            color: white;
            font-weight: bold;
            font-size: 22px;
            text-align: center;
            box-shadow: 0 10px 0 #0f3f57;
            transition: 0.1s;
            touch-action: manipulation;
        }
        .tab.active {
            background: #ffe28f;
            color: #1e3e55;
            border-color: #ffb84d;
            transform: translateY(-5px);
            box-shadow: 0 15px 0 #c68a2b;
        }
        .tab:active {
            transform: translateY(7px);
            box-shadow: 0 4px 0 #0f3f57;
        }
        .build-scroll {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(25px);
            border-radius: 80px;
            padding: 18px;
            margin-bottom: 28px;
            overflow-x: auto;
            white-space: nowrap;
            -webkit-overflow-scrolling: touch;
            scrollbar-width: none;
            border: 5px solid white;
            box-shadow: inset 0 10px 25px #b0b0b0;
        }
        .build-scroll::-webkit-scrollbar { display: none; }
        .build-track {
            display: inline-flex;
            gap: 24px;
            padding: 12px;
        }
        .build-card {
            background: linear-gradient(145deg, #fffef8, #f5ecd8);
            border-radius: 70px;
            padding: 28px 32px;
            display: inline-flex;
            flex-direction: column;
            align-items: center;
            min-width: 190px;
            box-shadow: 0 18px 0 #c0af8b, 0 28px 45px rgba(0,0,0,0.5);
            border: 6px solid #fffae6;
            transition: 0.1s;
            touch-action: manipulation;
        }
        .build-card.selected {
            transform: translateY(-10px);
            border-color: #f7b731;
            box-shadow: 0 22px 0 #c9912e, 0 35px 55px black;
        }
        .build-card:active {
            transform: translateY(10px);
            box-shadow: 0 8px 0 #c0af8b;
        }
        .card-preview {
            width: 110px;
            height: 110px;
            background: #d9ecf5;
            border-radius: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 70px;
            margin-bottom: 14px;
            box-shadow: inset 0 -10px 0 #aac6d4;
        }
        .card-name {
            font-weight: 800;
            font-size: 20px;
            color: #2e6652;
        }
        .card-price {
            background: #d4b98c;
            padding: 10px 28px;
            border-radius: 60px;
            font-weight: 700;
            margin-top: 12px;
            font-size: 20px;
            color: #2d2d2d;
        }
        .action-row {
            display: flex;
            gap: 20px;
            justify-content: center;
            flex-wrap: wrap;
            margin-bottom: 28px;
        }
        .primary-btn {
            flex: 1 1 auto;
            min-width: 200px;
            background: linear-gradient(145deg, #3f9ed4, #1c6fa0);
            border: none;
            border-radius: 80px;
            padding: 24px 26px;
            color: white;
            font-size: 28px;
            font-weight: bold;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 16px;
            box-shadow: 0 18px 0 #12547a, 0 30px 50px black;
            border: 5px solid #b0e2ff;
            touch-action: manipulation;
            position: relative;
        }
        .primary-btn:active {
            transform: translateY(10px);
            box-shadow: 0 8px 0 #12547a;
        }
        .primary-btn:disabled {
            opacity: 0.5;
            transform: none;
            pointer-events: none;
        }
        .cooldown-overlay {
            position: absolute;
            top: 0;
            left: 0;
            height: 100%;
            background: rgba(0,0,0,0.5);
            border-radius: 80px;
            transition: width 0.1s linear;
            pointer-events: none;
        }
        .info-card {
            background: #e5f2fa;
            border-radius: 70px;
            padding: 26px;
            color: #124257;
            border: 6px solid white;
            font-size: 22px;
            font-weight: 600;
            box-shadow: inset 0 10px 25px #b3d9f0, 0 18px 0 #548ea8;
        }
    </style>
</head>
<body>
<div class="game-frame">
    <div class="resource-panel">
        <div class="resource"><span class="resource-icon">üí∞</span> <span id="moneyDisplay">20000</span></div>
        <div class="resource"><span class="resource-icon">üë™</span> <span id="popDisplay">0</span></div>
        <div class="resource"><span class="resource-icon">üìà</span> <span id="incomeDisplay">0</span></div>
        <div class="resource"><span class="resource-icon">üèùÔ∏è</span> <span id="landDisplay">25</span></div>
    </div>

    <div class="canvas-holder">
        <canvas id="gameCanvas" width="600" height="500"></canvas>
    </div>

    <div class="category-tabs">
        <div class="tab active" id="tabResidential">üèòÔ∏è –ñ–∏–ª—ã–µ</div>
        <div class="tab" id="tabCommercial">üè™ –ö–æ–º–º–µ—Ä—Ü–∏—è</div>
        <div class="tab" id="tabInfra">üè• –ò–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä–∞</div>
    </div>

    <div class="build-scroll">
        <div class="build-track" id="buildTrack"></div>
    </div>

    <div class="action-row">
        <button class="primary-btn" id="collectBtn">
            <span>üí∞</span> –°–±–æ—Ä
            <div class="cooldown-overlay" id="cooldownOverlay" style="width: 0%;"></div>
        </button>
        <button class="primary-btn" id="expandBtn"><span>üåä‚ÜíüèùÔ∏è</span> 1200üí∞</button>
        <button class="primary-btn" id="cancelBtn"><span>‚ùå</span> –û—Ç–º–µ–Ω–∞</button>
    </div>

    <div class="info-card" id="infoPanel">
        üëâ –í—ã–±–µ—Ä–∏—Ç–µ –∑–¥–∞–Ω–∏–µ –∏ –∫–æ—Å–Ω–∏—Ç–µ—Å—å —É—á–∞—Å—Ç–∫–∞.
    </div>
</div>

<script src="https://telegram.org/js/telegram-web-app.js"></script>
<script>
    (function() {
        let tg = null;
        try {
            if (window.Telegram && Telegram.WebApp) {
                tg = Telegram.WebApp;
                tg.expand();
                tg.ready();
            }
        } catch(e) { console.log('No TG'); }

        // –†–∞–∑–º–µ—Ä—ã
        const GRID_SIZE = 7;
        const CELL_W = 100;
        const CELL_H = 60;
        const ISO_X0 = 280;
        const ISO_Y0 = 60;

        // ---- 3D-–º–æ–¥–µ–ª–∏ –∑–¥–∞–Ω–∏–π (–¥–µ—Ç–∞–ª—å–Ω–∞—è –ø—Ä–æ—Ä–∏—Å–æ–≤–∫–∞) ----
        const BUILDINGS = {
            empty: {
                name: '–ü—É—Å—Ç–æ', price: 0, income: 0, pop: 0,
                draw: (ctx, x, y) => {
                    // –ó–µ–º–ª—è —Å —Ç–µ–∫—Å—Ç—É—Ä–æ–π
                    ctx.fillStyle = '#7cb57c';
                    ctx.shadowColor = '#3a6b3a';
                    ctx.shadowBlur = 20;
                    ctx.shadowOffsetY = 12;
                    ctx.beginPath();
                    ctx.moveTo(x, y-6);
                    ctx.lineTo(x + CELL_W/2, y + CELL_H/2-6);
                    ctx.lineTo(x, y + CELL_H-6);
                    ctx.lineTo(x - CELL_W/2, y + CELL_H/2-6);
                    ctx.closePath();
                    ctx.fill();
                    ctx.shadowBlur = 0;
                    // –¢—Ä–∞–≤—è–Ω—ã–µ –∫–æ—á–∫–∏
                    ctx.fillStyle = '#5f8b5f';
                    for (let i = -20; i <= 20; i+=15) {
                        ctx.beginPath();
                        ctx.arc(x-10+i, y-24, 6, 0, 2*Math.PI);
                        ctx.fill();
                    }
                }
            },
            house1: { // –£—é—Ç–Ω—ã–π –¥–æ–º–∏–∫ —Å —á–µ—Ä–µ–ø–∏—Ü–µ–π
                name: '–î–æ–º', price: 250, income: 18, pop: 8,
                draw: (ctx, x, y) => {
                    // –¢–µ–Ω—å –ø–æ–¥ –¥–æ–º–æ–º
                    ctx.shadowColor = '#2b4d2b';
                    ctx.shadowBlur = 30;
                    ctx.shadowOffsetY = 18;
                    
                    // –û—Å–Ω–æ–≤–∞–Ω–∏–µ
                    ctx.fillStyle = '#e3b27c';
                    ctx.beginPath();
                    ctx.moveTo(x, y-22);
                    ctx.lineTo(x + CELL_W/2, y + CELL_H/2-22);
                    ctx.lineTo(x, y + CELL_H-22);
                    ctx.lineTo(x - CELL_W/2, y + CELL_H/2-22);
                    ctx.closePath();
                    ctx.fill();

                    // –°—Ç–µ–Ω—ã (–æ–±—ä—ë–º)
                    ctx.fillStyle = '#c49a6c';
                    ctx.beginPath();
                    ctx.moveTo(x-10, y-40);
                    ctx.lineTo(x+10, y-40);
                    ctx.lineTo(x+10, y-10);
                    ctx.lineTo(x-10, y-10);
                    ctx.closePath();
                    ctx.fill();

                    // –ö—Ä—ã—à–∞ (–∫—Ä–∞—Å–Ω–∞—è)
                    ctx.fillStyle = '#b54c4c';
                    ctx.beginPath();
                    ctx.moveTo(x-28, y-44);
                    ctx.lineTo(x+28, y-44);
                    ctx.lineTo(x, y-76);
                    ctx.closePath();
                    ctx.fill();

                    // –ß–µ—Ä–µ–ø–∏—Ü–∞
                    ctx.strokeStyle = '#8b3a3a';
                    ctx.lineWidth = 2;
                    for (let i = -20; i <= 20; i+=10) {
                        ctx.beginPath();
                        ctx.moveTo(x-20+i, y-50);
                        ctx.lineTo(x-5+i, y-66);
                        ctx.stroke();
                    }

                    // –î–≤–µ—Ä—å
                    ctx.fillStyle = '#8b5a2b';
                    ctx.fillRect(x-12, y-28, 24, 28);
                    ctx.fillStyle = '#d4af37';
                    ctx.beginPath();
                    ctx.arc(x-4, y-14, 3, 0, 2*Math.PI);
                    ctx.fill();

                    // –û–∫–Ω–∞
                    ctx.fillStyle = '#f9e076';
                    ctx.fillRect(x-24, y-38, 12, 14);
                    ctx.fillRect(x+12, y-38, 12, 14);
                    ctx.strokeStyle = '#6b4c2c';
                    ctx.lineWidth = 2;
                    ctx.strokeRect(x-24, y-38, 12, 14);
                    ctx.strokeRect(x+12, y-38, 12, 14);

                    // –¢—Ä—É–±–∞
                    ctx.fillStyle = '#8b5a2b';
                    ctx.fillRect(x+14, y-62, 8, 18);
                    ctx.shadowBlur = 0;
                }
            },
            house2: { // –ö–æ—Ç—Ç–µ–¥–∂ —Å –±–∞–ª–∫–æ–Ω–æ–º
                name: '–ö–æ—Ç—Ç–µ–¥–∂', price: 650, income: 48, pop: 22,
                draw: (ctx, x, y) => {
                    ctx.shadowColor = '#2b4d2b';
                    ctx.shadowBlur = 30;
                    ctx.shadowOffsetY = 18;

                    ctx.fillStyle = '#cf9f6b';
                    ctx.beginPath();
                    ctx.moveTo(x, y-28);
                    ctx.lineTo(x + CELL_W/2, y + CELL_H/2-28);
                    ctx.lineTo(x, y + CELL_H-28);
                    ctx.lineTo(x - CELL_W/2, y + CELL_H/2-28);
                    ctx.closePath();
                    ctx.fill();

                    // –û—Å–Ω–æ–≤–Ω–∞—è –∫—Ä—ã—à–∞
                    ctx.fillStyle = '#8b5a2b';
                    ctx.beginPath();
                    ctx.moveTo(x-32, y-58);
                    ctx.lineTo(x+32, y-58);
                    ctx.lineTo(x, y-94);
                    ctx.closePath();
                    ctx.fill();

                    // –ú–∞–Ω—Å–∞—Ä–¥–∞
                    ctx.fillStyle = '#c49a6c';
                    ctx.fillRect(x-16, y-68, 32, 18);
                    ctx.fillStyle = '#f9e076';
                    ctx.fillRect(x-10, y-64, 6, 6);
                    ctx.fillRect(x+4, y-64, 6, 6);

                    // –ë–∞–ª–∫–æ–Ω
                    ctx.fillStyle = '#a57248';
                    ctx.fillRect(x-24, y-40, 48, 8);
                    for (let i = -14; i <= 14; i+=14) {
                        ctx.fillStyle = '#8b5a2b';
                        ctx.fillRect(x-6+i, y-50, 8, 12);
                    }

                    // –û–∫–Ω–∞ –ø–µ—Ä–≤–æ–≥–æ —ç—Ç–∞–∂–∞
                    ctx.fillStyle = '#f9e076';
                    ctx.fillRect(x-22, y-34, 12, 14);
                    ctx.fillRect(x+10, y-34, 12, 14);
                    ctx.shadowBlur = 0;
                }
            },
            house3: { // –ú–Ω–æ–≥–æ–∫–≤–∞—Ä—Ç–∏—Ä–Ω—ã–π –¥–æ–º
                name: '–ú–Ω–æ–≥–æ–∫–≤.', price: 1800, income: 140, pop: 75,
                draw: (ctx, x, y) => {
                    ctx.shadowColor = '#2b4d2b';
                    ctx.shadowBlur = 35;
                    ctx.shadowOffsetY = 20;

                    ctx.fillStyle = '#b0bec5';
                    ctx.beginPath();
                    ctx.moveTo(x, y-36);
                    ctx.lineTo(x + CELL_W/2, y + CELL_H/2-36);
                    ctx.lineTo(x, y + CELL_H-36);
                    ctx.lineTo(x - CELL_W/2, y + CELL_H/2-36);
                    ctx.closePath();
                    ctx.fill();

                    ctx.fillStyle = '#8a9aa8';
                    ctx.fillRect(x-34, y-78, 68, 54);

                    // –û–∫–Ω–∞
                    for (let i = -20; i <= 20; i+=22) {
                        for (let j = -68; j <= -26; j+=22) {
                            ctx.fillStyle = '#cfd8dc';
                            ctx.fillRect(x-12+i, y+j, 14, 16);
                            ctx.fillStyle = '#f9e076';
                            ctx.fillRect(x-10+i, y+j+2, 4, 4);
                            ctx.fillRect(x-2+i, y+j+2, 4, 4);
                            ctx.fillStyle = '#cfd8dc';
                        }
                    }

                    // –ë–∞–ª–∫–æ–Ω—ã
                    ctx.fillStyle = '#a0aab3';
                    ctx.fillRect(x-26, y-54, 22, 6);
                    ctx.fillRect(x+4, y-54, 22, 6);
                    ctx.shadowBlur = 0;
                }
            },
            skyscraper: { // –ù–µ–±–æ—Å–∫—Ä—ë–±
                name: '–ù–µ–±–æ—Å–∫—Ä—ë–±', price: 6000, income: 500, pop: 300,
                draw: (ctx, x, y) => {
                    ctx.shadowColor = '#2b4d2b';
                    ctx.shadowBlur = 40;
                    ctx.shadowOffsetY = 25;

                    ctx.fillStyle = '#607d8b';
                    ctx.beginPath();
                    ctx.moveTo(x, y-52);
                    ctx.lineTo(x + CELL_W/2, y + CELL_H/2-52);
                    ctx.lineTo(x, y + CELL_H-52);
                    ctx.lineTo(x - CELL_W/2, y + CELL_H/2-52);
                    ctx.closePath();
                    ctx.fill();

                    ctx.fillStyle = '#4f6573';
                    ctx.fillRect(x-40, y-130, 80, 90);

                    // –û–∫–Ω–∞
                    for (let i = -28; i <= 28; i+=22) {
                        for (let j = -115; j <= -25; j+=22) {
                            ctx.fillStyle = '#ffd966';
                            ctx.fillRect(x-14+i, y+j-5, 16, 18);
                            ctx.fillStyle = '#fff';
                            ctx.fillRect(x-12+i, y+j-3, 6, 6);
                            ctx.fillRect(x-4+i, y+j-3, 6, 6);
                        }
                    }

                    // –ê–Ω—Ç–µ–Ω–Ω–∞
                    ctx.fillStyle = '#b0bec5';
                    ctx.fillRect(x-6, y-150, 12, 28);
                    ctx.fillStyle = '#d4af37';
                    ctx.beginPath();
                    ctx.arc(x, y-160, 8, 0, 2*Math.PI);
                    ctx.fill();

                    ctx.shadowBlur = 0;
                }
            },
            shop: { // –ú–∞–≥–∞–∑–∏–Ω
                name: '–ú–∞–≥–∞–∑–∏–Ω', price: 450, income: 55, pop: 5,
                draw: (ctx, x, y) => {
                    ctx.shadowColor = '#2b4d2b';
                    ctx.shadowBlur = 28;
                    ctx.shadowOffsetY = 16;

                    ctx.fillStyle = '#ffb74d';
                    ctx.beginPath();
                    ctx.moveTo(x, y-22);
                    ctx.lineTo(x + CELL_W/2, y + CELL_H/2-22);
                    ctx.lineTo(x, y + CELL_H-22);
                    ctx.lineTo(x - CELL_W/2, y + CELL_H/2-22);
                    ctx.closePath();
                    ctx.fill();

                    ctx.fillStyle = '#ff9800';
                    ctx.fillRect(x-32, y-48, 64, 34);

                    // –í–∏—Ç—Ä–∏–Ω–∞
                    ctx.fillStyle = '#fff2cc';
                    ctx.fillRect(x-22, y-40, 16, 18);
                    ctx.fillRect(x+6, y-40, 16, 18);
                    
                    ctx.fillStyle = '#8b5a2b';
                    ctx.font = '28px sans-serif';
                    ctx.fillText('üõí', x-32, y-16);
                    ctx.fillText('üßÉ', x+10, y-20);

                    // –í—ã–≤–µ—Å–∫–∞
                    ctx.fillStyle = '#c43a3a';
                    ctx.fillRect(x-14, y-70, 28, 12);
                    ctx.fillStyle = '#fff';
                    ctx.font = '20px sans-serif';
                    ctx.fillText('SALE', x-12, y-58);
                    ctx.shadowBlur = 0;
                }
            },
            office: { // –û—Ñ–∏—Å
                name: '–û—Ñ–∏—Å', price: 1300, income: 150, pop: 12,
                draw: (ctx, x, y) => {
                    ctx.shadowColor = '#2b4d2b';
                    ctx.shadowBlur = 32;
                    ctx.shadowOffsetY = 18;

                    ctx.fillStyle = '#9e9e9e';
                    ctx.beginPath();
                    ctx.moveTo(x, y-32);
                    ctx.lineTo(x + CELL_W/2, y + CELL_H/2-32);
                    ctx.lineTo(x, y + CELL_H-32);
                    ctx.lineTo(x - CELL_W/2, y + CELL_H/2-32);
                    ctx.closePath();
                    ctx.fill();

                    ctx.fillStyle = '#757575';
                    ctx.fillRect(x-34, y-68, 68, 48);

                    // –û–∫–Ω–∞
                    for (let i = -20; i <= 20; i+=24) {
                        ctx.fillStyle = '#cfd8dc';
                        ctx.fillRect(x-14+i, y-58, 16, 12);
                        ctx.fillRect(x-14+i, y-38, 16, 12);
                        ctx.fillStyle = '#aed6f1';
                        ctx.fillRect(x-12+i, y-56, 6, 6);
                        ctx.fillRect(x-12+i, y-36, 6, 6);
                    }

                    // –õ–æ–≥–æ—Ç–∏–ø
                    ctx.fillStyle = '#ffb74d';
                    ctx.beginPath();
                    ctx.arc(x, y-82, 10, 0, 2*Math.PI);
                    ctx.fill();
                    ctx.fillStyle = '#fff';
                    ctx.font = '18px sans-serif';
                    ctx.fillText('LLC', x-16, y-80);
                    ctx.shadowBlur = 0;
                }
            },
            school: { // –®–∫–æ–ª–∞
                name: '–®–∫–æ–ª–∞', price: 3000, income: 85, pop: 0,
                draw: (ctx, x, y) => {
                    ctx.shadowColor = '#2b4d2b';
                    ctx.shadowBlur = 32;
                    ctx.shadowOffsetY = 18;

                    ctx.fillStyle = '#ff8a80';
                    ctx.beginPath();
                    ctx.moveTo(x, y-30);
                    ctx.lineTo(x + CELL_W/2, y + CELL_H/2-30);
                    ctx.lineTo(x, y + CELL_H-30);
                    ctx.lineTo(x - CELL_W/2, y + CELL_H/2-30);
                    ctx.closePath();
                    ctx.fill();

                    ctx.fillStyle = '#f06292';
                    ctx.fillRect(x-36, y-66, 72, 50);

                    // –û–∫–Ω–∞
                    for (let i = -20; i <= 20; i+=24) {
                        ctx.fillStyle = '#ffffff';
                        ctx.fillRect(x-14+i, y-56, 16, 16);
                        ctx.fillRect(x-14+i, y-32, 16, 16);
                    }

                    // –ö—Ä—ã–ª—å—Ü–æ
                    ctx.fillStyle = '#8b5a2b';
                    ctx.fillRect(x-18, y-26, 36, 10);

                    // –ö–æ–ª–æ–∫–æ–ª—å—á–∏–∫
                    ctx.fillStyle = '#d4af37';
                    ctx.beginPath();
                    ctx.arc(x, y-88, 10, 0, 2*Math.PI);
                    ctx.fill();
                    ctx.fillStyle = '#b8860b';
                    ctx.fillRect(x-3, y-98, 6, 12);
                    ctx.shadowBlur = 0;
                }
            },
            hospital: { // –ë–æ–ª—å–Ω–∏—Ü–∞
                name: '–ë–æ–ª—å–Ω–∏—Ü–∞', price: 3800, income: 130, pop: 0,
                draw: (ctx, x, y) => {
                    ctx.shadowColor = '#2b4d2b';
                    ctx.shadowBlur = 32;
                    ctx.shadowOffsetY = 18;

                    ctx.fillStyle = '#ef9a9a';
                    ctx.beginPath();
                    ctx.moveTo(x, y-32);
                    ctx.lineTo(x + CELL_W/2, y + CELL_H/2-32);
                    ctx.lineTo(x, y + CELL_H-32);
                    ctx.lineTo(x - CELL_W/2, y + CELL_H/2-32);
                    ctx.closePath();
                    ctx.fill();

                    ctx.fillStyle = '#e57373';
                    ctx.fillRect(x-36, y-70, 72, 52);

                    // –ö—Ä–µ—Å—Ç
                    ctx.fillStyle = '#ffffff';
                    ctx.fillRect(x-10, y-58, 20, 10);
                    ctx.fillRect(x-5, y-66, 10, 24);

                    // –û–∫–Ω–∞
                    for (let i = -20; i <= 20; i+=24) {
                        ctx.fillStyle = '#b0e0e6';
                        ctx.fillRect(x-14+i, y-50, 12, 12);
                        ctx.fillRect(x-14+i, y-28, 12, 12);
                    }

                    // –í—Ö–æ–¥
                    ctx.fillStyle = '#8b5a2b';
                    ctx.fillRect(x-12, y-26, 24, 18);
                    ctx.shadowBlur = 0;
                }
            },
            park: { // –ü–∞—Ä–∫
                name: '–ü–∞—Ä–∫', price: 320, income: 30, pop: 5,
                draw: (ctx, x, y) => {
                    ctx.shadowColor = '#2b4d2b';
                    ctx.shadowBlur = 24;
                    ctx.shadowOffsetY = 14;

                    ctx.fillStyle = '#81c784';
                    ctx.beginPath();
                    ctx.moveTo(x, y-14);
                    ctx.lineTo(x + CELL_W/2, y + CELL_H/2-14);
                    ctx.lineTo(x, y + CELL_H-14);
                    ctx.lineTo(x - CELL_W/2, y + CELL_H/2-14);
                    ctx.closePath();
                    ctx.fill();

                    // –î–µ—Ä–µ–≤—å—è
                    ctx.fillStyle = '#5f9b6b';
                    ctx.beginPath();
                    ctx.arc(x-22, y-36, 16, 0, 2*Math.PI);
                    ctx.fill();
                    ctx.fillStyle = '#8b5a2b';
                    ctx.fillRect(x-28, y-22, 8, 20);
                    ctx.fillRect(x-20, y-22, 8, 20);

                    ctx.fillStyle = '#5f9b6b';
                    ctx.beginPath();
                    ctx.arc(x+22, y-44, 14, 0, 2*Math.PI);
                    ctx.fill();
                    ctx.fillStyle = '#8b5a2b';
                    ctx.fillRect(x+16, y-30, 8, 18);

                    // –¶–≤–µ—Ç—ã
                    ctx.fillStyle = '#f4a460';
                    for (let i = -10; i <= 10; i+=12) {
                        ctx.beginPath();
                        ctx.arc(x+i, y-20, 6, 0, 2*Math.PI);
                        ctx.fill();
                    }
                    ctx.shadowBlur = 0;
                }
            },
            road: { // –î–æ—Ä–æ–≥–∞ —Å —Ä–∞–∑–º–µ—Ç–∫–æ–π
                name: '–î–æ—Ä–æ–≥–∞', price: 150, income: 8, pop: 0,
                draw: (ctx, x, y) => {
                    ctx.shadowColor = '#2b4d2b';
                    ctx.shadowBlur = 20;
                    ctx.shadowOffsetY = 10;

                    ctx.fillStyle = '#b0bec5';
                    ctx.beginPath();
                    ctx.moveTo(x, y-8);
                    ctx.lineTo(x + CELL_W/2, y + CELL_H/2-8);
                    ctx.lineTo(x, y + CELL_H-8);
                    ctx.lineTo(x - CELL_W/2, y + CELL_H/2-8);
                    ctx.closePath();
                    ctx.fill();

                    // –†–∞–∑–º–µ—Ç–∫–∞
                    ctx.fillStyle = '#f5f5f5';
                    ctx.fillRect(x-34, y-16, 68, 6);
                    ctx.fillRect(x-12, y-30, 6, 24);
                    ctx.fillStyle = '#ffd966';
                    ctx.beginPath();
                    ctx.arc(x-18, y-22, 6, 0, 2*Math.PI);
                    ctx.fill();
                    ctx.beginPath();
                    ctx.arc(x+18, y-22, 6, 0, 2*Math.PI);
                    ctx.fill();

                    // –ë–æ—Ä–¥—é—Ä
                    ctx.fillStyle = '#8a9aa8';
                    ctx.fillRect(x-38, y-4, 76, 6);
                    ctx.shadowBlur = 0;
                }
            },
            powerplant: { // –≠–ª–µ–∫—Ç—Ä–æ—Å—Ç–∞–Ω—Ü–∏—è
                name: '–≠–ª–µ–∫—Ç—Ä–æ', price: 6500, income: 600, pop: 0,
                draw: (ctx, x, y) => {
                    ctx.shadowColor = '#2b4d2b';
                    ctx.shadowBlur = 45;
                    ctx.shadowOffsetY = 28;

                    ctx.fillStyle = '#b0a57c';
                    ctx.beginPath();
                    ctx.moveTo(x, y-44);
                    ctx.lineTo(x + CELL_W/2, y + CELL_H/2-44);
                    ctx.lineTo(x, y + CELL_H-44);
                    ctx.lineTo(x - CELL_W/2, y + CELL_H/2-44);
                    ctx.closePath();
                    ctx.fill();

                    ctx.fillStyle = '#8b7a5a';
                    ctx.fillRect(x-38, y-100, 76, 70);

                    // –¢—Ä—É–±—ã
                    ctx.fillStyle = '#6b5a3a';
                    ctx.fillRect(x-24, y-136, 14, 46);
                    ctx.fillRect(x+10, y-148, 14, 58);

                    // –î—ã–º
                    ctx.fillStyle = 'rgba(255,255,255,0.3)';
                    ctx.beginPath();
                    ctx.arc(x-18, y-160, 16, 0, 2*Math.PI);
                    ctx.fill();
                    ctx.beginPath();
                    ctx.arc(x+16, y-172, 14, 0, 2*Math.PI);
                    ctx.fill();

                    // –û–∫–Ω–∞
                    ctx.fillStyle = '#ffb74d';
                    for (let i = -18; i <= 18; i+=22) {
                        ctx.fillRect(x-10+i, y-68, 10, 12);
                    }

                    // –ú–æ–ª–Ω–∏—è
                    ctx.fillStyle = '#ffeb3b';
                    ctx.font = '36px sans-serif';
                    ctx.fillText('‚ö°', x-24, y-30);
                    ctx.shadowBlur = 0;
                }
            }
        };

        let gameState = {
            balance: 20000,
            gridSize: 7,
            grid: [],
            land: [],
            population: 0,
            lastTaxTime: Date.now(),
            taxCooldown: 5000, // 5 —Å–µ–∫—É–Ω–¥
            selectedBuilding: null,
            expandCost: 1200,
        };

        function initLand() {
            for (let r = 0; r < gameState.gridSize; r++) {
                gameState.grid[r] = [];
                gameState.land[r] = [];
                for (let c = 0; c < gameState.gridSize; c++) {
                    if (r >= 1 && r <= 5 && c >= 1 && c <= 5) {
                        gameState.land[r][c] = true;
                        gameState.grid[r][c] = 'empty';
                    } else {
                        gameState.land[r][c] = false;
                        gameState.grid[r][c] = 'empty';
                    }
                }
            }
        }
        initLand();

        function gridToIso(row, col) {
            return {
                x: (col - row) * CELL_W / 2 + ISO_X0,
                y: (col + row) * CELL_H / 2 + ISO_Y0
            };
        }

        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');

        function drawCity() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);

            // –ù–µ–±–æ —Å –≥—Ä–∞–¥–∏–µ–Ω—Ç–æ–º
            const grad = ctx.createLinearGradient(0, 0, 0, canvas.height);
            grad.addColorStop(0, '#0b4b72');
            grad.addColorStop(1, '#2379a3');
            ctx.fillStyle = grad;
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            // –°–æ–ª–Ω—Ü–µ
            ctx.shadowBlur = 60;
            ctx.shadowColor = '#fff7b0';
            ctx.beginPath();
            ctx.arc(120, 90, 40, 0, 2*Math.PI);
            ctx.fillStyle = '#fff3b0';
            ctx.fill();

            // –û–±–ª–∞–∫–∞
            ctx.shadowBlur = 40;
            ctx.fillStyle = 'rgba(255,255,255,0.2)';
            ctx.beginPath();
            ctx.ellipse(200, 140, 60, 30, 0, 0, 2*Math.PI);
            ctx.fill();
            ctx.beginPath();
            ctx.ellipse(400, 180, 80, 40, 0, 0, 2*Math.PI);
            ctx.fill();

            ctx.shadowBlur = 0;

            // –í–æ–¥–∞ —Å –∞–Ω–∏–º–∞—Ü–∏–µ–π
            let wave = Date.now() / 400;
            for (let i = 0; i < 12; i++) {
                ctx.fillStyle = `rgba(100, 200, 255, ${0.15 + Math.sin(wave + i)*0.05})`;
                ctx.beginPath();
                ctx.ellipse(80 + i*70, 400 + Math.sin(wave + i)*10, 60, 20, 0, 0, 2*Math.PI);
                ctx.fill();
            }

            // –û—Ç—Ä–∏—Å–æ–≤–∫–∞ –∫–ª–µ—Ç–æ–∫
            for (let r = 0; r < gameState.gridSize; r++) {
                for (let c = 0; c < gameState.gridSize; c++) {
                    const iso = gridToIso(r, c);
                    if (!gameState.land[r][c]) {
                        // –í–æ–¥–∞
                        ctx.fillStyle = '#1f7a9c';
                        ctx.shadowColor = '#0c4b66';
                        ctx.shadowBlur = 20;
                        ctx.shadowOffsetY = 8;
                        ctx.beginPath();
                        ctx.moveTo(iso.x, iso.y);
                        ctx.lineTo(iso.x + CELL_W/2, iso.y + CELL_H/2);
                        ctx.lineTo(iso.x, iso.y + CELL_H);
                        ctx.lineTo(iso.x - CELL_W/2, iso.y + CELL_H/2);
                        ctx.closePath();
                        ctx.fill();

                        ctx.fillStyle = '#48b5e0';
                        ctx.globalAlpha = 0.5 + Math.sin(wave + r)*0.2;
                        ctx.font = '28px sans-serif';
                        ctx.fillText('üíß', iso.x-20, iso.y-8);
                        ctx.globalAlpha = 1;
                        continue;
                    }
                    const type = gameState.grid[r][c];
                    const b = BUILDINGS[type] || BUILDINGS.empty;
                    b.draw(ctx, iso.x, iso.y);
                }
            }

            // –ü–æ–¥—Å–≤–µ—Ç–∫–∞ –≤—ã–±—Ä–∞–Ω–Ω–æ–π –∫–ª–µ—Ç–∫–∏
            if (selRow !== -1 && selCol !== -1 && gameState.land[selRow] && gameState.land[selRow][selCol]) {
                const iso = gridToIso(selRow, selCol);
                ctx.shadowColor = '#ffdf7e';
                ctx.shadowBlur = 45;
                ctx.strokeStyle = '#ffdb7e';
                ctx.lineWidth = 10;
                ctx.beginPath();
                ctx.moveTo(iso.x, iso.y-26);
                ctx.lineTo(iso.x + CELL_W/2, iso.y + CELL_H/2-26);
                ctx.lineTo(iso.x, iso.y + CELL_H-26);
                ctx.lineTo(iso.x - CELL_W/2, iso.y + CELL_H/2-26);
                ctx.closePath();
                ctx.stroke();
                ctx.shadowBlur = 0;
            }
        }

        let selRow = -1, selCol = -1;
        canvas.addEventListener('click', handleTap);
        canvas.addEventListener('touchstart', handleTap, {passive: false});

        function handleTap(e) {
            e.preventDefault();
            const rect = canvas.getBoundingClientRect();
            const scaleX = canvas.width / rect.width;
            const scaleY = canvas.height / rect.height;
            let clientX, clientY;
            if (e.touches) {
                clientX = e.touches[0].clientX;
                clientY = e.touches[0].clientY;
            } else {
                clientX = e.clientX;
                clientY = e.clientY;
            }
            const mouseX = (clientX - rect.left) * scaleX;
            const mouseY = (clientY - rect.top) * scaleY;

            let bestDist = 120;
            for (let r = 0; r < gameState.gridSize; r++) {
                for (let c = 0; c < gameState.gridSize; c++) {
                    const iso = gridToIso(r, c);
                    const dx = mouseX - iso.x;
                    const dy = mouseY - iso.y;
                    const dist = Math.sqrt(dx*dx + dy*dy);
                    if (dist < bestDist) {
                        bestDist = dist;
                        selRow = r;
                        selCol = c;
                    }
                }
            }
            if (selRow !== -1 && selCol !== -1) {
                if (!gameState.land[selRow][selCol]) {
                    document.getElementById('infoPanel').innerHTML = 'üåä –≠—Ç–æ –≤–æ–¥–∞. –ú–æ–∂–Ω–æ —Ä–∞—Å—à–∏—Ä–∏—Ç—å –æ—Å—Ç—Ä–æ–≤.';
                } else if (gameState.selectedBuilding) {
                    buildAt(selRow, selCol);
                } else {
                    showInfo(selRow, selCol);
                }
                drawCity();
            }
        }

        function buildAt(row, col) {
            if (!gameState.selectedBuilding) return;
            const type = gameState.selectedBuilding;
            const b = BUILDINGS[type];
            if (!b) return;
            if (gameState.balance < b.price) {
                alert('–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –º–æ–Ω–µ—Ç');
                return;
            }
            if (gameState.grid[row][col] !== 'empty') {
                alert('–ö–ª–µ—Ç–∫–∞ –∑–∞–Ω—è—Ç–∞');
                return;
            }
            gameState.balance -= b.price;
            gameState.grid[row][col] = type;
            gameState.population += b.pop || 0;
            updateUI();
            drawCity();
            saveGame();
            if (tg) tg.HapticFeedback.impactOccurred('light');
        }

        function showInfo(row, col) {
            const type = gameState.grid[row][col];
            if (type === 'empty') {
                document.getElementById('infoPanel').innerHTML = 'üå± –ü—É—Å—Ç–æ–π —É—á–∞—Å—Ç–æ–∫. –í—ã–±–µ—Ä–∏—Ç–µ –∑–¥–∞–Ω–∏–µ.';
            } else {
                const b = BUILDINGS[type];
                document.getElementById('infoPanel').innerHTML = `${b.name} | –î–æ—Ö–æ–¥: ${b.income}üí∞ | –ñ–∏—Ç–µ–ª–∏: +${b.pop}`;
            }
        }

        // –°–±–æ—Ä –Ω–∞–ª–æ–≥–æ–≤ —Å –∫—É–ª–¥–∞—É–Ω–æ–º 5 —Å–µ–∫
        let cooldownInterval = null;
        function collectTax() {
            const now = Date.now();
            const timeSince = now - gameState.lastTaxTime;
            if (timeSince < gameState.taxCooldown) return;

            let total = 0;
            for (let r = 0; r < gameState.gridSize; r++) {
                for (let c = 0; c < gameState.gridSize; c++) {
                    if (gameState.land[r][c] && gameState.grid[r][c] !== 'empty') {
                        total += BUILDINGS[gameState.grid[r][c]].income;
                    }
                }
            }
            gameState.balance += total;
            gameState.lastTaxTime = now;
            updateUI();
            saveGame();
            document.getElementById('infoPanel').innerHTML = `üí∞ –°–æ–±—Ä–∞–Ω–æ ${total} –º–æ–Ω–µ—Ç!`;

            // –ê–Ω–∏–º–∞—Ü–∏—è –º–æ–Ω–µ—Ç (–ø—Ä–æ—Å—Ç–∞—è)
            for (let i = 0; i < 5; i++) {
                setTimeout(() => {
                    if (tg) tg.HapticFeedback.impactOccurred('light');
                }, i*50);
            }

            // –ó–∞–ø—É—Å–∫ –≤–∏–∑—É–∞–ª—å–Ω–æ–≥–æ –∫—É–ª–¥–∞—É–Ω–∞
            startCooldown();
        }

        function startCooldown() {
            const btn = document.getElementById('collectBtn');
            const overlay = document.getElementById('cooldownOverlay');
            const startTime = Date.now();
            const endTime = startTime + gameState.taxCooldown;

            btn.disabled = true;

            function updateCooldown() {
                const now = Date.now();
                const remaining = endTime - now;
                if (remaining <= 0) {
                    btn.disabled = false;
                    overlay.style.width = '0%';
                    clearInterval(cooldownInterval);
                    return;
                }
                const percent = ((gameState.taxCooldown - remaining) / gameState.taxCooldown) * 100;
                overlay.style.width = percent + '%';
            }
            updateCooldown();
            cooldownInterval = setInterval(updateCooldown, 50);
        }

        function expandIsland() {
            if (gameState.balance < gameState.expandCost) {
                alert('–ù–µ —Ö–≤–∞—Ç–∞–µ—Ç –º–æ–Ω–µ—Ç');
                return;
            }
            let candidates = [];
            for (let r = 0; r < gameState.gridSize; r++) {
                for (let c = 0; c < gameState.gridSize; c++) {
                    if (!gameState.land[r][c]) {
                        const neighbors = [[-1,0],[1,0],[0,-1],[0,1]];
                        for (let [dr, dc] of neighbors) {
                            let nr = r+dr, nc = c+dc;
                            if (nr>=0 && nr<gameState.gridSize && nc>=0 && nc<gameState.gridSize && gameState.land[nr][nc]) {
                                candidates.push([r,c]);
                                break;
                            }
                        }
                    }
                }
            }
            if (candidates.length === 0) {
                alert('–ù–µ—Ç –¥–æ—Å—Ç—É–ø–Ω–æ–π –≤–æ–¥—ã –¥–ª—è —Ä–∞—Å—à–∏—Ä–µ–Ω–∏—è');
                return;
            }
            const [rr, cc] = candidates[Math.floor(Math.random() * candidates.length)];
            gameState.balance -= gameState.expandCost;
            gameState.land[rr][cc] = true;
            gameState.grid[rr][cc] = 'empty';
            updateUI();
            drawCity();
            saveGame();
            document.getElementById('infoPanel').innerHTML = 'üåä‚û°Ô∏èüèùÔ∏è –ù–æ–≤–∞—è –∑–µ–º–ª—è!';
        }

        function updateUI() {
            document.getElementById('moneyDisplay').innerText = gameState.balance;
            document.getElementById('popDisplay').innerText = gameState.population;
            let totalIncome = 0;
            for (let r = 0; r < gameState.gridSize; r++) {
                for (let c = 0; c < gameState.gridSize; c++) {
                    if (gameState.land[r][c] && gameState.grid[r][c] !== 'empty') {
                        totalIncome += BUILDINGS[gameState.grid[r][c]].income;
                    }
                }
            }
            document.getElementById('incomeDisplay').innerText = totalIncome;
            let landCount = 0;
            for (let r = 0; r < gameState.gridSize; r++) {
                for (let c = 0; c < gameState.gridSize; c++) {
                    if (gameState.land[r][c]) landCount++;
                }
            }
            document.getElementById('landDisplay').innerText = landCount;
        }

        const categories = {
            residential: ['house1', 'house2', 'house3', 'skyscraper'],
            commercial: ['shop', 'office'],
            infra: ['school', 'hospital', 'park', 'road', 'powerplant']
        };
        let currentCategory = 'residential';

        function renderBuildings(category) {
            const track = document.getElementById('buildTrack');
            track.innerHTML = '';
            const keys = categories[category];
            keys.forEach(key => {
                const b = BUILDINGS[key];
                const card = document.createElement('div');
                card.className = 'build-card';
                card.setAttribute('data-type', key);
                card.innerHTML = `
                    <div class="card-preview">${b.name === '–î–æ—Ä–æ–≥–∞' ? 'üõ£Ô∏è' : (b.name === '–ü–∞—Ä–∫' ? 'üå≥' : (b.name === '–≠–ª–µ–∫—Ç—Ä–æ' ? '‚ö°' : (b.name === '–®–∫–æ–ª–∞' ? 'üìö' : (b.name === '–ë–æ–ª—å–Ω–∏—Ü–∞' ? 'üè•' : (b.name === '–ú–∞–≥–∞–∑–∏–Ω' ? 'üè™' : (b.name === '–û—Ñ–∏—Å' ? 'üèõÔ∏è' : (b.name.includes('–ù–µ–±–æ') ? 'üèôÔ∏è' : (b.name.includes('–ú–Ω–æ–≥–æ') ? 'üè¢' : (b.name.includes('–ö–æ—Ç') ? 'üè°' : 'üè†')))))))))}</div>
                    <div class="card-name">${b.name}</div>
                    <div class="card-price">${b.price}üí∞</div>
                `;
                card.addEventListener('click', (e) => {
                    e.stopPropagation();
                    document.querySelectorAll('.build-card').forEach(c => c.classList.remove('selected'));
                    card.classList.add('selected');
                    gameState.selectedBuilding = key;
                    document.getElementById('infoPanel').innerHTML = `–í—ã–±—Ä–∞–Ω–æ: ${b.name}`;
                });
                track.appendChild(card);
            });
        }

        document.getElementById('tabResidential').addEventListener('click', () => {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.getElementById('tabResidential').classList.add('active');
            currentCategory = 'residential';
            renderBuildings('residential');
        });
        document.getElementById('tabCommercial').addEventListener('click', () => {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.getElementById('tabCommercial').classList.add('active');
            currentCategory = 'commercial';
            renderBuildings('commercial');
        });
        document.getElementById('tabInfra').addEventListener('click', () => {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.getElementById('tabInfra').classList.add('active');
            currentCategory = 'infra';
            renderBuildings('infra');
        });

        function saveGame() {
            if (tg) {
                tg.sendData(JSON.stringify({
                    balance: gameState.balance,
                    grid: gameState.grid,
                    land: gameState.land,
                    population: gameState.population
                }));
            }
            localStorage.setItem('islandEmpire3D', JSON.stringify(gameState));
        }

        function loadGame() {
            const saved = localStorage.getItem('islandEmpire3D');
            if (saved) {
                try {
                    const data = JSON.parse(saved);
                    gameState = {...gameState, ...data};
                } catch(e) {}
            }
            updateUI();
            drawCity();
        }

        renderBuildings('residential');
        loadGame();

        document.getElementById('collectBtn').addEventListener('click', collectTax);
        document.getElementById('expandBtn').addEventListener('click', expandIsland);
        document.getElementById('cancelBtn').addEventListener('click', () => {
            gameState.selectedBuilding = null;
            document.querySelectorAll('.build-card').forEach(c => c.classList.remove('selected'));
            document.getElementById('infoPanel').innerHTML = '–í—ã–±–æ—Ä –æ—Ç–º–µ–Ω—ë–Ω';
        });

        setInterval(() => {
            drawCity();
            saveGame();
        }, 100);
    })();
</script>
</body>
</html>
