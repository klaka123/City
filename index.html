<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>3D MEGA CITY - –†–ï–ê–õ–ò–°–¢–ò–ß–ù–ê–Ø –ì–†–ê–§–ò–ö–ê</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Roboto, 'Helvetica Neue', sans-serif;
            user-select: none;
        }

        body {
            background: #0a0f1a;
            overflow: hidden;
            touch-action: none;
        }

        .game-container {
            position: relative;
            width: 100vw;
            height: 100vh;
            overflow: hidden;
            background: #0a1a2a;
        }

        #gameCanvas {
            display: block;
            width: 100%;
            height: 100%;
            cursor: grab;
            touch-action: none;
        }

        #gameCanvas:active {
            cursor: grabbing;
        }

        /* –ò–Ω—Ç–µ—Ä—Ñ–µ–π—Å –ø–æ–≤–µ—Ä—Ö 3D */
        .ui-panel {
            position: fixed;
            bottom: 30px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(20, 30, 40, 0.85);
            backdrop-filter: blur(15px);
            border-radius: 70px;
            padding: 20px 40px;
            display: flex;
            gap: 40px;
            border: 2px solid rgba(255,255,255,0.2);
            box-shadow: 0 20px 40px rgba(0,0,0,0.7);
            z-index: 100;
            border-bottom: 4px solid #4a9ec0;
        }

        .stat-item {
            display: flex;
            align-items: center;
            gap: 15px;
            color: white;
            font-size: 28px;
            font-weight: 600;
            text-shadow: 0 2px 5px black;
            background: rgba(0,0,0,0.3);
            padding: 8px 25px;
            border-radius: 50px;
        }

        .stat-icon {
            font-size: 40px;
            filter: drop-shadow(0 4px 6px black);
        }

        .build-menu {
            position: fixed;
            top: 50%;
            left: 25px;
            transform: translateY(-50%);
            width: 400px;
            max-height: 85vh;
            background: rgba(15, 25, 35, 0.95);
            backdrop-filter: blur(15px);
            border-radius: 40px;
            padding: 20px;
            border: 2px solid rgba(255,255,255,0.2);
            box-shadow: 0 25px 50px rgba(0,0,0,0.8);
            z-index: 100;
            display: flex;
            flex-direction: column;
        }

        .menu-header {
            color: white;
            font-size: 24px;
            font-weight: 700;
            padding: 15px;
            background: rgba(255,255,255,0.1);
            border-radius: 30px;
            text-align: center;
            margin-bottom: 20px;
            border-bottom: 3px solid #4a9ec0;
        }

        .category-tabs {
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
            margin-bottom: 20px;
            justify-content: center;
        }

        .cat-tab {
            background: rgba(255,255,255,0.1);
            border: none;
            border-radius: 30px;
            padding: 8px 12px;
            color: white;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: 0.2s;
            border: 1px solid rgba(255,255,255,0.2);
        }

        .cat-tab:hover {
            background: rgba(255,255,255,0.2);
        }

        .cat-tab.active {
            background: #ffb84d;
            color: #1e3e55;
            border-color: #ff9f1c;
        }

        .buildings-list {
            flex: 1;
            overflow-y: auto;
            padding-right: 8px;
            scrollbar-width: thin;
            scrollbar-color: #4a9ec0 #1f3f55;
        }

        .buildings-list::-webkit-scrollbar {
            width: 8px;
        }

        .buildings-list::-webkit-scrollbar-thumb {
            background: #4a9ec0;
            border-radius: 10px;
        }

        .build-item {
            background: rgba(255,255,255,0.08);
            border-radius: 25px;
            padding: 12px;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 15px;
            cursor: pointer;
            transition: 0.2s;
            border: 2px solid transparent;
        }

        .build-item:hover {
            background: rgba(255,255,255,0.15);
            transform: translateX(5px);
        }

        .build-item.selected {
            border-color: #ffb84d;
            background: rgba(255,184,77,0.15);
        }

        .item-icon {
            width: 50px;
            height: 50px;
            background: rgba(255,255,255,0.1);
            border-radius: 25px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 30px;
        }

        .item-info {
            flex: 1;
        }

        .item-name {
            color: white;
            font-size: 16px;
            font-weight: 600;
        }

        .item-price {
            color: #ffd966;
            font-size: 14px;
            margin-top: 4px;
        }

        .control-menu {
            position: fixed;
            top: 50%;
            right: 25px;
            transform: translateY(-50%);
            background: rgba(15, 25, 35, 0.95);
            backdrop-filter: blur(15px);
            border-radius: 40px;
            padding: 25px;
            display: flex;
            flex-direction: column;
            gap: 15px;
            border: 2px solid rgba(255,255,255,0.2);
            box-shadow: 0 25px 50px rgba(0,0,0,0.8);
            z-index: 100;
            min-width: 200px;
        }

        .control-btn {
            background: rgba(255,255,255,0.1);
            border: none;
            border-radius: 40px;
            padding: 18px;
            color: white;
            font-size: 20px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 12px;
            cursor: pointer;
            transition: 0.2s;
            border: 2px solid rgba(255,255,255,0.15);
        }

        .control-btn:hover {
            background: rgba(255,255,255,0.2);
            transform: translateX(-5px);
        }

        .control-btn.collect {
            background: rgba(46,125,50,0.4);
            border-color: #4caf50;
        }

        .control-btn.cancel {
            background: rgba(198,40,40,0.4);
            border-color: #f44336;
        }

        .info-panel {
            position: fixed;
            top: 25px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(15, 25, 35, 0.95);
            backdrop-filter: blur(15px);
            border-radius: 50px;
            padding: 15px 40px;
            color: white;
            font-size: 22px;
            border: 2px solid rgba(255,255,255,0.2);
            z-index: 100;
            text-align: center;
            min-width: 500px;
            border-top: 4px solid #4a9ec0;
        }

        .notification {
            position: fixed;
            top: 100px;
            right: 30px;
            background: rgba(0,0,0,0.95);
            backdrop-filter: blur(15px);
            color: white;
            padding: 18px 35px;
            border-radius: 60px;
            font-size: 18px;
            z-index: 2000;
            animation: slideIn 0.3s ease;
            border: 2px solid #ffb84d;
        }

        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
    </style>
</head>
<body>
<div class="game-container">
    <canvas id="gameCanvas"></canvas>

    <!-- –ò–Ω—Ç–µ—Ä—Ñ–µ–π—Å -->
    <div class="ui-panel">
        <div class="stat-item"><span class="stat-icon">üí∞</span><span id="moneyDisplay">5,000,000</span></div>
        <div class="stat-item"><span class="stat-icon">üèóÔ∏è</span><span id="buildingsCount">0</span></div>
        <div class="stat-item"><span class="stat-icon">üìä</span><span id="incomeDisplay">0</span></div>
        <div class="stat-item"><span class="stat-icon">‚≠ê</span><span id="levelDisplay">1</span></div>
    </div>

    <div class="build-menu">
        <div class="menu-header">üèóÔ∏è 3D –ö–ê–¢–ê–õ–û–ì (2240 –ó–î–ê–ù–ò–ô)</div>
        <div class="category-tabs" id="categoryTabs"></div>
        <div class="buildings-list" id="buildingsList"></div>
    </div>

    <div class="control-menu">
        <button class="control-btn collect" id="collectBtn"><span>üí∞</span> –°–ë–û–†</button>
        <button class="control-btn" id="rotateBtn"><span>üîÑ</span> –ü–û–í–û–†–û–¢</button>
        <button class="control-btn" id="lightBtn"><span>üí°</span> –°–í–ï–¢</button>
        <button class="control-btn cancel" id="cancelBtn"><span>‚ùå</span> –û–¢–ú–ï–ù–ê</button>
        <button class="control-btn" id="resetBtn"><span>üîÑ</span> –ù–û–í–´–ô –ì–û–†–û–î</button>
    </div>

    <div class="info-panel" id="infoPanel">üëÜ –í–´–ë–ï–†–ò–¢–ï –ó–î–ê–ù–ò–ï –ò –ù–ê–ñ–ú–ò–¢–ï –ù–ê –ö–ê–†–¢–£</div>
</div>

<script>
(function() {
    // ==================== 3D –ù–ê–°–¢–†–û–ô–ö–ò ====================
    const GRID_SIZE = 10; // 10x10 –¥–ª—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
    const CELL_SIZE = 80;
    const GROUND_HEIGHT = 0;
    
    // –£–≥–æ–ª –æ–±–∑–æ—Ä–∞ (3D)
    let cameraAngle = 0.3;
    let cameraElevation = 0.4;
    let cameraDistance = 600;
    
    // –°–æ—Å—Ç–æ—è–Ω–∏–µ –∏–≥—Ä—ã
    const gameState = {
        money: 5000000,
        grid: [],
        selectedBuilding: null,
        buildingsCount: 0,
        lastTaxTime: Date.now(),
        lightIntensity: 1.0,
    };

    // –°–æ–∑–¥–∞–µ–º —Å–µ—Ç–∫—É
    for (let i = 0; i < GRID_SIZE; i++) {
        gameState.grid[i] = [];
        for (let j = 0; j < GRID_SIZE; j++) {
            gameState.grid[i][j] = null;
        }
    }

    // ==================== –ì–ï–ù–ï–†–ê–¶–ò–Ø 2240 –£–ù–ò–ö–ê–õ–¨–ù–´–• 3D –ó–î–ê–ù–ò–ô ====================
    const buildingTypes = [];
    
    const buildingStyles = [
        { baseColor: '#e3b27c', roofColor: '#b54c4c', windows: 2, height: 40 }, // –î–æ–º
        { baseColor: '#cf9f6b', roofColor: '#8b5a2b', windows: 3, height: 50 }, // –ö–æ—Ç—Ç–µ–¥–∂
        { baseColor: '#b0bec5', roofColor: '#607d8b', windows: 4, height: 70 }, // –û—Ñ–∏—Å
        { baseColor: '#ffb74d', roofColor: '#ff9800', windows: 2, height: 45 }, // –ú–∞–≥–∞–∑–∏–Ω
        { baseColor: '#ef9a9a', roofColor: '#e57373', windows: 3, height: 60 }, // –ë–æ–ª—å–Ω–∏—Ü–∞
        { baseColor: '#81c784', roofColor: '#4caf50', windows: 2, height: 35 }, // –ü–∞—Ä–∫
        { baseColor: '#ba68c8', roofColor: '#9c27b0', windows: 3, height: 55 }, // –®–∫–æ–ª–∞
        { baseColor: '#ff8a65', roofColor: '#ff5722', windows: 2, height: 40 }, // –†–µ—Å—Ç–æ—Ä–∞–Ω
    ];

    const prefixes = [
        '–£—é—Ç–Ω—ã–π', '–ë–æ–ª—å—à–æ–π', '–û–≥—Ä–æ–º–Ω—ã–π', '–ì–∏–≥–∞–Ω—Ç—Å–∫–∏–π', '–ú–∏–Ω–∏–∞—Ç—é—Ä–Ω—ã–π',
        '–°—Ç–∞—Ä–∏–Ω–Ω—ã–π', '–°–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–π', '–ö–ª–∞—Å—Å–∏—á–µ—Å–∫–∏–π', '–≠–ª–∏—Ç–Ω—ã–π', '–ë—é–¥–∂–µ—Ç–Ω—ã–π',
        '–°–µ–≤–µ—Ä–Ω—ã–π', '–Æ–∂–Ω—ã–π', '–ó–∞–ø–∞–¥–Ω—ã–π', '–í–æ—Å—Ç–æ—á–Ω—ã–π', '–¶–µ–Ω—Ç—Ä–∞–ª—å–Ω—ã–π',
        '–°—Ç–µ–∫–ª—è–Ω–Ω—ã–π', '–ö–∞–º–µ–Ω–Ω—ã–π', '–ö–∏—Ä–ø–∏—á–Ω—ã–π', '–î–µ—Ä–µ–≤—è–Ω–Ω—ã–π', '–ú–µ—Ç–∞–ª–ª–∏—á–µ—Å–∫–∏–π'
    ];

    const suffixes = [
        '–î–æ–º', '–ö–æ—Ç—Ç–µ–¥–∂', '–û—Å–æ–±–Ω—è–∫', '–†–µ–∑–∏–¥–µ–Ω—Ü–∏—è', '–í–∏–ª–ª–∞',
        '–û—Ñ–∏—Å', '–¶–µ–Ω—Ç—Ä', '–ö–æ–º–ø–ª–µ–∫—Å', '–ë–∞—à–Ω—è', '–î–≤–æ—Ä–µ—Ü',
        '–ú–∞–≥–∞–∑–∏–Ω', '–ë—É—Ç–∏–∫', '–¢–¶', '–†—ã–Ω–æ–∫', '–°—É–ø–µ—Ä–º–∞—Ä–∫–µ—Ç',
        '–ó–∞–≤–æ–¥', '–§–∞–±—Ä–∏–∫–∞', '–¶–µ—Ö', '–ö–æ–º–±–∏–Ω–∞—Ç', '–°–∫–ª–∞–¥'
    ];

    // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –∑–¥–∞–Ω–∏—è
    for (let style = 0; style < buildingStyles.length; style++) {
        for (let i = 0; i < 280; i++) {
            const prefix = prefixes[i % prefixes.length];
            const suffix = suffixes[i % suffixes.length];
            const styleData = buildingStyles[style];
            
            const name = `${prefix} ${suffix}`;
            const price = 1000 + (style * 500) + (i * 20);
            const income = 50 + Math.floor(price * 0.03);

            buildingTypes.push({
                id: buildingTypes.length,
                name: name,
                price: price,
                income: income,
                style: style,
                baseColor: styleData.baseColor,
                roofColor: styleData.roofColor,
                windows: styleData.windows,
                height: styleData.height,
                emoji: ['üè†','üè¢','üè™','üè•','üè´','üèõÔ∏è','üè≠','üè∞'][style % 8]
            });
        }
    }

    console.log(`‚úÖ –°–æ–∑–¥–∞–Ω–æ 3D –∑–¥–∞–Ω–∏–π: ${buildingTypes.length}`);

    // ==================== 3D –†–ï–ù–î–ï–†–ò–ù–ì ====================
    const canvas = document.getElementById('gameCanvas');
    const ctx = canvas.getContext('2d');

    function resizeCanvas() {
        canvas.width = window.innerWidth;
        canvas.height = window.innerHeight;
        draw3DCity();
    }

    window.addEventListener('resize', resizeCanvas);
    resizeCanvas();

    // 3D –ø—Ä–æ–µ–∫—Ü–∏—è (–∏–∑–æ–º–µ—Ç—Ä–∏—á–µ—Å–∫–∞—è —Å –ø–µ—Ä—Å–ø–µ–∫—Ç–∏–≤–æ–π)
    function project3D(x, y, z) {
        const scale = 1;
        const rotX = x * Math.cos(cameraAngle) - z * Math.sin(cameraAngle);
        const rotZ = x * Math.sin(cameraAngle) + z * Math.cos(cameraAngle);
        
        const screenX = canvas.width / 2 + rotX * scale;
        const screenY = canvas.height / 3 + y * scale - rotZ * Math.sin(cameraElevation) * scale;
        
        return { x: screenX, y: screenY, z: rotZ };
    }

    // –†–∏—Å—É–µ–º –∫—É–± —Å —Ç–µ–∫—Å—Ç—É—Ä–∞–º–∏
    function draw3DCube(x, y, z, width, height, depth, color, roofColor, windows) {
        const w = width / 2;
        const h = height;
        const d = depth / 2;
        
        // –¢–µ–Ω–∏
        ctx.shadowColor = 'rgba(0,0,0,0.5)';
        ctx.shadowBlur = 15;
        ctx.shadowOffsetX = 5;
        ctx.shadowOffsetY = 5;

        // –ü–µ—Ä–µ–¥–Ω—è—è –≥—Ä–∞–Ω—å
        const p1 = project3D(x - w, y, z + d);
        const p2 = project3D(x + w, y, z + d);
        const p3 = project3D(x + w, y - h, z + d);
        const p4 = project3D(x - w, y - h, z + d);
        
        ctx.beginPath();
        ctx.moveTo(p1.x, p1.y);
        ctx.lineTo(p2.x, p2.y);
        ctx.lineTo(p3.x, p3.y);
        ctx.lineTo(p4.x, p4.y);
        ctx.closePath();
        
        // –ì—Ä–∞–¥–∏–µ–Ω—Ç –¥–ª—è –æ–±—ä–µ–º–∞
        const grad = ctx.createLinearGradient(p1.x, p1.y, p3.x, p3.y);
        grad.addColorStop(0, color);
        grad.addColorStop(1, shadeColor(color, -40));
        ctx.fillStyle = grad;
        ctx.fill();
        ctx.strokeStyle = 'rgba(0,0,0,0.3)';
        ctx.stroke();

        // –û–∫–Ω–∞
        if (windows > 0) {
            ctx.fillStyle = '#f9e076';
            ctx.shadowBlur = 10;
            ctx.shadowColor = '#ffd700';
            for (let i = 0; i < windows; i++) {
                const wx = x - w/2 + (i * w/windows);
                const wy = y - h/2;
                const wp1 = project3D(wx, wy, z + d + 1);
                ctx.fillRect(wp1.x - 5, wp1.y - 10, 10, 15);
            }
        }

        // –ö—Ä—ã—à–∞ (–ø–∏—Ä–∞–º–∏–¥–∞)
        const roofTop = project3D(x, y - h - 15, z + d/2);
        ctx.beginPath();
        ctx.moveTo(p2.x, p2.y);
        ctx.lineTo(p3.x, p3.y);
        ctx.lineTo(roofTop.x, roofTop.y);
        ctx.closePath();
        ctx.fillStyle = roofColor;
        ctx.fill();
        
        ctx.beginPath();
        ctx.moveTo(p3.x, p3.y);
        ctx.lineTo(p4.x, p4.y);
        ctx.lineTo(roofTop.x, roofTop.y);
        ctx.closePath();
        ctx.fill();

        // –ü—Ä–∞–≤–∞—è –≥—Ä–∞–Ω—å
        const pr1 = project3D(x + w, y, z - d);
        const pr2 = project3D(x + w, y, z + d);
        const pr3 = project3D(x + w, y - h, z + d);
        const pr4 = project3D(x + w, y - h, z - d);
        
        ctx.beginPath();
        ctx.moveTo(pr1.x, pr1.y);
        ctx.lineTo(pr2.x, pr2.y);
        ctx.lineTo(pr3.x, pr3.y);
        ctx.lineTo(pr4.x, pr4.y);
        ctx.closePath();
        
        const grad2 = ctx.createLinearGradient(pr1.x, pr1.y, pr4.x, pr4.y);
        grad2.addColorStop(0, shadeColor(color, -20));
        grad2.addColorStop(1, shadeColor(color, -60));
        ctx.fillStyle = grad2;
        ctx.fill();
        ctx.stroke();

        // –¢–µ–Ω—å –Ω–∞ –∑–µ–º–ª–µ
        ctx.shadowBlur = 20;
        ctx.shadowColor = 'rgba(0,0,0,0.4)';
        ctx.fillStyle = 'rgba(0,0,0,0.1)';
        ctx.beginPath();
        ctx.ellipse(x, z, width/2, depth/4, 0, 0, Math.PI*2);
        ctx.fill();
        
        ctx.shadowBlur = 0;
        ctx.shadowOffsetX = 0;
        ctx.shadowOffsetY = 0;
    }

    function shadeColor(color, percent) {
        let R = parseInt(color.substring(1,3), 16);
        let G = parseInt(color.substring(3,5), 16);
        let B = parseInt(color.substring(5,7), 16);
        R = Math.min(255, Math.max(0, R + percent));
        G = Math.min(255, Math.max(0, G + percent));
        B = Math.min(255, Math.max(0, B + percent));
        return `#${((1 << 24) + (R << 16) + (G << 8) + B).toString(16).slice(1)}`;
    }

    // –†–∏—Å—É–µ–º –∑–µ–º–ª—é (—Å–µ—Ç–∫–∞)
    function drawGround() {
        const groundColor = '#5f8b5f';
        const lineColor = '#3a6b3a';
        
        for (let i = -1; i <= GRID_SIZE; i++) {
            for (let j = -1; j <= GRID_SIZE; j++) {
                const x = (j - GRID_SIZE/2) * CELL_SIZE;
                const z = (i - GRID_SIZE/2) * CELL_SIZE;
                
                const p1 = project3D(x, GROUND_HEIGHT, z);
                const p2 = project3D(x + CELL_SIZE, GROUND_HEIGHT, z);
                const p3 = project3D(x + CELL_SIZE, GROUND_HEIGHT, z + CELL_SIZE);
                const p4 = project3D(x, GROUND_HEIGHT, z + CELL_SIZE);
                
                ctx.beginPath();
                ctx.moveTo(p1.x, p1.y);
                ctx.lineTo(p2.x, p2.y);
                ctx.lineTo(p3.x, p3.y);
                ctx.lineTo(p4.x, p4.y);
                ctx.closePath();
                
                const grad = ctx.createLinearGradient(p1.x, p1.y, p3.x, p3.y);
                grad.addColorStop(0, groundColor);
                grad.addColorStop(1, shadeColor(groundColor, -30));
                ctx.fillStyle = grad;
                ctx.fill();
                
                ctx.strokeStyle = lineColor;
                ctx.lineWidth = 1;
                ctx.stroke();

                // –ù–æ–º–µ—Ä –∫–ª–µ—Ç–∫–∏
                const center = project3D(x + CELL_SIZE/2, GROUND_HEIGHT + 5, z + CELL_SIZE/2);
                ctx.font = '14px Arial';
                ctx.fillStyle = '#ffffff';
                ctx.shadowColor = '#000000';
                ctx.shadowBlur = 5;
                ctx.fillText(`${i},${j}`, center.x - 15, center.y - 5);
                ctx.shadowBlur = 0;
            }
        }
    }

    // ==================== –û–°–ù–û–í–ù–ê–Ø –û–¢–†–ò–°–û–í–ö–ê ====================
    function draw3DCity() {
        ctx.clearRect(0, 0, canvas.width, canvas.height);

        // –ù–µ–±–æ —Å –≥—Ä–∞–¥–∏–µ–Ω—Ç–æ–º
        const skyGrad = ctx.createLinearGradient(0, 0, 0, canvas.height);
        skyGrad.addColorStop(0, '#1a3344');
        skyGrad.addColorStop(1, '#4a7a9c');
        ctx.fillStyle = skyGrad;
        ctx.fillRect(0, 0, canvas.width, canvas.height);

        // –°–æ–ª–Ω—Ü–µ
        ctx.shadowBlur = 50;
        ctx.shadowColor = '#fff9c4';
        ctx.beginPath();
        ctx.arc(150, 100, 50, 0, Math.PI*2);
        ctx.fillStyle = '#fff3b0';
        ctx.fill();
        ctx.shadowBlur = 0;

        // –†–∏—Å—É–µ–º –∑–µ–º–ª—é
        drawGround();

        // –†–∏—Å—É–µ–º –∑–¥–∞–Ω–∏—è
        for (let row = 0; row < GRID_SIZE; row++) {
            for (let col = 0; col < GRID_SIZE; col++) {
                const building = gameState.grid[row][col];
                if (building !== null) {
                    const type = buildingTypes[building.type];
                    const x = (col - GRID_SIZE/2) * CELL_SIZE;
                    const z = (row - GRID_SIZE/2) * CELL_SIZE;
                    
                    draw3DCube(
                        x, GROUND_HEIGHT, z,
                        CELL_SIZE * 0.7,
                        type.height,
                        CELL_SIZE * 0.7,
                        type.baseColor,
                        type.roofColor,
                        type.windows
                    );
                }
            }
        }

        // –ü–æ–¥—Å–≤–µ—Ç–∫–∞ –≤—ã–±—Ä–∞–Ω–Ω–æ–π –∫–ª–µ—Ç–∫–∏
        if (selectedRow !== -1 && selectedCol !== -1) {
            const x = (selectedCol - GRID_SIZE/2) * CELL_SIZE;
            const z = (selectedRow - GRID_SIZE/2) * CELL_SIZE;
            
            for (let i = 0; i < 4; i++) {
                const corner1 = project3D(x + (i%2)*CELL_SIZE, GROUND_HEIGHT + 2, z + (i<2?0:CELL_SIZE));
                const corner2 = project3D(x + ((i+1)%2)*CELL_SIZE, GROUND_HEIGHT + 2, z + ((i+1)<2?0:CELL_SIZE));
                
                ctx.beginPath();
                ctx.moveTo(corner1.x, corner1.y);
                ctx.lineTo(corner2.x, corner2.y);
                ctx.strokeStyle = '#ffd700';
                ctx.lineWidth = 3;
                ctx.shadowBlur = 10;
                ctx.shadowColor = '#ffd700';
                ctx.stroke();
            }
        }
    }

    // ==================== –í–ó–ê–ò–ú–û–î–ï–ô–°–¢–í–ò–ï ====================
    let selectedRow = -1, selectedCol = -1;

    function getGridFromClick(mouseX, mouseY) {
        let bestDist = Infinity;
        let bestRow = -1, bestCol = -1;
        
        for (let row = 0; row < GRID_SIZE; row++) {
            for (let col = 0; col < GRID_SIZE; col++) {
                const x = (col - GRID_SIZE/2) * CELL_SIZE;
                const z = (row - GRID_SIZE/2) * CELL_SIZE;
                const center = project3D(x + CELL_SIZE/2, GROUND_HEIGHT + 10, z + CELL_SIZE/2);
                
                const dist = Math.hypot(mouseX - center.x, mouseY - center.y);
                if (dist < bestDist && dist < 50) {
                    bestDist = dist;
                    bestRow = row;
                    bestCol = col;
                }
            }
        }
        return { row: bestRow, col: bestCol };
    }

    canvas.addEventListener('click', (e) => {
        const rect = canvas.getBoundingClientRect();
        const mouseX = e.clientX - rect.left;
        const mouseY = e.clientY - rect.top;
        
        const { row, col } = getGridFromClick(mouseX, mouseY);
        
        if (row !== -1 && col !== -1) {
            selectedRow = row;
            selectedCol = col;
            
            if (gameState.selectedBuilding !== null) {
                // –°—Ç—Ä–æ–∏–º
                const type = buildingTypes[gameState.selectedBuilding];
                
                if (gameState.money < type.price) {
                    showNotification(`‚ùå –ù—É–∂–Ω–æ ${type.price.toLocaleString()}üí∞`, 'error');
                    return;
                }
                
                if (gameState.grid[row][col] !== null) {
                    showNotification('‚ùå –ö–ª–µ—Ç–∫–∞ –∑–∞–Ω—è—Ç–∞!', 'error');
                    return;
                }
                
                gameState.money -= type.price;
                gameState.grid[row][col] = { type: gameState.selectedBuilding };
                gameState.buildingsCount++;
                
                updateUI();
                draw3DCity();
                showNotification(`‚úÖ –ü–æ—Å—Ç—Ä–æ–µ–Ω–æ: ${type.name}`, 'success');
            } else {
                // –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è
                const building = gameState.grid[row][col];
                if (building) {
                    const type = buildingTypes[building.type];
                    showNotification(`${type.emoji} ${type.name} | –î–æ—Ö–æ–¥: ${type.income}üí∞`, 'info');
                }
            }
        }
    });

    // ==================== –£–ü–†–ê–í–õ–ï–ù–ò–ï –ö–ê–ú–ï–†–û–ô ====================
    let isDragging = false;
    let lastMouseX = 0;

    canvas.addEventListener('mousedown', (e) => {
        isDragging = true;
        lastMouseX = e.clientX;
    });

    canvas.addEventListener('mousemove', (e) => {
        if (isDragging) {
            const deltaX = e.clientX - lastMouseX;
            cameraAngle += deltaX * 0.01;
            lastMouseX = e.clientX;
            draw3DCity();
        }
    });

    canvas.addEventListener('mouseup', () => {
        isDragging = false;
    });

    canvas.addEventListener('wheel', (e) => {
        e.preventDefault();
        cameraDistance = Math.max(300, Math.min(1000, cameraDistance + e.deltaY * 0.5));
        draw3DCity();
    });

    // ==================== –û–ë–ù–û–í–õ–ï–ù–ò–ï UI ====================
    function updateUI() {
        document.getElementById('moneyDisplay').innerText = gameState.money.toLocaleString();
        document.getElementById('buildingsCount').innerText = gameState.buildingsCount;
        
        let totalIncome = 0;
        for (let row = 0; row < GRID_SIZE; row++) {
            for (let col = 0; col < GRID_SIZE; col++) {
                if (gameState.grid[row][col]) {
                    totalIncome += buildingTypes[gameState.grid[row][col].type].income;
                }
            }
        }
        document.getElementById('incomeDisplay').innerText = totalIncome;
        document.getElementById('levelDisplay').innerText = Math.floor(gameState.buildingsCount / 5) + 1;
    }

    function showNotification(msg, type) {
        const notif = document.createElement('div');
        notif.className = 'notification';
        notif.textContent = msg;
        document.body.appendChild(notif);
        setTimeout(() => notif.remove(), 3000);
    }

    // ==================== –ú–ï–ù–Æ ====================
    function buildMenu() {
        const tabs = document.getElementById('categoryTabs');
        const list = document.getElementById('buildingsList');

        // –ö–Ω–æ–ø–∫–∞ "–í—Å–µ"
        const allBtn = document.createElement('button');
        allBtn.className = 'cat-tab active';
        allBtn.dataset.cat = 'all';
        allBtn.textContent = 'üèÅ –í–°–ï';
        tabs.appendChild(allBtn);

        // –ö–∞—Ç–µ–≥–æ—Ä–∏–∏ –ø–æ —Å—Ç–∏–ª—è–º
        for (let i = 0; i < buildingStyles.length; i++) {
            const btn = document.createElement('button');
            btn.className = 'cat-tab';
            btn.dataset.cat = i;
            btn.textContent = `üèóÔ∏è –°—Ç–∏–ª—å ${i+1}`;
            tabs.appendChild(btn);
        }

        function showCategory(catId) {
            list.innerHTML = '';
            let filtered = buildingTypes;
            if (catId !== 'all') {
                filtered = buildingTypes.filter(b => b.style == catId);
            }
            
            filtered.forEach(b => {
                const item = document.createElement('div');
                item.className = 'build-item';
                item.innerHTML = `
                    <div class="item-icon">${b.emoji}</div>
                    <div class="item-info">
                        <div class="item-name">${b.name}</div>
                        <div class="item-price">üí∞ ${b.price.toLocaleString()}</div>
                    </div>
                `;
                item.onclick = () => {
                    document.querySelectorAll('.build-item').forEach(i => i.classList.remove('selected'));
                    item.classList.add('selected');
                    gameState.selectedBuilding = b.id;
                    document.getElementById('infoPanel').innerHTML = `–í—ã–±—Ä–∞–Ω–æ: ${b.name}`;
                };
                list.appendChild(item);
            });
        }

        document.querySelectorAll('.cat-tab').forEach(tab => {
            tab.onclick = () => {
                document.querySelectorAll('.cat-tab').forEach(t => t.classList.remove('active'));
                tab.classList.add('active');
                showCategory(tab.dataset.cat);
            };
        });

        showCategory('all');
    }

    // ==================== –ö–ù–û–ü–ö–ò ====================
    document.getElementById('collectBtn').onclick = () => {
        const now = Date.now();
        if (now - gameState.lastTaxTime < 5000) {
            showNotification('‚è≥ –ü–æ–¥–æ–∂–¥–∏—Ç–µ 5 —Å–µ–∫—É–Ω–¥!', 'warning');
            return;
        }
        
        let total = 0;
        for (let row = 0; row < GRID_SIZE; row++) {
            for (let col = 0; col < GRID_SIZE; col++) {
                if (gameState.grid[row][col]) {
                    total += buildingTypes[gameState.grid[row][col].type].income;
                }
            }
        }
        gameState.money += total;
        gameState.lastTaxTime = now;
        updateUI();
        showNotification(`üí∞ –°–æ–±—Ä–∞–Ω–æ ${total} –º–æ–Ω–µ—Ç!`, 'success');
    };

    document.getElementById('rotateBtn').onclick = () => {
        cameraAngle += 0.5;
        draw3DCity();
        showNotification('üîÑ –í–∏–¥ –∏–∑–º–µ–Ω—ë–Ω', 'info');
    };

    document.getElementById('lightBtn').onclick = () => {
        gameState.lightIntensity = gameState.lightIntensity === 1.0 ? 0.5 : 1.0;
        draw3DCity();
        showNotification(`üí° –°–≤–µ—Ç: ${gameState.lightIntensity === 1.0 ? '–Ø—Ä–∫–æ' : '–¢—É—Å–∫–ª–æ'}`, 'info');
    };

    document.getElementById('cancelBtn').onclick = () => {
        gameState.selectedBuilding = null;
        document.querySelectorAll('.build-item').forEach(i => i.classList.remove('selected'));
        document.getElementById('infoPanel').innerHTML = 'üëÜ –í—ã–±–µ—Ä–∏—Ç–µ –∑–¥–∞–Ω–∏–µ';
        showNotification('‚ùå –í—ã–±–æ—Ä –æ—Ç–º–µ–Ω—ë–Ω', 'info');
    };

    document.getElementById('resetBtn').onclick = () => {
        if (confirm('–ù–∞—á–∞—Ç—å –Ω–æ–≤—ã–π –≥–æ—Ä–æ–¥?')) {
            gameState.money = 5000000;
            gameState.buildingsCount = 0;
            gameState.selectedBuilding = null;
            for (let i = 0; i < GRID_SIZE; i++) {
                for (let j = 0; j < GRID_SIZE; j++) {
                    gameState.grid[i][j] = null;
                }
            }
            updateUI();
            draw3DCity();
            showNotification('üîÑ –ù–æ–≤—ã–π –≥–æ—Ä–æ–¥ —Å–æ–∑–¥–∞–Ω', 'success');
        }
    };

    // ==================== –ó–ê–ü–£–°–ö ====================
    buildMenu();
    updateUI();
    draw3DCity();
    setInterval(draw3DCity, 50); // –ê–Ω–∏–º–∞—Ü–∏—è
})();
</script>
</body>
</html>
