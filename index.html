<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>üèùÔ∏è Isometric Town | –†–∞–π—Å–∫–∏–π —É–≥–æ–ª–æ–∫</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            user-select: none;
        }

        body {
            background: #0a1a2a;
            font-family: 'Segoe UI', 'Helvetica', system-ui, sans-serif;
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 15px;
            margin: 0;
            background-image: radial-gradient(circle at 30% 40%, #2b5a7a 0%, #0a1a2a 80%);
        }

        /* –ì–ª–∞–≤–Ω—ã–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä */
        .game-world {
            max-width: 1300px;
            width: 100%;
            background: rgba(255, 255, 255, 0.08);
            backdrop-filter: blur(12px);
            border-radius: 48px;
            padding: 24px;
            box-shadow: 0 30px 60px -15px rgba(0, 0, 0, 0.6), inset 0 2px 4px rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.15);
        }

        /* –í–µ—Ä—Ö–Ω—è—è –ø–∞–Ω–µ–ª—å */
        .zen-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: rgba(20, 40, 55, 0.7);
            backdrop-filter: blur(8px);
            border-radius: 100px;
            padding: 12px 28px;
            margin-bottom: 28px;
            color: white;
            flex-wrap: wrap;
            gap: 20px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: 0 10px 20px -8px rgba(0, 0, 0, 0.4);
        }

        .resource {
            display: flex;
            align-items: center;
            gap: 12px;
            background: rgba(0, 0, 0, 0.3);
            padding: 8px 22px;
            border-radius: 60px;
            font-size: 24px;
            font-weight: 500;
            box-shadow: inset 0 2px 5px rgba(0,0,0,0.3);
        }

        .resource-icon {
            font-size: 28px;
            filter: drop-shadow(0 3px 2px rgba(0,0,0,0.3));
        }

        .stats {
            display: flex;
            gap: 28px;
            background: rgba(0, 0, 0, 0.2);
            padding: 8px 25px;
            border-radius: 50px;
        }

        .stat {
            text-align: center;
        }

        .stat-label {
            font-size: 12px;
            opacity: 0.8;
            letter-spacing: 1px;
            text-transform: uppercase;
        }

        .stat-value {
            font-size: 22px;
            font-weight: bold;
            text-shadow: 0 2px 5px rgba(0,0,0,0.4);
        }

        /* –í—Ä–µ–º—è —Å—É—Ç–æ–∫ */
        .time-indicator {
            display: flex;
            align-items: center;
            gap: 10px;
            background: rgba(0,0,0,0.3);
            padding: 6px 18px;
            border-radius: 40px;
        }

        .time-emoji {
            font-size: 24px;
        }

        .time-slider {
            width: 80px;
            height: 6px;
            background: rgba(255,255,255,0.2);
            border-radius: 10px;
            overflow: hidden;
        }

        .time-fill {
            height: 100%;
            width: 50%;
            background: linear-gradient(90deg, #ffd966, #ffaa00);
            border-radius: 10px;
        }

        /* –û—Å–Ω–æ–≤–Ω–æ–π –∫–æ–Ω—Ç–µ–Ω—Ç */
        .content {
            display: flex;
            gap: 28px;
            flex-wrap: wrap;
        }

        /* –ò–∑–æ–º–µ—Ç—Ä–∏—á–µ—Å–∫–∏–π —Ö–æ–ª—Å—Ç */
        .canvas-wrapper {
            flex: 3;
            min-width: 650px;
            background: linear-gradient(145deg, #2a6b8f, #1b4b6e);
            border-radius: 40px;
            padding: 25px;
            display: flex;
            justify-content: center;
            align-items: center;
            box-shadow: inset 0 -10px 30px rgba(0, 0, 0, 0.6), inset 0 10px 20px rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        #gameCanvas {
            width: 100%;
            height: auto;
            max-width: 800px;
            border-radius: 30px;
            box-shadow: 0 25px 40px -10px black;
            background: #3d7ea3;
            cursor: pointer;
            image-rendering: crisp-edges;
            image-rendering: pixelated;
            transition: filter 0.5s ease;
        }

        /* –ü—Ä–∞–≤–∞—è –ø–∞–Ω–µ–ª—å */
        .dream-panel {
            flex: 1.2;
            min-width: 300px;
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(12px);
            border-radius: 40px;
            padding: 28px 20px;
            box-shadow: 0 20px 30px -10px rgba(0, 0, 0, 0.4);
            border: 1px solid rgba(255, 255, 255, 0.6);
        }

        .panel-header {
            font-size: 28px;
            font-weight: 400;
            text-align: center;
            margin-bottom: 25px;
            color: #2c4c6b;
            letter-spacing: 1px;
            border-bottom: 2px dashed #b0c9da;
            padding-bottom: 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .panel-header span {
            font-size: 32px;
        }

        .buildings-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 18px;
            margin-bottom: 30px;
        }

        .dream-card {
            background: rgba(255, 255, 255, 0.7);
            backdrop-filter: blur(4px);
            border-radius: 30px;
            padding: 20px 8px;
            text-align: center;
            cursor: pointer;
            transition: all 0.25s ease;
            border: 2px solid rgba(255, 255, 255, 0.8);
            box-shadow: 0 8px 0 #9bb7d4, 0 12px 20px -10px rgba(0, 40, 80, 0.3);
            position: relative;
        }

        .dream-card.selected {
            transform: translateY(-4px);
            border-color: #ffb347;
            box-shadow: 0 10px 0 #d18d2c, 0 18px 25px -8px #b6731e;
        }

        .dream-card:active {
            transform: translateY(5px);
            box-shadow: 0 3px 0 #9bb7d4;
        }

        .card-emoji {
            font-size: 48px;
            margin-bottom: 5px;
            filter: drop-shadow(2px 8px 8px rgba(0,0,0,0.15));
        }

        .card-name {
            font-weight: 600;
            font-size: 16px;
            color: #1e3b4f;
            margin-bottom: 5px;
        }

        .card-price {
            font-size: 15px;
            background: #f1d5a9;
            display: inline-block;
            padding: 4px 12px;
            border-radius: 40px;
            font-weight: 600;
            color: #5a3e1b;
        }

        .card-income {
            font-size: 13px;
            color: #2b7355;
            margin-top: 8px;
            font-weight: 500;
        }

        .cooldown-badge {
            position: absolute;
            top: -8px;
            right: -5px;
            background: #ff8a7a;
            color: white;
            border-radius: 40px;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 14px;
            box-shadow: 0 4px 0 #b1453a;
            display: none;
        }

        /* –ö–Ω–æ–ø–∫–∏ */
        .zen-actions {
            display: flex;
            flex-direction: column;
            gap: 15px;
            margin: 25px 0 20px;
        }

        .zen-btn {
            border: none;
            border-radius: 60px;
            padding: 20px;
            font-size: 20px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.15s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
            box-shadow: 0 8px 0 #6b4f8c, 0 10px 25px -5px rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.5);
        }

        .zen-btn:active {
            transform: translateY(5px);
            box-shadow: 0 3px 0 #6b4f8c;
        }

        .zen-btn.primary {
            background: linear-gradient(145deg, #b7d9e7, #8dc0d4);
            color: #1d3e5b;
        }

        .zen-btn.success {
            background: linear-gradient(145deg, #c4e3cb, #a1d3b3);
            color: #1a5e3a;
            box-shadow: 0 8px 0 #528a66;
        }

        .zen-btn.warning {
            background: linear-gradient(145deg, #ffe1b3, #ffcb8a);
            color: #7b5800;
            box-shadow: 0 8px 0 #c6a15b;
        }

        .zen-btn:disabled {
            opacity: 0.5;
            transform: none;
            pointer-events: none;
        }

        /* –ò–Ω—Ñ–æ-–ø–∞–Ω–µ–ª—å */
        .mood-panel {
            background: #e4f0f9;
            border-radius: 28px;
            padding: 20px;
            margin-top: 20px;
            color: #1e415a;
            border: 1px solid white;
            box-shadow: inset 0 0 20px rgba(255, 255, 255, 0.7);
        }

        .mood-title {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .mood-text {
            font-size: 15px;
            line-height: 1.5;
            opacity: 0.9;
        }

        #selectedInfo {
            color: #1b5270;
            font-weight: 500;
            margin-top: 10px;
            padding: 10px;
            background: rgba(255,255,240,0.7);
            border-radius: 20px;
        }

        /* –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è */
        .toast {
            position: fixed;
            bottom: 30px;
            right: 30px;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(15px);
            color: white;
            padding: 18px 30px;
            border-radius: 60px;
            font-size: 17px;
            font-weight: 500;
            z-index: 2000;
            animation: slideUp 0.4s ease-out;
            border: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: 0 15px 30px -8px black;
        }

        @keyframes slideUp {
            from { transform: translateY(100px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        /* –ê–¥–∞–ø—Ç–∞—Ü–∏—è */
        @media (max-width: 950px) {
            .canvas-wrapper { min-width: 100%; }
        }
    </style>
</head>
<body>
    <div class="game-world">
        <!-- –í–µ—Ä—Ö–Ω—è—è –ø–∞–Ω–µ–ª—å -->
        <div class="zen-bar">
            <div class="resource">
                <span class="resource-icon">ü™ô</span>
                <span id="balanceDisplay">850</span>
            </div>
            <div class="stats">
                <div class="stat">
                    <div class="stat-label">–ñ–∏—Ç–µ–ª–∏</div>
                    <div class="stat-value" id="populationDisplay">12</div>
                </div>
                <div class="stat">
                    <div class="stat-label">–î–æ—Ö–æ–¥/–¥–µ–Ω—å</div>
                    <div class="stat-value" id="incomeDisplay">45</div>
                </div>
                <div class="stat">
                    <div class="stat-label">–ì–∞—Ä–º–æ–Ω–∏—è</div>
                    <div class="stat-value" id="harmonyDisplay">‚òÄÔ∏è</div>
                </div>
            </div>
            <div class="time-indicator">
                <span class="time-emoji" id="timeEmoji">‚òÄÔ∏è</span>
                <div class="time-slider">
                    <div class="time-fill" id="timeFill" style="width: 70%;"></div>
                </div>
            </div>
        </div>

        <!-- –ö–æ–Ω—Ç–µ–Ω—Ç -->
        <div class="content">
            <!-- Canvas -->
            <div class="canvas-wrapper">
                <canvas id="gameCanvas" width="800" height="600"></canvas>
            </div>

            <!-- –ü—Ä–∞–≤–∞—è –ø–∞–Ω–µ–ª—å -->
            <div class="dream-panel">
                <div class="panel-header">
                    <span>‚ú®</span> –ü–æ—Å—Ç—Ä–æ–π –º–µ—á—Ç—É <span>‚ú®</span>
                </div>

                <!-- –°–µ—Ç–∫–∞ –∑–¥–∞–Ω–∏–π -->
                <div class="buildings-grid" id="buildingsGrid">
                    <!-- –î–æ–º -->
                    <div class="dream-card" data-type="house" onclick="selectBuilding('house')">
                        <div class="card-emoji">üè°</div>
                        <div class="card-name">–î–æ–º–∏–∫</div>
                        <div class="card-price">35 ü™ô</div>
                        <div class="card-income">+5 –¥–æ—Ö–æ–¥–∞</div>
                        <div class="cooldown-badge" id="cooldown-house">3</div>
                    </div>
                    <!-- –ú–∞–≥–∞–∑–∏–Ω—á–∏–∫ -->
                    <div class="dream-card" data-type="shop" onclick="selectBuilding('shop')">
                        <div class="card-emoji">üçÉ</div>
                        <div class="card-name">–õ–∞–≤–∫–∞</div>
                        <div class="card-price">80 ü™ô</div>
                        <div class="card-income">+12 –¥–æ—Ö–æ–¥–∞</div>
                        <div class="cooldown-badge" id="cooldown-shop">4</div>
                    </div>
                    <!-- –î–µ—Ä–µ–≤—Ü–µ -->
                    <div class="dream-card" data-type="tree" onclick="selectBuilding('tree')">
                        <div class="card-emoji">üå≥</div>
                        <div class="card-name">–î–µ—Ä–µ–≤–æ</div>
                        <div class="card-price">20 ü™ô</div>
                        <div class="card-income">+3 –¥–æ—Ö–æ–¥–∞</div>
                        <div class="cooldown-badge" id="cooldown-tree">2</div>
                    </div>
                    <!-- –§–æ–Ω–∞—Ä—å -->
                    <div class="dream-card" data-type="lamp" onclick="selectBuilding('lamp')">
                        <div class="card-emoji">üèÆ</div>
                        <div class="card-name">–§–æ–Ω–∞—Ä—å</div>
                        <div class="card-price">45 ü™ô</div>
                        <div class="card-income">+6 –¥–æ—Ö–æ–¥–∞</div>
                        <div class="cooldown-badge" id="cooldown-lamp">3</div>
                    </div>
                    <!-- –ö–∞—Ñ–µ -->
                    <div class="dream-card" data-type="cafe" onclick="selectBuilding('cafe')">
                        <div class="card-emoji">‚òï</div>
                        <div class="card-name">–ö–∞—Ñ–µ</div>
                        <div class="card-price">150 ü™ô</div>
                        <div class="card-income">+25 –¥–æ—Ö–æ–¥–∞</div>
                        <div class="cooldown-badge" id="cooldown-cafe">6</div>
                    </div>
                    <!-- –¶–≤–µ—Ç—ã -->
                    <div class="dream-card" data-type="flower" onclick="selectBuilding('flower')">
                        <div class="card-emoji">üå∏</div>
                        <div class="card-name">–¶–≤–µ—Ç—ã</div>
                        <div class="card-price">15 ü™ô</div>
                        <div class="card-income">+2 –¥–æ—Ö–æ–¥–∞</div>
                        <div class="cooldown-badge" id="cooldown-flower">1</div>
                    </div>
                </div>

                <!-- –ö–Ω–æ–ø–∫–∏ –¥–µ–π—Å—Ç–≤–∏–π -->
                <div class="zen-actions">
                    <button class="zen-btn success" onclick="collectHarmony()" id="harmonyBtn">
                        <span>üå∏</span> –°–æ–±—Ä–∞—Ç—å –≥–∞—Ä–º–æ–Ω–∏—é
                    </button>
                    <button class="zen-btn primary" onclick="cancelSelection()">
                        <span>üîÑ</span> –°–±—Ä–æ—Å –≤—ã–±–æ—Ä–∞
                    </button>
                    <button class="zen-btn warning" onclick="resetWorld()">
                        <span>üå±</span> –ù–æ–≤—ã–π –º–∏—Ä
                    </button>
                </div>

                <!-- –ò–Ω—Ñ–æ-–ø–∞–Ω–µ–ª—å -->
                <div class="mood-panel">
                    <div class="mood-title">
                        <span>üßò</span> –¢–≤–æ–π —É–≥–æ–ª–æ–∫
                    </div>
                    <div class="mood-text" id="moodText">
                        –ù–∞–∂–º–∏ –Ω–∞ –∫–ª–µ—Ç–∫—É –∏–ª–∏ –≤—ã–±–µ—Ä–∏ –ø–æ—Å—Ç—Ä–æ–π–∫—É...
                    </div>
                    <div id="selectedInfo"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Telegram WebApp -->
    <script src="https://telegram.org/js/telegram-web-app.js"></script>

    <script>
        // ========== –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø TELEGRAM ==========
        let tg = null;
        try {
            if (window.Telegram && Telegram.WebApp) {
                tg = Telegram.WebApp;
                tg.expand();
                tg.ready();
                tg.setHeaderColor('#0a1a2a');
                tg.setBackgroundColor('#0a1a2a');
                console.log('Telegram WebApp –ø–æ–¥–∫–ª—é—á–µ–Ω');
            }
        } catch (e) {
            console.log('–†–µ–∂–∏–º —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏');
        }

        // ========== –ü–ê–†–ê–ú–ï–¢–†–´ –ú–ò–†–ê ==========
        const GRID_SIZE = 7; // 7x7 –¥–ª—è —É—é—Ç–∞
        const CELL_W = 80;    // —à–∏—Ä–∏–Ω–∞ –∫–ª–µ—Ç–∫–∏
        const CELL_H = 60;    // –≤—ã—Å–æ—Ç–∞ –∫–ª–µ—Ç–∫–∏
        const ISO_OFFSET_X = 400; // —Å–º–µ—â–µ–Ω–∏–µ –¥–ª—è —Ü–µ–Ω—Ç—Ä–∏—Ä–æ–≤–∞–Ω–∏—è
        const ISO_OFFSET_Y = 100;

        // –¢–∏–ø—ã –ø–æ—Å—Ç—Ä–æ–µ–∫ —Å —É–ª—É—á—à–µ–Ω–Ω—ã–º–∏ —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∞–º–∏
        const BUILDINGS = {
            empty: { name: '–ü—É—Å—Ç–æ', emoji: 'üåø', color: '#5f9b6b', price: 0, income: 0, level: 0, nightEmoji: 'üåô' },
            house: { name: '–î–æ–º–∏–∫', emoji: 'üè°', color: '#f7d6aa', price: 35, income: 5, level: 1, nightEmoji: 'üè°‚ú®' },
            shop: { name: '–õ–∞–≤–∫–∞', emoji: 'üçÉ', color: '#c4a5d1', price: 80, income: 12, level: 1, nightEmoji: 'üçÉ‚ú®' },
            tree: { name: '–î–µ—Ä–µ–≤–æ', emoji: 'üå≥', color: '#6b8e4c', price: 20, income: 3, level: 1, nightEmoji: 'üåôüå≥' },
            lamp: { name: '–§–æ–Ω–∞—Ä—å', emoji: 'üèÆ', color: '#f3d573', price: 45, income: 6, level: 1, nightEmoji: 'üèÆ‚ú®' },
            cafe: { name: '–ö–∞—Ñ–µ', emoji: '‚òï', color: '#d9b38c', price: 150, income: 25, level: 1, nightEmoji: '‚òïüåü' },
            flower: { name: '–¶–≤–µ—Ç—ã', emoji: 'üå∏', color: '#f9a8d4', price: 15, income: 2, level: 1, nightEmoji: 'üå∏üåô' }
        };

        // –°–æ—Å—Ç–æ—è–Ω–∏–µ –∏–≥—Ä—ã
        let gameState = {
            balance: 850,
            grid: [],
            selectedBuilding: null,
            lastHarvestTime: Date.now(),
            harvestCooldown: 45000, // 45 —Å–µ–∫—É–Ω–¥ (—Ä–∞—Å—Å–ª–∞–±–ª–µ–Ω–Ω—ã–π —Ä–µ–∂–∏–º)
            harmonyBtnDisabled: false,
            buildingsCount: {},
            cooldowns: {},
            timeOfDay: 0.7, // 0 = –Ω–æ—á—å, 1 = –¥–µ–Ω—å
            population: 12,
            harmony: '‚òÄÔ∏è',
            particles: []
        };

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å–µ—Ç–∫–∏
        for (let i = 0; i < GRID_SIZE; i++) {
            gameState.grid[i] = [];
            for (let j = 0; j < GRID_SIZE; j++) {
                gameState.grid[i][j] = 'empty';
            }
        }

        // –ù–µ—Å–∫–æ–ª—å–∫–æ –Ω–∞—á–∞–ª—å–Ω—ã—Ö –ø–æ—Å—Ç—Ä–æ–µ–∫ –¥–ª—è –∫—Ä–∞—Å–æ—Ç—ã
        gameState.grid[2][3] = 'house';
        gameState.grid[3][2] = 'tree';
        gameState.grid[3][4] = 'flower';
        gameState.grid[4][3] = 'lamp';

        // ========== CANVAS –° –ò–ó–û–ú–ï–¢–†–ò–ï–ô ==========
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');

        // –ü—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ —Å–µ—Ç–∫–∏ –≤ –∏–∑–æ–º–µ—Ç—Ä–∏—á–µ—Å–∫–∏–µ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã
        function gridToIso(row, col) {
            const x = (col - row) * CELL_W / 2 + ISO_OFFSET_X;
            const y = (col + row) * CELL_H / 2 + ISO_OFFSET_Y;
            return { x, y };
        }

        // –û—Ç—Ä–∏—Å–æ–≤–∫–∞ –≥–æ—Ä–æ–¥–∞
        function drawCity() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);

            // –ù–µ–±–æ (–∑–∞–≤–∏—Å–∏—Ç –æ—Ç –≤—Ä–µ–º–µ–Ω–∏ —Å—É—Ç–æ–∫)
            const skyR = Math.floor(135 + 60 * gameState.timeOfDay);
            const skyG = Math.floor(165 + 60 * gameState.timeOfDay);
            const skyB = Math.floor(200 + 55 * gameState.timeOfDay);
            ctx.fillStyle = `rgb(${skyR}, ${skyG}, ${skyB})`;
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            // –û–±–ª–∞–∫–∞/–∑–≤–µ–∑–¥—ã
            drawAtmosphere();

            // –†–∏—Å—É–µ–º —Ç–∞–π–ª—ã —Å–Ω–∏–∑—É –≤–≤–µ—Ä—Ö
            for (let row = 0; row < GRID_SIZE; row++) {
                for (let col = 0; col < GRID_SIZE; col++) {
                    const iso = gridToIso(row, col);
                    const type = gameState.grid[row][col];
                    const building = BUILDINGS[type] || BUILDINGS.empty;
                    
                    // –û—Å–Ω–æ–≤–Ω–æ–π —Ç–∞–π–ª (–∑–µ–º–ª—è)
                    ctx.beginPath();
                    ctx.moveTo(iso.x, iso.y);
                    ctx.lineTo(iso.x + CELL_W/2, iso.y + CELL_H/2);
                    ctx.lineTo(iso.x, iso.y + CELL_H);
                    ctx.lineTo(iso.x - CELL_W/2, iso.y + CELL_H/2);
                    ctx.closePath();
                    
                    // –ì—Ä–∞–¥–∏–µ–Ω—Ç –¥–ª—è –∑–µ–º–ª–∏
                    const gradient = ctx.createLinearGradient(iso.x - 20, iso.y, iso.x + 20, iso.y + CELL_H);
                    if (type === 'empty') {
                        gradient.addColorStop(0, '#6f9e7a');
                        gradient.addColorStop(1, '#4f7a5a');
                    } else {
                        gradient.addColorStop(0, building.color);
                        gradient.addColorStop(1, shadeColor(building.color, -30));
                    }
                    ctx.fillStyle = gradient;
                    ctx.fill();
                    
                    ctx.strokeStyle = 'rgba(255, 255, 255, 0.2)';
                    ctx.lineWidth = 1;
                    ctx.stroke();

                    // –ü–æ—Å—Ç—Ä–æ–π–∫–∞ (—ç–º–æ–¥–∑–∏)
                    ctx.font = '42px "Segoe UI Emoji", "Apple Color Emoji", "Noto Color Emoji", sans-serif';
                    ctx.textAlign = 'center';
                    ctx.textBaseline = 'middle';
                    
                    let emoji = building.emoji;
                    if (gameState.timeOfDay < 0.3 && building.nightEmoji) {
                        emoji = building.nightEmoji; // –ù–æ—á–Ω–∞—è –≤–µ—Ä—Å–∏—è
                    }
                    
                    // –¢–µ–Ω—å –¥–ª—è —ç–º–æ–¥–∑–∏
                    ctx.shadowColor = 'rgba(0, 0, 0, 0.4)';
                    ctx.shadowBlur = 10;
                    ctx.shadowOffsetY = 3;
                    ctx.fillStyle = '#000';
                    ctx.fillText(emoji, iso.x, iso.y - 10);
                    
                    // –°–∞–º —ç–º–æ–¥–∑–∏
                    ctx.shadowBlur = 15;
                    ctx.shadowColor = 'rgba(255, 255, 200, 0.3)';
                    ctx.fillStyle = '#fff';
                    ctx.fillText(emoji, iso.x, iso.y - 12);
                    
                    ctx.shadowBlur = 0;
                    ctx.shadowOffsetY = 0;
                }
            }

            // –ü–æ–¥—Å–≤–µ—Ç–∫–∞ –≤—ã–±—Ä–∞–Ω–Ω–æ–π –∫–ª–µ—Ç–∫–∏
            if (selectedRow !== -1 && selectedCol !== -1) {
                const iso = gridToIso(selectedRow, selectedCol);
                ctx.beginPath();
                ctx.moveTo(iso.x, iso.y - 10);
                ctx.lineTo(iso.x + CELL_W/2, iso.y + CELL_H/2 - 10);
                ctx.lineTo(iso.x, iso.y + CELL_H - 10);
                ctx.lineTo(iso.x - CELL_W/2, iso.y + CELL_H/2 - 10);
                ctx.closePath();
                ctx.strokeStyle = '#ffdf7e';
                ctx.lineWidth = 4;
                ctx.shadowColor = '#ffb347';
                ctx.shadowBlur = 15;
                ctx.stroke();
                ctx.shadowBlur = 0;
            }

            // –†–∏—Å—É–µ–º —á–∞—Å—Ç–∏—Ü—ã (–ª–∏—Å—Ç—å—è, –∑–≤–µ–∑–¥—ã)
            drawParticles();
        }

        // –ó–∞—Ç–µ–º–Ω–µ–Ω–∏–µ —Ü–≤–µ—Ç–∞
        function shadeColor(color, percent) {
            let R = parseInt(color.substring(1,3), 16);
            let G = parseInt(color.substring(3,5), 16);
            let B = parseInt(color.substring(5,7), 16);
            R = Math.min(255, Math.max(0, R + percent));
            G = Math.min(255, Math.max(0, G + percent));
            B = Math.min(255, Math.max(0, B + percent));
            return `#${((1 << 24) + (R << 16) + (G << 8) + B).toString(16).slice(1)}`;
        }

        // –ê—Ç–º–æ—Å—Ñ–µ—Ä–Ω—ã–µ —ç—Ñ—Ñ–µ–∫—Ç—ã
        function drawAtmosphere() {
            if (gameState.timeOfDay > 0.6) {
                // –°–æ–ª–Ω—Ü–µ
                ctx.beginPath();
                ctx.arc(100, 80, 40, 0, Math.PI * 2);
                ctx.fillStyle = '#fff9bf';
                ctx.shadowColor = '#ffeb73';
                ctx.shadowBlur = 40;
                ctx.fill();
                // –û–±–ª–∞–∫–∞
                ctx.fillStyle = 'rgba(255, 255, 255, 0.3)';
                ctx.shadowBlur = 30;
                ctx.beginPath();
                ctx.arc(200, 120, 40, 0, Math.PI*2);
                ctx.arc(250, 100, 35, 0, Math.PI*2);
                ctx.arc(280, 130, 30, 0, Math.PI*2);
                ctx.fill();
            } else {
                // –õ—É–Ω–∞ –∏ –∑–≤–µ–∑–¥—ã
                ctx.beginPath();
                ctx.arc(750, 80, 30, 0, Math.PI * 2);
                ctx.fillStyle = '#f8f3e0';
                ctx.shadowColor = '#e6ddaa';
                ctx.shadowBlur = 30;
                ctx.fill();
                
                // –ó–≤–µ–∑–¥—ã
                for (let i = 0; i < 30; i++) {
                    if (i % 3 === 0) continue;
                    ctx.fillStyle = `rgba(255, 255, 200, ${Math.random()*0.5 + 0.3})`;
                    ctx.shadowBlur = 10;
                    ctx.beginPath();
                    ctx.arc(50 + i * 25, 40 + (i % 5) * 15, 2 + Math.random()*3, 0, Math.PI*2);
                    ctx.fill();
                }
            }
            ctx.shadowBlur = 0;
        }

        // –ß–∞—Å—Ç–∏—Ü—ã (–ª–∏—Å—Ç—å—è, –∏—Å–∫—Ä—ã)
        function drawParticles() {
            for (let p of gameState.particles) {
                ctx.globalAlpha = p.life;
                ctx.font = `${p.size}px "Segoe UI Emoji"`;
                ctx.fillStyle = '#fff';
                ctx.shadowBlur = 8;
                ctx.shadowColor = p.color;
                ctx.fillText(p.emoji, p.x, p.y);
                p.x += p.vx;
                p.y += p.vy;
                p.life -= 0.005;
                if (p.vy < 2) p.vy += 0.05;
            }
            gameState.particles = gameState.particles.filter(p => p.life > 0);
            ctx.globalAlpha = 1;
            ctx.shadowBlur = 0;
        }

        // –î–æ–±–∞–≤–∏—Ç—å —á–∞—Å—Ç–∏—Ü—ã
        function addParticles(x, y, emoji, count = 5) {
            for (let i = 0; i < count; i++) {
                gameState.particles.push({
                    x: x - 20 + Math.random()*40,
                    y: y - 20 + Math.random()*40,
                    vx: (Math.random() - 0.5) * 1.5,
                    vy: -Math.random() * 2,
                    emoji: emoji,
                    size: 20 + Math.floor(Math.random()*15),
                    life: 0.8 + Math.random()*0.3,
                    color: ['#ffd966', '#f9a8d4', '#b7d9e7'][Math.floor(Math.random()*3)]
                });
            }
        }

        // ========== –í–ó–ê–ò–ú–û–î–ï–ô–°–¢–í–ò–ï ==========
        let selectedRow = -1, selectedCol = -1;

        canvas.addEventListener('click', (e) => {
            const rect = canvas.getBoundingClientRect();
            const scaleX = canvas.width / rect.width;
            const scaleY = canvas.height / rect.height;
            
            const mouseX = (e.clientX - rect.left) * scaleX;
            const mouseY = (e.clientY - rect.top) * scaleY;

            // –ü–æ–∏—Å–∫ –±–ª–∏–∂–∞–π—à–µ–π –∫–ª–µ—Ç–∫–∏
            let minDist = Infinity;
            for (let r = 0; r < GRID_SIZE; r++) {
                for (let c = 0; c < GRID_SIZE; c++) {
                    const iso = gridToIso(r, c);
                    const dx = mouseX - iso.x;
                    const dy = mouseY - iso.y;
                    const dist = Math.sqrt(dx*dx + dy*dy);
                    if (dist < minDist && dist < 50) {
                        minDist = dist;
                        selectedRow = r;
                        selectedCol = c;
                    }
                }
            }

            if (selectedRow !== -1 && selectedCol !== -1) {
                if (gameState.selectedBuilding) {
                    buildAt(selectedRow, selectedCol);
                } else {
                    showCellInfo(selectedRow, selectedCol);
                }
                drawCity();
            }
        });

        // –°—Ç—Ä–æ–∏—Ç–µ–ª—å—Å—Ç–≤–æ
        function buildAt(row, col) {
            if (!gameState.selectedBuilding) return;
            
            const building = BUILDINGS[gameState.selectedBuilding];
            const currentCell = gameState.grid[row][col];
            
            if (currentCell !== 'empty') {
                showToast('‚ùå –ó–¥–µ—Å—å —É–∂–µ —á—Ç–æ-—Ç–æ –µ—Å—Ç—å', '#ff8a7a');
                return;
            }
            
            if (gameState.balance < building.price) {
                showToast('üí´ –ù—É–∂–Ω–æ –±–æ–ª—å—à–µ –º–æ–Ω–µ—Ç...', '#ffb347');
                return;
            }
            
            // –ê–Ω—Ç–∏-—Å–ø–∞–º –∫—É–ª–¥–∞—É–Ω
            const now = Date.now();
            const lastBuild = gameState.cooldowns[gameState.selectedBuilding] || 0;
            const cooldownMs = (building.price > 80 ? 4000 : 2500); // 2.5-4 —Å–µ–∫
            
            if (now - lastBuild < cooldownMs) {
                const secs = Math.ceil((cooldownMs - (now - lastBuild)) / 1000);
                showToast(`‚è≥ –ü–æ–¥–æ–∂–¥–∏ ${secs} —Å–µ–∫...`, '#b0b0b0');
                return;
            }
            
            // –°—Ç—Ä–æ–∏–º
            gameState.grid[row][col] = gameState.selectedBuilding;
            gameState.balance -= building.price;
            
            gameState.buildingsCount[gameState.selectedBuilding] = 
                (gameState.buildingsCount[gameState.selectedBuilding] || 0) + 1;
            
            if (gameState.selectedBuilding === 'house') gameState.population += 3;
            if (gameState.selectedBuilding === 'cafe') gameState.population += 2;
            if (gameState.selectedBuilding === 'tree') gameState.population += 1;
            
            gameState.cooldowns[gameState.selectedBuilding] = now;
            
            // –í–∏–∑—É–∞–ª—å–Ω—ã–π –∫—É–ª–¥–∞—É–Ω
            const badge = document.getElementById(`cooldown-${gameState.selectedBuilding}`);
            if (badge) {
                badge.style.display = 'flex';
                badge.textContent = Math.ceil(cooldownMs/1000);
                setTimeout(() => { badge.style.display = 'none'; }, cooldownMs);
            }
            
            // –ß–∞—Å—Ç–∏—Ü—ã
            const iso = gridToIso(row, col);
            addParticles(iso.x, iso.y, '‚ú®', 8);
            
            saveToTelegram();
            updateUI();
            drawCity();
            
            showToast(`‚ú® ${building.name} –ø–æ—Å—Ç—Ä–æ–µ–Ω!`, '#9bcd9b');
            
            if (tg) tg.HapticFeedback.impactOccurred('light');
        }

        // –°–±–æ—Ä –≥–∞—Ä–º–æ–Ω–∏–∏ (–Ω–∞–ª–æ–≥–æ–≤)
        function collectHarmony() {
            const btn = document.getElementById('harmonyBtn');
            const now = Date.now();
            const timeSince = now - gameState.lastHarvestTime;
            
            if (timeSince < gameState.harvestCooldown) {
                const secs = Math.ceil((gameState.harvestCooldown - timeSince) / 1000);
                showToast(`üå∏ –ï—â–µ ${secs} —Å–µ–∫ –¥–æ –≥–∞—Ä–º–æ–Ω–∏–∏`, '#b0b0b0');
                return;
            }
            
            let total = 0;
            for (let r = 0; r < GRID_SIZE; r++) {
                for (let c = 0; c < GRID_SIZE; c++) {
                    const type = gameState.grid[r][c];
                    if (type !== 'empty') {
                        total += BUILDINGS[type].income;
                        // –ë–æ–Ω—É—Å –∑–∞ —Å–æ—Å–µ–¥—Å—Ç–≤–æ —Å —Ü–≤–µ—Ç–∞–º–∏
                        if (type === 'flower') total += 3;
                    }
                }
            }
            
            // –ë–æ–Ω—É—Å –∑–∞ –≥–∞—Ä–º–æ–Ω–∏—é
            total = Math.floor(total * (0.9 + gameState.timeOfDay * 0.3));
            
            gameState.balance += total;
            gameState.lastHarvestTime = now;
            
            btn.disabled = true;
            gameState.harmonyBtnDisabled = true;
            
            setTimeout(() => {
                btn.disabled = false;
                gameState.harmonyBtnDisabled = false;
                updateUI();
            }, gameState.harvestCooldown);
            
            // –ß–∞—Å—Ç–∏—Ü—ã —Ä–∞–¥–æ—Å—Ç–∏
            addParticles(400, 300, 'üå∏', 15);
            
            saveToTelegram();
            updateUI();
            
            showToast(`üå∏ +${total} –≥–∞—Ä–º–æ–Ω–∏–∏!`, '#a5d6a5');
            if (tg) tg.HapticFeedback.notificationOccurred('success');
        }

        // –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –∫–ª–µ—Ç–∫–µ
        function showCellInfo(row, col) {
            const type = gameState.grid[row][col];
            if (type === 'empty') {
                document.getElementById('moodText').innerHTML = 'üå± –ü—É—Å—Ç–∞—è –∑–µ–º–ª—è. –ü–æ—Å–∞–¥–∏ —á—Ç–æ-–Ω–∏–±—É–¥—å...';
            } else {
                const b = BUILDINGS[type];
                document.getElementById('moodText').innerHTML = 
                    `${b.emoji} ${b.name}<br>üí∞ –î–æ—Ö–æ–¥: ${b.income} –∑–∞ —Å–±–æ—Ä<br>${b.emoji === 'üå≥' ? 'üå¨Ô∏è –®–µ–ª–µ—Å—Ç–∏—Ç –ª–∏—Å—Ç—å—è–º–∏...' : '‚ú® –ü—Ä–∏–Ω–æ—Å–∏—Ç —É—é—Ç'}`;
            }
        }

        // –í—ã–±–æ—Ä –ø–æ—Å—Ç—Ä–æ–π–∫–∏
        function selectBuilding(type) {
            gameState.selectedBuilding = type;
            document.querySelectorAll('.dream-card').forEach(c => c.classList.remove('selected'));
            document.querySelector(`[data-type="${type}"]`).classList.add('selected');
            document.getElementById('selectedInfo').innerHTML = 
                `‚ú® –í—ã–±—Ä–∞–Ω–æ: ${BUILDINGS[type].emoji} ${BUILDINGS[type].name}`;
        }

        function cancelSelection() {
            gameState.selectedBuilding = null;
            document.querySelectorAll('.dream-card').forEach(c => c.classList.remove('selected'));
            document.getElementById('selectedInfo').innerHTML = '';
            selectedRow = selectedCol = -1;
            drawCity();
        }

        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ UI
        function updateUI() {
            document.getElementById('balanceDisplay').textContent = gameState.balance;
            document.getElementById('populationDisplay').textContent = gameState.population;
            
            let totalIncome = 0;
            for (let r = 0; r < GRID_SIZE; r++) {
                for (let c = 0; c < GRID_SIZE; c++) {
                    const type = gameState.grid[r][c];
                    if (type !== 'empty') totalIncome += BUILDINGS[type].income;
                }
            }
            document.getElementById('incomeDisplay').textContent = totalIncome;
            
            // –ì–∞—Ä–º–æ–Ω–∏—è
            if (gameState.population > 30) gameState.harmony = 'üåà';
            else if (gameState.population > 15) gameState.harmony = '‚òÄÔ∏è';
            else gameState.harmony = 'üå±';
            document.getElementById('harmonyDisplay').textContent = gameState.harmony;
            
            // –í—Ä–µ–º—è —Å—É—Ç–æ–∫ (–º–µ–¥–ª–µ–Ω–Ω–æ –º–µ–Ω—è–µ—Ç—Å—è)
            gameState.timeOfDay += 0.001;
            if (gameState.timeOfDay > 1) gameState.timeOfDay = 0;
            document.getElementById('timeFill').style.width = `${gameState.timeOfDay * 100}%`;
            document.getElementById('timeEmoji').textContent = 
                gameState.timeOfDay > 0.6 ? '‚òÄÔ∏è' : (gameState.timeOfDay > 0.3 ? '‚õÖ' : 'üåô');
        }

        // –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
        function showToast(msg, color = '#333') {
            const toast = document.createElement('div');
            toast.className = 'toast';
            toast.style.background = color;
            toast.style.boxShadow = `0 10px 20px -5px ${color}`;
            toast.textContent = msg;
            document.body.appendChild(toast);
            setTimeout(() => toast.remove(), 2800);
        }

        // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ
        function saveToTelegram() {
            if (tg) {
                tg.sendData(JSON.stringify({
                    balance: gameState.balance,
                    grid: gameState.grid,
                    population: gameState.population,
                    time: Date.now()
                }));
            }
            localStorage.setItem('zenCity', JSON.stringify(gameState));
        }

        // –ó–∞–≥—Ä—É–∑–∫–∞
        function loadGame() {
            const saved = localStorage.getItem('zenCity');
            if (saved) {
                try {
                    const data = JSON.parse(saved);
                    gameState = { ...gameState, ...data };
                } catch (e) {}
            }
            updateUI();
            drawCity();
        }

        // –°–±—Ä–æ—Å
        function resetWorld() {
            if (confirm('–ù–∞—á–∞—Ç—å –∑–∞–Ω–æ–≤–æ? –í–µ—Å—å –ø—Ä–æ–≥—Ä–µ—Å—Å –∏—Å—á–µ–∑–Ω–µ—Ç.')) {
                gameState = {
                    balance: 850,
                    grid: [],
                    selectedBuilding: null,
                    lastHarvestTime: Date.now(),
                    harvestCooldown: 45000,
                    harmonyBtnDisabled: false,
                    buildingsCount: {},
                    cooldowns: {},
                    timeOfDay: 0.7,
                    population: 12,
                    harmony: '‚òÄÔ∏è',
                    particles: []
                };
                for (let i = 0; i < GRID_SIZE; i++) {
                    gameState.grid[i] = [];
                    for (let j = 0; j < GRID_SIZE; j++) {
                        gameState.grid[i][j] = 'empty';
                    }
                }
                gameState.grid[2][3] = 'house';
                gameState.grid[3][2] = 'tree';
                gameState.grid[3][4] = 'flower';
                gameState.grid[4][3] = 'lamp';
                
                document.getElementById('harmonyBtn').disabled = false;
                cancelSelection();
                updateUI();
                drawCity();
                showToast('üå± –ù–æ–≤—ã–π –º–∏—Ä —Å–æ–∑–¥–∞–Ω...', '#a5d6a5');
                saveToTelegram();
            }
        }

        // –ê–Ω–∏–º–∞—Ü–∏—è
        function animate() {
            updateUI();
            drawCity();
            requestAnimationFrame(animate);
        }

        // –ó–∞–ø—É—Å–∫
        document.addEventListener('DOMContentLoaded', () => {
            loadGame();
            animate();
        });
    </script>
</body>
</html>
