<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>–ê—Ä—Ö–∏–ø–µ–ª–∞–≥ ‚Äî 3D –≥—Ä–∞–¥–æ—Å—Ç—Ä–æ–∏—Ç–µ–ª—å–Ω—ã–π —Å–∏–º—É–ª—è—Ç–æ—Ä</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Roboto, 'Helvetica Neue', sans-serif;
        }
        body {
            background: #0a1f30;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            padding: 12px;
        }
        .game-wrapper {
            width: 100%;
            max-width: 780px;
            background: linear-gradient(145deg, #23658b, #154a68);
            border-radius: 90px;
            padding: 35px;
            box-shadow: 0 70px 120px rgba(0,0,0,0.9), inset 0 6px 20px rgba(255,255,255,0.4);
            border: 6px solid #7fbee0;
        }
        .stats-panel {
            background: rgba(0, 30, 45, 0.9);
            backdrop-filter: blur(40px);
            border-radius: 90px;
            padding: 24px 40px;
            display: flex;
            justify-content: space-between;
            color: white;
            margin-bottom: 35px;
            border: 3px solid #b8e2ff;
            box-shadow: 0 22px 0 #13445c;
        }
        .stat-item {
            display: flex;
            align-items: center;
            gap: 15px;
            font-size: 30px;
            font-weight: 700;
            background: rgba(0,0,0,0.45);
            padding: 12px 35px;
            border-radius: 80px;
            backdrop-filter: blur(5px);
        }
        .stat-icon {
            font-size: 48px;
            filter: drop-shadow(0 8px 10px black);
        }
        .canvas-area {
            background: #1e729c;
            border-radius: 80px;
            padding: 35px;
            display: flex;
            justify-content: center;
            box-shadow: inset 0 -40px 80px #0e405a, 0 45px 80px black;
            margin-bottom: 35px;
        }
        #gameCanvas {
            width: 100%;
            height: auto;
            border-radius: 70px;
            background: #3b8fc2;
            cursor: pointer;
            touch-action: none;
            max-width: 640px;
            box-shadow: 0 0 0 10px #d9f0ff, 0 45px 90px black;
        }
        .category-bar {
            display: flex;
            gap: 24px;
            margin-bottom: 28px;
        }
        .cat-btn {
            flex: 1;
            background: rgba(255,255,255,0.2);
            backdrop-filter: blur(30px);
            border: 5px solid white;
            border-radius: 90px;
            padding: 22px;
            color: white;
            font-size: 26px;
            font-weight: bold;
            text-align: center;
            box-shadow: 0 15px 0 #134a64;
            transition: 0.1s;
        }
        .cat-btn.active {
            background: #ffdb94;
            color: #1c4a66;
            border-color: #ffb84d;
            transform: translateY(-7px);
            box-shadow: 0 22px 0 #cc9530;
        }
        .cat-btn:active {
            transform: translateY(10px);
            box-shadow: 0 6px 0 #134a64;
        }
        .buildings-scroll {
            background: rgba(255,255,255,0.96);
            backdrop-filter: blur(35px);
            border-radius: 100px;
            padding: 24px;
            margin-bottom: 35px;
            overflow-x: auto;
            white-space: nowrap;
            border: 6px solid white;
            box-shadow: inset 0 12px 35px #aaa;
        }
        .buildings-scroll::-webkit-scrollbar { display: none; }
        .buildings-track {
            display: inline-flex;
            gap: 32px;
            padding: 18px;
        }
        .build-card {
            background: linear-gradient(145deg, #fffef8, #f7eedb);
            border-radius: 90px;
            padding: 36px 42px;
            display: inline-flex;
            flex-direction: column;
            align-items: center;
            min-width: 250px;
            box-shadow: 0 28px 0 #d4bf98, 0 45px 70px rgba(0,0,0,0.6);
            border: 7px solid #fffae6;
            transition: 0.1s;
        }
        .build-card.selected {
            transform: translateY(-15px);
            border-color: #f7b731;
            box-shadow: 0 35px 0 #c9912e, 0 55px 80px black;
        }
        .build-card:active {
            transform: translateY(15px);
            box-shadow: 0 13px 0 #d4bf98;
        }
        .card-icon {
            width: 150px;
            height: 150px;
            background: #e3f0f5;
            border-radius: 70px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 100px;
            margin-bottom: 20px;
            box-shadow: inset 0 -15px 0 #c2d9e4;
        }
        .card-name {
            font-weight: 800;
            font-size: 28px;
            color: #2b7059;
        }
        .card-price {
            background: #d9bf94;
            padding: 14px 40px;
            border-radius: 80px;
            font-weight: 700;
            margin-top: 18px;
            font-size: 26px;
        }
        .action-bar {
            display: flex;
            gap: 25px;
            justify-content: center;
            flex-wrap: wrap;
            margin-bottom: 35px;
        }
        .action-button {
            flex: 1 1 auto;
            min-width: 250px;
            background: linear-gradient(145deg, #3f9ed4, #1c6fa0);
            border: none;
            border-radius: 100px;
            padding: 32px 35px;
            color: white;
            font-size: 34px;
            font-weight: bold;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 20px;
            box-shadow: 0 28px 0 #12547a, 0 45px 75px black;
            border: 6px solid #b0e2ff;
            position: relative;
        }
        .action-button:active {
            transform: translateY(15px);
            box-shadow: 0 13px 0 #12547a;
        }
        .cooldown-indicator {
            position: absolute;
            top: 0;
            left: 0;
            height: 100%;
            background: rgba(0,0,0,0.45);
            border-radius: 100px;
            transition: width 0.1s linear;
            pointer-events: none;
        }
        .info-area {
            background: #e5f2fa;
            border-radius: 90px;
            padding: 32px;
            color: #12597a;
            border: 7px solid white;
            font-size: 28px;
            font-weight: 600;
            box-shadow: inset 0 15px 35px #b3d9f0, 0 28px 0 #548ea8;
        }
    </style>
</head>
<body>
<div class="game-wrapper">
    <div class="stats-panel">
        <div class="stat-item"><span class="stat-icon">üí∞</span> <span id="moneyDisplay">35000</span></div>
        <div class="stat-item"><span class="stat-icon">üë•</span> <span id="popDisplay">0</span></div>
        <div class="stat-item"><span class="stat-icon">üìä</span> <span id="incomeDisplay">0</span></div>
        <div class="stat-item"><span class="stat-icon">üèùÔ∏è</span> <span id="landDisplay">25</span></div>
    </div>

    <div class="canvas-area">
        <canvas id="gameCanvas" width="640" height="540"></canvas>
    </div>

    <div class="category-bar">
        <div class="cat-btn active" id="catRes">üèòÔ∏è –ñ–∏–ª—ã–µ</div>
        <div class="cat-btn" id="catCom">üè™ –ö–æ–º–º–µ—Ä—Ü–∏—è</div>
        <div class="cat-btn" id="catInd">üè≠ –ò–Ω–¥—É—Å—Ç—Ä–∏—è</div>
        <div class="cat-btn" id="catInf">üè• –°–æ—Ü. —Å—Ñ–µ—Ä–∞</div>
    </div>

    <div class="buildings-scroll">
        <div class="buildings-track" id="buildingsTrack"></div>
    </div>

    <div class="action-bar">
        <button class="action-button" id="collectBtn">
            <span>üí∞</span> –°–±–æ—Ä
            <div class="cooldown-indicator" id="cooldownBar" style="width: 0%;"></div>
        </button>
        <button class="action-button" id="expandBtn"><span>üåäüèùÔ∏è</span> 2000üí∞</button>
        <button class="action-button" id="cancelBtn"><span>‚ùå</span> –û—Ç–º–µ–Ω–∞</button>
    </div>

    <div class="info-area" id="infoPanel">
        üëÜ –í—ã–±–µ—Ä–∏—Ç–µ –∑–¥–∞–Ω–∏–µ –∏ –∫–æ—Å–Ω–∏—Ç–µ—Å—å —É—á–∞—Å—Ç–∫–∞ –Ω–∞ –∫–∞—Ä—Ç–µ.
    </div>
</div>

<script src="https://telegram.org/js/telegram-web-app.js"></script>
<script>
(function() {
    // ==================== –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Telegram ====================
    let tg = null;
    try {
        if (window.Telegram?.WebApp) {
            tg = Telegram.WebApp;
            tg.expand();
            tg.ready();
        }
    } catch {}

    // ==================== –ö–æ–Ω—Å—Ç–∞–Ω—Ç—ã –∏–∑–æ–º–µ—Ç—Ä–∏–∏ ====================
    const GRID_SIZE = 8;               // 8x8 –¥–ª—è –±–æ–ª—å—à–µ–≥–æ –ø—Ä–æ—Å—Ç–æ—Ä–∞
    const CELL_W = 100;                 // —à–∏—Ä–∏–Ω–∞ –æ—Å–Ω–æ–≤–∞–Ω–∏—è
    const CELL_H = 55;                  // –≤—ã—Å–æ—Ç–∞ –æ—Å–Ω–æ–≤–∞–Ω–∏—è
    const ISO_OFFSET_X = 300;            // —Ü–µ–Ω—Ç—Ä–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–∞ canvas 640x540
    const ISO_OFFSET_Y = 70;

    // ==================== –ì–ª–æ–±–∞–ª—å–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ ====================
    let gameState = {
        money: 35000,
        grid: [],
        land: [],
        population: 0,
        lastTaxTime: Date.now(),
        taxCooldown: 5000,                // 5 —Å–µ–∫—É–Ω–¥
        selectedBuilding: null,
        expandCost: 2000,
        gridSize: GRID_SIZE,
        buildingsCount: {},                // —Å—á—ë—Ç—á–∏–∫ –ø–æ—Å—Ç—Ä–æ–µ–∫ –¥–ª—è –≤–∞—Ä–∏–∞—Ü–∏–π
        season: 0,                         // –¥–ª—è —Å–º–µ–Ω—ã —Ü–≤–µ—Ç–∞ –ª–∏—Å—Ç–≤—ã (0-3)
    };

    // ==================== –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –æ—Å—Ç—Ä–æ–≤–∞ (–±–æ–ª—å—à–µ —Å—É—à–∏) ====================
    for (let r = 0; r < GRID_SIZE; r++) {
        gameState.grid[r] = [];
        gameState.land[r] = [];
        for (let c = 0; c < GRID_SIZE; c++) {
            // –¶–µ–Ω—Ç—Ä–∞–ª—å–Ω–∞—è –æ–±–ª–∞—Å—Ç—å 6x6 ‚Äî —Å—É—à–∞
            if (r >= 1 && r <= 6 && c >= 1 && c <= 6) {
                gameState.land[r][c] = true;
                gameState.grid[r][c] = 'empty';
            } else {
                gameState.land[r][c] = false;
                gameState.grid[r][c] = 'empty';
            }
        }
    }

    // ==================== –ë–ò–ë–õ–ò–û–¢–ï–ö–ê –ó–î–ê–ù–ò–ô (–†–ê–°–®–ò–†–ï–ù–ù–ê–Ø) ====================
    // –ö–∞–∂–¥–æ–µ –∑–¥–∞–Ω–∏–µ –∏–º–µ–µ—Ç –º–Ω–æ–∂–µ—Å—Ç–≤–æ –≤–∞—Ä–∏–∞—Ü–∏–π, –∫–æ—Ç–æ—Ä—ã–µ –≤—ã–±–∏—Ä–∞—é—Ç—Å—è —Å–ª—É—á–∞–π–Ω–æ –ø—Ä–∏ –ø–æ—Å—Ç—Ä–æ–π–∫–µ
    // –≠—Ç–æ –ø–æ–∑–≤–æ–ª—è–µ—Ç –≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å —É–Ω–∏–∫–∞–ª—å–Ω—ã–π –≤–Ω–µ—à–Ω–∏–π –≤–∏–¥ –±–µ–∑ –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏—è –∫–æ–¥–∞.

    const BUILDING_VARIANTS = {
        house: [
            { name: '–î–æ–º —Å –º–µ–∑–æ–Ω–∏–Ω–æ–º', colorBase: '#e3b27c', colorRoof: '#b54c4c', windows: 2, hasChimney: true, doorColor: '#8b5a2b' },
            { name: '–ö–æ—Ç—Ç–µ–¥–∂', colorBase: '#cf9f6b', colorRoof: '#8b5a2b', windows: 3, hasChimney: false, doorColor: '#a57248' },
            { name: '–¢–∞—É–Ω—Ö–∞—É—Å', colorBase: '#c49a6c', colorRoof: '#7a4c4c', windows: 4, hasChimney: true, doorColor: '#6b4c2c' },
            { name: '–í–∏–ª–ª–∞', colorBase: '#d9b382', colorRoof: '#b34b4b', windows: 4, hasChimney: true, doorColor: '#8b5a2b' },
            { name: '–®–∞–ª–µ', colorBase: '#b38b5a', colorRoof: '#6b4c2c', windows: 3, hasChimney: true, doorColor: '#5a3e24' }
        ],
        apartment: [
            { name: '–ú–Ω–æ–≥–æ–∫–≤–∞—Ä—Ç–∏—Ä–Ω—ã–π', colorBase: '#b0bec5', colorAccent: '#8a9aa8', windowsRows: 3, balconies: true },
            { name: '–ñ–∏–ª–æ–π –∫–æ–º–ø–ª–µ–∫—Å', colorBase: '#9e9e9e', colorAccent: '#757575', windowsRows: 4, balconies: true },
            { name: '–ë–∞—à–Ω—è', colorBase: '#8a9aa8', colorAccent: '#607d8b', windowsRows: 5, balconies: false }
        ],
        skyscraper: [
            { name: '–ù–µ–±–æ—Å–∫—Ä—ë–±', colorBase: '#607d8b', colorAccent: '#4f6573', windowsRows: 8, hasSpire: true, antenna: true },
            { name: '–ë–∏–∑–Ω–µ—Å-—Ü–µ–Ω—Ç—Ä', colorBase: '#546e7a', colorAccent: '#37474f', windowsRows: 7, hasSpire: false, antenna: true },
            { name: '–û—Ñ–∏—Å–Ω–∞—è –±–∞—à–Ω—è', colorBase: '#78909c', colorAccent: '#546e7a', windowsRows: 8, hasSpire: true, antenna: false }
        ],
        shop: [
            { name: '–ú–∞–≥–∞–∑–∏–Ω', colorBase: '#ffb74d', colorRoof: '#ff9800', hasSign: true, windows: 2 },
            { name: '–°—É–ø–µ—Ä–º–∞—Ä–∫–µ—Ç', colorBase: '#ff8a65', colorRoof: '#f57c00', hasSign: true, windows: 3 },
            { name: '–ë—É—Ç–∏–∫', colorBase: '#f9a825', colorRoof: '#f57f17', hasSign: true, windows: 2 }
        ],
        office: [
            { name: '–û—Ñ–∏—Å', colorBase: '#9e9e9e', colorAccent: '#757575', windowsRows: 3, hasLogo: true },
            { name: '–ë–∏–∑–Ω–µ—Å-–ø–∞—Ä–∫', colorBase: '#b0bec5', colorAccent: '#78909c', windowsRows: 4, hasLogo: false }
        ],
        school: [
            { name: '–®–∫–æ–ª–∞', colorBase: '#ff8a80', colorAccent: '#f06292', hasBell: true, columns: 2 },
            { name: '–ì–∏–º–Ω–∞–∑–∏—è', colorBase: '#ffab91', colorAccent: '#ff8a80', hasBell: true, columns: 3 }
        ],
        hospital: [
            { name: '–ë–æ–ª—å–Ω–∏—Ü–∞', colorBase: '#ef9a9a', colorAccent: '#e57373', hasCross: true, windows: 4 },
            { name: '–ö–ª–∏–Ω–∏–∫–∞', colorBase: '#ffcdd2', colorAccent: '#ef9a9a', hasCross: true, windows: 3 }
        ],
        park: [
            { name: '–ü–∞—Ä–∫', colorBase: '#81c784', treeCount: 3, hasFountain: true },
            { name: '–°–∫–≤–µ—Ä', colorBase: '#66bb6a', treeCount: 4, hasFountain: false },
            { name: '–ë—É–ª—å–≤–∞—Ä', colorBase: '#4caf50', treeCount: 5, hasFountain: false }
        ],
        road: [
            { name: '–î–æ—Ä–æ–≥–∞', colorBase: '#b0bec5', hasMarkup: true, hasLights: true },
            { name: '–®–æ—Å—Å–µ', colorBase: '#9e9e9e', hasMarkup: true, hasLights: false }
        ],
        powerplant: [
            { name: '–≠–ª–µ–∫—Ç—Ä–æ—Å—Ç–∞–Ω—Ü–∏—è', colorBase: '#b0a57c', colorAccent: '#8b7a5a', chimneys: 2, hasSmoke: true },
            { name: '–¢–≠–¶', colorBase: '#9e8f72', colorAccent: '#6b5d3a', chimneys: 3, hasSmoke: true }
        ],
        factory: [
            { name: '–ó–∞–≤–æ–¥', colorBase: '#b0bec5', colorAccent: '#8a9aa8', chimneys: 2, hasSmoke: true },
            { name: '–§–∞–±—Ä–∏–∫–∞', colorBase: '#9e9e9e', colorAccent: '#757575', chimneys: 1, hasSmoke: true }
        ],
        bank: [
            { name: '–ë–∞–Ω–∫', colorBase: '#cfd8dc', colorAccent: '#b0bec5', columns: 4, hasStatue: true },
            { name: '–§–∏–Ω–∞–Ω—Å–æ–≤—ã–π —Ü–µ–Ω—Ç—Ä', colorBase: '#b0bec5', colorAccent: '#90a4ae', columns: 6, hasStatue: false }
        ],
        hotel: [
            { name: '–û—Ç–µ–ª—å', colorBase: '#ffe082', colorAccent: '#ffd54f', windowsRows: 5, hasPool: true },
            { name: '–ì–æ—Å—Ç–∏–Ω–∏—Ü–∞', colorBase: '#ffd54f', colorAccent: '#ffb300', windowsRows: 4, hasPool: false }
        ],
        church: [
            { name: '–¶–µ—Ä–∫–æ–≤—å', colorBase: '#f5f5f5', colorRoof: '#b71c1c', hasSpire: true, hasCross: true },
            { name: '–°–æ–±–æ—Ä', colorBase: '#eeeeee', colorRoof: '#7b1f1f', hasSpire: true, hasCross: true }
        ],
        monument: [
            { name: '–ú–æ–Ω—É–º–µ–Ω—Ç', colorBase: '#b0bec5', height: 40, hasStatue: true },
            { name: '–°—Ç–µ–ª–∞', colorBase: '#9e9e9e', height: 35, hasStatue: false }
        ]
    };

    // ==================== –ö–ê–¢–ê–õ–û–ì –ó–î–ê–ù–ò–ô (–¥–ª—è UI –∏ —ç–∫–æ–Ω–æ–º–∏–∫–∏) ====================
    const BUILDINGS_CATALOG = [
        // –ñ–∏–ª—ã–µ
        { id: 'house1', category: 'residential', variantPool: 'house', basePrice: 300, baseIncome: 22, basePop: 9 },
        { id: 'house2', category: 'residential', variantPool: 'house', basePrice: 600, baseIncome: 40, basePop: 18 },
        { id: 'apartment1', category: 'residential', variantPool: 'apartment', basePrice: 2000, baseIncome: 150, basePop: 70 },
        { id: 'skyscraper1', category: 'residential', variantPool: 'skyscraper', basePrice: 8000, baseIncome: 700, basePop: 350 },
        // –ö–æ–º–º–µ—Ä—Ü–∏—è
        { id: 'shop1', category: 'commercial', variantPool: 'shop', basePrice: 500, baseIncome: 60, basePop: 4 },
        { id: 'office1', category: 'commercial', variantPool: 'office', basePrice: 1800, baseIncome: 200, basePop: 12 },
        { id: 'bank1', category: 'commercial', variantPool: 'bank', basePrice: 4000, baseIncome: 450, basePop: 8 },
        { id: 'hotel1', category: 'commercial', variantPool: 'hotel', basePrice: 3500, baseIncome: 380, basePop: 25 },
        // –ò–Ω–¥—É—Å—Ç—Ä–∏—è
        { id: 'factory1', category: 'industrial', variantPool: 'factory', basePrice: 3000, baseIncome: 350, basePop: 5 },
        { id: 'powerplant1', category: 'industrial', variantPool: 'powerplant', basePrice: 7000, baseIncome: 800, basePop: 0 },
        // –°–æ—Ü–∏–∞–ª—å–Ω–∞—è —Å—Ñ–µ—Ä–∞
        { id: 'school1', category: 'infrastructure', variantPool: 'school', basePrice: 3000, baseIncome: 90, basePop: 0 },
        { id: 'hospital1', category: 'infrastructure', variantPool: 'hospital', basePrice: 5000, baseIncome: 160, basePop: 0 },
        { id: 'park1', category: 'infrastructure', variantPool: 'park', basePrice: 400, baseIncome: 30, basePop: 4 },
        { id: 'road1', category: 'infrastructure', variantPool: 'road', basePrice: 180, baseIncome: 8, basePop: 0 },
        { id: 'church1', category: 'infrastructure', variantPool: 'church', basePrice: 2500, baseIncome: 60, basePop: 0 },
        { id: 'monument1', category: 'infrastructure', variantPool: 'monument', basePrice: 1500, baseIncome: 25, basePop: 0 }
    ];

    // –°–æ–∑–¥–∞—ë–º –±—ã—Å—Ç—Ä—ã–π —Å–ª–æ–≤–∞—Ä—å –¥–ª—è –¥–æ—Å—Ç—É–ø–∞ –ø–æ id
    const BUILDING_DICT = {};
    BUILDINGS_CATALOG.forEach(b => { BUILDING_DICT[b.id] = b; });

    // –•—Ä–∞–Ω–∏–ª–∏—â–µ –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤ –¥–ª—è –∫–∞–∂–¥–æ–π –ø–æ—Å—Ç—Ä–æ–µ–Ω–Ω–æ–π –∫–ª–µ—Ç–∫–∏
    let buildingVariants = {};

    // ==================== –§–£–ù–ö–¶–ò–ò –û–¢–†–ò–°–û–í–ö–ò (–î–ï–¢–ê–õ–¨–ù–´–ï, –° –¢–ï–ù–Ø–ú–ò) ====================
    const ctx = document.getElementById('gameCanvas').getContext('2d');

    function drawBase(x, y, color, heightOffset = 0) {
        ctx.fillStyle = color;
        ctx.shadowColor = '#2b4d2b';
        ctx.shadowBlur = 30;
        ctx.shadowOffsetY = 18;
        ctx.beginPath();
        ctx.moveTo(x, y - 5 - heightOffset);
        ctx.lineTo(x + CELL_W/2, y + CELL_H/2 - 5 - heightOffset);
        ctx.lineTo(x, y + CELL_H - 5 - heightOffset);
        ctx.lineTo(x - CELL_W/2, y + CELL_H/2 - 5 - heightOffset);
        ctx.closePath();
        ctx.fill();
    }

    function drawHouse(x, y, variant) {
        drawBase(x, y, variant.colorBase);
        // –°—Ç–µ–Ω—ã
        ctx.fillStyle = variant.colorBase;
        ctx.fillRect(x-22, y-48, 44, 32);
        // –ö—Ä—ã—à–∞
        ctx.fillStyle = variant.colorRoof;
        ctx.beginPath();
        ctx.moveTo(x-30, y-52);
        ctx.lineTo(x+30, y-52);
        ctx.lineTo(x, y-84);
        ctx.closePath();
        ctx.fill();
        // –ß–µ—Ä–µ–ø–∏—Ü–∞
        ctx.strokeStyle = '#8b3a3a';
        ctx.lineWidth = 2;
        for (let i = -20; i <= 20; i+=12) {
            ctx.beginPath();
            ctx.moveTo(x-25+i, y-60);
            ctx.lineTo(x-8+i, y-78);
            ctx.stroke();
        }
        // –û–∫–Ω–∞
        ctx.fillStyle = '#f9e076';
        ctx.shadowBlur = 10;
        if (variant.windows >= 2) {
            ctx.fillRect(x-30, y-42, 10, 14);
            ctx.fillRect(x+20, y-42, 10, 14);
            if (variant.windows >= 3) {
                ctx.fillRect(x-10, y-42, 10, 14);
            }
            if (variant.windows >= 4) {
                ctx.fillRect(x-30, y-24, 10, 14);
                ctx.fillRect(x+20, y-24, 10, 14);
            }
        }
        // –î–≤–µ—Ä—å
        ctx.fillStyle = variant.doorColor;
        ctx.fillRect(x-12, y-28, 24, 28);
        ctx.fillStyle = '#d4af37';
        ctx.beginPath();
        ctx.arc(x-4, y-14, 3, 0, 2*Math.PI);
        ctx.fill();
        // –¢—Ä—É–±–∞
        if (variant.hasChimney) {
            ctx.fillStyle = '#8b5a2b';
            ctx.fillRect(x+18, y-70, 8, 18);
        }
        ctx.shadowBlur = 0;
    }

    function drawApartment(x, y, variant) {
        drawBase(x, y, variant.colorBase);
        ctx.fillStyle = variant.colorAccent;
        ctx.fillRect(x-28, y-70, 56, 48);
        // –û–∫–Ω–∞
        for (let i = -16; i <= 16; i+=20) {
            for (let j = -60; j <= -24; j+=18) {
                ctx.fillStyle = '#cfd8dc';
                ctx.fillRect(x-10+i, y+j, 12, 12);
                ctx.fillStyle = '#f9e076';
                ctx.fillRect(x-8+i, y+j+2, 4, 4);
                ctx.fillRect(x-2+i, y+j+2, 4, 4);
            }
        }
        // –ë–∞–ª–∫–æ–Ω—ã
        if (variant.balconies) {
            ctx.fillStyle = '#a0aab3';
            ctx.fillRect(x-34, y-46, 22, 6);
            ctx.fillRect(x+12, y-46, 22, 6);
        }
    }

    function drawSkyscraper(x, y, variant) {
        drawBase(x, y, variant.colorBase);
        ctx.fillStyle = variant.colorAccent;
        ctx.fillRect(x-36, y-120, 72, 90);
        // –û–∫–Ω–∞
        for (let i = -24; i <= 24; i+=20) {
            for (let j = -105; j <= -25; j+=20) {
                ctx.fillStyle = '#ffd966';
                ctx.fillRect(x-12+i, y+j-2, 14, 14);
                ctx.fillStyle = '#fff';
                ctx.fillRect(x-10+i, y+j, 4, 4);
                ctx.fillRect(x-2+i, y+j, 4, 4);
            }
        }
        // –®–ø–∏–ª—å/–∞–Ω—Ç–µ–Ω–Ω–∞
        if (variant.hasSpire) {
            ctx.fillStyle = '#b0bec5';
            ctx.fillRect(x-4, y-138, 8, 22);
            ctx.fillStyle = '#d4af37';
            ctx.beginPath();
            ctx.arc(x, y-150, 8, 0, 2*Math.PI);
            ctx.fill();
        }
        if (variant.antenna) {
            ctx.fillStyle = '#b0bec5';
            ctx.fillRect(x-2, y-148, 4, 28);
        }
    }

    function drawShop(x, y, variant) {
        drawBase(x, y, variant.colorBase);
        ctx.fillStyle = variant.colorRoof;
        ctx.fillRect(x-30, y-48, 60, 30);
        // –í–∏—Ç—Ä–∏–Ω–∞
        ctx.fillStyle = '#fff2cc';
        ctx.fillRect(x-22, y-42, 16, 18);
        ctx.fillRect(x+6, y-42, 16, 18);
        // –¢–æ–≤–∞—Ä—ã
        ctx.fillStyle = '#8b5a2b';
        ctx.font = '28px sans-serif';
        ctx.fillText('üõí', x-32, y-18);
        ctx.fillText('üßÉ', x+10, y-22);
        // –í—ã–≤–µ—Å–∫–∞
        if (variant.hasSign) {
            ctx.fillStyle = '#c43a3a';
            ctx.fillRect(x-16, y-70, 32, 14);
            ctx.fillStyle = '#fff';
            ctx.font = '22px sans-serif';
            ctx.fillText('SALE', x-14, y-58);
        }
    }

    function drawOffice(x, y, variant) {
        drawBase(x, y, variant.colorBase);
        ctx.fillStyle = variant.colorAccent;
        ctx.fillRect(x-32, y-68, 64, 48);
        // –û–∫–Ω–∞
        for (let i = -18; i <= 18; i+=22) {
            ctx.fillStyle = '#cfd8dc';
            ctx.fillRect(x-14+i, y-58, 14, 10);
            ctx.fillRect(x-14+i, y-38, 14, 10);
            ctx.fillStyle = '#aed6f1';
            ctx.fillRect(x-12+i, y-56, 4, 4);
            ctx.fillRect(x-12+i, y-36, 4, 4);
        }
        // –õ–æ–≥–æ—Ç–∏–ø
        if (variant.hasLogo) {
            ctx.fillStyle = '#ffb74d';
            ctx.beginPath();
            ctx.arc(x, y-84, 10, 0, 2*Math.PI);
            ctx.fill();
            ctx.fillStyle = '#fff';
            ctx.font = '18px sans-serif';
            ctx.fillText('INC', x-16, y-82);
        }
    }

    function drawSchool(x, y, variant) {
        drawBase(x, y, variant.colorBase);
        ctx.fillStyle = variant.colorAccent;
        ctx.fillRect(x-36, y-68, 72, 50);
        // –ö–æ–ª–æ–Ω–Ω—ã
        ctx.fillStyle = '#fff0e0';
        for (let i = -20; i <= 20; i+=22) {
            ctx.fillRect(x-12+i, y-50, 8, 28);
        }
        // –û–∫–Ω–∞
        for (let i = -20; i <= 20; i+=22) {
            ctx.fillStyle = '#ffffff';
            ctx.fillRect(x-10+i, y-58, 12, 12);
            ctx.fillRect(x-10+i, y-34, 12, 12);
        }
        // –ö–æ–ª–æ–∫–æ–ª—å—á–∏–∫
        if (variant.hasBell) {
            ctx.fillStyle = '#d4af37';
            ctx.beginPath();
            ctx.arc(x, y-90, 10, 0, 2*Math.PI);
            ctx.fill();
            ctx.fillStyle = '#b8860b';
            ctx.fillRect(x-3, y-100, 6, 12);
        }
    }

    function drawHospital(x, y, variant) {
        drawBase(x, y, variant.colorBase);
        ctx.fillStyle = variant.colorAccent;
        ctx.fillRect(x-36, y-72, 72, 54);
        // –ö—Ä–∞—Å–Ω—ã–π –∫—Ä–µ—Å—Ç
        ctx.fillStyle = '#ff4d4d';
        ctx.fillRect(x-10, y-54, 20, 12);
        ctx.fillRect(x-5, y-62, 10, 24);
        // –û–∫–Ω–∞
        for (let i = -20; i <= 20; i+=24) {
            ctx.fillStyle = '#b0e0e6';
            ctx.fillRect(x-14+i, y-52, 12, 12);
            ctx.fillRect(x-14+i, y-28, 12, 12);
        }
    }

    function drawPark(x, y, variant) {
        drawBase(x, y, variant.colorBase);
        // –î–µ—Ä–µ–≤—å—è
        ctx.fillStyle = '#5f9b6b';
        for (let i = 0; i < variant.treeCount; i++) {
            let dx = -25 + i * 15;
            ctx.beginPath();
            ctx.arc(x+dx, y-35 - i*2, 10, 0, 2*Math.PI);
            ctx.fill();
        }
        ctx.fillStyle = '#8b5a2b';
        for (let i = 0; i < variant.treeCount; i++) {
            let dx = -25 + i * 15;
            ctx.fillRect(x-4+dx, y-28, 6, 15);
        }
        // –§–æ–Ω—Ç–∞–Ω
        if (variant.hasFountain) {
            ctx.fillStyle = '#b0e0e6';
            ctx.beginPath();
            ctx.arc(x, y-25, 12, 0, 2*Math.PI);
            ctx.fill();
            ctx.fillStyle = '#fff';
            ctx.font = '22px sans-serif';
            ctx.fillText('‚õ≤', x-10, y-30);
        }
    }

    function drawRoad(x, y, variant) {
        drawBase(x, y, variant.colorBase, 2);
        // –ê—Å—Ñ–∞–ª—å—Ç
        ctx.fillStyle = '#b0bec5';
        ctx.fillRect(x-40, y-12, 80, 6);
        // –†–∞–∑–º–µ—Ç–∫–∞
        if (variant.hasMarkup) {
            ctx.fillStyle = '#f5f5f5';
            ctx.fillRect(x-35, y-8, 10, 2);
            ctx.fillRect(x-10, y-8, 10, 2);
            ctx.fillRect(x+15, y-8, 10, 2);
        }
        // –§–æ–Ω–∞—Ä–∏
        if (variant.hasLights) {
            ctx.fillStyle = '#8a9aa8';
            ctx.fillRect(x-25, y-45, 4, 28);
            ctx.fillRect(x+21, y-45, 4, 28);
            ctx.fillStyle = '#ffd966';
            ctx.beginPath();
            ctx.arc(x-23, y-52, 5, 0, 2*Math.PI);
            ctx.fill();
            ctx.beginPath();
            ctx.arc(x+23, y-52, 5, 0, 2*Math.PI);
            ctx.fill();
        }
    }

    function drawPowerPlant(x, y, variant) {
        drawBase(x, y, variant.colorBase);
        ctx.fillStyle = variant.colorAccent;
        ctx.fillRect(x-38, y-90, 76, 60);
        // –¢—Ä—É–±—ã
        ctx.fillStyle = '#6b5a3a';
        for (let i = 0; i < variant.chimneys; i++) {
            let dx = -20 + i * 25;
            ctx.fillRect(x-8+dx, y-120, 10, 38);
        }
        // –î—ã–º
        if (variant.hasSmoke) {
            ctx.fillStyle = 'rgba(255,255,255,0.3)';
            ctx.beginPath();
            ctx.arc(x-15, y-140, 14, 0, 2*Math.PI);
            ctx.fill();
            ctx.beginPath();
            ctx.arc(x+15, y-150, 12, 0, 2*Math.PI);
            ctx.fill();
        }
        // –û–∫–Ω–∞
        ctx.fillStyle = '#ffb74d';
        for (let i = -16; i <= 16; i+=20) {
            ctx.fillRect(x-8+i, y-60, 8, 10);
        }
    }

    function drawFactory(x, y, variant) {
        drawBase(x, y, variant.colorBase);
        ctx.fillStyle = variant.colorAccent;
        ctx.fillRect(x-34, y-80, 68, 52);
        // –¢—Ä—É–±—ã
        ctx.fillStyle = '#6b5a3a';
        for (let i = 0; i < variant.chimneys; i++) {
            let dx = -15 + i * 25;
            ctx.fillRect(x-6+dx, y-110, 8, 32);
        }
        // –î—ã–º
        if (variant.hasSmoke) {
            ctx.fillStyle = 'rgba(255,255,255,0.3)';
            ctx.beginPath();
            ctx.arc(x-12, y-130, 12, 0, 2*Math.PI);
            ctx.fill();
        }
        // –í–æ—Ä–æ—Ç–∞
        ctx.fillStyle = '#8b5a2b';
        ctx.fillRect(x-18, y-40, 36, 20);
    }

    function drawBank(x, y, variant) {
        drawBase(x, y, variant.colorBase);
        ctx.fillStyle = variant.colorAccent;
        ctx.fillRect(x-40, y-70, 80, 48);
        // –ö–æ–ª–æ–Ω–Ω—ã
        ctx.fillStyle = '#f5f5f5';
        for (let i = -28; i <= 28; i+=18) {
            ctx.fillRect(x-6+i, y-58, 8, 32);
        }
        // –°—Ç–∞—Ç—É—è
        if (variant.hasStatue) {
            ctx.fillStyle = '#b0bec5';
            ctx.beginPath();
            ctx.arc(x, y-88, 10, 0, 2*Math.PI);
            ctx.fill();
            ctx.fillRect(x-3, y-98, 6, 12);
        }
    }

    function drawHotel(x, y, variant) {
        drawBase(x, y, variant.colorBase);
        ctx.fillStyle = variant.colorAccent;
        ctx.fillRect(x-38, y-90, 76, 62);
        // –û–∫–Ω–∞
        for (let i = -24; i <= 24; i+=20) {
            for (let j = -78; j <= -22; j+=18) {
                ctx.fillStyle = '#fff2cc';
                ctx.fillRect(x-12+i, y+j, 14, 12);
            }
        }
        // –ë–∞—Å—Å–µ–π–Ω
        if (variant.hasPool) {
            ctx.fillStyle = '#7ec8e0';
            ctx.fillRect(x-20, y-18, 40, 8);
        }
    }

    function drawChurch(x, y, variant) {
        drawBase(x, y, variant.colorBase);
        ctx.fillStyle = variant.colorBase;
        ctx.fillRect(x-28, y-70, 56, 48);
        // –ö—Ä—ã—à–∞
        ctx.fillStyle = variant.colorRoof;
        ctx.beginPath();
        ctx.moveTo(x-35, y-74);
        ctx.lineTo(x+35, y-74);
        ctx.lineTo(x, y-110);
        ctx.closePath();
        ctx.fill();
        // –ö—Ä–µ—Å—Ç
        if (variant.hasCross) {
            ctx.fillStyle = '#d4af37';
            ctx.fillRect(x-3, y-118, 6, 22);
            ctx.fillRect(x-9, y-128, 18, 6);
        }
    }

    function drawMonument(x, y, variant) {
        drawBase(x, y, variant.colorBase);
        ctx.fillStyle = variant.colorBase;
        ctx.fillRect(x-16, y-70, 32, 48);
        // –°—Ç–∞—Ç—É—è
        if (variant.hasStatue) {
            ctx.fillStyle = '#cfd8dc';
            ctx.beginPath();
            ctx.arc(x, y-94, 10, 0, 2*Math.PI);
            ctx.fill();
        }
    }

    // ==================== –û–°–ù–û–í–ù–ê–Ø –§–£–ù–ö–¶–ò–Ø –û–¢–†–ò–°–û–í–ö–ò –ì–û–†–û–î–ê ====================
    function drawCity() {
        ctx.clearRect(0, 0, canvas.width, canvas.height);

        // –ù–µ–±–æ —Å –≥–ª—É–±–æ–∫–∏–º –≥—Ä–∞–¥–∏–µ–Ω—Ç–æ–º
        const skyGrad = ctx.createLinearGradient(0, 0, 0, canvas.height);
        skyGrad.addColorStop(0, '#0b4b72');
        skyGrad.addColorStop(1, '#1f7aa3');
        ctx.fillStyle = skyGrad;
        ctx.fillRect(0, 0, canvas.width, canvas.height);

        // –°–æ–ª–Ω—Ü–µ —Å —Å–∏—è–Ω–∏–µ–º
        ctx.shadowBlur = 100;
        ctx.shadowColor = '#fff9c4';
        ctx.beginPath();
        ctx.arc(160, 110, 50, 0, 2*Math.PI);
        ctx.fillStyle = '#fff3b0';
        ctx.fill();

        // –û–±–ª–∞–∫–∞
        ctx.shadowBlur = 70;
        ctx.fillStyle = 'rgba(255,255,255,0.15)';
        ctx.beginPath();
        ctx.ellipse(240, 170, 100, 45, 0, 0, 2*Math.PI);
        ctx.fill();
        ctx.beginPath();
        ctx.ellipse(460, 210, 120, 55, 0, 0, 2*Math.PI);
        ctx.fill();

        ctx.shadowBlur = 0;

        // –í–æ–¥–∞ (–≥–ª–∞–¥–∫–∞—è, –±–µ–∑ –≤–æ–ª–Ω)
        ctx.fillStyle = '#1f7a9c';
        ctx.shadowColor = '#0c4b66';
        ctx.shadowBlur = 30;
        ctx.shadowOffsetY = 12;
        for (let r = 0; r < GRID_SIZE; r++) {
            for (let c = 0; c < GRID_SIZE; c++) {
                if (!gameState.land[r][c]) {
                    let p = iso(r, c);
                    ctx.beginPath();
                    ctx.moveTo(p.x, p.y);
                    ctx.lineTo(p.x + CELL_W/2, p.y + CELL_H/2);
                    ctx.lineTo(p.x, p.y + CELL_H);
                    ctx.lineTo(p.x - CELL_W/2, p.y + CELL_H/2);
                    ctx.closePath();
                    ctx.fill();
                }
            }
        }

        // –û—Ç—Ä–∏—Å–æ–≤–∫–∞ —Å—É—à–∏ –∏ –∑–¥–∞–Ω–∏–π
        for (let r = 0; r < GRID_SIZE; r++) {
            for (let c = 0; c < GRID_SIZE; c++) {
                if (gameState.land[r][c]) {
                    let p = iso(r, c);
                    let cellType = gameState.grid[r][c];
                    if (cellType === 'empty') {
                        // –ü—É—Å—Ç–∞—è –∑–µ–º–ª—è —Å —Ç–µ–∫—Å—Ç—É—Ä–æ–π
                        ctx.fillStyle = '#7cb57c';
                        ctx.shadowBlur = 30;
                        ctx.shadowOffsetY = 15;
                        ctx.beginPath();
                        ctx.moveTo(p.x, p.y-5);
                        ctx.lineTo(p.x + CELL_W/2, p.y + CELL_H/2-5);
                        ctx.lineTo(p.x, p.y + CELL_H-5);
                        ctx.lineTo(p.x - CELL_W/2, p.y + CELL_H/2-5);
                        ctx.closePath();
                        ctx.fill();
                        ctx.shadowBlur = 0;
                        // –¢—Ä–∞–≤–∏–Ω–∫–∏
                        ctx.fillStyle = '#5f8b5f';
                        for (let i = -20; i <= 20; i+=15) {
                            ctx.fillRect(p.x-5+i, p.y-28, 4, 15);
                        }
                    } else {
                        // –ó–¥–∞–Ω–∏–µ ‚Äî –∏—â–µ–º –≤–∞—Ä–∏–∞–Ω—Ç
                        let variantKey = r + '_' + c;
                        let variant = buildingVariants[variantKey];
                        if (!variant) {
                            // –ï—Å–ª–∏ –≤–∞—Ä–∏–∞–Ω—Ç–∞ –Ω–µ—Ç, —Å–æ–∑–¥–∞—ë–º —Å–ª—É—á–∞–π–Ω—ã–π –∏–∑ –ø—É–ª–∞
                            let buildingDef = BUILDING_DICT[cellType];
                            if (buildingDef) {
                                let pool = BUILDING_VARIANTS[buildingDef.variantPool];
                                if (pool && pool.length) {
                                    variant = pool[Math.floor(Math.random() * pool.length)];
                                    buildingVariants[variantKey] = variant;
                                }
                            }
                        }
                        if (variant) {
                            // –í—ã–∑—ã–≤–∞–µ–º –Ω—É–∂–Ω—É—é —Ñ—É–Ω–∫—Ü–∏—é –æ—Ç—Ä–∏—Å–æ–≤–∫–∏
                            switch (buildingDef.variantPool) {
                                case 'house': drawHouse(p.x, p.y, variant); break;
                                case 'apartment': drawApartment(p.x, p.y, variant); break;
                                case 'skyscraper': drawSkyscraper(p.x, p.y, variant); break;
                                case 'shop': drawShop(p.x, p.y, variant); break;
                                case 'office': drawOffice(p.x, p.y, variant); break;
                                case 'school': drawSchool(p.x, p.y, variant); break;
                                case 'hospital': drawHospital(p.x, p.y, variant); break;
                                case 'park': drawPark(p.x, p.y, variant); break;
                                case 'road': drawRoad(p.x, p.y, variant); break;
                                case 'powerplant': drawPowerPlant(p.x, p.y, variant); break;
                                case 'factory': drawFactory(p.x, p.y, variant); break;
                                case 'bank': drawBank(p.x, p.y, variant); break;
                                case 'hotel': drawHotel(p.x, p.y, variant); break;
                                case 'church': drawChurch(p.x, p.y, variant); break;
                                case 'monument': drawMonument(p.x, p.y, variant); break;
                                default: break;
                            }
                        }
                    }
                }
            }
        }

        // –ü–æ–¥—Å–≤–µ—Ç–∫–∞ –≤—ã–±—Ä–∞–Ω–Ω–æ–π –∫–ª–µ—Ç–∫–∏
        if (selectedRow !== -1 && selectedCol !== -1 && gameState.land[selectedRow]?.[selectedCol]) {
            let p = iso(selectedRow, selectedCol);
            ctx.shadowColor = '#ffdf7e';
            ctx.shadowBlur = 60;
            ctx.strokeStyle = '#ffdb7e';
            ctx.lineWidth = 12;
            ctx.beginPath();
            ctx.moveTo(p.x, p.y-30);
            ctx.lineTo(p.x + CELL_W/2, p.y + CELL_H/2-30);
            ctx.lineTo(p.x, p.y + CELL_H-30);
            ctx.lineTo(p.x - CELL_W/2, p.y + CELL_H/2-30);
            ctx.closePath();
            ctx.stroke();
            ctx.shadowBlur = 0;
        }
    }

    // ==================== –í–°–ü–û–ú–û–ì–ê–¢–ï–õ–¨–ù–´–ï –§–£–ù–ö–¶–ò–ò ====================
    function iso(row, col) {
        return {
            x: (col - row) * CELL_W / 2 + ISO_OFFSET_X,
            y: (col + row) * CELL_H / 2 + ISO_OFFSET_Y
        };
    }

    let selectedRow = -1, selectedCol = -1;

    function handleCanvasTap(e) {
        e.preventDefault();
        const rect = canvas.getBoundingClientRect();
        const scaleX = canvas.width / rect.width;
        const scaleY = canvas.height / rect.height;
        let clientX, clientY;
        if (e.touches) {
            clientX = e.touches[0].clientX;
            clientY = e.touches[0].clientY;
        } else {
            clientX = e.clientX;
            clientY = e.clientY;
        }
        const mouseX = (clientX - rect.left) * scaleX;
        const mouseY = (clientY - rect.top) * scaleY;

        let bestDist = 150;
        for (let r = 0; r < GRID_SIZE; r++) {
            for (let c = 0; c < GRID_SIZE; c++) {
                let p = iso(r, c);
                let d = Math.hypot(mouseX - p.x, mouseY - p.y);
                if (d < bestDist) {
                    bestDist = d;
                    selectedRow = r;
                    selectedCol = c;
                }
            }
        }
        if (selectedRow !== -1 && selectedCol !== -1) {
            if (!gameState.land[selectedRow][selectedCol]) {
                document.getElementById('infoPanel').innerText = 'üåä –í–æ–¥–∞. –ú–æ–∂–Ω–æ —Ä–∞—Å—à–∏—Ä–∏—Ç—å –æ—Å—Ç—Ä–æ–≤.';
            } else if (gameState.selectedBuilding) {
                buildAt(selectedRow, selectedCol);
            } else {
                showInfo(selectedRow, selectedCol);
            }
            drawCity();
        }
    }

    function buildAt(row, col) {
        if (!gameState.selectedBuilding) return;
        let buildingDef = BUILDING_DICT[gameState.selectedBuilding];
        if (!buildingDef) return;
        if (gameState.money < buildingDef.basePrice) {
            alert('–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –º–æ–Ω–µ—Ç');
            return;
        }
        if (gameState.grid[row][col] !== 'empty') {
            alert('–ö–ª–µ—Ç–∫–∞ —É–∂–µ –∑–∞–Ω—è—Ç–∞');
            return;
        }
        // –°—Ç—Ä–æ–∏–º
        gameState.money -= buildingDef.basePrice;
        gameState.grid[row][col] = gameState.selectedBuilding;
        gameState.population += buildingDef.basePop;

        // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º —É–Ω–∏–∫–∞–ª—å–Ω—ã–π –≤–∞—Ä–∏–∞–Ω—Ç –¥–ª—è —ç—Ç–æ–≥–æ –∑–¥–∞–Ω–∏—è
        let pool = BUILDING_VARIANTS[buildingDef.variantPool];
        if (pool && pool.length) {
            let variant = pool[Math.floor(Math.random() * pool.length)];
            buildingVariants[row + '_' + col] = variant;
        }

        updateUI();
        drawCity();
        saveGame();
        if (tg) tg.HapticFeedback.impactOccurred('light');
    }

    function showInfo(row, col) {
        let type = gameState.grid[row][col];
        if (type === 'empty') {
            document.getElementById('infoPanel').innerText = 'üå± –ü—É—Å—Ç–æ–π —É—á–∞—Å—Ç–æ–∫. –í—ã–±–µ—Ä–∏—Ç–µ –∑–¥–∞–Ω–∏–µ.';
        } else {
            let def = BUILDING_DICT[type];
            document.getElementById('infoPanel').innerText = `${def.name} | –¥–æ—Ö–æ–¥: ${def.baseIncome}üí∞ | –∂–∏—Ç–µ–ª–∏: +${def.basePop}`;
        }
    }

    // ==================== –°–ë–û–† –ù–ê–õ–û–ì–û–í ====================
    function collectTaxes() {
        let now = Date.now();
        if (now - gameState.lastTaxTime < gameState.taxCooldown) return;

        let total = 0;
        for (let r = 0; r < GRID_SIZE; r++) {
            for (let c = 0; c < GRID_SIZE; c++) {
                if (gameState.land[r][c] && gameState.grid[r][c] !== 'empty') {
                    let def = BUILDING_DICT[gameState.grid[r][c]];
                    if (def) total += def.baseIncome;
                }
            }
        }
        gameState.money += total;
        gameState.lastTaxTime = now;
        updateUI();
        saveGame();
        document.getElementById('infoPanel').innerText = `üí∞ –°–æ–±—Ä–∞–Ω–æ ${total} –º–æ–Ω–µ—Ç!`;
        startCooldown();
        if (tg) tg.HapticFeedback.notificationOccurred('success');
    }

    function startCooldown() {
        let btn = document.getElementById('collectBtn');
        let bar = document.getElementById('cooldownBar');
        let start = Date.now();
        let end = start + gameState.taxCooldown;
        btn.disabled = true;
        let interval = setInterval(() => {
            let now = Date.now();
            let remaining = end - now;
            if (remaining <= 0) {
                btn.disabled = false;
                bar.style.width = '0%';
                clearInterval(interval);
                return;
            }
            let percent = ((gameState.taxCooldown - remaining) / gameState.taxCooldown) * 100;
            bar.style.width = percent + '%';
        }, 50);
    }

    // ==================== –†–ê–°–®–ò–†–ï–ù–ò–ï –û–°–¢–†–û–í–ê ====================
    function expandIsland() {
        if (gameState.money < gameState.expandCost) {
            alert('–ù–µ —Ö–≤–∞—Ç–∞–µ—Ç –º–æ–Ω–µ—Ç');
            return;
        }
        let candidates = [];
        for (let r = 0; r < GRID_SIZE; r++) {
            for (let c = 0; c < GRID_SIZE; c++) {
                if (!gameState.land[r][c]) {
                    let neighbors = [[-1,0],[1,0],[0,-1],[0,1]];
                    for (let [dr, dc] of neighbors) {
                        let nr = r+dr, nc = c+dc;
                        if (nr>=0 && nr<GRID_SIZE && nc>=0 && nc<GRID_SIZE && gameState.land[nr][nc]) {
                            candidates.push([r,c]);
                            break;
                        }
                    }
                }
            }
        }
        if (candidates.length === 0) {
            alert('–ù–µ—Ç –¥–æ—Å—Ç—É–ø–Ω–æ–π –≤–æ–¥—ã –¥–ª—è —Ä–∞—Å—à–∏—Ä–µ–Ω–∏—è');
            return;
        }
        let [rr, cc] = candidates[Math.floor(Math.random() * candidates.length)];
        gameState.money -= gameState.expandCost;
        gameState.land[rr][cc] = true;
        gameState.grid[rr][cc] = 'empty';
        updateUI();
        drawCity();
        saveGame();
        document.getElementById('infoPanel').innerText = 'üåä‚û°Ô∏èüèùÔ∏è –ù–æ–≤–∞—è –∑–µ–º–ª—è!';
    }

    // ==================== –û–ë–ù–û–í–õ–ï–ù–ò–ï –ò–ù–¢–ï–†–§–ï–ô–°–ê ====================
    function updateUI() {
        document.getElementById('moneyDisplay').innerText = gameState.money;
        document.getElementById('popDisplay').innerText = gameState.population;
        let totalIncome = 0;
        for (let r = 0; r < GRID_SIZE; r++) {
            for (let c = 0; c < GRID_SIZE; c++) {
                if (gameState.land[r][c] && gameState.grid[r][c] !== 'empty') {
                    let def = BUILDING_DICT[gameState.grid[r][c]];
                    if (def) totalIncome += def.baseIncome;
                }
            }
        }
        document.getElementById('incomeDisplay').innerText = totalIncome;
        let landCount = 0;
        for (let r = 0; r < GRID_SIZE; r++) {
            for (let c = 0; c < GRID_SIZE; c++) {
                if (gameState.land[r][c]) landCount++;
            }
        }
        document.getElementById('landDisplay').innerText = landCount;
    }

    // ==================== –ü–û–°–¢–†–û–ï–ù–ò–ï –ü–ê–ù–ï–õ–ò –í–´–ë–û–†–ê ====================
    function renderBuildings(category) {
        const track = document.getElementById('buildingsTrack');
        track.innerHTML = '';
        let filtered = BUILDINGS_CATALOG.filter(b => b.category === category);
        filtered.forEach(b => {
            let card = document.createElement('div');
            card.className = 'build-card';
            card.dataset.type = b.id;
            // –í—ã–±–∏—Ä–∞–µ–º —ç–º–æ–¥–∑–∏ –¥–ª—è –ø—Ä–µ–≤—å—é
            let emoji = 'üè†';
            if (b.variantPool === 'apartment') emoji = 'üè¢';
            else if (b.variantPool === 'skyscraper') emoji = 'üèôÔ∏è';
            else if (b.variantPool === 'shop') emoji = 'üè™';
            else if (b.variantPool === 'office') emoji = 'üèõÔ∏è';
            else if (b.variantPool === 'school') emoji = 'üìö';
            else if (b.variantPool === 'hospital') emoji = 'üè•';
            else if (b.variantPool === 'park') emoji = 'üå≥';
            else if (b.variantPool === 'road') emoji = 'üõ£Ô∏è';
            else if (b.variantPool === 'powerplant') emoji = '‚ö°';
            else if (b.variantPool === 'factory') emoji = 'üè≠';
            else if (b.variantPool === 'bank') emoji = 'üí∞';
            else if (b.variantPool === 'hotel') emoji = 'üè®';
            else if (b.variantPool === 'church') emoji = '‚õ™';
            else if (b.variantPool === 'monument') emoji = 'üóΩ';

            card.innerHTML = `
                <div class="card-icon">${emoji}</div>
                <div class="card-name">${b.name}</div>
                <div class="card-price">${b.basePrice}üí∞</div>
            `;
            card.addEventListener('click', () => {
                document.querySelectorAll('.build-card').forEach(c => c.classList.remove('selected'));
                card.classList.add('selected');
                gameState.selectedBuilding = b.id;
                document.getElementById('infoPanel').innerText = `–í—ã–±—Ä–∞–Ω–æ: ${b.name}`;
            });
            track.appendChild(card);
        });
    }

    // ==================== –°–û–•–†–ê–ù–ï–ù–ò–ï/–ó–ê–ì–†–£–ó–ö–ê ====================
    function saveGame() {
        if (tg) {
            tg.sendData(JSON.stringify({
                money: gameState.money,
                grid: gameState.grid,
                land: gameState.land,
                population: gameState.population,
                variants: buildingVariants
            }));
        }
        localStorage.setItem('archipelago3D', JSON.stringify({
            money: gameState.money,
            grid: gameState.grid,
            land: gameState.land,
            population: gameState.population,
            variants: buildingVariants
        }));
    }

    function loadGame() {
        let saved = localStorage.getItem('archipelago3D');
        if (saved) {
            try {
                let data = JSON.parse(saved);
                gameState.money = data.money || 35000;
                gameState.grid = data.grid || gameState.grid;
                gameState.land = data.land || gameState.land;
                gameState.population = data.population || 0;
                buildingVariants = data.variants || {};
            } catch(e) {}
        }
        updateUI();
        drawCity();
    }

    // ==================== –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø ====================
    const canvas = document.getElementById('gameCanvas');
    canvas.addEventListener('click', handleCanvasTap);
    canvas.addEventListener('touchstart', handleCanvasTap, {passive: false});

    // –ö–∞—Ç–µ–≥–æ—Ä–∏–∏
    document.getElementById('catRes').addEventListener('click', () => {
        document.querySelectorAll('.cat-btn').forEach(t => t.classList.remove('active'));
        document.getElementById('catRes').classList.add('active');
        renderBuildings('residential');
    });
    document.getElementById('catCom').addEventListener('click', () => {
        document.querySelectorAll('.cat-btn').forEach(t => t.classList.remove('active'));
        document.getElementById('catCom').classList.add('active');
        renderBuildings('commercial');
    });
    document.getElementById('catInd').addEventListener('click', () => {
        document.querySelectorAll('.cat-btn').forEach(t => t.classList.remove('active'));
        document.getElementById('catInd').classList.add('active');
        renderBuildings('industrial');
    });
    document.getElementById('catInf').addEventListener('click', () => {
        document.querySelectorAll('.cat-btn').forEach(t => t.classList.remove('active'));
        document.getElementById('catInf').classList.add('active');
        renderBuildings('infrastructure');
    });

    // –ö–Ω–æ–ø–∫–∏
    document.getElementById('collectBtn').addEventListener('click', collectTaxes);
    document.getElementById('expandBtn').addEventListener('click', expandIsland);
    document.getElementById('cancelBtn').addEventListener('click', () => {
        gameState.selectedBuilding = null;
        document.querySelectorAll('.build-card').forEach(c => c.classList.remove('selected'));
        document.getElementById('infoPanel').innerText = '–í—ã–±–æ—Ä –æ—Ç–º–µ–Ω—ë–Ω';
    });

    // –ó–∞–ø—É—Å–∫
    renderBuildings('residential');
    loadGame();

    // –ê–≤—Ç–æ—Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∏ –∞–Ω–∏–º–∞—Ü–∏—è
    setInterval(() => {
        drawCity();
        saveGame();
    }, 100);
})();
</script>
</body>
</html>
