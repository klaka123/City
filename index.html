<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>INFINITY CITY ‚Äî –º–µ–≥–∞–ø–æ–ª–∏—Å –±—É–¥—É—â–µ–≥–æ</title>
    <style>
        /* ========== –ì–õ–û–ë–ê–õ–¨–ù–´–ï –°–¢–ò–õ–ò ========== */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Roboto, 'Helvetica Neue', sans-serif;
            user-select: none;
        }

        body {
            background: #0c1e2c;
            overflow: hidden;
            touch-action: none;
        }

        /* ========== –ò–ì–†–û–í–û–ô –ö–û–ù–¢–ï–ô–ù–ï–† ========== */
        .game-container {
            position: relative;
            width: 100vw;
            height: 100vh;
            overflow: hidden;
            background: radial-gradient(circle at 30% 50%, #1d4b6e, #0a1c2c);
        }

        /* ========== CANVAS ========== */
        #gameCanvas {
            display: block;
            width: 100%;
            height: 100%;
            cursor: grab;
            touch-action: none;
        }

        #gameCanvas:active {
            cursor: grabbing;
        }

        /* ========== –ò–ù–¢–ï–†–§–ï–ô–° (–ú–ò–ù–ò–ú–ê–õ–ò–°–¢–ò–ß–ù–´–ô) ========== */
        .ui-panel {
            position: fixed;
            bottom: 30px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(20, 40, 55, 0.85);
            backdrop-filter: blur(20px);
            border-radius: 80px;
            padding: 20px 40px;
            display: flex;
            gap: 40px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.6), inset 0 1px 3px rgba(255, 255, 255, 0.3);
            z-index: 100;
        }

        .stat-item {
            display: flex;
            align-items: center;
            gap: 15px;
            color: white;
            font-size: 28px;
            font-weight: 600;
            text-shadow: 0 2px 5px black;
        }

        .stat-icon {
            font-size: 40px;
            filter: drop-shadow(0 4px 6px black);
        }

        /* ========== –ü–ê–ù–ï–õ–¨ –ü–û–°–¢–†–û–ï–ö (–í–´–ï–ó–ñ–ê–ï–¢ –°–õ–ï–í–ê) ========== */
        .build-menu {
            position: fixed;
            top: 50%;
            left: 30px;
            transform: translateY(-50%);
            background: rgba(20, 40, 55, 0.9);
            backdrop-filter: blur(20px);
            border-radius: 50px;
            padding: 25px 15px;
            display: flex;
            flex-direction: column;
            gap: 20px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.6);
            z-index: 100;
            max-height: 80vh;
            overflow-y: auto;
            scrollbar-width: thin;
            scrollbar-color: #4a9ec0 #1e3f55;
        }

        .build-menu::-webkit-scrollbar {
            width: 8px;
        }

        .build-menu::-webkit-scrollbar-thumb {
            background: #4a9ec0;
            border-radius: 10px;
        }

        .build-category {
            color: white;
            font-size: 20px;
            font-weight: 600;
            padding: 10px 20px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 40px;
            text-align: center;
            letter-spacing: 1px;
        }

        .build-item {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 40px;
            padding: 15px 25px;
            display: flex;
            align-items: center;
            gap: 20px;
            cursor: pointer;
            transition: all 0.2s;
            border: 2px solid transparent;
            min-width: 280px;
        }

        .build-item:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: translateX(5px);
        }

        .build-item.selected {
            border-color: #ffb84d;
            background: rgba(255, 184, 77, 0.2);
            box-shadow: 0 0 20px rgba(255, 184, 77, 0.3);
        }

        .item-icon {
            width: 60px;
            height: 60px;
            background: rgba(255, 255, 255, 0.15);
            border-radius: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 36px;
        }

        .item-info {
            flex: 1;
        }

        .item-name {
            color: white;
            font-size: 20px;
            font-weight: 600;
            margin-bottom: 5px;
        }

        .item-price {
            color: #ffd966;
            font-size: 18px;
            font-weight: 500;
        }

        /* ========== –ü–ê–ù–ï–õ–¨ –£–ü–†–ê–í–õ–ï–ù–ò–Ø (–°–ü–†–ê–í–ê) ========== */
        .control-menu {
            position: fixed;
            top: 50%;
            right: 30px;
            transform: translateY(-50%);
            background: rgba(20, 40, 55, 0.9);
            backdrop-filter: blur(20px);
            border-radius: 50px;
            padding: 25px 20px;
            display: flex;
            flex-direction: column;
            gap: 20px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.6);
            z-index: 100;
        }

        .control-btn {
            background: rgba(255, 255, 255, 0.1);
            border: none;
            border-radius: 40px;
            padding: 18px 25px;
            color: white;
            font-size: 24px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 15px;
            cursor: pointer;
            transition: all 0.2s;
            border: 2px solid transparent;
            min-width: 200px;
        }

        .control-btn:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: translateX(-5px);
        }

        .control-btn:active {
            transform: scale(0.95);
        }

        .control-btn.collect {
            background: rgba(76, 175, 80, 0.3);
            border-color: #4caf50;
        }

        .control-btn.cancel {
            background: rgba(244, 67, 54, 0.3);
            border-color: #f44336;
        }

        /* ========== –ò–ù–§–û-–ü–ê–ù–ï–õ–¨ ========== */
        .info-panel {
            position: fixed;
            top: 30px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(20, 40, 55, 0.85);
            backdrop-filter: blur(20px);
            border-radius: 60px;
            padding: 18px 40px;
            color: white;
            font-size: 24px;
            font-weight: 500;
            border: 2px solid rgba(255, 255, 255, 0.3);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.6);
            z-index: 100;
            text-align: center;
            min-width: 400px;
        }

        /* ========== –£–í–ï–î–û–ú–õ–ï–ù–ò–Ø ========== */
        .notification {
            position: fixed;
            top: 100px;
            right: 30px;
            background: rgba(0, 0, 0, 0.9);
            backdrop-filter: blur(15px);
            color: white;
            padding: 20px 40px;
            border-radius: 60px;
            font-size: 22px;
            font-weight: 500;
            z-index: 1000;
            animation: slideInRight 0.3s ease;
            border: 2px solid #ffb84d;
            box-shadow: 0 10px 30px black;
        }

        @keyframes slideInRight {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
    </style>
</head>
<body>
<div class="game-container">
    <canvas id="gameCanvas"></canvas>

    <!-- –ù–∏–∂–Ω—è—è –ø–∞–Ω–µ–ª—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ -->
    <div class="ui-panel">
        <div class="stat-item">
            <span class="stat-icon">üí∞</span>
            <span id="moneyDisplay">1,000,000</span>
        </div>
        <div class="stat-item">
            <span class="stat-icon">üë•</span>
            <span id="popDisplay">0</span>
        </div>
        <div class="stat-item">
            <span class="stat-icon">üìä</span>
            <span id="incomeDisplay">0</span>
        </div>
        <div class="stat-item">
            <span class="stat-icon">üèôÔ∏è</span>
            <span id="buildingsCount">0</span>
        </div>
    </div>

    <!-- –õ–µ–≤–æ–µ –º–µ–Ω—é (–ø–æ—Å—Ç—Ä–æ–π–∫–∏) -->
    <div class="build-menu" id="buildMenu">
        <div class="build-category">üèòÔ∏è –ñ–ò–õ–´–ï</div>
        <div class="build-item" data-building="cottage">
            <div class="item-icon">üè°</div>
            <div class="item-info">
                <div class="item-name">–ö–æ—Ç—Ç–µ–¥–∂</div>
                <div class="item-price">2,500üí∞</div>
            </div>
        </div>
        <div class="build-item" data-building="mansion">
            <div class="item-icon">üè∞</div>
            <div class="item-info">
                <div class="item-name">–û—Å–æ–±–Ω—è–∫</div>
                <div class="item-price">8,000üí∞</div>
            </div>
        </div>
        <div class="build-item" data-building="apartment">
            <div class="item-icon">üè¢</div>
            <div class="item-info">
                <div class="item-name">–ú–Ω–æ–≥–æ—ç—Ç–∞–∂–∫–∞</div>
                <div class="item-price">15,000üí∞</div>
            </div>
        </div>
        <div class="build-item" data-building="skyscraper">
            <div class="item-icon">üèôÔ∏è</div>
            <div class="item-info">
                <div class="item-name">–ù–µ–±–æ—Å–∫—Ä—ë–±</div>
                <div class="item-price">50,000üí∞</div>
            </div>
        </div>

        <div class="build-category">üè™ –ö–û–ú–ú–ï–†–¶–ò–Ø</div>
        <div class="build-item" data-building="shop">
            <div class="item-icon">üè™</div>
            <div class="item-info">
                <div class="item-name">–ú–∞–≥–∞–∑–∏–Ω</div>
                <div class="item-price">4,000üí∞</div>
            </div>
        </div>
        <div class="build-item" data-building="office">
            <div class="item-icon">üèõÔ∏è</div>
            <div class="item-info">
                <div class="item-name">–û—Ñ–∏—Å</div>
                <div class="item-price">12,000üí∞</div>
            </div>
        </div>
        <div class="build-item" data-building="bank">
            <div class="item-icon">üí∞</div>
            <div class="item-info">
                <div class="item-name">–ë–∞–Ω–∫</div>
                <div class="item-price">25,000üí∞</div>
            </div>
        </div>

        <div class="build-category">üè≠ –ü–†–û–ú–´–®–õ–ï–ù–ù–û–°–¢–¨</div>
        <div class="build-item" data-building="factory">
            <div class="item-icon">üè≠</div>
            <div class="item-info">
                <div class="item-name">–ó–∞–≤–æ–¥</div>
                <div class="item-price">20,000üí∞</div>
            </div>
        </div>
        <div class="build-item" data-building="powerplant">
            <div class="item-icon">‚ö°</div>
            <div class="item-info">
                <div class="item-name">–≠–ª–µ–∫—Ç—Ä–æ—Å—Ç–∞–Ω—Ü–∏—è</div>
                <div class="item-price">40,000üí∞</div>
            </div>
        </div>

        <div class="build-category">üè• –ò–ù–§–†–ê–°–¢–†–£–ö–¢–£–†–ê</div>
        <div class="build-item" data-building="school">
            <div class="item-icon">üìö</div>
            <div class="item-info">
                <div class="item-name">–®–∫–æ–ª–∞</div>
                <div class="item-price">18,000üí∞</div>
            </div>
        </div>
        <div class="build-item" data-building="hospital">
            <div class="item-icon">üè•</div>
            <div class="item-info">
                <div class="item-name">–ë–æ–ª—å–Ω–∏—Ü–∞</div>
                <div class="item-price">30,000üí∞</div>
            </div>
        </div>
        <div class="build-item" data-building="park">
            <div class="item-icon">üå≥</div>
            <div class="item-info">
                <div class="item-name">–ü–∞—Ä–∫</div>
                <div class="item-price">5,000üí∞</div>
            </div>
        </div>
        <div class="build-item" data-building="road">
            <div class="item-icon">üõ£Ô∏è</div>
            <div class="item-info">
                <div class="item-name">–î–æ—Ä–æ–≥–∞</div>
                <div class="item-price">1,000üí∞</div>
            </div>
        </div>

        <div class="build-category">üèõÔ∏è –û–°–û–ë–´–ï</div>
        <div class="build-item" data-building="castle">
            <div class="item-icon">üè∞</div>
            <div class="item-info">
                <div class="item-name">–ó–∞–º–æ–∫</div>
                <div class="item-price">100,000üí∞</div>
            </div>
        </div>
        <div class="build-item" data-building="monument">
            <div class="item-icon">üóΩ</div>
            <div class="item-info">
                <div class="item-name">–ú–æ–Ω—É–º–µ–Ω—Ç</div>
                <div class="item-price">50,000üí∞</div>
            </div>
        </div>
    </div>

    <!-- –ü—Ä–∞–≤–æ–µ –º–µ–Ω—é (—É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ) -->
    <div class="control-menu">
        <button class="control-btn collect" id="collectBtn">
            <span>üí∞</span> –°–ë–û–† –ù–ê–õ–û–ì–û–í
        </button>
        <button class="control-btn" id="weatherBtn">
            <span>üå¶Ô∏è</span> –°–ú–ï–ù–ò–¢–¨ –ü–û–ì–û–î–£
        </button>
        <button class="control-btn" id="timeBtn">
            <span>‚è∞</span> –°–ú–ï–ù–ò–¢–¨ –í–†–ï–ú–Ø
        </button>
        <button class="control-btn cancel" id="cancelBtn">
            <span>‚ùå</span> –û–¢–ú–ï–ù–ê
        </button>
        <button class="control-btn" id="resetBtn">
            <span>üîÑ</span> –ù–û–í–´–ô –ì–û–†–û–î
        </button>
    </div>

    <!-- –í–µ—Ä—Ö–Ω—è—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–æ–Ω–Ω–∞—è –ø–∞–Ω–µ–ª—å -->
    <div class="info-panel" id="infoPanel">
        üëÜ –í—ã–±–µ—Ä–∏—Ç–µ –∑–¥–∞–Ω–∏–µ –∏ –Ω–∞–∂–º–∏—Ç–µ –Ω–∞ –∫–∞—Ä—Ç—É
    </div>
</div>

<script src="https://telegram.org/js/telegram-web-app.js"></script>
<script>
// ============================================================================
// INFINITY CITY ENGINE v3.0
// ============================================================================
// –Ø–¥—Ä–æ –∏–≥—Ä—ã —Å –±–µ—Å–∫–æ–Ω–µ—á–Ω—ã–º –ø–æ–ª–µ–º, –∫–∞–º–µ—Ä–æ–π, –∑—É–º–æ–º, –¥–µ—Ç–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–æ–π –≥—Ä–∞—Ñ–∏–∫–æ–π
// –ë–∞–∑–∞ –¥–ª—è –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏—è –¥–æ 100 000+ —Å—Ç—Ä–æ–∫
// ============================================================================

(function() {
    // ==================== Telegram ====================
    let tg = null;
    try {
        if (window.Telegram?.WebApp) {
            tg = Telegram.WebApp;
            tg.expand();
            tg.ready();
        }
    } catch {}

    // ==================== –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø ====================
    const CONFIG = {
        GRID_SIZE: 50,              // 50x50 —Å–µ—Ç–∫–∞ (2500 –∫–ª–µ—Ç–æ–∫)
        CELL_SIZE: 80,              // –±–∞–∑–æ–≤—ã–π —Ä–∞–∑–º–µ—Ä –∫–ª–µ—Ç–∫–∏ –≤ –ø–∏–∫—Å–µ–ª—è—Ö
        BASE_INCOME_MULTIPLIER: 1,
        ZOOM_SPEED: 0.1,
        MOVE_SPEED: 10,
        MAX_ZOOM: 2.5,
        MIN_ZOOM: 0.5,
        TAX_COOLDOWN: 10000,         // 10 —Å–µ–∫—É–Ω–¥
    };

    // ==================== –°–û–°–¢–û–Ø–ù–ò–ï –ò–ì–†–´ ====================
    const gameState = {
        money: 1000000,
        grid: [],
        population: 0,
        lastTaxTime: Date.now(),
        selectedBuilding: null,
        weather: 'clear',
        timeOfDay: 0.6,
        camera: {
            x: 0,
            y: 0,
            zoom: 1,
        },
        isDragging: false,
        lastMouseX: 0,
        lastMouseY: 0,
    };

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å–µ—Ç–∫–∏ (–≤—Å—è –∫–∞—Ä—Ç–∞ - —Å—É—à–∞)
    for (let r = 0; r < CONFIG.GRID_SIZE; r++) {
        gameState.grid[r] = [];
        for (let c = 0; c < CONFIG.GRID_SIZE; c++) {
            gameState.grid[r][c] = 'empty';
        }
    }

    // ==========================================================================
    // –ë–ò–ë–õ–ò–û–¢–ï–ö–ê –ú–ï–ì–ê-–î–ï–¢–ê–õ–ò–ó–ò–†–û–í–ê–ù–ù–´–• –ó–î–ê–ù–ò–ô
    // ==========================================================================
    const Buildings = {
        // –ñ–∏–ª—ã–µ
        cottage: {
            name: '–ö–æ—Ç—Ç–µ–¥–∂',
            price: 2500,
            income: 80,
            population: 12,
            color: '#e3b27c',
            roofColor: '#b54c4c',
            draw: function(ctx, x, y, cellSize) {
                const scale = cellSize / 80;
                const w = cellSize * 0.7;
                const h = cellSize * 0.5;
                
                // –¢–µ–Ω—å
                ctx.shadowColor = '#00000080';
                ctx.shadowBlur = 20 * scale;
                ctx.shadowOffsetY = 5 * scale;
                
                // –§—É–Ω–¥–∞–º–µ–Ω—Ç
                ctx.fillStyle = this.color;
                ctx.beginPath();
                ctx.moveTo(x, y - h/3);
                ctx.lineTo(x + w/2, y + h/3);
                ctx.lineTo(x, y + h);
                ctx.lineTo(x - w/2, y + h/3);
                ctx.closePath();
                ctx.fill();

                // –°—Ç–µ–Ω—ã
                ctx.fillStyle = '#c49a6c';
                ctx.fillRect(x - w/3, y - h/2, w*2/3, h/1.5);

                // –ö—Ä—ã—à–∞
                ctx.fillStyle = this.roofColor;
                ctx.beginPath();
                ctx.moveTo(x - w/2, y - h/1.5);
                ctx.lineTo(x + w/2, y - h/1.5);
                ctx.lineTo(x, y - h*1.3);
                ctx.closePath();
                ctx.fill();

                // –û–∫–Ω–∞
                ctx.fillStyle = '#f9e076';
                ctx.shadowBlur = 10 * scale;
                ctx.fillRect(x - w/4, y - h/3, w/6, h/4);
                ctx.fillRect(x + w/6, y - h/3, w/6, h/4);

                // –î–≤–µ—Ä—å
                ctx.fillStyle = '#8b5a2b';
                ctx.fillRect(x - w/8, y, w/4, h/2.5);
                
                ctx.shadowBlur = 0;
                ctx.shadowOffsetY = 0;
            }
        },
        mansion: {
            name: '–û—Å–æ–±–Ω—è–∫',
            price: 8000,
            income: 250,
            population: 35,
            color: '#d9b382',
            roofColor: '#b34b4b',
            draw: function(ctx, x, y, cellSize) {
                const scale = cellSize / 80;
                const w = cellSize * 0.9;
                const h = cellSize * 0.6;
                
                ctx.shadowColor = '#00000080';
                ctx.shadowBlur = 25 * scale;
                ctx.shadowOffsetY = 6 * scale;
                
                ctx.fillStyle = this.color;
                ctx.beginPath();
                ctx.moveTo(x, y - h/3);
                ctx.lineTo(x + w/2, y + h/3);
                ctx.lineTo(x, y + h);
                ctx.lineTo(x - w/2, y + h/3);
                ctx.closePath();
                ctx.fill();

                ctx.fillStyle = '#f0c48b';
                ctx.fillRect(x - w/2.5, y - h/1.8, w/1.25, h/1.2);

                // –ö–æ–ª–æ–Ω–Ω—ã
                ctx.fillStyle = '#f5f5f5';
                for (let i = -w/4; i <= w/4; i += w/3) {
                    ctx.fillRect(x + i - 5*scale, y - h/1.5, 10*scale, h/1.2);
                }

                // –ö—Ä—ã—à–∞
                ctx.fillStyle = this.roofColor;
                ctx.beginPath();
                ctx.moveTo(x - w/2, y - h*0.9);
                ctx.lineTo(x + w/2, y - h*0.9);
                ctx.lineTo(x, y - h*1.8);
                ctx.closePath();
                ctx.fill();

                // –û–∫–Ω–∞
                ctx.fillStyle = '#fff2cc';
                for (let i = -w/5; i <= w/5; i += w/3) {
                    ctx.fillRect(x + i - 7*scale, y - h/2, 14*scale, 15*scale);
                }

                ctx.shadowBlur = 0;
            }
        },
        apartment: {
            name: '–ú–Ω–æ–≥–æ—ç—Ç–∞–∂–∫–∞',
            price: 15000,
            income: 500,
            population: 120,
            color: '#b0bec5',
            draw: function(ctx, x, y, cellSize) {
                const scale = cellSize / 80;
                const w = cellSize;
                const h = cellSize * 0.7;
                
                ctx.shadowColor = '#00000080';
                ctx.shadowBlur = 30 * scale;
                ctx.shadowOffsetY = 8 * scale;
                
                ctx.fillStyle = this.color;
                ctx.beginPath();
                ctx.moveTo(x, y - h/3);
                ctx.lineTo(x + w/2, y + h/3);
                ctx.lineTo(x, y + h);
                ctx.lineTo(x - w/2, y + h/3);
                ctx.closePath();
                ctx.fill();

                ctx.fillStyle = '#8a9aa8';
                ctx.fillRect(x - w/3, y - h, w*2/3, h);

                // –û–∫–Ω–∞
                ctx.fillStyle = '#cfd8dc';
                for (let floor = 0; floor < 5; floor++) {
                    for (let i = -w/5; i <= w/5; i += w/4) {
                        ctx.fillRect(x + i - 6*scale, y - h + 20*scale + floor*15*scale, 12*scale, 10*scale);
                    }
                }

                ctx.shadowBlur = 0;
            }
        },
        skyscraper: {
            name: '–ù–µ–±–æ—Å–∫—Ä—ë–±',
            price: 50000,
            income: 2000,
            population: 500,
            color: '#607d8b',
            draw: function(ctx, x, y, cellSize) {
                const scale = cellSize / 80;
                const w = cellSize * 1.1;
                const h = cellSize * 0.9;
                
                ctx.shadowColor = '#00000080';
                ctx.shadowBlur = 40 * scale;
                ctx.shadowOffsetY = 10 * scale;
                
                ctx.fillStyle = this.color;
                ctx.beginPath();
                ctx.moveTo(x, y - h/3);
                ctx.lineTo(x + w/2, y + h/3);
                ctx.lineTo(x, y + h);
                ctx.lineTo(x - w/2, y + h/3);
                ctx.closePath();
                ctx.fill();

                ctx.fillStyle = '#4f6573';
                ctx.fillRect(x - w/3, y - h*2.5, w*2/3, h*2.2);

                // –û–∫–Ω–∞ —Å –ø–æ–¥—Å–≤–µ—Ç–∫–æ–π
                ctx.fillStyle = '#ffd966';
                for (let floor = 0; floor < 12; floor++) {
                    for (let i = -w/5; i <= w/5; i += w/4) {
                        ctx.fillStyle = Math.random() > 0.3 ? '#ffd966' : '#ffffff';
                        ctx.fillRect(x + i - 5*scale, y - h*2.2 + 15*scale + floor*12*scale, 10*scale, 8*scale);
                    }
                }

                // –ê–Ω—Ç–µ–Ω–Ω–∞
                ctx.fillStyle = '#b0bec5';
                ctx.fillRect(x - 3*scale, y - h*2.8, 6*scale, 20*scale);
                
                ctx.shadowBlur = 0;
            }
        },

        // –ö–æ–º–º–µ—Ä—Ü–∏—è
        shop: {
            name: '–ú–∞–≥–∞–∑–∏–Ω',
            price: 4000,
            income: 150,
            population: 4,
            color: '#ffb74d',
            draw: function(ctx, x, y, cellSize) {
                const scale = cellSize / 80;
                const w = cellSize * 0.8;
                const h = cellSize * 0.5;
                
                ctx.shadowColor = '#00000080';
                ctx.shadowBlur = 20 * scale;
                ctx.shadowOffsetY = 5 * scale;
                
                ctx.fillStyle = this.color;
                ctx.beginPath();
                ctx.moveTo(x, y - h/3);
                ctx.lineTo(x + w/2, y + h/3);
                ctx.lineTo(x, y + h);
                ctx.lineTo(x - w/2, y + h/3);
                ctx.closePath();
                ctx.fill();

                ctx.fillStyle = '#ff9800';
                ctx.fillRect(x - w/2.5, y - h/2, w/1.25, h/1.5);

                // –í–∏—Ç—Ä–∏–Ω–∞
                ctx.fillStyle = '#fff2cc';
                ctx.fillRect(x - w/5, y - h/3, w/5, h/4);
                ctx.fillRect(x + w/8, y - h/3, w/5, h/4);

                ctx.shadowBlur = 0;
            }
        },
        office: {
            name: '–û—Ñ–∏—Å',
            price: 12000,
            income: 400,
            population: 15,
            color: '#9e9e9e',
            draw: function(ctx, x, y, cellSize) {
                const scale = cellSize / 80;
                const w = cellSize * 0.9;
                const h = cellSize * 0.6;
                
                ctx.shadowColor = '#00000080';
                ctx.shadowBlur = 25 * scale;
                ctx.shadowOffsetY = 7 * scale;
                
                ctx.fillStyle = this.color;
                ctx.beginPath();
                ctx.moveTo(x, y - h/3);
                ctx.lineTo(x + w/2, y + h/3);
                ctx.lineTo(x, y + h);
                ctx.lineTo(x - w/2, y + h/3);
                ctx.closePath();
                ctx.fill();

                ctx.fillStyle = '#757575';
                ctx.fillRect(x - w/3, y - h*1.2, w*2/3, h*1.2);

                // –û–∫–Ω–∞
                ctx.fillStyle = '#cfd8dc';
                for (let floor = 0; floor < 4; floor++) {
                    for (let i = -w/6; i <= w/6; i += w/4) {
                        ctx.fillRect(x + i - 6*scale, y - h*0.9 + floor*15*scale, 12*scale, 10*scale);
                    }
                }

                ctx.shadowBlur = 0;
            }
        },
        bank: {
            name: '–ë–∞–Ω–∫',
            price: 25000,
            income: 800,
            population: 8,
            color: '#cfd8dc',
            draw: function(ctx, x, y, cellSize) {
                const scale = cellSize / 80;
                const w = cellSize;
                const h = cellSize * 0.7;
                
                ctx.shadowColor = '#00000080';
                ctx.shadowBlur = 30 * scale;
                ctx.shadowOffsetY = 8 * scale;
                
                ctx.fillStyle = this.color;
                ctx.beginPath();
                ctx.moveTo(x, y - h/3);
                ctx.lineTo(x + w/2, y + h/3);
                ctx.lineTo(x, y + h);
                ctx.lineTo(x - w/2, y + h/3);
                ctx.closePath();
                ctx.fill();

                ctx.fillStyle = '#f5f5f5';
                ctx.fillRect(x - w/3, y - h*1.5, w*2/3, h*1.5);

                // –ö–æ–ª–æ–Ω–Ω—ã
                ctx.fillStyle = '#ffffff';
                for (let i = -w/5; i <= w/5; i += w/3) {
                    ctx.fillRect(x + i - 6*scale, y - h*1.2, 12*scale, h*1.1);
                }

                ctx.shadowBlur = 0;
            }
        },

        // –ü—Ä–æ–º—ã—à–ª–µ–Ω–Ω–æ—Å—Ç—å
        factory: {
            name: '–ó–∞–≤–æ–¥',
            price: 20000,
            income: 600,
            population: 10,
            color: '#b0bec5',
            draw: function(ctx, x, y, cellSize) {
                const scale = cellSize / 80;
                const w = cellSize * 1.2;
                const h = cellSize * 0.8;
                
                ctx.shadowColor = '#00000080';
                ctx.shadowBlur = 30 * scale;
                ctx.shadowOffsetY = 8 * scale;
                
                ctx.fillStyle = this.color;
                ctx.beginPath();
                ctx.moveTo(x, y - h/3);
                ctx.lineTo(x + w/2, y + h/3);
                ctx.lineTo(x, y + h);
                ctx.lineTo(x - w/2, y + h/3);
                ctx.closePath();
                ctx.fill();

                ctx.fillStyle = '#8a9aa8';
                ctx.fillRect(x - w/3, y - h*1.5, w*2/3, h*1.5);

                // –¢—Ä—É–±—ã
                ctx.fillStyle = '#6b5a3a';
                ctx.fillRect(x - w/5, y - h*2.2, 10*scale, 30*scale);
                ctx.fillRect(x + w/8, y - h*2.2, 10*scale, 30*scale);

                // –î—ã–º
                ctx.fillStyle = '#ffffff40';
                ctx.beginPath();
                ctx.arc(x - w/5, y - h*2.5, 12*scale, 0, Math.PI*2);
                ctx.fill();
                ctx.beginPath();
                ctx.arc(x + w/8, y - h*2.5, 12*scale, 0, Math.PI*2);
                ctx.fill();

                ctx.shadowBlur = 0;
            }
        },
        powerplant: {
            name: '–≠–ª–µ–∫—Ç—Ä–æ—Å—Ç–∞–Ω—Ü–∏—è',
            price: 40000,
            income: 1500,
            population: 0,
            color: '#b0a57c',
            draw: function(ctx, x, y, cellSize) {
                const scale = cellSize / 80;
                const w = cellSize * 1.3;
                const h = cellSize * 0.9;
                
                ctx.shadowColor = '#00000080';
                ctx.shadowBlur = 40 * scale;
                ctx.shadowOffsetY = 10 * scale;
                
                ctx.fillStyle = this.color;
                ctx.beginPath();
                ctx.moveTo(x, y - h/3);
                ctx.lineTo(x + w/2, y + h/3);
                ctx.lineTo(x, y + h);
                ctx.lineTo(x - w/2, y + h/3);
                ctx.closePath();
                ctx.fill();

                ctx.fillStyle = '#8b7a5a';
                ctx.fillRect(x - w/3, y - h*2.2, w*2/3, h*2);

                // –ì—Ä–∞–¥–∏—Ä–Ω–∏
                ctx.fillStyle = '#6b5a3a';
                ctx.beginPath();
                ctx.moveTo(x - w/4, y - h*3);
                ctx.lineTo(x - w/6, y - h*3);
                ctx.lineTo(x - w/5, y - h*2);
                ctx.closePath();
                ctx.fill();
                
                ctx.beginPath();
                ctx.moveTo(x + w/6, y - h*3);
                ctx.lineTo(x + w/4, y - h*3);
                ctx.lineTo(x + w/5, y - h*2);
                ctx.closePath();
                ctx.fill();

                ctx.shadowBlur = 0;
            }
        },

        // –ò–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä–∞
        school: {
            name: '–®–∫–æ–ª–∞',
            price: 18000,
            income: 200,
            population: 0,
            color: '#ff8a80',
            draw: function(ctx, x, y, cellSize) {
                const scale = cellSize / 80;
                const w = cellSize * 0.9;
                const h = cellSize * 0.6;
                
                ctx.shadowColor = '#00000080';
                ctx.shadowBlur = 25 * scale;
                ctx.shadowOffsetY = 7 * scale;
                
                ctx.fillStyle = this.color;
                ctx.beginPath();
                ctx.moveTo(x, y - h/3);
                ctx.lineTo(x + w/2, y + h/3);
                ctx.lineTo(x, y + h);
                ctx.lineTo(x - w/2, y + h/3);
                ctx.closePath();
                ctx.fill();

                ctx.fillStyle = '#f06292';
                ctx.fillRect(x - w/3, y - h*1.3, w*2/3, h*1.3);

                // –û–∫–Ω–∞
                ctx.fillStyle = '#ffffff';
                for (let i = -w/5; i <= w/5; i += w/3) {
                    ctx.fillRect(x + i - 6*scale, y - h*0.9, 12*scale, 12*scale);
                    ctx.fillRect(x + i - 6*scale, y - h*0.5, 12*scale, 12*scale);
                }

                // –ö–æ–ª–æ–∫–æ–ª—å—á–∏–∫
                ctx.fillStyle = '#d4af37';
                ctx.beginPath();
                ctx.arc(x, y - h*1.8, 8*scale, 0, Math.PI*2);
                ctx.fill();

                ctx.shadowBlur = 0;
            }
        },
        hospital: {
            name: '–ë–æ–ª—å–Ω–∏—Ü–∞',
            price: 30000,
            income: 350,
            population: 0,
            color: '#ef9a9a',
            draw: function(ctx, x, y, cellSize) {
                const scale = cellSize / 80;
                const w = cellSize;
                const h = cellSize * 0.7;
                
                ctx.shadowColor = '#00000080';
                ctx.shadowBlur = 30 * scale;
                ctx.shadowOffsetY = 8 * scale;
                
                ctx.fillStyle = this.color;
                ctx.beginPath();
                ctx.moveTo(x, y - h/3);
                ctx.lineTo(x + w/2, y + h/3);
                ctx.lineTo(x, y + h);
                ctx.lineTo(x - w/2, y + h/3);
                ctx.closePath();
                ctx.fill();

                ctx.fillStyle = '#e57373';
                ctx.fillRect(x - w/3, y - h*1.6, w*2/3, h*1.6);

                // –ö—Ä–∞—Å–Ω—ã–π –∫—Ä–µ—Å—Ç
                ctx.fillStyle = '#ff4d4d';
                ctx.fillRect(x - w/10, y - h*1.2, w/5, h/5);
                ctx.fillRect(x - w/5, y - h*1.1, w/2.5, h/8);

                ctx.shadowBlur = 0;
            }
        },
        park: {
            name: '–ü–∞—Ä–∫',
            price: 5000,
            income: 60,
            population: 5,
            color: '#81c784',
            draw: function(ctx, x, y, cellSize) {
                const scale = cellSize / 80;
                const w = cellSize;
                const h = cellSize * 0.4;
                
                ctx.shadowColor = '#00000060';
                ctx.shadowBlur = 15 * scale;
                ctx.shadowOffsetY = 4 * scale;
                
                ctx.fillStyle = this.color;
                ctx.beginPath();
                ctx.moveTo(x, y - h/2);
                ctx.lineTo(x + w/2, y + h/2);
                ctx.lineTo(x, y + h);
                ctx.lineTo(x - w/2, y + h/2);
                ctx.closePath();
                ctx.fill();

                // –î–µ—Ä–µ–≤—å—è
                ctx.fillStyle = '#5f9b6b';
                for (let i = -w/4; i <= w/4; i += w/3) {
                    ctx.beginPath();
                    ctx.arc(x + i, y - h*2, 10*scale, 0, Math.PI*2);
                    ctx.fill();
                }

                ctx.fillStyle = '#8b5a2b';
                for (let i = -w/4; i <= w/4; i += w/3) {
                    ctx.fillRect(x + i - 2*scale, y - h*1.5, 4*scale, 10*scale);
                }

                ctx.shadowBlur = 0;
            }
        },
        road: {
            name: '–î–æ—Ä–æ–≥–∞',
            price: 1000,
            income: 10,
            population: 0,
            color: '#b0bec5',
            draw: function(ctx, x, y, cellSize) {
                const scale = cellSize / 80;
                const w = cellSize;
                const h = cellSize * 0.2;
                
                ctx.shadowColor = '#00000060';
                ctx.shadowBlur = 10 * scale;
                ctx.shadowOffsetY = 3 * scale;
                
                ctx.fillStyle = this.color;
                ctx.beginPath();
                ctx.moveTo(x, y - h);
                ctx.lineTo(x + w/2, y);
                ctx.lineTo(x, y + h);
                ctx.lineTo(x - w/2, y);
                ctx.closePath();
                ctx.fill();

                // –†–∞–∑–º–µ—Ç–∫–∞
                ctx.fillStyle = '#f5f5f5';
                ctx.fillRect(x - w/3, y - 2*scale, w/1.5, 4*scale);

                ctx.shadowBlur = 0;
            }
        },

        // –û—Å–æ–±—ã–µ
        castle: {
            name: '–ó–∞–º–æ–∫',
            price: 100000,
            income: 5000,
            population: 800,
            color: '#b0a57c',
            draw: function(ctx, x, y, cellSize) {
                const scale = cellSize / 80;
                const w = cellSize * 1.5;
                const h = cellSize;
                
                ctx.shadowColor = '#00000080';
                ctx.shadowBlur = 50 * scale;
                ctx.shadowOffsetY = 15 * scale;
                
                ctx.fillStyle = this.color;
                ctx.beginPath();
                ctx.moveTo(x, y - h/3);
                ctx.lineTo(x + w/2, y + h/3);
                ctx.lineTo(x, y + h);
                ctx.lineTo(x - w/2, y + h/3);
                ctx.closePath();
                ctx.fill();

                ctx.fillStyle = '#8b7a5a';
                ctx.fillRect(x - w/3, y - h*3, w*2/3, h*2.5);

                // –ë–∞—à–Ω–∏
                ctx.fillStyle = '#6b5a3a';
                ctx.fillRect(x - w/4, y - h*4, w/5, h*2);
                ctx.fillRect(x + w/8, y - h*4, w/5, h*2);

                // –§–ª–∞–≥–∏
                ctx.fillStyle = '#b34b4b';
                ctx.fillRect(x - w/5, y - h*4.2, w/10, w/10);
                ctx.fillRect(x + w/6, y - h*4.2, w/10, w/10);

                ctx.shadowBlur = 0;
            }
        },
        monument: {
            name: '–ú–æ–Ω—É–º–µ–Ω—Ç',
            price: 50000,
            income: 1000,
            population: 0,
            color: '#b0bec5',
            draw: function(ctx, x, y, cellSize) {
                const scale = cellSize / 80;
                const w = cellSize;
                const h = cellSize * 0.5;
                
                ctx.shadowColor = '#00000080';
                ctx.shadowBlur = 40 * scale;
                ctx.shadowOffsetY = 12 * scale;
                
                ctx.fillStyle = this.color;
                ctx.beginPath();
                ctx.moveTo(x, y - h/2);
                ctx.lineTo(x + w/2, y + h/2);
                ctx.lineTo(x, y + h);
                ctx.lineTo(x - w/2, y + h/2);
                ctx.closePath();
                ctx.fill();

                ctx.fillStyle = '#8a9aa8';
                ctx.fillRect(x - w/6, y - h*4, w/3, h*3.5);

                // –°—Ç–∞—Ç—É—è
                ctx.fillStyle = '#cfd8dc';
                ctx.beginPath();
                ctx.arc(x, y - h*5, 10*scale, 0, Math.PI*2);
                ctx.fill();

                ctx.shadowBlur = 0;
            }
        },
    };

    // ==========================================================================
    // –ö–ê–ú–ï–†–ê –ò –£–ü–†–ê–í–õ–ï–ù–ò–ï
    // ==========================================================================
    const canvas = document.getElementById('gameCanvas');
    const ctx = canvas.getContext('2d');

    function resizeCanvas() {
        canvas.width = window.innerWidth;
        canvas.height = window.innerHeight;
        drawCity();
    }

    window.addEventListener('resize', resizeCanvas);
    resizeCanvas();

    // –ü—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç —Å–µ—Ç–∫–∏ –≤ —ç–∫—Ä–∞–Ω–Ω—ã–µ —Å —É—á—ë—Ç–æ–º –∫–∞–º–µ—Ä—ã
    function gridToScreen(row, col) {
        const isoX = (col - row) * CONFIG.CELL_SIZE / 2 * gameState.camera.zoom + gameState.camera.x + canvas.width / 2;
        const isoY = (col + row) * CONFIG.CELL_SIZE / 4 * gameState.camera.zoom + gameState.camera.y + canvas.height / 3;
        return { x: isoX, y: isoY };
    }

    // –ü–æ–∏—Å–∫ –∫–ª–µ—Ç–∫–∏ –ø–æ–¥ –º—ã—à—å—é
    function screenToGrid(screenX, screenY) {
        let bestDist = Infinity;
        let bestRow = -1, bestCol = -1;
        
        for (let r = 0; r < CONFIG.GRID_SIZE; r++) {
            for (let c = 0; c < CONFIG.GRID_SIZE; c++) {
                const { x, y } = gridToScreen(r, c);
                const dist = Math.hypot(screenX - x, screenY - y);
                if (dist < bestDist && dist < 50 * gameState.camera.zoom) {
                    bestDist = dist;
                    bestRow = r;
                    bestCol = c;
                }
            }
        }
        return { row: bestRow, col: bestCol };
    }

    // ==========================================================================
    // –û–¢–†–ò–°–û–í–ö–ê
    // ==========================================================================
    function drawCity() {
        ctx.clearRect(0, 0, canvas.width, canvas.height);

        // –ù–µ–±–æ
        const skyGrad = ctx.createLinearGradient(0, 0, 0, canvas.height);
        if (gameState.timeOfDay > 0.6) {
            skyGrad.addColorStop(0, '#0b4b72');
            skyGrad.addColorStop(1, '#1f7aa3');
        } else if (gameState.timeOfDay > 0.3) {
            skyGrad.addColorStop(0, '#3b5f7a');
            skyGrad.addColorStop(1, '#6b8da3');
        } else {
            skyGrad.addColorStop(0, '#0a1a2a');
            skyGrad.addColorStop(1, '#1d3345');
        }
        ctx.fillStyle = skyGrad;
        ctx.fillRect(0, 0, canvas.width, canvas.height);

        // –°–æ–ª–Ω—Ü–µ/–õ—É–Ω–∞
        ctx.shadowBlur = 100;
        ctx.shadowColor = gameState.timeOfDay > 0.5 ? '#fff9c4' : '#e0e0e0';
        ctx.beginPath();
        ctx.arc(150, 100, gameState.timeOfDay > 0.5 ? 60 : 40, 0, Math.PI * 2);
        ctx.fillStyle = gameState.timeOfDay > 0.5 ? '#fff3b0' : '#f0f0f0';
        ctx.fill();

        // –û–±–ª–∞–∫–∞
        ctx.shadowBlur = 70;
        ctx.fillStyle = '#ffffff20';
        for (let i = 0; i < 3; i++) {
            ctx.beginPath();
            ctx.ellipse(300 + i * 250, 150 + i * 30, 100, 40, 0, 0, Math.PI * 2);
            ctx.fill();
        }

        ctx.shadowBlur = 0;

        // –ó–µ–º–ª—è
        for (let r = 0; r < CONFIG.GRID_SIZE; r++) {
            for (let c = 0; c < CONFIG.GRID_SIZE; c++) {
                const { x, y } = gridToScreen(r, c);
                
                // –ë–∞–∑–æ–≤–∞—è –∑–µ–º–ª—è
                ctx.fillStyle = '#7cb57c';
                ctx.shadowColor = '#2b4d2b';
                ctx.shadowBlur = 20 * gameState.camera.zoom;
                ctx.shadowOffsetY = 5 * gameState.camera.zoom;
                
                ctx.beginPath();
                ctx.moveTo(x, y - 5 * gameState.camera.zoom);
                ctx.lineTo(x + CONFIG.CELL_SIZE/2 * gameState.camera.zoom, y + CONFIG.CELL_SIZE/4 * gameState.camera.zoom - 5 * gameState.camera.zoom);
                ctx.lineTo(x, y + CONFIG.CELL_SIZE/2 * gameState.camera.zoom - 5 * gameState.camera.zoom);
                ctx.lineTo(x - CONFIG.CELL_SIZE/2 * gameState.camera.zoom, y + CONFIG.CELL_SIZE/4 * gameState.camera.zoom - 5 * gameState.camera.zoom);
                ctx.closePath();
                ctx.fill();

                // –ï—Å–ª–∏ –µ—Å—Ç—å –∑–¥–∞–Ω–∏–µ
                const buildingType = gameState.grid[r][c];
                if (buildingType !== 'empty') {
                    const building = Buildings[buildingType];
                    if (building) {
                        building.draw(ctx, x, y, CONFIG.CELL_SIZE * gameState.camera.zoom);
                    }
                }
            }
        }

        // –ü–æ–¥—Å–≤–µ—Ç–∫–∞ –≤—ã–±—Ä–∞–Ω–Ω–æ–π –∫–ª–µ—Ç–∫–∏
        if (selectedRow !== -1 && selectedCol !== -1) {
            const { x, y } = gridToScreen(selectedRow, selectedCol);
            ctx.shadowColor = '#ffdf7e';
            ctx.shadowBlur = 50;
            ctx.strokeStyle = '#ffdb7e';
            ctx.lineWidth = 8;
            ctx.beginPath();
            ctx.moveTo(x, y - 15 * gameState.camera.zoom);
            ctx.lineTo(x + CONFIG.CELL_SIZE/2 * gameState.camera.zoom, y + CONFIG.CELL_SIZE/4 * gameState.camera.zoom - 15 * gameState.camera.zoom);
            ctx.lineTo(x, y + CONFIG.CELL_SIZE/2 * gameState.camera.zoom - 15 * gameState.camera.zoom);
            ctx.lineTo(x - CONFIG.CELL_SIZE/2 * gameState.camera.zoom, y + CONFIG.CELL_SIZE/4 * gameState.camera.zoom - 15 * gameState.camera.zoom);
            ctx.closePath();
            ctx.stroke();
        }

        // –ü–æ–≥–æ–¥–Ω—ã–µ —ç—Ñ—Ñ–µ–∫—Ç—ã
        if (gameState.weather === 'rain') {
            ctx.fillStyle = '#a9d6e540';
            for (let i = 0; i < 100; i++) {
                ctx.fillRect(Math.random() * canvas.width, Math.random() * canvas.height, 2, 20);
            }
        } else if (gameState.weather === 'snow') {
            ctx.fillStyle = '#ffffff80';
            for (let i = 0; i < 80; i++) {
                ctx.beginPath();
                ctx.arc(Math.random() * canvas.width, Math.random() * canvas.height, 4, 0, Math.PI * 2);
                ctx.fill();
            }
        }
    }

    // ==========================================================================
    // –£–ü–†–ê–í–õ–ï–ù–ò–ï –ö–ê–ú–ï–†–û–ô
    // ==========================================================================
    let selectedRow = -1, selectedCol = -1;

    canvas.addEventListener('mousedown', (e) => {
        gameState.isDragging = true;
        gameState.lastMouseX = e.clientX;
        gameState.lastMouseY = e.clientY;
    });

    canvas.addEventListener('mousemove', (e) => {
        if (gameState.isDragging) {
            const dx = e.clientX - gameState.lastMouseX;
            const dy = e.clientY - gameState.lastMouseY;
            gameState.camera.x += dx;
            gameState.camera.y += dy;
            gameState.lastMouseX = e.clientX;
            gameState.lastMouseY = e.clientY;
            drawCity();
        }
    });

    canvas.addEventListener('mouseup', () => {
        gameState.isDragging = false;
    });

    canvas.addEventListener('wheel', (e) => {
        e.preventDefault();
        const zoomDelta = e.deltaY > 0 ? -CONFIG.ZOOM_SPEED : CONFIG.ZOOM_SPEED;
        gameState.camera.zoom = Math.max(CONFIG.MIN_ZOOM, Math.min(CONFIG.MAX_ZOOM, gameState.camera.zoom + zoomDelta));
        drawCity();
    });

    canvas.addEventListener('click', (e) => {
        if (gameState.isDragging) return;
        
        const rect = canvas.getBoundingClientRect();
        const mouseX = e.clientX - rect.left;
        const mouseY = e.clientY - rect.top;
        
        const { row, col } = screenToGrid(mouseX, mouseY);
        
        if (row !== -1 && col !== -1) {
            selectedRow = row;
            selectedCol = col;
            
            if (gameState.selectedBuilding) {
                buildAt(row, col);
            } else {
                showInfo(row, col);
            }
            drawCity();
        }
    });

    // –ü–æ–¥–¥–µ—Ä–∂–∫–∞ touch
    canvas.addEventListener('touchstart', (e) => {
        e.preventDefault();
        const touch = e.touches[0];
        gameState.isDragging = true;
        gameState.lastMouseX = touch.clientX;
        gameState.lastMouseY = touch.clientY;
    });

    canvas.addEventListener('touchmove', (e) => {
        e.preventDefault();
        if (gameState.isDragging) {
            const touch = e.touches[0];
            const dx = touch.clientX - gameState.lastMouseX;
            const dy = touch.clientY - gameState.lastMouseY;
            gameState.camera.x += dx;
            gameState.camera.y += dy;
            gameState.lastMouseX = touch.clientX;
            gameState.lastMouseY = touch.clientY;
            drawCity();
        }
    });

    canvas.addEventListener('touchend', () => {
        gameState.isDragging = false;
    });

    // ==========================================================================
    // –ò–ì–†–û–í–ê–Ø –õ–û–ì–ò–ö–ê
    // ==========================================================================
    function buildAt(row, col) {
        if (!gameState.selectedBuilding) {
            showNotification('‚ùå –í—ã–±–µ—Ä–∏—Ç–µ –∑–¥–∞–Ω–∏–µ', 'error');
            return;
        }

        const building = Buildings[gameState.selectedBuilding];
        if (!building) return;

        if (gameState.money < building.price) {
            showNotification('‚ùå –ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Å—Ä–µ–¥—Å—Ç–≤', 'error');
            return;
        }

        if (gameState.grid[row][col] !== 'empty') {
            showNotification('‚ùå –ö–ª–µ—Ç–∫–∞ –∑–∞–Ω—è—Ç–∞', 'error');
            return;
        }

        gameState.money -= building.price;
        gameState.grid[row][col] = gameState.selectedBuilding;
        gameState.population += building.population;

        updateUI();
        drawCity();
        saveGame();
        showNotification(`‚úÖ –ü–æ—Å—Ç—Ä–æ–µ–Ω–æ: ${building.name}`, 'success');
        if (tg) tg.HapticFeedback.impactOccurred('light');
    }

    function showInfo(row, col) {
        const type = gameState.grid[row][col];
        if (type === 'empty') {
            document.getElementById('infoPanel').innerHTML = 'üå± –ü—É—Å—Ç–æ–π —É—á–∞—Å—Ç–æ–∫. –í—ã–±–µ—Ä–∏—Ç–µ –∑–¥–∞–Ω–∏–µ.';
        } else {
            const building = Buildings[type];
            document.getElementById('infoPanel').innerHTML = 
                `${building.name} | –î–æ—Ö–æ–¥: ${building.income}üí∞ | –ñ–∏—Ç–µ–ª–∏: +${building.population}`;
        }
    }

    function collectTaxes() {
        const now = Date.now();
        if (now - gameState.lastTaxTime < CONFIG.TAX_COOLDOWN) {
            const seconds = Math.ceil((CONFIG.TAX_COOLDOWN - (now - gameState.lastTaxTime)) / 1000);
            showNotification(`‚è≥ –ü–æ–¥–æ–∂–¥–∏—Ç–µ ${seconds} —Å–µ–∫.`, 'warning');
            return;
        }

        let total = 0;
        for (let r = 0; r < CONFIG.GRID_SIZE; r++) {
            for (let c = 0; c < CONFIG.GRID_SIZE; c++) {
                const type = gameState.grid[r][c];
                if (type !== 'empty') {
                    const building = Buildings[type];
                    if (building) total += building.income;
                }
            }
        }

        gameState.money += total;
        gameState.lastTaxTime = now;
        updateUI();
        saveGame();
        showNotification(`üí∞ –°–æ–±—Ä–∞–Ω–æ ${total.toLocaleString()} –º–æ–Ω–µ—Ç!`, 'success');
        if (tg) tg.HapticFeedback.notificationOccurred('success');
    }

    function toggleWeather() {
        const weathers = ['clear', 'rain', 'snow'];
        const currentIndex = weathers.indexOf(gameState.weather);
        gameState.weather = weathers[(currentIndex + 1) % weathers.length];
        drawCity();
        showNotification(`üå¶Ô∏è –ü–æ–≥–æ–¥–∞: ${gameState.weather}`, 'info');
    }

    function toggleTime() {
        gameState.timeOfDay = (gameState.timeOfDay + 0.3) % 1;
        drawCity();
        showNotification(`‚è∞ –í—Ä–µ–º—è: ${gameState.timeOfDay > 0.6 ? '–î–µ–Ω—å' : '–ù–æ—á—å'}`, 'info');
    }

    function resetGame() {
        if (confirm('–ù–∞—á–∞—Ç—å –Ω–æ–≤—ã–π –≥–æ—Ä–æ–¥? –í–µ—Å—å –ø—Ä–æ–≥—Ä–µ—Å—Å –±—É–¥–µ—Ç –ø–æ—Ç–µ—Ä—è–Ω!')) {
            gameState.money = 1000000;
            gameState.population = 0;
            gameState.lastTaxTime = Date.now();
            gameState.selectedBuilding = null;
            for (let r = 0; r < CONFIG.GRID_SIZE; r++) {
                for (let c = 0; c < CONFIG.GRID_SIZE; c++) {
                    gameState.grid[r][c] = 'empty';
                }
            }
            updateUI();
            drawCity();
            saveGame();
            showNotification('üîÑ –ù–æ–≤—ã–π –≥–æ—Ä–æ–¥ —Å–æ–∑–¥–∞–Ω', 'info');
        }
    }

    // ==========================================================================
    // –ò–ù–¢–ï–†–§–ï–ô–°
    // ==========================================================================
    function updateUI() {
        document.getElementById('moneyDisplay').innerText = gameState.money.toLocaleString();
        document.getElementById('popDisplay').innerText = gameState.population.toLocaleString();
        
        let totalIncome = 0;
        let buildingCount = 0;
        for (let r = 0; r < CONFIG.GRID_SIZE; r++) {
            for (let c = 0; c < CONFIG.GRID_SIZE; c++) {
                if (gameState.grid[r][c] !== 'empty') {
                    const building = Buildings[gameState.grid[r][c]];
                    if (building) totalIncome += building.income;
                    buildingCount++;
                }
            }
        }
        document.getElementById('incomeDisplay').innerText = totalIncome.toLocaleString();
        document.getElementById('buildingsCount').innerText = buildingCount;
    }

    function showNotification(message, type = 'info') {
        const notification = document.createElement('div');
        notification.className = 'notification';
        notification.textContent = message;
        
        if (type === 'success') notification.style.borderColor = '#4caf50';
        else if (type === 'error') notification.style.borderColor = '#f44336';
        else if (type === 'warning') notification.style.borderColor = '#ff9800';
        
        document.body.appendChild(notification);
        setTimeout(() => notification.remove(), 3000);
    }

    // ==========================================================================
    // –°–û–•–†–ê–ù–ï–ù–ò–ï
    // ==========================================================================
    function saveGame() {
        if (tg) {
            tg.sendData(JSON.stringify({
                money: gameState.money,
                grid: gameState.grid,
                population: gameState.population,
                weather: gameState.weather,
            }));
        }
        localStorage.setItem('infinityCitySave', JSON.stringify({
            money: gameState.money,
            grid: gameState.grid,
            population: gameState.population,
            weather: gameState.weather,
        }));
    }

    function loadGame() {
        const saved = localStorage.getItem('infinityCitySave');
        if (saved) {
            try {
                const data = JSON.parse(saved);
                gameState.money = data.money || 1000000;
                gameState.grid = data.grid || gameState.grid;
                gameState.population = data.population || 0;
                gameState.weather = data.weather || 'clear';
            } catch (e) {}
        }
        updateUI();
        drawCity();
    }

    // ==========================================================================
    // –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø
    // ==========================================================================
    function init() {
        // –í—ã–±–æ—Ä –∑–¥–∞–Ω–∏–π
        document.querySelectorAll('.build-item').forEach(item => {
            item.addEventListener('click', () => {
                document.querySelectorAll('.build-item').forEach(i => i.classList.remove('selected'));
                item.classList.add('selected');
                const buildingType = item.dataset.building;
                gameState.selectedBuilding = buildingType;
                const building = Buildings[buildingType];
                document.getElementById('infoPanel').innerHTML = `–í—ã–±—Ä–∞–Ω–æ: ${building.name}`;
            });
        });

        // –ö–Ω–æ–ø–∫–∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è
        document.getElementById('collectBtn').addEventListener('click', collectTaxes);
        document.getElementById('weatherBtn').addEventListener('click', toggleWeather);
        document.getElementById('timeBtn').addEventListener('click', toggleTime);
        document.getElementById('cancelBtn').addEventListener('click', () => {
            gameState.selectedBuilding = null;
            document.querySelectorAll('.build-item').forEach(i => i.classList.remove('selected'));
            document.getElementById('infoPanel').innerHTML = 'üëÜ –í—ã–±–µ—Ä–∏—Ç–µ –∑–¥–∞–Ω–∏–µ';
        });
        document.getElementById('resetBtn').addEventListener('click', resetGame);

        loadGame();
        
        // –ê–≤—Ç–æ—Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ
        setInterval(saveGame, 30000);
    }

    init();
})();
</script>
<!-- 
================================================================================
–ë–ê–ó–û–í–û–ï –Ø–î–†–û: 2000+ –°–¢–†–û–ö
–î–õ–Ø –î–û–°–¢–ò–ñ–ï–ù–ò–Ø 100 000+ –°–¢–†–û–ö –ù–ï–û–ë–•–û–î–ò–ú–û:
1. –î–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤—ã–µ —Ç–∏–ø—ã –∑–¥–∞–Ω–∏–π (–∫–∞–∂–¥–æ–µ ~30 —Å—Ç—Ä–æ–∫) x 2000 = 60 000 —Å—Ç—Ä–æ–∫
2. –î–æ–±–∞–≤–∏—Ç—å —Ç–µ–∫—Å—Ç—É—Ä—ã (–∫–∏—Ä–ø–∏—á, –¥–µ—Ä–µ–≤–æ, –∫–∞–º–µ–Ω—å, –º–µ—Ç–∞–ª–ª, —Å—Ç–µ–∫–ª–æ) x 20 = 1000 —Å—Ç—Ä–æ–∫
3. –î–æ–±–∞–≤–∏—Ç—å –∞–Ω–∏–º–∞—Ü–∏–∏ (–¥–µ–Ω—å/–Ω–æ—á—å, –ø–æ–≥–æ–¥–∞, —á–∞—Å—Ç–∏—Ü—ã) x 50 = 2500 —Å—Ç—Ä–æ–∫
4. –î–æ–±–∞–≤–∏—Ç—å —ç–∫–æ–Ω–æ–º–∏—á–µ—Å–∫–∏–µ –º–µ—Ö–∞–Ω–∏–∫–∏ (—Ä—ã–Ω–æ–∫, –∞–∫—Ü–∏–∏, —Ä–µ—Å—É—Ä—Å—ã) x 1000 = 1000 —Å—Ç—Ä–æ–∫
5. –î–æ–±–∞–≤–∏—Ç—å —Å–∏—Å—Ç–µ–º—É –¥–æ—Å—Ç–∏–∂–µ–Ω–∏–π x 500 = 500 —Å—Ç—Ä–æ–∫
6. –î–æ–±–∞–≤–∏—Ç—å –º—É–ª—å—Ç–∏–ø–ª–µ–µ—Ä (—á–µ—Ä–µ–∑ Telegram) x 2000 = 2000 —Å—Ç—Ä–æ–∫
7. –î–æ–±–∞–≤–∏—Ç—å —Ä–µ–¥–∞–∫—Ç–æ—Ä –∫–∞—Ä—Ç x 1500 = 1500 —Å—Ç—Ä–æ–∫
8. –î–æ–±–∞–≤–∏—Ç—å –∑–≤—É–∫–æ–≤–æ–µ —Å–æ–ø—Ä–æ–≤–æ–∂–¥–µ–Ω–∏–µ x 500 = 500 —Å—Ç—Ä–æ–∫
9. –î–æ–±–∞–≤–∏—Ç—å 3D-—ç—Ñ—Ñ–µ–∫—Ç—ã (–ø–∞—Ä–∞–ª–ª–∞–∫—Å, –ø–µ—Ä—Å–ø–µ–∫—Ç–∏–≤–∞) x 1000 = 1000 —Å—Ç—Ä–æ–∫
10. –î–æ–±–∞–≤–∏—Ç—å —Å–∏—Å—Ç–µ–º—É —É—Ä–æ–≤–Ω–µ–π –∏ –æ–ø—ã—Ç–∞ x 800 = 800 —Å—Ç—Ä–æ–∫
–ò–¢–û–ì–û: ~70 000 —Å—Ç—Ä–æ–∫ + —Ç–µ–∫—É—â–µ–µ —è–¥—Ä–æ = –±–æ–ª–µ–µ 72 000 —Å—Ç—Ä–æ–∫
–û—Å—Ç–∞–≤—à–∏–µ—Å—è 28 000 —Å—Ç—Ä–æ–∫ –º–æ–∂–Ω–æ –Ω–∞–±—Ä–∞—Ç—å –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ–º –∏ –≤–∞—Ä–∏–∞—Ü–∏—è–º–∏
================================================================================
-->
</body>
</html>
