<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>üåÜ –£–Æ–¢–ù–´–ô –ì–û–†–û–î 3D - MEGA QUALITY</title>
<style>
*{
    margin:0;
    padding:0;
    box-sizing:border-box;
    font-family:'Segoe UI', Roboto, sans-serif;
    user-select:none;
}
body{
    background:#0a1a2a;
    overflow:hidden;
    touch-action:none;
}
.game{
    width:100vw;
    height:100vh;
    position:relative;
}
canvas{
    width:100%;
    height:100%;
    display:block;
    touch-action:none;
    cursor:grab;
}
canvas:active{cursor:grabbing}

.ui{
    position:fixed;
    bottom:15px;
    left:50%;
    transform:translateX(-50%);
    display:flex;
    gap:10px;
    background:rgba(25,35,45,.95);
    backdrop-filter:blur(10px);
    padding:10px 20px;
    border-radius:40px;
    color:#fff;
    font-size:clamp(14px,4vw,20px);
    z-index:10;
    border:2px solid #ffffff30;
    flex-wrap:wrap;
    justify-content:center;
    max-width:95%;
    box-shadow:0 10px 30px #00000060;
}
.ui div{
    background:rgba(0,0,0,.4);
    padding:6px 14px;
    border-radius:30px;
    white-space:nowrap;
    border:1px solid #ffffff20;
}

.menu-left{
    position:fixed;
    top:50%;
    left:10px;
    transform:translateY(-50%);
    width:min(350px,90vw);
    max-height:80vh;
    background:rgba(25,35,45,.95);
    backdrop-filter:blur(10px);
    border-radius:30px;
    padding:20px;
    display:flex;
    flex-direction:column;
    gap:15px;
    z-index:10;
    border:2px solid #ffffff20;
    box-shadow:0 20px 40px #00000080;
}
.menu-left h2{
    color:#fff;
    text-align:center;
    font-size:clamp(18px,4vw,24px);
    text-shadow:0 2px 5px black;
}
.categories{
    display:flex;
    flex-wrap:wrap;
    gap:5px;
    justify-content:center;
}
.categories button{
    flex:1 0 auto;
    min-width:70px;
    padding:8px;
    border-radius:25px;
    border:none;
    cursor:pointer;
    background:#ffffff20;
    color:#fff;
    font-size:clamp(12px,3vw,14px);
    transition:0.2s;
    border:1px solid #ffffff30;
}
.categories button:hover{
    background:#ffffff40;
}
.categories button.active{
    background:#ffb84d;
    color:#1a2a3a;
    border-color:#ff9f1c;
}
.list{
    flex:1;
    overflow:auto;
    scrollbar-width:thin;
    scrollbar-color:#4a9ec0 #1f3f55;
    padding-right:5px;
}
.list::-webkit-scrollbar{
    width:6px;
}
.list::-webkit-scrollbar-thumb{
    background:#4a9ec0;
    border-radius:10px;
}
.item{
    background:rgba(255,255,255,.08);
    margin-bottom:8px;
    padding:12px;
    border-radius:20px;
    color:#fff;
    cursor:pointer;
    display:flex;
    align-items:center;
    gap:12px;
    font-size:clamp(12px,3vw,14px);
    border:2px solid transparent;
    transition:0.2s;
}
.item:hover{
    background:rgba(255,255,255,.15);
    transform:translateX(3px);
}
.item.selected{
    border-color:#ffb84d;
    background:rgba(255,184,77,.15);
}
.item-icon{
    font-size:28px;
    filter:drop-shadow(0 2px 5px black);
}

.menu-right{
    position:fixed;
    top:50%;
    right:10px;
    transform:translateY(-50%);
    background:rgba(25,35,45,.95);
    backdrop-filter:blur(10px);
    border-radius:30px;
    padding:20px;
    display:flex;
    flex-direction:column;
    gap:10px;
    z-index:10;
    border:2px solid #ffffff20;
    box-shadow:0 20px 40px #00000080;
    max-width:min(220px,40vw);
}
.menu-right button{
    padding:12px 15px;
    font-size:clamp(14px,3.5vw,16px);
    border-radius:30px;
    border:none;
    cursor:pointer;
    background:#ffffff20;
    color:#fff;
    display:flex;
    align-items:center;
    justify-content:center;
    gap:10px;
    transition:0.2s;
    border:1px solid #ffffff30;
}
.menu-right button:hover{
    background:#ffffff40;
    transform:translateX(-5px);
}
.menu-right button:active{
    transform:scale(0.98);
}
.menu-right button.collect{
    background:#2e7d3240;
    border:2px solid #4caf50;
}
.menu-right button.delete{
    background:#b71c1c40;
    border:2px solid #f44336;
}

.info{
    position:fixed;
    top:15px;
    left:50%;
    transform:translateX(-50%);
    background:rgba(25,35,45,.95);
    backdrop-filter:blur(10px);
    padding:12px 30px;
    border-radius:40px;
    color:#fff;
    z-index:10;
    font-size:clamp(14px,4vw,18px);
    border:2px solid #ffffff30;
    white-space:nowrap;
    max-width:90%;
    overflow:hidden;
    text-overflow:ellipsis;
    box-shadow:0 10px 30px #00000060;
    border-top:4px solid #4a9ec0;
}
</style>
</head>

<body>
<div class="game">
<canvas id="c"></canvas>

<div class="info" id="info">üèôÔ∏è –£–Æ–¢–ù–´–ô –ì–û–†–û–î 3D - –≤—ã–±–µ—Ä–∏—Ç–µ –∑–¥–∞–Ω–∏–µ</div>

<div class="ui">
    <div>üí∞ <span id="money">100,000,000</span></div>
    <div>üë• <span id="pop">0</span></div>
    <div>üìà <span id="inc">0</span></div>
    <div>üèóÔ∏è <span id="cnt">0/900</span></div>
</div>

<div class="menu-left">
<h2>üèóÔ∏è –ö–ê–¢–ê–õ–û–ì –ü–û–°–¢–†–û–ï–ö</h2>
<div class="categories" id="cats"></div>
<div class="list" id="list"></div>
</div>

<div class="menu-right">
    <button class="collect" onclick="collectTaxes()"><span>üí∞</span> –°–ë–û–†</button>
    <button onclick="rotateLeft()"><span>‚Ü∫</span> –í–õ–ï–í–û</button>
    <button onclick="rotateRight()"><span>‚Üª</span> –í–ü–†–ê–í–û</button>
    <button onclick="zoomIn()"><span>üîç+</span> –ü–†–ò–ë–õ–ò–ó–ò–¢–¨</button>
    <button onclick="zoomOut()"><span>üîç-</span> –û–¢–î–ê–õ–ò–¢–¨</button>
    <button onclick="toggleWeather()"><span>üå¶Ô∏è</span> –ü–û–ì–û–î–ê</button>
    <button onclick="toggleTime()"><span>‚è∞</span> –í–†–ï–ú–Ø</button>
    <button class="delete" onclick="toggleDeleteMode()"><span>üóëÔ∏è</span> –£–î–ê–õ–ò–¢–¨</button>
    <button onclick="cancel()"><span>‚ùå</span> –û–¢–ú–ï–ù–ê</button>
    <button onclick="resetGame()"><span>üîÑ</span> –ù–û–í–´–ô –ì–û–†–û–î</button>
</div>
</div>

<script>
// ==================== 3D –î–í–ò–ñ–û–ö –ü–†–ï–ú–ò–£–ú ====================
const canvas = document.getElementById('c');
const ctx = canvas.getContext('2d');

// –†–∞–∑–º–µ—Ä—ã –º–∏—Ä–∞
const GRID = 15;
const CELL = 100;

// –ö–∞–º–µ—Ä–∞
let camera = {
    angle: 0.5,
    height: 250,
    distance: 900,
    targetX: 0,
    targetY: 0
};

// –°–æ—Å—Ç–æ—è–Ω–∏–µ –∏–≥—Ä—ã
let game = {
    money: 100000000,
    population: 0,
    buildingsCount: 0,
    weather: 0,
    timeOfDay: 0.7,
    grid: []
};

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å–µ—Ç–∫–∏
for (let r = 0; r < GRID; r++) {
    game.grid[r] = [];
    for (let c = 0; c < GRID; c++) {
        game.grid[r][c] = null;
    }
}

// –î–æ—Ä–æ–≥–∏ –¥–ª—è —Ç—Ä–∞—Ñ–∏–∫–∞
let roads = [];

// ==================== –ì–ï–ù–ï–†–ê–¶–ò–Ø 5000+ –£–ù–ò–ö–ê–õ–¨–ù–´–• –ó–î–ê–ù–ò–ô ====================
const buildingStyles = [
    // –î–æ–º–∞
    { type: 'house', baseColor: '#f9d79f', roofColor: '#b54c4c', windows: 2, chimney: true, door: true },
    { type: 'house', baseColor: '#cf9f6b', roofColor: '#8b5a2b', windows: 3, chimney: true, door: true },
    { type: 'house', baseColor: '#e3b27c', roofColor: '#b34b4b', windows: 2, chimney: true, door: true },
    { type: 'house', baseColor: '#c49a6c', roofColor: '#7a4c4c', windows: 3, chimney: true, door: true },
    
    // –ö–æ—Ç—Ç–µ–¥–∂–∏
    { type: 'cottage', baseColor: '#d9b382', roofColor: '#b34b4b', windows: 3, balcony: true, garage: false },
    { type: 'cottage', baseColor: '#f0c48b', roofColor: '#b34b4b', windows: 4, balcony: true, garage: true },
    { type: 'cottage', baseColor: '#e6b87a', roofColor: '#a54444', windows: 3, balcony: true, garage: false },
    
    // –ú–∞–≥–∞–∑–∏–Ω—ã
    { type: 'shop', baseColor: '#ffb74d', roofColor: '#ff9800', windows: 2, sign: true },
    { type: 'shop', baseColor: '#ff8a65', roofColor: '#f57c00', windows: 2, sign: true },
    { type: 'shop', baseColor: '#ffa726', roofColor: '#fb8c00', windows: 3, sign: true },
    
    // –û—Ñ–∏—Å—ã
    { type: 'office', baseColor: '#9e9e9e', roofColor: '#757575', windows: 4, floors: 2 },
    { type: 'office', baseColor: '#b0bec5', roofColor: '#607d8b', windows: 5, floors: 3 },
    { type: 'office', baseColor: '#cfd8dc', roofColor: '#90a4ae', windows: 4, floors: 2 },
    
    // –†–µ—Å—Ç–æ—Ä–∞–Ω—ã
    { type: 'restaurant', baseColor: '#ef9a9a', roofColor: '#e57373', terrace: true, windows: 2 },
    { type: 'restaurant', baseColor: '#ffab91', roofColor: '#ff8a65', terrace: false, windows: 3 },
    
    // –ú–µ–¥–∏—Ü–∏–Ω–∞
    { type: 'hospital', baseColor: '#ef9a9a', cross: true, windows: 3 },
    { type: 'clinic', baseColor: '#ffcdd2', cross: true, windows: 2 },
    
    // –û–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ
    { type: 'school', baseColor: '#ff8a80', bell: true, windows: 4 },
    { type: 'school', baseColor: '#ffab91', bell: true, windows: 5 },
    
    // –ö—É–ª—å—Ç—É—Ä–∞
    { type: 'church', baseColor: '#f5f5f5', roofColor: '#b71c1c', spire: true },
    { type: 'museum', baseColor: '#cfd8dc', columns: true, windows: 3 },
    
    // –ò–Ω–¥—É—Å—Ç—Ä–∏—è
    { type: 'factory', baseColor: '#b0bec5', chimney: true, windows: 2 },
    { type: 'factory', baseColor: '#9e9e9e', chimney: true, windows: 3 },
    
    // –ü–∞—Ä–∫–∏
    { type: 'park', trees: 3, fountain: true },
    { type: 'park', trees: 4, fountain: false },
    
    // –î–æ—Ä–æ–≥–∏
    { type: 'road', hasCars: true, hasLights: true }
];

const prefixes = [
    '–£—é—Ç–Ω—ã–π', '–ë–æ–ª—å—à–æ–π', '–û–≥—Ä–æ–º–Ω—ã–π', '–ú–∏–Ω–∏–∞—Ç—é—Ä–Ω—ã–π', '–°—Ç–∞—Ä–∏–Ω–Ω—ã–π', '–°–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–π',
    '–ö–ª–∞—Å—Å–∏—á–µ—Å–∫–∏–π', '–≠–ª–∏—Ç–Ω—ã–π', '–ù–∞—Ä–æ–¥–Ω—ã–π', '–ö–æ—Ä–æ–ª–µ–≤—Å–∫–∏–π', '–°–∫–∞–∑–æ—á–Ω—ã–π', '–õ–µ—Å–Ω–æ–π',
    '–ü—Ä–∏–±—Ä–µ–∂–Ω—ã–π', '–ì–æ—Ä–Ω—ã–π', '–°–æ–ª–Ω–µ—á–Ω—ã–π', '–¢–µ–Ω–∏—Å—Ç—ã–π', '–¶–≤–µ—Ç—É—â–∏–π', '–ó–æ–ª–æ—Ç–æ–π'
];

const buildings = {};
let buildingId = 0;

// –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º 5000+ –∑–¥–∞–Ω–∏–π
for (let s = 0; s < buildingStyles.length; s++) {
    for (let i = 0; i < 250; i++) {
        const style = buildingStyles[s];
        const prefix = prefixes[i % prefixes.length];
        const types = {
            house: '–î–æ–º',
            cottage: '–ö–æ—Ç—Ç–µ–¥–∂',
            shop: '–ú–∞–≥–∞–∑–∏–Ω',
            office: '–û—Ñ–∏—Å',
            restaurant: '–†–µ—Å—Ç–æ—Ä–∞–Ω',
            hospital: '–ë–æ–ª—å–Ω–∏—Ü–∞',
            clinic: '–ö–ª–∏–Ω–∏–∫–∞',
            school: '–®–∫–æ–ª–∞',
            church: '–¶–µ—Ä–∫–æ–≤—å',
            museum: '–ú—É–∑–µ–π',
            factory: '–ó–∞–≤–æ–¥',
            park: '–ü–∞—Ä–∫',
            road: '–î–æ—Ä–æ–≥–∞'
        };
        const typeName = types[style.type] || '–ó–¥–∞–Ω–∏–µ';
        const name = `${prefix} ${typeName} ${i+1}`;
        
        const price = 1000 + (s * 800) + (i * 50);
        const income = Math.floor(price * 0.08) + 10;
        const population = style.type === 'house' ? 5 + Math.floor(i/10) : 
                          style.type === 'cottage' ? 12 + Math.floor(i/5) :
                          style.type === 'shop' ? 2 : 1;
        
        buildings['b'+buildingId] = {
            id: 'b'+buildingId,
            name: name,
            price: price,
            income: income,
            population: population,
            style: style,
            category: s % 8
        };
        buildingId++;
    }
}

// ==================== 3D –ü–†–û–ï–ö–¶–ò–Ø ====================
function project(x, y, z) {
    const cosA = Math.cos(camera.angle);
    const sinA = Math.sin(camera.angle);
    
    const rx = x * cosA - z * sinA;
    const rz = x * sinA + z * cosA;
    
    const scale = camera.distance / (camera.distance + rz);
    const screenX = canvas.width / 2 + rx * scale;
    const screenY = canvas.height / 2 - (y - camera.height) * scale;
    
    return { x: screenX, y: screenY, scale: scale };
}

// ==================== –†–ò–°–û–í–ê–ù–ò–ï –î–ï–¢–ê–õ–¨–ù–´–• –ó–î–ê–ù–ò–ô ====================
function drawHouse(x, y, z, style) {
    const w = CELL * 0.7;
    const h = style.height || 70;
    const d = CELL * 0.7;
    
    ctx.shadowColor = 'rgba(0,0,0,0.5)';
    ctx.shadowBlur = 20;
    ctx.shadowOffsetX = 5;
    ctx.shadowOffsetY = 5;
    
    // –°—Ç–µ–Ω—ã
    const p1 = project(x - w/2, y, z - d/2);
    const p2 = project(x + w/2, y, z - d/2);
    const p3 = project(x + w/2, y - h, z - d/2);
    const p4 = project(x - w/2, y - h, z - d/2);
    
    ctx.beginPath();
    ctx.moveTo(p1.x, p1.y);
    ctx.lineTo(p2.x, p2.y);
    ctx.lineTo(p3.x, p3.y);
    ctx.lineTo(p4.x, p4.y);
    ctx.closePath();
    ctx.fillStyle = style.baseColor || '#e3b27c';
    ctx.fill();
    
    // –ö—Ä—ã—à–∞
    const r1 = project(x - w/2, y - h, z - d/2);
    const r2 = project(x + w/2, y - h, z - d/2);
    const r3 = project(x, y - h - 30, z);
    
    ctx.beginPath();
    ctx.moveTo(r1.x, r1.y);
    ctx.lineTo(r2.x, r2.y);
    ctx.lineTo(r3.x, r3.y);
    ctx.closePath();
    ctx.fillStyle = style.roofColor || '#b54c4c';
    ctx.fill();
    
    // –û–∫–Ω–∞
    ctx.fillStyle = '#f9e076';
    ctx.shadowColor = '#ffd700';
    for (let i = 0; i < (style.windows || 2); i++) {
        const wx = x - w/4 + i * w/3;
        const wy = y - h/2;
        const wz = z - d/2 + 5;
        const wp = project(wx, wy, wz);
        ctx.fillRect(wp.x - 8, wp.y - 12, 16, 20);
    }
    
    // –î–≤–µ—Ä—å
    if (style.door) {
        const dp = project(x, y - h/3, z - d/2 + 5);
        ctx.fillStyle = '#8b5a2b';
        ctx.fillRect(dp.x - 10, dp.y - 20, 20, 30);
    }
    
    ctx.shadowBlur = 0;
    ctx.shadowOffsetX = 0;
    ctx.shadowOffsetY = 0;
}

function drawRoad(x, y, z) {
    const w = CELL * 0.9;
    const d = CELL * 0.9;
    
    ctx.shadowBlur = 10;
    ctx.fillStyle = '#b0bec5';
    
    const p1 = project(x - w/2, y + 2, z - d/2);
    const p2 = project(x + w/2, y + 2, z - d/2);
    const p3 = project(x + w/2, y + 2, z + d/2);
    const p4 = project(x - w/2, y + 2, z + d/2);
    
    ctx.beginPath();
    ctx.moveTo(p1.x, p1.y);
    ctx.lineTo(p2.x, p2.y);
    ctx.lineTo(p3.x, p3.y);
    ctx.lineTo(p4.x, p4.y);
    ctx.closePath();
    ctx.fill();
    
    // –†–∞–∑–º–µ—Ç–∫–∞
    ctx.fillStyle = '#f5f5f5';
    const m1 = project(x - w/3, y + 3, z);
    const m2 = project(x + w/3, y + 3, z);
    ctx.fillRect(m1.x - 10, m1.y - 3, 20, 5);
    ctx.fillRect(m2.x - 10, m2.y - 3, 20, 5);
}

function drawPark(x, y, z, style) {
    ctx.shadowBlur = 15;
    
    // –¢—Ä–∞–≤–∞
    ctx.fillStyle = '#81c784';
    const p1 = project(x - CELL/2, y, z - CELL/2);
    const p2 = project(x + CELL/2, y, z - CELL/2);
    const p3 = project(x + CELL/2, y, z + CELL/2);
    const p4 = project(x - CELL/2, y, z + CELL/2);
    
    ctx.beginPath();
    ctx.moveTo(p1.x, p1.y);
    ctx.lineTo(p2.x, p2.y);
    ctx.lineTo(p3.x, p3.y);
    ctx.lineTo(p4.x, p4.y);
    ctx.closePath();
    ctx.fill();
    
    // –î–µ—Ä–µ–≤—å—è
    for (let i = 0; i < (style.trees || 3); i++) {
        const tx = x - CELL/3 + i * CELL/3;
        const tz = z;
        drawTree(tx, y, tz);
    }
}

function drawTree(x, y, z) {
    // –°—Ç–≤–æ–ª
    ctx.fillStyle = '#8b5a2b';
    const t1 = project(x, y, z);
    const t2 = project(x, y + 30, z);
    ctx.fillRect(t1.x - 5, t1.y - 15, 10, 30);
    
    // –ö—Ä–æ–Ω–∞
    ctx.fillStyle = '#5f9b6b';
    for (let i = 0; i < 3; i++) {
        const cx = x + (i-1) * 12;
        const cy = y + 40;
        const cz = z;
        const c = project(cx, cy, cz);
        ctx.beginPath();
        ctx.arc(c.x, c.y, 12, 0, Math.PI*2);
        ctx.fill();
    }
}

// ==================== –ú–ê–®–ò–ù–´ ====================
let vehicles = [];

function createVehicle(type, x, z) {
    return {
        type: type,
        x: x,
        z: z,
        speed: 0.5 + Math.random() * 2,
        color: `hsl(${Math.random() * 360}, 80%, 60%)`,
        dir: Math.floor(Math.random() * 4),
        size: type === 'car' ? 20 : type === 'truck' ? 30 : 15
    };
}

function drawVehicle(v) {
    ctx.shadowBlur = 15;
    ctx.shadowColor = 'rgba(0,0,0,0.5)';
    
    const points = [
        project(v.x - v.size/2, 5, v.z - v.size/4),
        project(v.x + v.size/2, 5, v.z - v.size/4),
        project(v.x + v.size/2, 5, v.z + v.size/4),
        project(v.x - v.size/2, 5, v.z + v.size/4)
    ];
    
    ctx.beginPath();
    ctx.moveTo(points[0].x, points[0].y);
    for (let i = 1; i < 4; i++) {
        ctx.lineTo(points[i].x, points[i].y);
    }
    ctx.closePath();
    ctx.fillStyle = v.color;
    ctx.fill();
    
    // –û–∫–Ω–∞
    ctx.fillStyle = '#aed6f1';
    const w1 = project(v.x - v.size/4, 10, v.z);
    const w2 = project(v.x + v.size/4, 10, v.z);
    ctx.fillRect(w1.x - 5, w1.y - 5, 10, 8);
    ctx.fillRect(w2.x - 5, w2.y - 5, 10, 8);
}

// ==================== –ü–ï–®–ï–•–û–î–´ ====================
let pedestrians = [];

function createPedestrian(x, z) {
    return {
        x: x,
        z: z,
        speed: 0.1 + Math.random() * 0.3,
        color: '#fff',
        targetX: x + (Math.random() - 0.5) * 100,
        targetZ: z + (Math.random() - 0.5) * 100
    };
}

function drawPedestrian(p) {
    const pos = project(p.x, 5, p.z);
    ctx.beginPath();
    ctx.arc(pos.x, pos.y, 3, 0, Math.PI*2);
    ctx.fillStyle = '#fff';
    ctx.shadowBlur = 5;
    ctx.fill();
}

// ==================== –û–°–ù–û–í–ù–ê–Ø –û–¢–†–ò–°–û–í–ö–ê ====================
function draw3D() {
    ctx.clearRect(0, 0, canvas.width, canvas.height);

    // –ù–µ–±–æ —Å –ø–ª–∞–≤–Ω—ã–º –≥—Ä–∞–¥–∏–µ–Ω—Ç–æ–º
    const skyGrad = ctx.createLinearGradient(0, 0, 0, canvas.height);
    if (game.timeOfDay > 0.7) {
        skyGrad.addColorStop(0, '#0b4b72');
        skyGrad.addColorStop(0.5, '#1f7aa3');
        skyGrad.addColorStop(1, '#2d8fc9');
    } else if (game.timeOfDay > 0.4) {
        skyGrad.addColorStop(0, '#2c4f6e');
        skyGrad.addColorStop(0.5, '#4f7a9e');
        skyGrad.addColorStop(1, '#6b9fc9');
    } else if (game.timeOfDay > 0.2) {
        skyGrad.addColorStop(0, '#1e3a50');
        skyGrad.addColorStop(0.5, '#345e82');
        skyGrad.addColorStop(1, '#4a7ca3');
    } else {
        skyGrad.addColorStop(0, '#0a1a2a');
        skyGrad.addColorStop(0.5, '#1b3447');
        skyGrad.addColorStop(1, '#2a4a63');
    }
    ctx.fillStyle = skyGrad;
    ctx.fillRect(0, 0, canvas.width, canvas.height);

    // –°–æ–ª–Ω—Ü–µ/–õ—É–Ω–∞ —Å –æ—Ä–µ–æ–ª–æ–º
    ctx.shadowBlur = 100;
    ctx.shadowColor = game.timeOfDay > 0.5 ? '#fff9c480' : '#e0e0e080';
    ctx.beginPath();
    ctx.arc(150, 100, game.timeOfDay > 0.5 ? 60 : 40, 0, Math.PI*2);
    ctx.fillStyle = game.timeOfDay > 0.5 ? '#fff3b0' : '#f0f0f0';
    ctx.fill();
    ctx.shadowBlur = 0;

    // –†–∏—Å—É–µ–º –∑–µ–º–ª—é –∏ –∑–¥–∞–Ω–∏—è
    const size = GRID * CELL;
    const startX = -size/2;
    const startZ = -size/2;
    
    for (let r = 0; r < GRID; r++) {
        for (let c = 0; c < GRID; c++) {
            const x = startX + r * CELL + CELL/2;
            const z = startZ + c * CELL + CELL/2;
            
            // –ó–µ–º–ª—è
            const groundColor = '#5f8b5f';
            const g1 = project(x - CELL/2, 0, z - CELL/2);
            const g2 = project(x + CELL/2, 0, z - CELL/2);
            const g3 = project(x + CELL/2, 0, z + CELL/2);
            const g4 = project(x - CELL/2, 0, z + CELL/2);
            
            ctx.beginPath();
            ctx.moveTo(g1.x, g1.y);
            ctx.lineTo(g2.x, g2.y);
            ctx.lineTo(g3.x, g3.y);
            ctx.lineTo(g4.x, g4.y);
            ctx.closePath();
            ctx.fillStyle = groundColor;
            ctx.fill();
            ctx.strokeStyle = '#3a6b3a';
            ctx.lineWidth = 1;
            ctx.stroke();

            // –ó–¥–∞–Ω–∏–µ
            const buildingId = game.grid[r][c];
            if (buildingId && buildings[buildingId]) {
                const b = buildings[buildingId];
                if (b.style.type === 'road') {
                    drawRoad(x, 0, z);
                } else if (b.style.type === 'park') {
                    drawPark(x, 0, z, b.style);
                } else {
                    drawHouse(x, 0, z, b.style);
                }
            }
        }
    }

    // –ú–∞—à–∏–Ω—ã (—Ç–æ–ª—å–∫–æ –Ω–∞ –¥–æ—Ä–æ–≥–∞—Ö)
    vehicles = vehicles.filter(v => {
        v.x += v.speed * (v.dir === 0 ? 1 : v.dir === 1 ? -1 : 0);
        v.z += v.speed * (v.dir === 2 ? 1 : v.dir === 3 ? -1 : 0);
        
        // –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –≥—Ä–∞–Ω–∏—Ü—ã
        if (Math.abs(v.x) > size/2 || Math.abs(v.z) > size/2) {
            return false;
        }
        
        drawVehicle(v);
        return true;
    });

    // –ü–µ—à–µ—Ö–æ–¥—ã
    pedestrians.forEach(p => {
        // –î–≤–∏–∂–µ–Ω–∏–µ –∫ —Ü–µ–ª–∏
        const dx = p.targetX - p.x;
        const dz = p.targetZ - p.z;
        if (Math.abs(dx) < 5 && Math.abs(dz) < 5) {
            p.targetX = p.x + (Math.random() - 0.5) * 200;
            p.targetZ = p.z + (Math.random() - 0.5) * 200;
        }
        p.x += Math.sign(dx) * p.speed;
        p.z += Math.sign(dz) * p.speed;
        
        drawPedestrian(p);
    });

    // –ü–æ–¥—Å–≤–µ—Ç–∫–∞ –≤—ã–±—Ä–∞–Ω–Ω–æ–π –∫–ª–µ—Ç–∫–∏
    if (selRow !== -1 && selCol !== -1) {
        const x = startX + selRow * CELL + CELL/2;
        const z = startZ + selCol * CELL + CELL/2;
        
        const h1 = project(x - CELL/2, 10, z - CELL/2);
        const h2 = project(x + CELL/2, 10, z - CELL/2);
        const h3 = project(x + CELL/2, 10, z + CELL/2);
        const h4 = project(x - CELL/2, 10, z + CELL/2);
        
        ctx.beginPath();
        ctx.moveTo(h1.x, h1.y);
        ctx.lineTo(h2.x, h2.y);
        ctx.lineTo(h3.x, h3.y);
        ctx.lineTo(h4.x, h4.y);
        ctx.closePath();
        ctx.strokeStyle = deleteModeActive ? '#f44336' : '#ffd700';
        ctx.lineWidth = 4;
        ctx.shadowBlur = 20;
        ctx.shadowColor = deleteModeActive ? '#f44336' : '#ffd700';
        ctx.stroke();
        ctx.shadowBlur = 0;
    }

    // –ü–æ–≥–æ–¥–∞
    if (game.weather === 1) { // –î–æ–∂–¥—å
        ctx.fillStyle = '#a9d6e5c0';
        for (let i = 0; i < 200; i++) {
            ctx.fillRect(Math.random() * canvas.width, Math.random() * canvas.height, 2, 25);
        }
    } else if (game.weather === 2) { // –°–Ω–µ–≥
        ctx.fillStyle = '#ffffffe0';
        for (let i = 0; i < 150; i++) {
            ctx.beginPath();
            ctx.arc(Math.random() * canvas.width, Math.random() * canvas.height, 5, 0, Math.PI*2);
            ctx.fill();
        }
    }
}

// ==================== –£–ü–†–ê–í–õ–ï–ù–ò–ï ====================
let drag = false, lastX = 0, lastY = 0;
let selRow = -1, selCol = -1;
let selectedBuilding = null;
let deleteModeActive = false;

// –°–æ–±—ã—Ç–∏—è –º—ã—à–∏
canvas.addEventListener('mousedown', (e) => {
    drag = true;
    lastX = e.clientX;
    lastY = e.clientY;
});

canvas.addEventListener('mouseup', () => drag = false);
canvas.addEventListener('mouseleave', () => drag = false);

canvas.addEventListener('mousemove', (e) => {
    if (!drag) return;
    camera.angle += (e.clientX - lastX) * 0.005;
    camera.height -= (e.clientY - lastY) * 0.5;
    camera.height = Math.max(150, Math.min(400, camera.height));
    lastX = e.clientX;
    lastY = e.clientY;
    draw3D();
});

canvas.addEventListener('wheel', (e) => {
    e.preventDefault();
    camera.distance = Math.max(500, Math.min(1500, camera.distance + (e.deltaY > 0 ? 50 : -50)));
    draw3D();
});

canvas.addEventListener('click', (e) => {
    const rect = canvas.getBoundingClientRect();
    const mouseX = e.clientX - rect.left;
    const mouseY = e.clientY - rect.top;
    
    let bestDist = Infinity;
    let bestR = -1, bestC = -1;
    
    const size = GRID * CELL;
    const startX = -size/2;
    const startZ = -size/2;
    
    for (let r = 0; r < GRID; r++) {
        for (let c = 0; c < GRID; c++) {
            const x = startX + r * CELL + CELL/2;
            const z = startZ + c * CELL + CELL/2;
            const p = project(x, 20, z);
            
            const dist = Math.hypot(mouseX - p.x, mouseY - p.y);
            if (dist < bestDist && dist < 60) {
                bestDist = dist;
                bestR = r;
                bestC = c;
            }
        }
    }
    
    if (bestR !== -1) {
        selRow = bestR;
        selCol = bestC;
        
        if (deleteModeActive) {
            deleteBuilding(bestR, bestC);
        } else if (selectedBuilding) {
            build(bestR, bestC);
        }
        draw3D();
    }
});

// –ò–≥—Ä–æ–≤—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏
function build(r, c) {
    const b = buildings[selectedBuilding];
    if (!b) return;
    
    if (game.money < b.price) {
        showMessage('‚ùå –ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –¥–µ–Ω–µ–≥!');
        return;
    }
    
    if (game.grid[r][c] !== null) {
        showMessage('‚ùå –ö–ª–µ—Ç–∫–∞ –∑–∞–Ω—è—Ç–∞!');
        return;
    }
    
    game.money -= b.price;
    game.grid[r][c] = b.id;
    game.population += b.population || 0;
    game.buildingsCount++;
    
    // –ï—Å–ª–∏ –ø–æ—Å—Ç—Ä–æ–∏–ª–∏ –¥–æ—Ä–æ–≥—É, –¥–æ–±–∞–≤–ª—è–µ–º –º–∞—à–∏–Ω—ã
    if (b.style.type === 'road') {
        for (let i = 0; i < 2; i++) {
            const types = ['car', 'car', 'truck', 'suv'];
            vehicles.push(createVehicle(
                types[Math.floor(Math.random() * types.length)],
                (r - GRID/2) * CELL,
                (c - GRID/2) * CELL
            ));
        }
    }
    
    // –î–æ–±–∞–≤–ª—è–µ–º –ø–µ—à–µ—Ö–æ–¥–æ–≤ —Ä—è–¥–æ–º —Å –∂–∏–ª—ã–º–∏ –¥–æ–º–∞–º–∏
    if (b.style.type === 'house' || b.style.type === 'cottage') {
        for (let i = 0; i < 3; i++) {
            pedestrians.push(createPedestrian(
                (r - GRID/2) * CELL + (Math.random() - 0.5) * CELL,
                (c - GRID/2) * CELL + (Math.random() - 0.5) * CELL
            ));
        }
    }
    
    updateUI();
    showMessage(`‚úÖ –ü–æ—Å—Ç—Ä–æ–µ–Ω–æ: ${b.name}`);
}

function deleteBuilding(r, c) {
    const id = game.grid[r][c];
    if (!id) {
        showMessage('‚ùå –ó–¥–µ—Å—å –Ω–µ—Ç –∑–¥–∞–Ω–∏—è');
        return;
    }
    
    const b = buildings[id];
    game.money += Math.floor(b.price * 0.6);
    game.population = Math.max(0, game.population - (b.population || 0));
    game.buildingsCount--;
    game.grid[r][c] = null;
    
    updateUI();
    showMessage('üóëÔ∏è –ó–¥–∞–Ω–∏–µ —É–¥–∞–ª–µ–Ω–æ');
}

function collectTaxes() {
    let total = 0;
    for (let r = 0; r < GRID; r++) {
        for (let c = 0; c < GRID; c++) {
            const id = game.grid[r][c];
            if (id && buildings[id]) {
                total += buildings[id].income;
            }
        }
    }
    game.money += total;
    updateUI();
    showMessage(`üí∞ –°–æ–±—Ä–∞–Ω–æ ${total.toLocaleString()} –º–æ–Ω–µ—Ç!`);
}

function toggleWeather() {
    game.weather = (game.weather + 1) % 3;
    draw3D();
    showMessage(`üå¶Ô∏è –ü–æ–≥–æ–¥–∞: ${game.weather === 0 ? '–Ø—Å–Ω–æ' : game.weather === 1 ? '–î–æ–∂–¥—å' : '–°–Ω–µ–≥'}`);
}

function toggleTime() {
    game.timeOfDay = (game.timeOfDay + 0.3) % 1;
    draw3D();
    const timeStr = game.timeOfDay > 0.7 ? '–î–µ–Ω—å' : game.timeOfDay > 0.4 ? '–í–µ—á–µ—Ä' : game.timeOfDay > 0.2 ? '–°—É–º–µ—Ä–∫–∏' : '–ù–æ—á—å';
    showMessage(`‚è∞ ${timeStr}`);
}

function toggleDeleteMode() {
    deleteModeActive = !deleteModeActive;
    showMessage(deleteModeActive ? 'üóëÔ∏è –†–µ–∂–∏–º —É–¥–∞–ª–µ–Ω–∏—è –≤–∫–ª—é—á–µ–Ω' : '‚ùå –†–µ–∂–∏–º —É–¥–∞–ª–µ–Ω–∏—è –≤—ã–∫–ª—é—á–µ–Ω');
}

function cancel() {
    selectedBuilding = null;
    deleteModeActive = false;
    document.querySelectorAll('.item').forEach(i => i.classList.remove('selected'));
    document.getElementById('info').innerText = 'üëÜ –í—ã–±–µ—Ä–∏—Ç–µ –∑–¥–∞–Ω–∏–µ';
}

function resetGame() {
    if (confirm('–ù–∞—á–∞—Ç—å –Ω–æ–≤—ã–π –≥–æ—Ä–æ–¥?')) {
        game = {
            money: 100000000,
            population: 0,
            buildingsCount: 0,
            weather: 0,
            timeOfDay: 0.7,
            grid: []
        };
        for (let r = 0; r < GRID; r++) {
            game.grid[r] = [];
            for (let c = 0; c < GRID; c++) {
                game.grid[r][c] = null;
            }
        }
        vehicles = [];
        pedestrians = [];
        updateUI();
        draw3D();
    }
}

function rotateLeft() { camera.angle -= 0.3; draw3D(); }
function rotateRight() { camera.angle += 0.3; draw3D(); }
function zoomIn() { camera.distance = Math.max(500, camera.distance - 100); draw3D(); }
function zoomOut() { camera.distance = Math.min(1500, camera.distance + 100); draw3D(); }

function updateUI() {
    document.getElementById('money').innerText = game.money.toLocaleString();
    document.getElementById('pop').innerText = game.population.toLocaleString();
    document.getElementById('cnt').innerText = `${game.buildingsCount}/${GRID*GRID}`;
    
    let totalIncome = 0;
    for (let r = 0; r < GRID; r++) {
        for (let c = 0; c < GRID; c++) {
            const id = game.grid[r][c];
            if (id && buildings[id]) totalIncome += buildings[id].income;
        }
    }
    document.getElementById('inc').innerText = totalIncome.toLocaleString();
}

function showMessage(msg) {
    document.getElementById('info').innerText = msg;
    setTimeout(() => {
        document.getElementById('info').innerText = 'üèôÔ∏è –£–Æ–¢–ù–´–ô –ì–û–†–û–î 3D';
    }, 3000);
}

// –ü–æ—Å—Ç—Ä–æ–µ–Ω–∏–µ –∫–∞—Ç–∞–ª–æ–≥–∞
const catsDiv = document.getElementById('cats');
const listDiv = document.getElementById('list');

// –ö–Ω–æ–ø–∫–∞ "–í—Å–µ"
const allBtn = document.createElement('button');
allBtn.textContent = 'üèÅ –í–°–ï';
allBtn.classList.add('active');
allBtn.onclick = () => {
    document.querySelectorAll('#cats button').forEach(b => b.classList.remove('active'));
    allBtn.classList.add('active');
    showCategory(null);
};
catsDiv.appendChild(allBtn);

// –ö–∞—Ç–µ–≥–æ—Ä–∏–∏
for (let i = 0; i < 8; i++) {
    const btn = document.createElement('button');
    btn.textContent = `üèóÔ∏è –ö–∞—Ç ${i+1}`;
    btn.onclick = () => {
        document.querySelectorAll('#cats button').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        showCategory(i);
    };
    catsDiv.appendChild(btn);
}

function showCategory(cat) {
    listDiv.innerHTML = '';
    
    let filtered = Object.values(buildings);
    if (cat !== null) {
        filtered = filtered.filter(b => b.category === cat);
    }
    
    filtered.slice(0, 200).forEach(b => {
        const div = document.createElement('div');
        div.className = 'item';
        div.innerHTML = `
            <span class="item-icon">üèóÔ∏è</span>
            <span>${b.name}<br><small>üí∞${b.price.toLocaleString()} | üìà+${b.income}</small></span>
        `;
        div.onclick = () => {
            document.querySelectorAll('.item').forEach(i => i.classList.remove('selected'));
            div.classList.add('selected');
            selectedBuilding = b.id;
            deleteModeActive = false;
            document.getElementById('info').innerText = '–í—ã–±—Ä–∞–Ω–æ: ' + b.name;
        };
        listDiv.appendChild(div);
    });
}

// –ê–Ω–∏–º–∞—Ü–∏—è
function animate() {
    draw3D();
    requestAnimationFrame(animate);
}

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
resize();
showCategory(null);
updateUI();
animate();
</script>
</body>
</html>
