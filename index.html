<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>MEGA CITY 5120</title>

<style>
*{
    margin:0;
    padding:0;
    box-sizing:border-box;
    font-family:Segoe UI, Roboto, sans-serif;
    user-select:none;
}
body{
    background:#081823;
    overflow:hidden;
}
.game{
    width:100vw;
    height:100vh;
    position:relative;
}
canvas{
    width:100%;
    height:100%;
    display:block;
    touch-action:none;
    cursor:grab;
}
canvas:active{cursor:grabbing}

.ui{
    position:fixed;
    bottom:15px;
    left:50%;
    transform:translateX(-50%);
    display:flex;
    gap:15px;
    background:rgba(15,35,50,.95);
    padding:12px 25px;
    border-radius:40px;
    color:#fff;
    font-size:18px;
    z-index:10;
}
.ui div{
    background:rgba(0,0,0,.3);
    padding:6px 14px;
    border-radius:30px;
}

.menu-left{
    position:fixed;
    top:50%;
    left:15px;
    transform:translateY(-50%);
    width:320px;
    height:80vh;
    background:rgba(10,28,40,.95);
    border-radius:25px;
    padding:15px;
    display:flex;
    flex-direction:column;
    gap:10px;
    z-index:10;
}
.menu-left h2{
    color:#fff;
    text-align:center;
}
.categories{
    display:flex;
    flex-wrap:wrap;
    gap:5px;
}
.categories button{
    flex:1;
    padding:6px;
    border-radius:20px;
    border:none;
    cursor:pointer;
}
.list{
    flex:1;
    overflow:auto;
}
.item{
    background:rgba(255,255,255,.08);
    margin-bottom:6px;
    padding:8px;
    border-radius:18px;
    color:#fff;
    cursor:pointer;
}
.item.selected{
    outline:2px solid #ffb84d;
}

.menu-right{
    position:fixed;
    top:50%;
    right:15px;
    transform:translateY(-50%);
    background:rgba(10,28,40,.95);
    border-radius:25px;
    padding:15px;
    display:flex;
    flex-direction:column;
    gap:10px;
    z-index:10;
}
.menu-right button{
    padding:12px;
    font-size:16px;
    border-radius:25px;
    border:none;
    cursor:pointer;
}

.info{
    position:fixed;
    top:15px;
    left:50%;
    transform:translateX(-50%);
    background:rgba(10,28,40,.95);
    padding:12px 25px;
    border-radius:30px;
    color:#fff;
    z-index:10;
}
</style>
</head>

<body>
<div class="game">
<canvas id="c"></canvas>

<div class="info" id="info">–í—ã–±–µ—Ä–∏—Ç–µ –∑–¥–∞–Ω–∏–µ</div>

<div class="ui">
    <div>üí∞ <span id="money">50000000</span></div>
    <div>üë• <span id="pop">0</span></div>
    <div>üìà <span id="inc">0</span></div>
    <div>üèóÔ∏è <span id="cnt">0/3600</span></div>
</div>

<div class="menu-left">
<h2>üèóÔ∏è –ó–î–ê–ù–ò–Ø</h2>
<div class="categories" id="cats"></div>
<div class="list" id="list"></div>
</div>

<div class="menu-right">
<button onclick="collect()">üí∞ –°–ë–û–†</button>
<button onclick="weather()">üå¶Ô∏è –ü–û–ì–û–î–ê</button>
<button onclick="timeDay()">‚è∞ –í–†–ï–ú–Ø</button>
<button onclick="cancel()">‚ùå –û–¢–ú–ï–ù–ê</button>
<button onclick="resetGame()">üîÑ –ù–û–í–´–ô –ì–û–†–û–î</button>
</div>
</div>

<script>
const tg = window.Telegram?.WebApp;
tg?.expand(); tg?.ready();

const GRID=60, CELL=70;
const canvas=document.getElementById('c');
const ctx=canvas.getContext('2d');

let cam={x:0,y:0,z:1};
let drag=false, lx=0, ly=0;
let selRow=-1, selCol=-1;

let game={
money:50000000,
pop:0,
cnt:0,
weather:0,
time:0.6,
grid:[]
};

for(let r=0;r<GRID;r++){
game.grid[r]=[];
for(let c=0;c<GRID;c++)game.grid[r][c]=null;
}

const cats=[
{id:'res',n:'–ñ–∏–ª—ã–µ',e:'üè†',p:1000},
{id:'com',n:'–¢–æ—Ä–≥',e:'üè™',p:2000},
{id:'ind',n:'–ó–∞–≤–æ–¥—ã',e:'üè≠',p:3000},
{id:'fun',n:'–†–∞–∑–≤–ª–µ—á',e:'üé°',p:4000},
{id:'gov',n:'–ì–æ—Å',e:'üèõÔ∏è',p:6000},
];

const buildings={};
let id=0;
cats.forEach((c,ci)=>{
for(let i=0;i<1024;i++){
const price=c.p*(i+1)*(ci+1);
buildings['b'+id]={
id:'b'+id,
cat:c.id,
name:c.n+' '+(i+1),
price,
inc:Math.floor(price*0.12),
pop:Math.floor(price/200),
lvl:1,
e:c.e,
col:`hsl(${(ci*50+i)%360},70%,60%)`
};
id++;
}});
const all=Object.values(buildings);

function resize(){
canvas.width=innerWidth;
canvas.height=innerHeight;
draw();
}
addEventListener('resize',resize);
resize();

function iso(r,c){
return{
x:(c-r)*CELL/2*cam.z+cam.x+canvas.width/2,
y:(c+r)*CELL/4*cam.z+cam.y+canvas.height/3
};
}

function draw(){
ctx.clearRect(0,0,canvas.width,canvas.height);
ctx.fillStyle='#7cb57c';
for(let r=0;r<GRID;r++)for(let c=0;c<GRID;c++){
const p=iso(r,c);
ctx.beginPath();
ctx.moveTo(p.x,p.y);
ctx.lineTo(p.x+CELL/2*cam.z,p.y+CELL/4*cam.z);
ctx.lineTo(p.x,p.y+CELL/2*cam.z);
ctx.lineTo(p.x-CELL/2*cam.z,p.y+CELL/4*cam.z);
ctx.closePath();
ctx.fill();

const id=game.grid[r][c];
if(id){
const b=buildings[id];
ctx.fillStyle=b.col;
ctx.fill();
ctx.fillStyle='#fff';
ctx.textAlign='center';
ctx.fillText(b.e,p.x,p.y);
}
}
}

canvas.onmousedown=e=>{drag=true;lx=e.clientX;ly=e.clientY}
canvas.onmouseup=_=>drag=false;
canvas.onmousemove=e=>{
if(!drag)return;
cam.x+=e.clientX-lx;
cam.y+=e.clientY-ly;
lx=e.clientX;ly=e.clientY;
draw();
}
canvas.onwheel=e=>{
cam.z=Math.min(3,Math.max(.4,cam.z+(e.deltaY<0?.1:-.1)));
draw();
}

canvas.onclick=e=>{
const rect=canvas.getBoundingClientRect();
let mx=e.clientX-rect.left,my=e.clientY-rect.top;
let best=null,br=-1,bc=-1;
for(let r=0;r<GRID;r++)for(let c=0;c<GRID;c++){
const p=iso(r,c);
const d=Math.hypot(mx-p.x,my-p.y);
if(d<40 && (!best||d<best)){best=d;br=r;bc=c;}
}
if(br!=-1){
selRow=br;selCol=bc;
if(selected)build(br,bc);
}
}

let selected=null;

function build(r,c){
const b=buildings[selected];
if(game.money<b.price||game.grid[r][c])return;
game.money-=b.price;
game.grid[r][c]=b.id;
game.pop+=b.pop;
game.cnt++;
update();
draw();
}

function collect(){
let t=0;
for(let r=0;r<GRID;r++)for(let c=0;c<GRID;c++){
const id=game.grid[r][c];
if(id)t+=buildings[id].inc;
}
game.money+=t;
update();
}

function weather(){game.weather=(game.weather+1)%3;draw();}
function timeDay(){game.time=(game.time+.3)%1;draw();}
function cancel(){selected=null;info.innerText='–í—ã–±–æ—Ä —Å–±—Ä–æ—à–µ–Ω'}
function resetGame(){location.reload()}

function update(){
money.innerText=game.money.toLocaleString();
pop.innerText=game.pop.toLocaleString();
cnt.innerText=game.cnt+'/3600';
let inc=0;
for(let r=0;r<GRID;r++)for(let c=0;c<GRID;c++){
const id=game.grid[r][c];
if(id)inc+=buildings[id].inc;
}
incSpan.innerText=inc.toLocaleString();
}

const catsDiv=document.getElementById('cats');
const list=document.getElementById('list');
const info=document.getElementById('info');
const money=document.getElementById('money');
const pop=document.getElementById('pop');
const incSpan=document.getElementById('inc');
const cnt=document.getElementById('cnt');

cats.forEach(c=>{
const btn=document.createElement('button');
btn.textContent=c.e+' '+c.n;
btn.onclick=_=>{
list.innerHTML='';
all.filter(b=>b.cat===c.id).slice(0,200).forEach(b=>{
const d=document.createElement('div');
d.className='item';
d.innerText=b.e+' '+b.name+' üí∞'+b.price;
d.onclick=_=>{
document.querySelectorAll('.item').forEach(i=>i.classList.remove('selected'));
d.classList.add('selected');
selected=b.id;
info.innerText='–í—ã–±—Ä–∞–Ω–æ: '+b.name;
};
list.appendChild(d);
});
};
catsDiv.appendChild(btn);
});

draw();
update();
</script>
</body>
</html>
